<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>ğŸŒ èŠ±è“®å…‰å¾©æ•‘ç½äº¤é€šåª’åˆ</title>
<style>
  body {
    font-family: "Microsoft JhengHei", sans-serif;
    margin: 0;
    padding: 0;
    background: linear-gradient(to right, #eaf8ff, #f7fff7);
    color: #222;
  }

  /* é é¢æ¨™é¡Œ */
  h1 {
    text-align: center;
    padding: 20px;
    color: #005c4b;
  }

  /* å°æ¨™é¡Œ */
  h2 {
    color: #00695c;
    margin: 20px;
    font-size: 20px;
  }

  /* æŒ‰éˆ•ç¾¤çµ„ */
  .buttons {
    text-align: center;
    margin: 20px 0;
  }

  /* ä¸»åŠŸèƒ½æŒ‰éˆ• */
  .btn-main {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 12px 24px;
    font-size: 16px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    margin: 0 6px;
    color: #fff;
    font-weight: bold;
    transition: transform 0.2s, background 0.3s;
  }

  .btn-driver {
    background: #007bff;
  }
  .btn-driver:hover {
    background: #0056b3;
    transform: scale(1.05);
  }

  .btn-passenger {
    background: #dc3545;
  }
  .btn-passenger:hover {
    background: #a71d2a;
    transform: scale(1.05);
  }

  /* å¡ç‰‡ */
  .card {
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: #fff;
    margin: 10px 20px;
    padding: 15px;
    border-radius: 8px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    animation: fadeInUp 0.4s ease-in-out;
    position: relative;
    flex-wrap: wrap; /* âœ…é¿å…å°è¢å¹•çˆ†ç‰ˆ */
  }

  .card::before {
    content: "";
    display: block;
    width: 6px;
    height: 100%;
    border-radius: 6px 0 0 6px;
    margin-right: 10px;
    position: absolute;
    left: 0;
    top: 0;
  }

  .driver-card::before {
    background: #2196f3;
  }

  .passenger-card::before {
    background: #f44336;
  }

  /* æ“ä½œæŒ‰éˆ• */
  .actions {
    display: flex;
    align-items: center;
    margin-left: auto;
  }

  .actions button {
    padding: 6px 12px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    color: #fff;
    background: #007bff;
    margin-left: 6px;
    transition: background 0.3s;
  }

  .actions button:hover {
    background: #0056b3;
  }

  /* å±•é–‹è©³ç´°è³‡è¨Š */
  .details {
    display: none;
    width: 100%;
    margin-top: 10px;
    padding: 10px;
    background: #f9f9f9;
    border-top: 1px solid #ddd;
    border-radius: 0 0 8px 8px;
  }

  .details h4 {
    margin: 10px 0 5px;
    font-size: 15px;
    color: #333;
  }

  .details p {
    margin: 3px 0;
    font-size: 14px;
  }

  .details ul {
    margin: 0;
    padding-left: 20px;
  }

  .arrow {
    cursor: pointer;
    margin-left: 8px;
    font-size: 14px;
    color: #555;
    transition: transform 0.3s;
  }

  .arrow.open {
    transform: rotate(90deg); /* â–¶ è®Šæˆ â–¼ */
  }

  /* Modal */
  .modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.6);
  }

  .modal-content {
    background: #fff;
    margin: 10% auto;
    padding: 20px;
    border-radius: 10px;
    width: 90%;
    max-width: 450px;
  }

  .close {
    float: right;
    font-size: 20px;
    cursor: pointer;
  }

  /* å‹•ç•« */
  @keyframes fadeInUp {
    from {opacity: 0; transform: translateY(15px);}
    to {opacity: 1; transform: translateY(0);}
  }

  /* å›åˆ°é ‚ç«¯æŒ‰éˆ• */
  #backToTop {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: #00897b;
    color: #fff;
    border: none;
    border-radius: 50%;
    padding: 14px;
    font-size: 20px;
    cursor: pointer;
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    z-index: 1200;
    transition: transform 0.2s, background 0.3s;
  }

  #backToTop:hover {
    background: #00695c;
    transform: scale(1.08);
  }
</style>

</head>
<body>
  <h1>ğŸŒ èŠ±è“®å…‰å¾©æ•‘ç½äº¤é€šåª’åˆ</h1>

  <div class="buttons">
    <a href="{% url 'find_car' %}">
      <button class="btn-main btn-driver">ğŸš— æˆ‘è¦å‡ºè»Šï¼ˆæ‰¾ä¹˜å®¢ï¼‰</button>
    </a>
    <a href="{% url 'find_people' %}">
      <button class="btn-main btn-passenger">ğŸ§ æˆ‘è¦æ­è»Šï¼ˆæ‰¾è»Šï¼‰</button>
    </a>
  </div>

  <h2>æ‰¾äººè³‡è¨Šï¼ˆå¸æ©Ÿæä¾›åº§ä½ï¼‰</h2>
  <ul id="passenger-list">
    {% for p in passengers %}
      {% if not p.is_matched %}
        <li class="card passenger-card">
          <span><b>{{ p.passenger_name }}</b> - éœ€è¦ {{ p.seats_needed }} äºº
            ({{ p.departure }} â†’ {{ p.destination }}, {{ p.date }})</span>
          <div class="actions">
            <button onclick="openPassengerModal('{{ p.id }}')">ç·¨è¼¯</button>
            <button onclick="openJoinModal('{{ p.id }}')">åƒåŠ </button>
          </div>
        </li>
      {% endif %}
    {% empty %}
      <li class="card passenger-card">ç›®å‰æ²’æœ‰éœ€æ±‚</li>
    {% endfor %}
  </ul>

<h2>æ‰¾è»Šéœ€æ±‚ï¼ˆä¹˜å®¢éœ€è¦å¸æ©Ÿï¼‰</h2>
<ul id="driver-list"></ul>


  <!-- å›åˆ°é ‚ç«¯ -->
  <button id="backToTop" onclick="window.scrollTo({top:0, behavior:'smooth'});">â¬†</button>

<script>
  // WebSocket è‡ªå‹•æ›´æ–°
  const socket = new WebSocket("ws://" + window.location.host + "/ws/find/");

  socket.onopen = function() {
    console.log("âœ… WebSocket é€£ç·šæˆåŠŸ");
  };

  socket.onmessage = function(event) {
    try {
      const data = JSON.parse(event.data);
      console.log("ğŸ“© æ”¶åˆ°è³‡æ–™ï¼š", data);

      if (data.type === "update") {
        if (data.passengers_html) {
          document.getElementById("passenger-list").innerHTML = data.passengers_html;
        }
        if (data.drivers_html) {
          document.getElementById("driver-list").innerHTML = data.drivers_html;
        }
      }

      // åŠ å…¥æç¤ºè¨Šæ¯
      if (data.type === "join_result") {
        if (data.success) {
          showToast("âœ… æˆåŠŸåŠ å…¥ä¹˜å®¢è¡Œç¨‹ï¼", "success");
        } else {
          showToast("âš ï¸ åŠ å…¥å¤±æ•—ï¼š" + (data.message || "æ²’æœ‰å¯ç”¨çš„å¸æ©Ÿ"), "error");
        }
      }
    } catch (err) {
      console.error("âš ï¸ è§£æè¨Šæ¯å¤±æ•—", err, event.data);
    }
  };

  socket.onclose = function() {
    console.log("âŒ WebSocket å·²é—œé–‰");
  };

  socket.onerror = function(error) {
    console.error("âš ï¸ WebSocket ç™¼ç”ŸéŒ¯èª¤", error);
  };

  // ğŸ”¹ ç®¡ç†å¸æ©ŸæŒ‰éˆ•äº‹ä»¶
  function manageDriver(driverId) {
    console.log("ğŸ“¤ å‚³é€ç®¡ç†äº‹ä»¶ï¼ŒdriverId:", driverId);
    socket.send(JSON.stringify({
      action: "driver_manage",
      driver_id: driverId
    }));
  }

  // æ‰“é–‹ç®¡ç† Modal
  function openDriverModal(driverId, seats, isActive) {
    document.getElementById("driverId").value = driverId;
    document.getElementById("driverSeats").value = seats;
    document.getElementById("driverActive").value = isActive === "True" ? "true" : "false";

    document.getElementById("driverModal").style.display = "block";
  }

  // é—œé–‰ç®¡ç† Modal
  function closeDriverModal() {
    document.getElementById("driverModal").style.display = "none";
  }

  // å„²å­˜ä¿®æ”¹ â†’ ç™¼é€ WebSocket
  function saveDriverChanges() {
    const driverId = document.getElementById("driverId").value;
    const seats = document.getElementById("driverSeats").value;
    const isActive = document.getElementById("driverActive").value;

    console.log("ğŸ“¤ å„²å­˜å¸æ©Ÿä¿®æ”¹:", driverId, seats, isActive);

    socket.send(JSON.stringify({
      action: "driver_update",
      driver_id: driverId,
      seats_total: seats,
      is_active: isActive === "true"
    }));

    closeDriverModal();
  }

  // é»æ“Šã€ŒåƒåŠ ã€æŒ‰éˆ•
  function openJoinDriverModal(driverId) {
    document.getElementById("joinModal").style.display = "block";
    document.getElementById("joinForm").action = `/find/driver/${driverId}/join/`;
  }

  function openJoinModal(driverId) {
    document.getElementById("joinModal").style.display = "block";
    document.getElementById("joinForm").action = `/find/driver/${driverId}/join/`;
  }

  function showToast(message, type = "success") {
    const container = document.getElementById("toast-container");
    const toast = document.createElement("div");
    toast.style.minWidth = "200px";
    toast.style.marginTop = "10px";
    toast.style.padding = "12px 18px";
    toast.style.borderRadius = "6px";
    toast.style.color = "#fff";
    toast.style.fontWeight = "bold";
    toast.style.boxShadow = "0 4px 8px rgba(0,0,0,0.2)";
    toast.style.opacity = "0.95";
    toast.style.transition = "transform 0.3s ease, opacity 0.3s ease";

    if (type === "success") {
      toast.style.background = "#28a745";
    } else if (type === "error") {
      toast.style.background = "#dc3545";
    } else {
      toast.style.background = "#6c757d";
    }

    toast.textContent = message;
    container.appendChild(toast);

    setTimeout(() => {
      toast.style.opacity = "0";
      toast.style.transform = "translateY(-20px)";
      setTimeout(() => container.removeChild(toast), 300);
    }, 3000);
  }

  // âœ… æ”¹è‰¯ç‰ˆï¼šå±•é–‹/æ”¶åˆè©³ç´°è³‡è¨Š + å°ç®­é ­åˆ‡æ›
  function toggleDetails(id) {
  const details = document.getElementById("details-" + id);
  const arrow = document.querySelector(`#details-${id}`).parentNode.querySelector(".arrow");

  if (details.classList.contains("hidden")) {
    details.classList.remove("hidden");
    arrow.classList.add("open");   // ğŸ”¹ç®­é ­åŠ ä¸Šæ—‹è½‰
  } else {
    details.classList.add("hidden");
    arrow.classList.remove("open"); // ğŸ”¹ç®­é ­æ¢å¾©
  }
}
</script>



<!-- ç®¡ç†å¸æ©Ÿ Modal -->
<div id="driverModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeDriverModal()">&times;</span>
    <h3>ğŸš— ç®¡ç†å¸æ©Ÿ</h3>
    
    <input type="hidden" id="driverId">

    <label>åº§ä½æ•¸ï¼š</label>
    <input type="number" id="driverSeats" min="1" value="4" style="width:100%; margin-bottom:10px;"><br>

    <label>æ˜¯å¦å•Ÿç”¨ï¼š</label>
    <select id="driverActive" style="width:100%; margin-bottom:10px;">
      <option value="true">å•Ÿç”¨</option>
      <option value="false">åœç”¨</option>
    </select>

    <button onclick="saveDriverChanges()">ğŸ’¾ å„²å­˜</button>
  </div>
</div>

<!-- Toast å®¹å™¨ -->
<div id="toast-container" style="
  position: fixed;
  top: 20px;
  right: 20px;
  z-index: 2000;
"></div>

<!-- Modal -->
<div id="joinModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="document.getElementById('joinModal').style.display='none'">&times;</span>
    <h2>åƒåŠ è¡Œç¨‹</h2>
    <form id="joinForm" method="POST">
      {% csrf_token %}
      <label>å§“åï¼š</label>
      <input type="text" name="passenger_name" required><br>

      <label>éœ€è¦äººæ•¸ï¼š</label>
      <input type="number" name="seats_needed" value="1" min="1" max="10"><br>

      <label>å‡ºç™¼åœ°ï¼š</label>
      <input type="text" name="departure" required><br>

      <label>ç›®çš„åœ°ï¼š</label>
      <input type="text" name="destination" required><br>

      <label>æ—¥æœŸï¼š</label>
      <input type="date" name="date" required><br>

      <button type="submit">é€å‡º</button>
    </form>
  </div>
</div>

</body>
</html>

{% extends "portfolio/base.html" %}
{% block title %}Minecraft ç©å®¶æŸ¥è©¢{% endblock %}

{% block content %}
<div class="container my-5 section-box">
  <h2 class="text-center mb-4">Minecraft ç©å®¶è³‡æ–™æŸ¥è©¢</h2>

  <!-- æŸ¥è©¢ç©å®¶ -->
  <div class="input-group mb-3">
    <input type="text" id="playerId" class="form-control" placeholder="è¼¸å…¥ Minecraft ID æˆ– UUID">
    <button class="btn btn-primary" id="searchBtn">æŸ¥è©¢</button>
  </div>

  <!-- æŸ¥æ’è¡Œæ¦œ -->
  <div class="text-center mb-3">
    <div class="btn-group">
      <button class="btn btn-outline-success rank-btn" data-type="money">ğŸ’° é‡‘å¹£æ’è¡Œ</button>
      <button class="btn btn-outline-primary rank-btn" data-type="level">ğŸ“ˆ ç­‰ç´šæ’è¡Œ</button>
      <button class="btn btn-outline-warning rank-btn" data-type="guild">ğŸ° å…¬æœƒæ’è¡Œ</button>
      <button class="btn btn-outline-dark rank-btn" data-type="playtime">â± éŠç©æ™‚é–“æ’è¡Œ</button>
    </div>
  </div>

  <!-- æœå°‹æ¡†-->
  <div class="input-group mb-3" id="rankSearchBox" style="display:none;">
    <span class="input-group-text">æœå°‹ç©å®¶</span>
    <input type="text" id="rankSearchInput" class="form-control" placeholder="è¼¸å…¥ç©å®¶åç¨±æˆ–UUID">
    <button class="btn btn-outline-secondary" id="closeRankBtn">æ”¶åˆæ’è¡Œæ¦œ</button>
  </div>

  <!-- æŸ¥è©¢çµæœ -->
  <div id="results"></div>
</div>

<style>
.fade-in {
  animation: fadeIn 0.6s ease-in-out;
}
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}
.highlight {
  animation: blink 1s linear 2;
}
@keyframes blink {
  0%, 100% { background-color: transparent; }
  50% { background-color: #fff3cd; }
}
</style>

<script>
// ç©å®¶æŸ¥è©¢
document.getElementById("searchBtn").addEventListener("click", () => {
  const playerId = document.getElementById("playerId").value;
  fetch(`/minecraft/search/?player_id=${playerId}`)
    .then(res => res.json())
    .then(data => {
      let html = "<div class='fade-in'>";
      if (data.mmocore.length > 0) {
        const d = data.mmocore[0];
        html += `<h4 class="mt-4">MMOcore</h4>
        <table class="table table-bordered">
          <tr><th>UUID</th><td>${d.uuid}</td></tr>
          <tr><th>è·æ¥­</th><td>${d.class}</td></tr>
          <tr><th>ç­‰ç´š</th><td>${d.level}</td></tr>
          <tr><th>ä¸»ç­‰ç´š</th><td>${d.mainlevel_level}</td></tr>
        </table>`;
      }
      if (data.playerdata.length > 0) {
        const d = data.playerdata[0];
        html += `<h4 class="mt-4">ç¶“æ¿Ÿç³»çµ±</h4>
        <table class="table table-bordered">
          <tr><th>UUID</th><td>${d.player_uuid}</td></tr>
          <tr><th>ç©å®¶åç¨±</th><td>${d.player_name}</td></tr>
          <tr><th>é‡‘å¹£</th><td>${d.money}</td></tr>
        </table>`;
      }
      if (data.guilds.length > 0) {
        const d = data.guilds[0];
        html += `<h4 class="mt-4">å…¬æœƒç³»çµ±</h4>
        <table class="table table-bordered">
          <tr><th>å…¬æœƒåç¨±</th><td>${d.gname}</td></tr>
          <tr><th>ç­‰ç´š</th><td>${d.glevel}</td></tr>
          <tr><th>è³‡é‡‘</th><td>${d.gmoney}</td></tr>
        </table>`;
      }
      if (data.cmi.length > 0) {
        const d = data.cmi[0];
        html += `<h4 class="mt-4">CMI ç³»çµ±</h4>
        <table class="table table-bordered">
          <tr><th>UUID</th><td>${d.player_uuid}</td></tr>
          <tr><th>ç©å®¶åç¨±</th><td>${d.username}</td></tr>
          <tr><th>ç¸½éŠç©æ™‚é–“</th><td>${d.TotalPlayTime}</td></tr>
          <tr><th>é¤˜é¡</th><td>${d.Balance}</td></tr>
          <tr><th>é£›è¡Œèƒ½é‡</th><td>${d.FlightCharge}</td></tr>
          <tr><th>é¡¯ç¤ºåç¨±</th><td>${d.DisplayName}</td></tr>
        </table>`;
      }
      html += "</div>";
      document.getElementById("results").innerHTML = html || "<p class='text-danger'>æ‰¾ä¸åˆ°è©²ç©å®¶è³‡æ–™</p>";
    });
});

// æ’è¡Œæ¦œæŸ¥è©¢
document.querySelectorAll(".rank-btn").forEach(btn => {
  btn.addEventListener("click", () => {
    const type = btn.getAttribute("data-type");
    fetch(`/minecraft/rank/?type=${type}`)
      .then(res => res.json())
      .then(data => {
        let html = `<h3 class="mt-4">æ’è¡Œæ¦œ - ${btn.textContent}</h3>`;
        html += "<table class='table table-striped fade-in' id='rankTable'><thead><tr>";

        if (type === "money") {
          html += "<th>#</th><th>ç©å®¶</th><th>é‡‘å¹£</th></tr></thead><tbody>";
          data.rows.forEach((row, i) => {
            html += `<tr><td>${i+1}</td><td>${row.player_name}</td><td>${row.money}</td></tr>`;
          });
        } else if (type === "level") {
          html += "<th>#</th><th>UUID</th><th>è·æ¥­</th><th>ä¸»ç­‰ç´š</th></tr></thead><tbody>";
          data.rows.forEach((row, i) => {
            html += `<tr><td>${i+1}</td><td>${row.uuid}</td><td>${row.class}</td><td>${row.mainlevel_level}</td></tr>`;
          });
        } else if (type === "guild") {
          html += "<th>#</th><th>å…¬æœƒåç¨±</th><th>ç­‰ç´š</th><th>è³‡é‡‘</th></tr></thead><tbody>";
          data.rows.forEach((row, i) => {
            html += `<tr><td>${i+1}</td><td>${row.gname}</td><td>${row.glevel}</td><td>${row.gmoney}</td></tr>`;
          });
        } else if (type === "playtime") {
          html += "<th>#</th><th>ç©å®¶</th><th>éŠç©æ™‚é–“</th><th>é¤˜é¡</th></tr></thead><tbody>";
          data.rows.forEach((row, i) => {
            html += `<tr><td>${i+1}</td><td>${row.username}</td><td>${row.TotalPlayTime}</td><td>${row.Balance}</td></tr>`;
          });
        }

        html += "</tbody></table>";
        document.getElementById("results").innerHTML = html;
        document.getElementById("rankSearchBox").style.display = "flex";
      });
  });
});

document.getElementById("rankSearchInput").addEventListener("input", function() {
  const filter = this.value.toLowerCase();
  const rows = document.querySelectorAll("#rankTable tbody tr");
  rows.forEach(row => {
    const text = row.innerText.toLowerCase();
    if (text.includes(filter)) {
      row.style.display = "";
      row.classList.add("highlight");
      setTimeout(() => row.classList.remove("highlight"), 2000);
    } else {
      row.style.display = "none";
    }
  });
});

// æ”¶åˆæ’è¡Œæ¦œ
document.getElementById("closeRankBtn").addEventListener("click", () => {
  document.getElementById("results").innerHTML = "";
  document.getElementById("rankSearchBox").style.display = "none";
  document.getElementById("rankSearchInput").value = "";
});
</script>
{% endblock %}

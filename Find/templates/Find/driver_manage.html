<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>ğŸ›  å¸æ©Ÿç®¡ç†</title>
  <style>
/* ========== Base ========== */
:root{
  --clr-primary:#007bff;
  --clr-primary-2:#0056b3;
  --clr-accent:#00b894;
}
*{box-sizing:border-box}
body{
  font-family:"Microsoft JhengHei",sans-serif;
  background:linear-gradient(to right,#f0f9ff,#fefefe);
  margin:0; padding:40px 20px;
}
h2{ text-align:center; color:#005c4b; margin-bottom:25px; font-size:26px; }
@keyframes fadeIn{ from{opacity:0;transform:translateY(20px)} to{opacity:1;transform:translateY(0)} }

/* ========== Forms ========== */
form{
  max-width:600px;margin:0 auto;background:#fff;
  padding:25px 30px;border-radius:16px;
  box-shadow:0 6px 12px rgba(0,0,0,.1);animation:fadeIn .5s ease-in-out;
}
label{font-weight:700;display:block;margin:12px 0 6px;color:#444}
input,textarea,select{
  width:100%;padding:12px;margin-bottom:10px;border-radius:10px;
  border:1px solid #ccc;transition:border-color .3s,box-shadow .3s;font-size:15px;
}
input:focus,textarea:focus,select:focus{
  border-color:var(--clr-primary);
  box-shadow:0 0 8px rgba(0,123,255,.3); outline:none;
}
textarea{min-height:80px;resize:vertical}
.required::after{content:" *";color:red}

/* ========== Buttons ========== */
.btn{
  width:100%;padding:14px;border:0;border-radius:10px;
  background:linear-gradient(45deg,var(--clr-primary),var(--clr-accent));
  color:#fff;font-size:18px;font-weight:700;cursor:pointer;
  transition:background .3s,transform .2s;
}
.btn:hover{background:linear-gradient(45deg,var(--clr-primary-2),#009e77);transform:scale(1.02)}
.btn-danger{background:linear-gradient(45deg,#ef4444,#f97316)}
.btn-danger:hover{background:linear-gradient(45deg,#b91c1c,#ea580c)}
.btn-ghost{
  width:100%;padding:14px;border:0;border-radius:10px;
  background:linear-gradient(45deg,var(--clr-primary),var(--clr-accent));
  color:#fff;font-size:18px;font-weight:700;cursor:pointer;transition:background .3s,transform .2s;
}
.btn-ghost:hover{background:linear-gradient(45deg,#0fbfd2,#402fc7);transform:scale(1.02)}
.btn-mini{
  padding:8px 12px;border:0;border-radius:8px;line-height:1;font-weight:600;cursor:pointer;
}
.btn-mini:hover{filter:brightness(.97)}
.btn-mini.ok{background:#dcfce7;color:#065f46}
.btn-mini.danger{background:#fee2e2;color:#7f1d1d}
.btn-mini.memo{background:#e0e7ff;color:#3730a3}

/* ========== Alerts ========== */
.alert{max-width:600px;margin:0 auto 12px;padding:12px 14px;border-radius:10px}
.alert-ok{background:#e8f8ef;color:#206b3a;border:1px solid #a7e2bf}
.alert-warn{background:#fff7e6;color:#9a6b00;border:1px solid #f7d7a3}

/* ========== Passenger cards ========== */
.panel{max-width:900px;margin:18px auto}
.pax-list{list-style:none;margin:10px auto 0;padding:0;max-width:900px}
.pax-item{
  background:#fff;border:1px solid #e5e7eb;border-radius:12px;
  padding:14px 16px;margin:10px 0;box-shadow:0 3px 8px rgba(0,0,0,.05)
}
.pax-row{display:grid;grid-template-columns:1fr auto;grid-row-gap:10px;align-items:start}
.pax-head{grid-column:1/-1;display:flex;align-items:center;gap:8px}
.pax-name{font-weight:700;font-size:15px}
.badge{font-size:12px;padding:2px 8px;border-radius:999px;background:#eef2ff;color:#4338ca}
.badge.gender{background:#e0f2fe;color:#0369a1}
.badge.rt{background:#fef3c7;color:#92400e}
.pax-grid{
  grid-column:1/-1;display:grid;grid-template-columns:repeat(6,minmax(0,1fr));
  gap:10px 14px
}
.pax-cell label{display:block;font-size:12px;color:#6b7280;margin-bottom:4px;letter-spacing:.02em}
.pax-cell div{font-size:14px;color:#111827}
.pax-cell.span-2{grid-column:span 2}
.pax-actions{
  display:flex;
  gap:8px;
  justify-content:flex-end; /* å…§å®¹å‘å³ */
  align-self:end;           /* åœ¨ grid åˆ—ä¸­é ä¸‹ */
  justify-self:end;         /* åœ¨ grid æ¬„ä½é å³ */
  grid-column: 1 / -1;      /* éœ€è¦æ™‚è®“æ•´åˆ—æ©«è·¨ï¼Œæ‰èƒ½è²¼åˆ°æœ€å³é‚Š */
}

/* ========== Note & Memo ribbons ========== */
.pax-note, .pax-memo{
  grid-column: 1 / -1;
  position:relative;
  display:grid; grid-template-columns:92px 1fr auto;
  align-items:center; gap:10px 14px; padding:10px 12px;
  border-radius:10px; margin:10px 0 8px; border:1px solid transparent;
}
.pax-note{ background:#fff7ed; border-color:#ffe6c7; }
.pax-note .label{ font-weight:700; color:#9a6700; }
.pax-memo{ background:#eef6ff; border-color:#dbeafe; }
.pax-memo .label{ font-weight:700; color:#1d4ed8; }
.pax-memo .memo-text{ color:#0f172a; word-break:break-word; }
.pax-memo .memo-actions{ display:flex; gap:8px; justify-self:end; }
/* å·¦å´è‰²æ¢ */
.pax-note::before, .pax-memo::before{
  content:""; position:absolute; left:0; top:0; bottom:0; width:6px; border-radius:10px 0 0 10px;
}
.pax-note::before{ background:#f59e0b; }
.pax-memo::before{ background:#3b82f6; }

/* ========== Switch (toggle) ========== */
.switch{
  display:flex;align-items:center;justify-content:center;gap:12px;margin:10px 0;
}
.switch input[type="checkbox"]{position:absolute;opacity:0;width:0;height:0}
.switch .toggle{
  position:relative;width:52px;height:30px;border-radius:999px;background:#e5e7eb;
  box-shadow:inset 0 0 0 1px rgba(0,0,0,.06);transition:background .2s ease;cursor:pointer;display:inline-block;
}
.switch .toggle::after{
  content:"";position:absolute;top:3px;left:3px;width:24px;height:24px;border-radius:50%;background:#fff;
  box-shadow:0 1px 2px rgba(0,0,0,.2);transition:transform .2s ease;
}
.switch input[type="checkbox"]:checked + .toggle{ background:#10b981 }
.switch input[type="checkbox"]:checked + .toggle::after{ transform:translateX(22px) }
.switch .toggle.is-disabled{opacity:.6;cursor:not-allowed}
.switch label{font-weight:600;color:#374151;cursor:pointer}
.switch .hint{display:block;font-size:12px;color:#6b7280;margin-top:2px;text-align:center}

/* ========== Responsive ========== */
@media (max-width:1024px){ .pax-grid{grid-template-columns:repeat(4,minmax(0,1fr))} }
@media (max-width:768px){
  form{padding:18px 16px}
  .pax-row{grid-template-columns:1fr}
  .pax-actions{justify-content:flex-end}
  .pax-grid{grid-template-columns:repeat(2,minmax(0,1fr))}
  .pax-cell.span-2{grid-column:1/-1}
  .pax-note, .pax-memo{grid-template-columns:1fr;gap:6px}
  .pax-memo .memo-actions{justify-self:start}
  .switch .toggle{width:56px;height:34px}
  .switch .toggle::after{width:26px;height:26px;top:4px;left:4px;transform:none}
  .switch input[type="checkbox"]:checked + .toggle::after{transform:translateX(22px)}
}
@media (max-width:480px){ .pax-grid{grid-template-columns:1fr} }
</style>

</head>
<body>
  <h2>ğŸ›  å¸æ©Ÿç®¡ç†</h2>

  {% if saved_msg %}<div class="alert alert-ok">{{ saved_msg }}</div>{% endif %}
  {% if matched_msg %}<div class="alert alert-ok">{{ matched_msg }}</div>{% endif %}
  {% if full_msg %}<div class="alert alert-warn">{{ full_msg }}</div>{% endif %}

  <!-- A) ç·¨è¼¯å¸æ©Ÿè³‡æ–™ -->
  <!-- çœç•¥å‰æ®µç›¸åŒ CSS èˆ‡ <body> é–‹é ­ -->

  <!-- A) ç·¨è¼¯å¸æ©Ÿè³‡æ–™ -->
  <form method="POST">
    {% csrf_token %}
    <input type="hidden" name="form" value="update_driver" />

    <label class="required">æš±ç¨±</label>
    <input type="text" name="driver_name" value="{{ driver.driver_name }}" required />

    <label class="required">æ€§åˆ¥</label>
    <select name="gender" required>
      <option value="M" {% if driver.gender == 'M' %}selected{% endif %}>ç”·ç”Ÿ</option>
      <option value="F" {% if driver.gender == 'F' %}selected{% endif %}>å¥³ç”Ÿ</option>
      <option value="X" {% if driver.gender == 'X' %}selected{% endif %}>ä¸æ–¹ä¾¿é€æ¼</option>
    </select>

    <label>Emailï¼ˆé¸å¡«ï¼‰</label>
    <input type="email" id="email" name="email" value="{{ driver.email|default_if_none:'' }}" />

    <!-- ğŸ”’ éš±ç§ï¼šéœ€è¦ Email æ‰èƒ½å•Ÿç”¨ -->
    <div class="switch" id="privacy-switch" style="margin-top:6px;">
      <input type="checkbox"
             id="hide_contact"
             name="hide_contact"
             {% if driver.hide_contact %}checked{% endif %} />
      <span class="toggle"></span>
      <label for="hide_contact">éš±è—å€‹è³‡ï¼ˆè¯çµ¡æ–¹å¼ï¼‰</label>
    </div>
    <span id="privacyHint" class="hint">éœ€å¡«å¯« Email æ‰èƒ½éš±è—ï¼›Email åƒ…ä¾›ç³»çµ±é€šçŸ¥ï¼Œä¸æœƒå…¬é–‹ã€‚</span>

    <label class="required" style="margin-top:14px;">è¯çµ¡æ–¹å¼</label>
    <input type="text" name="contact" value="{{ driver.contact }}" placeholder="LINE / IG / Phone Number" required />

    <label>ç®¡ç†å¯†ç¢¼ï¼ˆç•™ç©ºä¸è®Šæ›´ï¼‰</label>
    <input type="password" name="passwordf" placeholder="ç•™ç©ºä¸ä¿®æ”¹" />

    <label class="required">ç¸½åº§ä½</label>
    <input type="number" id="seats_total" name="seats_total" min="1" value="{{ driver.seats_total }}" required />

    <!-- å‡ºç™¼åœ°ï¼ˆä¸‹æ‹‰ + è‡ªå¡«ï¼‰ -->
    {% with has_dep_custom=driver.departure_custom %}
    <label class="required">å‡ºç™¼åœ°</label>
    <select name="departure" id="departure" onchange="checkCustomDeparture(this)" required>
      <option value="" {% if not driver.departure and not has_dep_custom %}selected{% endif %}>è«‹é¸æ“‡ç¸£å¸‚</option>
      <option value="è‡ªå¡«" {% if has_dep_custom %}selected{% endif %}>å…¶ä»–</option>
      <option value="èŠ±è“®ç¸£å…‰å¾©é„‰" {% if not has_dep_custom and driver.departure == 'èŠ±è“®ç¸£å…‰å¾©é„‰' %}selected{% endif %}>èŠ±è“®ç¸£å…‰å¾©é„‰</option>
      <option value="èŠ±è“®ç¸£å…‰å¾©è»Šç«™ä»¥å¤–ç«è»Šç«™" {% if not has_dep_custom and driver.departure == 'èŠ±è“®ç¸£å…‰å¾©è»Šç«™ä»¥å¤–ç«è»Šç«™' %}selected{% endif %}>èŠ±è“®ç¸£å…‰å¾©è»Šç«™ä»¥å¤–ç«è»Šç«™</option>
      <option value="èŠ±è“®ç¸£å…‰å¾©è»Šç«™" {% if not has_dep_custom and driver.departure == 'èŠ±è“®ç¸£å…‰å¾©è»Šç«™' %}selected{% endif %}>èŠ±è“®ç¸£å…‰å¾©è»Šç«™</option>
      <option value="å…‰å¾©é„‰ç³–å» " {% if not has_dep_custom and driver.departure == 'å…‰å¾©é„‰ç³–å» ' %}selected{% endif %}>å…‰å¾©é„‰ç³–å» </option>
      <option value="éœ€æ¸…æ·¤åœ°å€" {% if not has_dep_custom and driver.departure == 'éœ€æ¸…æ·¤åœ°å€' %}selected{% endif %}>éœ€æ¸…æ·¤åœ°å€</option>
      <option value="å°åŒ—å¸‚" {% if not has_dep_custom and driver.departure == 'å°åŒ—å¸‚' %}selected{% endif %}>å°åŒ—å¸‚</option>
      <option value="æ–°åŒ—å¸‚" {% if not has_dep_custom and driver.departure == 'æ–°åŒ—å¸‚' %}selected{% endif %}>æ–°åŒ—å¸‚</option>
      <option value="åŸºéš†å¸‚" {% if not has_dep_custom and driver.departure == 'åŸºéš†å¸‚' %}selected{% endif %}>åŸºéš†å¸‚</option>
      <option value="æ¡ƒåœ’å¸‚" {% if not has_dep_custom and driver.departure == 'æ¡ƒåœ’å¸‚' %}selected{% endif %}>æ¡ƒåœ’å¸‚</option>
      <option value="æ–°ç«¹å¸‚" {% if not has_dep_custom and driver.departure == 'æ–°ç«¹å¸‚' %}selected{% endif %}>æ–°ç«¹å¸‚</option>
      <option value="æ–°ç«¹ç¸£" {% if not has_dep_custom and driver.departure == 'æ–°ç«¹ç¸£' %}selected{% endif %}>æ–°ç«¹ç¸£</option>
      <option value="è‹—æ —ç¸£" {% if not has_dep_custom and driver.departure == 'è‹—æ —ç¸£' %}selected{% endif %}>è‹—æ —ç¸£</option>
      <option value="å°ä¸­å¸‚" {% if not has_dep_custom and driver.departure == 'å°ä¸­å¸‚' %}selected{% endif %}>å°ä¸­å¸‚</option>
      <option value="å½°åŒ–ç¸£" {% if not has_dep_custom and driver.departure == 'å½°åŒ–ç¸£' %}selected{% endif %}>å½°åŒ–ç¸£</option>
      <option value="å—æŠ•ç¸£" {% if not has_dep_custom and driver.departure == 'å—æŠ•ç¸£' %}selected{% endif %}>å—æŠ•ç¸£</option>
      <option value="é›²æ—ç¸£" {% if not has_dep_custom and driver.departure == 'é›²æ—ç¸£' %}selected{% endif %}>é›²æ—ç¸£</option>
      <option value="å˜‰ç¾©å¸‚" {% if not has_dep_custom and driver.departure == 'å˜‰ç¾©å¸‚' %}selected{% endif %}>å˜‰ç¾©å¸‚</option>
      <option value="å˜‰ç¾©ç¸£" {% if not has_dep_custom and driver.departure == 'å˜‰ç¾©ç¸£' %}selected{% endif %}>å˜‰ç¾©ç¸£</option>
      <option value="å°å—å¸‚" {% if not has_dep_custom and driver.departure == 'å°å—å¸‚' %}selected{% endif %}>å°å—å¸‚</option>
      <option value="é«˜é›„å¸‚" {% if not has_dep_custom and driver.departure == 'é«˜é›„å¸‚' %}selected{% endif %}>é«˜é›„å¸‚</option>
      <option value="å±æ±ç¸£" {% if not has_dep_custom and driver.departure == 'å±æ±ç¸£' %}selected{% endif %}>å±æ±ç¸£</option>
      <option value="å®œè˜­ç¸£" {% if not has_dep_custom and driver.departure == 'å®œè˜­ç¸£' %}selected{% endif %}>å®œè˜­ç¸£</option>
      <option value="èŠ±è“®ç¸£" {% if not has_dep_custom and driver.departure == 'èŠ±è“®ç¸£' %}selected{% endif %}>èŠ±è“®ç¸£</option>
      <option value="å°æ±ç¸£" {% if not has_dep_custom and driver.departure == 'å°æ±ç¸£' %}selected{% endif %}>å°æ±ç¸£</option>
      <option value="æ¾æ¹–ç¸£" {% if not has_dep_custom and driver.departure == 'æ¾æ¹–ç¸£' %}selected{% endif %}>æ¾æ¹–ç¸£</option>
      <option value="é‡‘é–€ç¸£" {% if not has_dep_custom and driver.departure == 'é‡‘é–€ç¸£' %}selected{% endif %}>é‡‘é–€ç¸£</option>
      <option value="é€£æ±Ÿç¸£" {% if not has_dep_custom and driver.departure == 'é€£æ±Ÿç¸£' %}selected{% endif %}>é€£æ±Ÿç¸£</option>
    </select>
    <input type="text"
           id="customDeparture"
           name="departure_custom"
           value="{{ driver.departure_custom|default:'' }}"
           style="display:{% if has_dep_custom %}block{% else %}none{% endif %};"
           placeholder="è¼¸å…¥è‡ªè¨‚å‡ºç™¼åœ°" />
    {% endwith %}

    <!-- ç›®çš„åœ°ï¼ˆä¸‹æ‹‰ + è‡ªå¡«ï¼‰ -->
    {% with has_des_custom=driver.destination_custom %}
    <label>ç›®çš„åœ°</label>
    <select name="destination" id="destination" onchange="checkCustomDestination(this)">
      <option value="" {% if not driver.destination and not has_des_custom %}selected{% endif %}>è«‹é¸æ“‡ç¸£å¸‚</option>
      <option value="è‡ªå¡«" {% if has_des_custom %}selected{% endif %}>å…¶ä»–</option>
      <option value="èŠ±è“®ç¸£å…‰å¾©é„‰" {% if not has_des_custom and driver.destination == 'èŠ±è“®ç¸£å…‰å¾©é„‰' %}selected{% endif %}>èŠ±è“®ç¸£å…‰å¾©é„‰</option>
      <option value="èŠ±è“®ç¸£å…‰å¾©è»Šç«™ä»¥å¤–ç«è»Šç«™" {% if not has_des_custom and driver.destination == 'èŠ±è“®ç¸£å…‰å¾©è»Šç«™ä»¥å¤–ç«è»Šç«™' %}selected{% endif %}>èŠ±è“®ç¸£å…‰å¾©è»Šç«™ä»¥å¤–ç«è»Šç«™</option>
      <option value="èŠ±è“®ç¸£å…‰å¾©è»Šç«™" {% if not has_des_custom and driver.destination == 'èŠ±è“®ç¸£å…‰å¾©è»Šç«™' %}selected{% endif %}>èŠ±è“®ç¸£å…‰å¾©è»Šç«™</option>
      <option value="å…‰å¾©é„‰ç³–å» " {% if not has_des_custom and driver.destination == 'å…‰å¾©é„‰ç³–å» ' %}selected{% endif %}>å…‰å¾©é„‰ç³–å» </option>
      <option value="éœ€æ¸…æ·¤åœ°å€" {% if not has_des_custom and driver.destination == 'éœ€æ¸…æ·¤åœ°å€' %}selected{% endif %}>éœ€æ¸…æ·¤åœ°å€</option>
      <option value="å°åŒ—å¸‚" {% if not has_des_custom and driver.destination == 'å°åŒ—å¸‚' %}selected{% endif %}>å°åŒ—å¸‚</option>
      <option value="æ–°åŒ—å¸‚"  {% if not has_des_custom and driver.destination == 'æ–°åŒ—å¸‚' %}selected{% endif %}>æ–°åŒ—å¸‚</option>
      <option value="åŸºéš†å¸‚"  {% if not has_des_custom and driver.destination == 'åŸºéš†å¸‚' %}selected{% endif %}>åŸºéš†å¸‚</option>
      <option value="æ¡ƒåœ’å¸‚"  {% if not has_des_custom and driver.destination == 'æ¡ƒåœ’å¸‚' %}selected{% endif %}>æ¡ƒåœ’å¸‚</option>
      <option value="æ–°ç«¹å¸‚"  {% if not has_des_custom and driver.destination == 'æ–°ç«¹å¸‚' %}selected{% endif %}>æ–°ç«¹å¸‚</option>
      <option value="æ–°ç«¹ç¸£"  {% if not has_des_custom and driver.destination == 'æ–°ç«¹ç¸£' %}selected{% endif %}>æ–°ç«¹ç¸£</option>
      <option value="è‹—æ —ç¸£"  {% if not has_des_custom and driver.destination == 'è‹—æ —ç¸£' %}selected{% endif %}>è‹—æ —ç¸£</option>
      <option value="å°ä¸­å¸‚"  {% if not has_des_custom and driver.destination == 'å°ä¸­å¸‚' %}selected{% endif %}>å°ä¸­å¸‚</option>
      <option value="å½°åŒ–ç¸£"  {% if not has_des_custom and driver.destination == 'å½°åŒ–ç¸£' %}selected{% endif %}>å½°åŒ–ç¸£</option>
      <option value="å—æŠ•ç¸£"  {% if not has_des_custom and driver.destination == 'å—æŠ•ç¸£' %}selected{% endif %}>å—æŠ•ç¸£</option>
      <option value="é›²æ—ç¸£"  {% if not has_des_custom and driver.destination == 'é›²æ—ç¸£' %}selected{% endif %}>é›²æ—ç¸£</option>
      <option value="å˜‰ç¾©å¸‚"  {% if not has_des_custom and driver.destination == 'å˜‰ç¾©å¸‚' %}selected{% endif %}>å˜‰ç¾©å¸‚</option>
      <option value="å˜‰ç¾©ç¸£"  {% if not has_des_custom and driver.destination == 'å˜‰ç¾©ç¸£' %}selected{% endif %}>å˜‰ç¾©ç¸£</option>
      <option value="å°å—å¸‚"  {% if not has_des_custom and driver.destination == 'å°å—å¸‚' %}selected{% endif %}>å°å—å¸‚</option>
      <option value="é«˜é›„å¸‚"  {% if not has_des_custom and driver.destination == 'é«˜é›„å¸‚' %}selected{% endif %}>é«˜é›„å¸‚</option>
      <option value="å±æ±ç¸£"  {% if not has_des_custom and driver.destination == 'å±æ±ç¸£' %}selected{% endif %}>å±æ±ç¸£</option>
      <option value="å®œè˜­ç¸£"  {% if not has_des_custom and driver.destination == 'å®œè˜­ç¸£' %}selected{% endif %}>å®œè˜­ç¸£</option>
      <option value="èŠ±è“®ç¸£"  {% if not has_des_custom and driver.destination == 'èŠ±è“®ç¸£' %}selected{% endif %}>èŠ±è“®ç¸£</option>
      <option value="å°æ±ç¸£"  {% if not has_des_custom and driver.destination == 'å°æ±ç¸£' %}selected{% endif %}>å°æ±ç¸£</option>
      <option value="æ¾æ¹–ç¸£"  {% if not has_des_custom and driver.destination == 'æ¾æ¹–ç¸£' %}selected{% endif %}>æ¾æ¹–ç¸£</option>
      <option value="é‡‘é–€ç¸£"  {% if not has_des_custom and driver.destination == 'é‡‘é–€ç¸£' %}selected{% endif %}>é‡‘é–€ç¸£</option>
      <option value="é€£æ±Ÿç¸£"  {% if not has_des_custom and driver.destination == 'é€£æ±Ÿç¸£' %}selected{% endif %}>é€£æ±Ÿç¸£</option>
    </select>
    <input type="text"
           id="customDestination"
           name="destination_custom"
           value="{{ driver.destination_custom|default:'' }}"
           style="display:{% if has_des_custom %}block{% else %}none{% endif %};"
           placeholder="è¼¸å…¥è‡ªè¨‚ç›®çš„åœ°" />
    {% endwith %}

    <label>é…Œæ”¶è²»ç”¨ï¼ˆé¸å¡«ï¼‰</label>
    <input type="text" name="fare_note" value="{{ driver.fare_note|default_if_none:'' }}" placeholder="ä¾‹å¦‚ï¼šæ¯äºº 200ã€æ²¹éŒ¢å‡æ”¤ã€è¦–é‡Œç¨‹è€Œå®šâ€¦" />

    <label class="required">å‡ºç™¼æ—¥æœŸ</label>
    <input type="date" name="date" id="driver-date" value="{{ driver.date|date:'Y-m-d' }}" required />

    <label>å›ç¨‹æ—¥æœŸï¼ˆé¸å¡«ï¼‰</label>
    <input type="date" name="return_date" id="driver-return" value="{{ driver.return_date|date:'Y-m-d' }}" />

    <label>é †è·¯æ¥é€æ„é¡˜</label>
    <select name="flexible_pickup">
      <option value="YES" {% if driver.flexible_pickup == 'YES' %}selected{% endif %}>é †è·¯å¯è¼‰</option>
      <option value="NO"  {% if driver.flexible_pickup == 'NO'  %}selected{% endif %}>ä¸é †è·¯ä¹ŸOK</option>
      <option value="MAYBE" {% if driver.flexible_pickup == 'MAYBE' %}selected{% endif %}>è¦–æƒ…æ³</option>
    </select>

    <div class="switch" id="active-switch">
      <input type="checkbox" name="is_active" id="is_active" {% if driver.is_active %}checked{% endif %} />
      <span class="toggle"></span>
      <label for="is_active">æ˜¯å¦é–‹æ”¾ï¼ˆåº§ä½æ»¿æœƒè‡ªå‹•é—œé–‰ï¼‰</label>
    </div>

    <label>å‚™è¨»</label>
    <textarea id="driverNote" name="note" row="3" placeholder="å‚™è¨»(é¸å¡«)">{{ driver.note|default_if_none:'' }}</textarea>

    <button class="btn" type="submit">ğŸ’¾ å„²å­˜</button>

    <div style="max-width:600px;margin:0 auto 8px;">
      <a href="{% url 'find_index' %}" class="btn-ghost" style="display:inline-block;text-decoration:none;text-align:center;width:96%;padding:12px;margin-top:10px;border-radius:10px;font-weight:700;">
        ğŸ  å›é¦–é 
      </a>
    </div>
  </form>

  <!-- åˆªé™¤å¸æ©Ÿè¡¨å–®ï¼ˆä¿ç•™ CSRF èˆ‡ actionï¼‰ -->
<form id="deleteDriverForm"
      method="POST"
      action="{% url 'delete_driver' driver.id %}"
      style="max-width:600px;margin:14px auto 0;"
      onsubmit="return handleDeleteDriverSubmit(event)">
  {% csrf_token %}
  <button id="deleteDriverBtn" class="btn btn-danger" type="submit">ğŸ—‘ï¸ å–æ¶ˆå‡ºè»Š</button>
</form>

  <!-- ä¹˜å®¢æ¸…å–®ï¼ˆåŸæ¨£ï¼‰ -->
<!-- C) å·²ç™»è¨˜ä¹˜å®¢ï¼ˆå‡ç´šï¼šæ¥å— / æ‹’çµ• / å¸æ©Ÿå‚™å¿˜éŒ„ï¼‰ -->
<div class="panel" id="manage-panels">
  {% csrf_token %}
  {% include "Find/_manage_panels.html" %}
</div>

<div id="driver-meta" data-driver-id="{{ driver.id }}"></div>

</div>

  <script>
    const driverId = "{{ driver.id }}";
    const proto = location.protocol === "https:" ? "wss" : "ws";
    // å‡ºç™¼/ç›®çš„è‡ªå¡«é¡¯ç¤ºï¼ˆåŸæ¨£ï¼‰
    function checkCustomDeparture(select){
      const customInput = document.getElementById('customDeparture');
      if (!customInput) return;
      const show = (select.value === 'è‡ªå¡«');
      customInput.style.display = show ? 'block' : 'none';
      customInput.required = show;
      if (!show) customInput.value = '';
    }
    function checkCustomDestination(select){
      const input = document.getElementById('customDestination');
      if (!input) return;
      const show = (select.value === 'è‡ªå¡«');
      input.style.display = show ? 'block' : 'none';
      input.required = show;
      if (!show) input.value = '';
    }

    // æ—¥æœŸé˜²å‘†ï¼ˆåŸæ¨£ï¼‰
    document.addEventListener('DOMContentLoaded', () => {
      const dep = document.getElementById('driver-date');
      const ret = document.getElementById('driver-return');
      const today = new Date().toISOString().split('T')[0];
      if (!dep || !ret) return;
      function syncMin(){
        dep.min = today;
        ret.min = dep.value || today;
        if (ret.value && ret.value < ret.min) ret.value = '';
      }
      dep.addEventListener('change', syncMin);
      ret.addEventListener('change', syncMin);
      syncMin();
    });

    // åˆå§‹åŒ–ã€Œè‡ªå¡«ã€å±•é–‹
    (function(){
      const depSel = document.getElementById('departure');
      const desSel = document.getElementById('destination');
      if (depSel) checkCustomDeparture(depSel);
      if (desSel) checkCustomDestination(desSel);
    })();

    function getCsrfToken() {
    // å¾è¡¨å–® hidden input æ‹¿ CSRF
    const tokenInput = document.querySelector('#deleteDriverForm input[name=csrfmiddlewaretoken]');
    return tokenInput ? tokenInput.value : '';
  }

    // âœ… éš±ç§é–‹é—œï¼šéœ€è¦ Email æ‰èƒ½å•Ÿç”¨
(function () {
  const wrap   = document.getElementById('privacy-switch');
  const email  = document.getElementById('email');           // å¸æ©Ÿçš„ Email æ¬„
  const cb     = document.getElementById('hide_contact');    // å¸æ©Ÿçš„éš±ç§ checkbox
  const knob   = wrap?.querySelector('.toggle');
  const hintEl = document.getElementById('privacyHint');
  if (!wrap || !email || !cb) return;

  function syncDriverPrivacy () {
    const hasEmail = !!email.value.trim();

    // æ²’ Email â†’ ä¸€å¾‹ä¸Šé–ä¸”å¼·åˆ¶é—œé–‰
    if (!hasEmail) {
      cb.checked  = false;          // åªæœ‰æ²’ Email æ™‚æ‰å¼·åˆ¶æ”¹ç‚ºé—œé–‰
      cb.disabled = true;
      knob?.classList.add('is-disabled');
      if (hintEl) { hintEl.textContent = 'å°šæœªå¡«å¯« Emailï¼Œç„¡æ³•éš±è—è¯çµ¡æ–¹å¼ã€‚'; hintEl.style.color = '#9a6b00'; }
      return;
    }

    // æœ‰ Email â†’ åªè§£é–ï¼Œä¸æ”¹è®Šä½¿ç”¨è€…å‹¾é¸çµæœ
    cb.disabled = false;            // è®“ä½¿ç”¨è€…è‡ªå·±æ±ºå®šå‹¾/ä¸å‹¾
    knob?.classList.remove('is-disabled');
    if (hintEl) { hintEl.textContent = 'éœ€å¡«å¯« Email æ‰èƒ½éš±è—ï¼›Email åƒ…ä¾›ç³»çµ±é€šçŸ¥ï¼Œä¸æœƒå…¬é–‹ã€‚'; hintEl.style.color = '#6b7280'; }
  }

  // è®“é»æ“Šæ»‘æ¡¿ä¹Ÿèƒ½åˆ‡æ›ï¼ˆè¢«é–å®šæ™‚ä¸å‹•ï¼‰
  knob?.addEventListener('click', () => {
    if (cb.disabled) return;
    cb.checked = !cb.checked;
  });

  // Email è®Šå‹•æ™‚é‡æ–°åŒæ­¥ï¼›åˆå§‹åŒ–è·‘ä¸€æ¬¡ï¼ˆä¿ç•™ä¼ºæœå™¨åˆå§‹ checkedï¼‰
  email.addEventListener('input', syncDriverPrivacy);
  syncDriverPrivacy();

  // å¦‚æœä½ æœ‰å¾å¾Œç«¯ AJAX å›å¡«å¸æ©Ÿè³‡æ–™ï¼Œå¯åœ¨å›å¡«å¾Œå‘¼å«é€™å€‹
  window.syncDriverPrivacy = syncDriverPrivacy;
})();

    // æ˜¯å¦é–‹æ”¾ switch é–å®šï¼ˆä½ åŸæœ¬çš„è…³æœ¬ä¿ç•™ï¼‰
    (function () {
  const wrap    = document.getElementById('active-switch');
  if (!wrap) return;
  const elActive= document.getElementById('is_active');
  const elToggle= wrap.querySelector('.toggle');
  const elLabel = wrap.querySelector('label');

  // å»ºç«‹æç¤ºï¼šæ’åœ¨ã€Œæ˜¯å¦é–‹æ”¾ã€é€™çµ„é–‹é—œä¸‹é¢
  let hint = wrap.querySelector('#active-hint');
  if (!hint) {
    hint = document.createElement('span');
    hint.id = 'active-hint';
    hint.className = 'hint';
    elLabel.insertAdjacentElement('afterend', hint);
  }

  // å–å¾— filledï¼ˆèˆ‡ä½ åŸæœ¬ä¸€è‡´ï¼‰
  function getFilled() {
    const h = document.getElementById('seats_filled_val');
    if (h && h.value !== undefined) {
      const n = parseInt(h.value, 10);
      return Number.isFinite(n) ? n : 0;
    }
    const meta = document.getElementById('driver-meta');
    if (meta?.dataset?.seatsFilled !== undefined) {
      const n = parseInt(meta.dataset.seatsFilled, 10);
      return Number.isFinite(n) ? n : 0;
    }
    return 0;
  }

  const elTotal = document.getElementById('seats_total');

  function setHint(text, tone){
    hint.textContent = text || '';
    hint.style.color = (tone === 'warn') ? '#9a6b00'
                    : (tone === 'ok')   ? '#206b3a'
                    : '#6b7280';
  }

  function refreshLock() {
    const filled = getFilled();
    const total  = parseInt(elTotal && elTotal.value, 10);
    const totalSafe = Number.isFinite(total) ? Math.max(1, total) : 1;

    if (filled >= totalSafe) {
      elActive.checked = false;
      elActive.disabled = true;
      elToggle.classList.add('is-disabled');
      setHint(`åº§ä½å·²æ»¿ï¼ˆ${filled}/${totalSafe}ï¼‰ï¼Œå·²è‡ªå‹•é—œé–‰`, 'warn');
      elActive.title = 'åº§ä½å·²æ»¿æ™‚ä¸å¯é–‹æ”¾';
    } else {
      elActive.disabled = false;
      elToggle.classList.remove('is-disabled');
      elActive.title = '';
      setHint(elActive.checked ? 'ç›®å‰ç‹€æ…‹ï¼šå·²é–‹æ”¾' : 'ç›®å‰ç‹€æ…‹ï¼šæœªé–‹æ”¾', elActive.checked ? 'ok' : '');
    }
  }

      elToggle.addEventListener('click', () => {
        if (elActive.disabled) return;
        elActive.checked = !elActive.checked;
        refreshLock();
      });
      elActive.addEventListener('change', refreshLock);
      if (elTotal) {
        elTotal.addEventListener('input', refreshLock);
        elTotal.addEventListener('change', refreshLock);
      }
      refreshLock();
    })();
    
  </script>
<script>
(function(){
  const $  = (s, r=document)=>r.querySelector(s);
  const $$ = (s, r=document)=>Array.from(r.querySelectorAll(s));
  const pendingList  = $('#pending-list');
  const acceptedList = $('#accepted-list');

  function htmlToNode(html){
    const wrap = document.createElement('div');
    wrap.innerHTML = html.trim();
    return wrap.firstElementChild;
  }
  function getListByStatus(status){
    if (status === 'pending')  return pendingList;
    if (status === 'accepted') return acceptedList;
    return null;
  }
  function patchPaxItem(payload){
    if (!payload || !payload.pax_id) return;
    const id  = String(payload.pax_id);
    const old = document.querySelector(`.pax-item[data-pax="${CSS.escape(id)}"]`);

    if (payload.status === 'deleted'){
      if (old) old.remove();
      return;
    }
    const container = getListByStatus(payload.status);
    if (!container) return;

    const node = htmlToNode(payload.html);
    if (!node) return;

    if (old && old.parentElement === container){
      old.replaceWith(node);
    }else{
      if (old) old.remove();
      container.appendChild(node);
    }
  }
// å–å¾— CSRFï¼ˆæ²¿ç”¨ä½ ç¾æœ‰çš„ getCSRF() å³å¯ï¼‰
function getCSRF() {
  return (document.querySelector('[name=csrfmiddlewaretoken]')?.value) || '';
}
// å°å·¥å…·ï¼šæŠŠ /0/accept/ â†’ /{id}/accept/ï¼›/0/reject/ â†’ /{id}/reject/
function buildUrl(base, id, action) {
  const pat = action === 'accept' ? /\/0\/accept\/?$/ : /\/0\/reject\/?$/;
  return base.replace(pat, `/${id}/${action}/`);
}

document.addEventListener('click', async (e) => {
  // ==== æ¥å— ====
  const btnAccept = e.target.closest('button[data-action="accept"]');
  if (btnAccept) {
    e.preventDefault();
    const pid  = btnAccept.dataset.id;
    const base = btnAccept.dataset.urlBase; // ä¾‹å¦‚ /find/pax/0/accept/
    if (!pid || !base) return;
    const url  = buildUrl(base, pid, 'accept');

    try {
      const res = await fetch(url, {
        method: 'POST',
        headers: {
          'X-CSRFToken': getCSRF(),
          'X-Requested-With': 'XMLHttpRequest',
          'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8',
        },
        body: new URLSearchParams(),
        credentials: 'same-origin',
      });

      let data;
      try { data = await res.json(); }
      catch { data = { ok:false, error: await res.text() || `HTTP ${res.status}` }; }

      if (!res.ok || !data.ok) { alert(data.error || 'æ¥å—å¤±æ•—'); return; }
      // æˆåŠŸï¼šç­‰ WebSocket å»£æ’­è‡ªå‹•é‡ç¹ª
    } catch (err) {
      console.error(err); alert('ç¶²è·¯éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦');
    }
  }

  // ==== æ‹’çµ• ====
  const btnReject = e.target.closest('button[data-action="reject"]');
  if (btnReject) {
    e.preventDefault();
    const pid  = btnReject.dataset.id;
    const base = btnReject.dataset.urlBase; // ä¾‹å¦‚ /find/pax/0/reject/
    if (!pid || !base) return;
    const url  = buildUrl(base, pid, 'reject');

    try {
      const res = await fetch(url, {
        method: 'POST',
        headers: {
          'X-CSRFToken': getCSRF(),
          'X-Requested-With': 'XMLHttpRequest',
          'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8',
        },
        body: new URLSearchParams(),
        credentials: 'same-origin',
      });

      let data;
      try { data = await res.json(); }
      catch { data = { ok:false, error: await res.text() || `HTTP ${res.status}` }; }

      if (!res.ok || !data.ok) { alert(data.error || 'æ“ä½œå¤±æ•—'); return; }
      // æˆåŠŸï¼šç­‰ WebSocket å»£æ’­è‡ªå‹•é‡ç¹ª
    } catch (err) {
      console.error(err); alert('ç¶²è·¯éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦');
    }
  }
});


  // å¸æ©Ÿå‚™å¿˜éŒ„ï¼ˆprompt ç‰ˆæœ¬ï¼‰
document.addEventListener('click', async (e) => {
    const btn = e.target.closest('button[data-action="memo"]');
    if (!btn) return;

    const paxId   = btn.dataset.id;
    const urlBase = btn.dataset.urlBase; // ä¾‹å¦‚ /find/pax/0/memo/
    const cur     = btn.dataset.current || "";
    if (!paxId || !urlBase) return;
    const url     = urlBase.replace(/\/0\/memo\/?$/, `/${paxId}/memo/`);

    const memo = prompt('å¸æ©Ÿå‚™å¿˜éŒ„ï¼ˆåƒ…å¸æ©Ÿå¯è¦‹ï¼‰', cur);
    if (memo === null) return;

    try{
      const csrf = document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
      const fd   = new FormData(); fd.append('memo', memo);
      const res  = await fetch(url, { method:'POST', headers:{'X-CSRFToken': csrf}, body: fd });
      const data = await res.json();
      if (!data.ok) throw new Error(data.error||'æ›´æ–°å¤±æ•—');

      patchPaxItem(data); // ç›´æ¥ç”¨å¾Œç«¯å›ä¾†çš„æ–° li æ›¿æ›
      alert('å·²æ›´æ–°å¸æ©Ÿå‚™å¿˜éŒ„');
    }catch(err){
      console.error(err); alert('æ›´æ–°å¤±æ•—');
    }
  });

  // WebSocketï¼šåˆ¥è™•ä¿®æ”¹ï¼ˆå¦‚å…¬é–‹åˆ—è¡¨ç·¨è¼¯ï¼‰æ™‚å³æ™‚åŒæ­¥
  try{
    const driverId = $('#driver-meta')?.dataset?.driverId || '{{ driver.id }}';
    const proto = location.protocol === 'https:' ? 'wss' : 'ws';
    ws.onmessage = (evt) => {
      try{
        const data = JSON.parse(evt.data);
        if (data && data.ok) patchPaxItem(data);
      }catch(_e){}
    };
  }catch(_e){}
})();

(function initManageWS(){
  const meta = document.getElementById('driver-meta');
  if (!meta) return;
  const driverId = meta.dataset.driverId;
  if (!driverId) return;

  // âœ… ç”¨ driver/<id> é€™æ¢è·¯ï¼Œæˆ– manage/<id> éƒ½å¯ï¼ˆå› ç‚ºè·¯ç”±éƒ½åŠ äº†ï¼‰
  const proto = (location.protocol === 'https:') ? 'wss://' : 'ws://';
  const host  = location.host;
  const wsUrl = `${proto}${host}/ws/find/driver/${driverId}/`;   // â†â† å»ºè­°ç”¨é€™æ¢

  // é¿å…é‡è¤‡å»ºç«‹å¤šæ¢é€£ç·š
  if (window.__manageWS && window.__manageWS.readyState === 1) {
    try { window.__manageWS.close(); } catch (_) {}
  }

  const ws = new WebSocket(wsUrl);
  window.__manageWS = ws;

  ws.onopen = () => console.log('[manageWS] connected:', wsUrl);
  ws.onclose = (e) => console.log('[manageWS] closed', e.code, e.reason);
  ws.onerror = (e) => console.error('[manageWS] error', e);

  // å¾Œç«¯å»£æ’­ manage_panels çš„ payloadï¼Œè¦åœ¨é€™è£¡æ›´æ–°ç•«é¢
  ws.onmessage = (ev) => {
    try {
      const msg = JSON.parse(ev.data);
      if (msg.type === 'manage_panels' && typeof msg.html === 'string') {
        const box = document.getElementById('manage-panels');
        if (box) box.innerHTML = msg.html;
      }
      // å¦‚æœä½ æœ‰åˆ†å–®å¼µå¡ç‰‡æ›´æ–°ï¼š
      if (msg.type === 'replace_pax_item' && msg.pax_id && typeof msg.html === 'string') {
        const li = document.querySelector(`.pax-item[data-pax="${msg.pax_id}"]`);
        if (li) li.outerHTML = msg.html;
      }
    } catch (err) {
      console.error('ws message parse error', err, ev.data);
    }
  };
})();
</script>
<script>
async function handleDeleteDriverSubmit(e){
  e.preventDefault();
  if (!confirm('âš ï¸ ç¢ºå®šè¦å–æ¶ˆå‡ºè»Šå—ï¼Ÿç›¸é—œä¹˜å®¢ä¹Ÿæœƒè¢«è§£é™¤é—œè¯ï¼')) return false;

  const btn  = document.getElementById('deleteDriverBtn');
  const form = document.getElementById('deleteDriverForm');
  const url  = form.action;
  const csrf = form.querySelector('input[name=csrfmiddlewaretoken]')?.value || '';

  btn.disabled = true; btn.textContent = 'è™•ç†ä¸­â€¦';

  try {
    const resp = await fetch(url, {
      method: 'POST',
      headers: {
        'X-CSRFToken': csrf,
        'X-Requested-With': 'XMLHttpRequest'
      }
    });
    const data = await resp.json();

    if (!resp.ok || !data.ok) {
      alert(data.error || 'åˆªé™¤å¤±æ•—'); 
      btn.disabled = false; btn.textContent = 'ğŸ—‘ï¸ å–æ¶ˆå‡ºè»Š';
      return false;
    }

    // âœ… æˆåŠŸï¼šé€™é æ²’æœ‰ onmessageï¼Œå°±æ‰‹å‹•è·³å›åˆ—è¡¨ï¼ˆæˆ–æ”¹æˆ location.reload()ï¼‰
    window.location.href = "{% url 'find_index' %}";
    return true;
  } catch (err) {
    console.error(err);
    alert('ç¶²è·¯éŒ¯èª¤');
    btn.disabled = false; btn.textContent = 'ğŸ—‘ï¸ å–æ¶ˆå‡ºè»Š';
    return false;
  }
}
</script>
<script>
(function () {
  const wsScheme = location.protocol === 'https:' ? 'wss' : 'ws';
  const wsUrl    = `${wsScheme}://${location.host}/ws/find/`; // â† è·¯ç”±è¦‹ç¬¬2æ­¥
  let socket;

  function connect() {
    socket = new WebSocket(wsUrl);
    socket.onopen  = () => console.log('[WS] connected');
    socket.onclose = () => setTimeout(connect, 2000);
    socket.onerror = (e) => { console.error('[WS] error', e); socket.close(); };

    socket.onmessage = (e) => {
      let msg; try { msg = JSON.parse(e.data); } catch { return; }

      if (msg.type === "send.update") {
        const dList = document.getElementById("driver-list");
        const pList = document.getElementById("passenger-list");
        if (msg.drivers_html && dList)    dList.innerHTML    = msg.drivers_html;
        if (msg.passengers_html && pList) pList.innerHTML = msg.passengers_html;
        return;
      }

      if (msg.type === "send.partial") {
        if (msg.payload && msg.payload.type === "driver_partial") {
          upsertDriverCard(msg.payload.driver_id, msg.payload.driver_html, msg.payload.active !== false);
          return;
        }
        if (msg.driver_id && msg.html) {
          upsertDriverCard(msg.driver_id, msg.html, true);
          return;
        }
      }

      if (msg.type === "manage.panels" && msg.html) {
        const el = document.getElementById("managePanels");
        if (el) el.innerHTML = msg.html;
      }
    };
  }
  connect();

  function upsertDriverCard(driverId, html, active = true) {
    const list = document.getElementById("driver-list");
    if (!list) return;
    const existing = list.querySelector(`[data-driver-id="${driverId}"]`);

    if (active === false) { if (existing) existing.remove(); return; }

    const tmp = document.createElement('div');
    tmp.innerHTML = (html || '').trim();
    const node = tmp.firstElementChild;
    if (!node) return;

    if (existing) existing.replaceWith(node);
    else list.prepend(node);
  }
})();
</script>



</body>
</html>

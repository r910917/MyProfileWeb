<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>🌐 花蓮光復救災交通媒合</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script defer src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <!-- <link
  href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
  rel="stylesheet"
  integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
  crossorigin="anonymous"
/> -->
<!-- <script
  src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
  integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
  crossorigin="anonymous"
></script> -->
<style>
/* ==========================================================================
   全站基礎：字體、背景、主標題/小標題
   ========================================================================== */
body{
  font-family:"Microsoft JhengHei",sans-serif;
  margin:0; padding:0;
  background:linear-gradient(to right,#eaf8ff,#f7fff7);
  color:#222;
}
h1{ text-align:center; padding:20px; color:#005c4b; }
h2{ color:#00695c; margin:20px; font-size:20px; }

/* ==========================================================================
   首頁3顆主功能按鈕
   ========================================================================== */
/* 主操作區：桌機置中、手機三欄一列 */
.hero-actions{
  display:flex;
  gap:14px;
  align-items:center;
  justify-content:center;
  margin:10px 0 18px;
}

/* 共用主按鈕外觀（你原本 btn-main 可沿用；這裡補些細節） */
.btn-main{
  display:inline-flex; align-items:center; justify-content:center;
  gap:.5rem; padding:12px 22px; border-radius:999px;
  font-weight:800; letter-spacing:.5px; border:1px solid transparent;
  box-shadow:0 6px 24px rgba(0,0,0,.08); cursor:pointer;
  transition:transform .08s ease, box-shadow .2s ease, background .2s ease, border-color .2s ease;
}
.btn-main .ico{ font-size:1.05rem; line-height:1; }

/* 三種色系 */
.btn-driver   { background:#0b74ff; color:#fff; }
.btn-driver:hover{ background:#0a61d6; transform:translateY(-1px); }

.btn-passenger{ background:#e53545; color:#fff; }
.btn-passenger:hover{ background:#c92f3e; transform:translateY(-1px); }

/* 說明＝幽靈膠囊按鈕（亮色描邊 + 玻璃感） */
.btn-ghost{
  background:rgba(255,255,255,.75);
  color:#334155;
  border-color:#d9e1ec;
  backdrop-filter:saturate(180%) blur(6px);
}
.btn-ghost:hover{
  background:#f2f6fb;
  border-color:#c7d3e4;
  color:#0f172a;
  transform:translateY(-1px);
}
.btn-ghost:focus-visible{
  outline:none;
  box-shadow:0 0 0 3px rgba(59,130,246,.25);
}

/* 手機：三欄一列、滿版按鈕 */
@media (max-width:640px){
  .hero-actions{
    display:grid;
    grid-template-columns:repeat(3,1fr);  /* 三欄一列 */
    gap:10px;
    padding:0 10px;
  }
  .btn-main{ width:100%; padding:12px 10px; font-size:15px; }
  .btn-main .ico{ font-size:1rem; }
}

/* =============== 說明按鈕（和你現有藍色系一致） =============== */
/* 說明區縮排（徽章左、文字右；換行自動對齊） */
.intro-list { margin: 0; padding-left: 0; }
.intro-row {
  display: grid;
  grid-template-columns: auto 1fr; /* 徽章固定寬、文字佔滿 */
  column-gap: .5rem;
  row-gap: .25rem;
  align-items: start;
  margin-bottom: .5rem;            /* 每條之間間距 */
}
.intro-row .badge {
  white-space: nowrap;             /* 徽章不換行 */
  font-weight: 600;
}
.intro-row span:last-child {
  line-height: 1.7;                /* 文字行距舒適 */
}

/* ==========================================================================
   卡片（Driver/Passenger 列表）＋ 左側色條
   ========================================================================== */
/* 更貼左、較薄的卡片 */
.card{
  display:flex;
  align-items:left;
  justify-content:space-between;
  background:#fff;
  margin:3px;                 /* 取消奇怪的負邊距，左右不縮進 */
  padding:8px 12px 8px 24px;    /* 上下變薄、左邊多一點空間給色條 */
  border-radius:8px;            /* 比 1px 好看許多 */
  box-shadow:0 2px 6px rgba(0,0,0,.08);
  position:relative;
  flex-wrap:wrap;
  animation:fadeInUp .3s ease-out;
}

/* 讓色條微微突出到卡片外，視覺上更靠左，但不需要負邊距 */
.card::before{
  content:"";
  position:absolute;
  top:0;
  bottom:0;       /* 等同於 height:100% + 更穩定 */
  left:10px;      /* 向左突出 8px，達到「貼左」效果 */
  width:6px;
  border-radius:6px 0 0 6px;
}

.driver-card::before{ background:#2196f3; }
.passenger-card::before{ background:#f44336; }

/* 1) 取消 UL 預設縮排：卡片不要被推到右側 */
#driver-list,
#passenger-list {
  list-style: none;
  margin: 0;
  padding: 0;        /* ← 這行是重點 */
}

/* 如果有其它容器對 ul/li 做了 padding-left，也一併歸零 */
#driver-list > li,
#passenger-list > li {
  margin-left: 0;
}

/* ==========================================================================
   司機卡片三欄排版（左：暱稱座位 / 中：三行 / 右：操作與箭頭）
   ========================================================================== */
.driver-grid{
  display:grid; grid-template-columns:minmax(140px,200px) 1fr auto;
  column-gap:10px; align-items:center; width:100%;
}
/* 左欄：暱稱 - 座位 */
.col-left{ display:flex; align-items:center; justify-content:flex-start; height:100%; font-size:15px; }
.name-seat{ font-size:15px; color:#222; margin:0; }
/* 中欄：三行資訊 */
.col-middle .line{ display:block; margin:2px 0; }
.col-middle .line1{ font-size:16px; color:#222; }
.col-middle .line2, .col-middle .line3{ font-size:14px; color:#444; }
/* 右欄：操作按鈕＋箭頭 */
.col-actions{ display:flex; align-items:center; justify-content:flex-end; gap:6px; }

/* 展開區塊鋪滿整列 */
.details{ grid-column:1 / -1; }

/* ==========================================================================
   展開/收合：箭頭旋轉、絲滑開合；管理/參加按鈕色系
   ========================================================================== */
.driver-card .arrow{
  cursor:pointer; margin-left:6px; min-width:36px; min-height:36px;
  font-size:16px; color:#333; background:transparent; border:0;
  transition:transform .25s ease;
}
.driver-card .arrow.open{ transform:rotate(90deg); }

.driver-card .details{
  margin-top:0px; max-height:0; overflow:hidden; padding:0px 0px;
  background: transparent; border:0 #e6e6e6;
  transition:max-height 1.2s ease, padding 1s ease;
}
/* 展開時再加回外觀 */
.driver-card .details.open {
  margin-top: 8px;
  max-height: 650px;
  padding: 10px;
  background: #f9f9f9;
  border-top: 1px solid #e6e6e6;
  border-radius: 6px;
}

.driver-card .btn-manage{ background:#007bff; color:#fff; border:0; border-radius:6px; padding:6px 10px; }
.driver-card .btn-manage:hover{ background:#0056b3; }
.driver-card .btn-join{ background:#28a745; color:#fff; border:0; border-radius:6px; padding:6px 10px; }
.driver-card .btn-join:hover{ background:#1e7e34; }

/* 手機上：展開面板本身可捲，兩個乘客清單也各自可捲 */
@media (max-width: 640px) {
  .driver-card .details.open {
    /* JS 會塞 max-height，這裡保一個保底值 */
    max-height: 72svh;
    overflow: auto;
    -webkit-overflow-scrolling: touch;
    margin-bottom: 12px;
    background: #fff;
    border-radius: 10px;
    box-shadow: 0 6px 16px rgba(0,0,0,.08);
  }
  .driver-card .pax-scroll {
    max-height: 28svh;         /* 每欄各自上限，避免撐破 */
    overflow: auto;
    -webkit-overflow-scrolling: touch;
  }
}

/* =============================================================================
   A. 乘客清單（待確認 / 已接受）卡片樣式
   ========================================================================== */

/* 清單容器（舊 two-col 保留，某些頁面可能仍在用） */
.pax-section{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:16px;
  align-items:start;
}
@media (max-width: 860px){
  .pax-section{ grid-template-columns: 1fr; }
}

.pax-list{ list-style:none; padding:0; margin:8px 0 0; }
.pax-item{
  box-sizing:border-box;
  background:#fff;
  border:1px solid #e5e7eb;
  border-radius:10px;
  padding:12px 14px;
  margin:8px 0;
}

/* 每筆：左文字（兩行） + 右按鈕 */
.pax-2col{
  display:grid;
  grid-template-columns: 1fr auto;
  column-gap: 12px;
  align-items:center;
}
.pax-left{ min-width:0; }
.pax-title{
  font-weight:700;
  font-size:15px;
  color:#111827;
  line-height:1.25;
}
.pax-sub{
  margin-top:2px;
  font-size:13px;
  color:#4b5563;
  line-height:1.3;
}
.pax-actions{ display:inline-flex; gap:8px; white-space:nowrap; }

.btn-mini{
  border:0; border-radius:8px; padding:6px 10px; background:#e5e7eb; cursor:pointer;
}
.btn-mini:hover{ background:#d1d5db; }
.btn-mini.danger{ background:#fecaca; color:#7f1d1d; }
.btn-mini.danger:hover{ background:#fca5a5; }

/* 已接受：綠色底提示 */
.pax-item.pax-accepted{ background:#f0fdf4; border:1px solid #bbf7d0; }
.pax-item.pax-accepted .pax-title .check{
  display:inline-block; margin-right:6px; color:#16a34a; font-weight:800;
}
.pax-item.pax-accepted .btn-mini{ background:#e7f5ec; }
.pax-item.pax-accepted .btn-mini:hover{ background:#d9f0e4; }

/* 手機按鈕落到下方 */
@media (max-width: 640px){
  .pax-2col{ grid-template-columns:1fr; row-gap:8px; align-items:start; }
  .pax-actions{ justify-content:flex-start; }
}

/* 自訂卷軸（淡淡的） */
.pax-scroll::-webkit-scrollbar,
.pending-scroll::-webkit-scrollbar{ width:8px; }
.pax-scroll::-webkit-scrollbar-thumb,
.pending-scroll::-webkit-scrollbar-thumb{ background:#d5d9e0; border-radius:6px; }
.pax-scroll::-webkit-scrollbar-track,
.pending-scroll::-webkit-scrollbar-track{ background:transparent; }


/* =============================================================================
   B. 詳細區塊：三欄（桌機）= 左：司機資訊 / 中：待確認 / 右：已接受
   ========================================================================== */

/* 你的 details 開闔動畫（保留） */
.details{
  margin-top:8px; max-height:0; overflow:hidden; padding:8px 10px;
  background:#f9f9f9; border-top:1px solid #e6e6e6; border-radius:6px;
  transition:max-height .35s ease, padding .25s ease;
}
.details.open{ max-height:1200px; padding:10px; }

/* 三欄容器（桌機） */
.details-grid3{
  /* 可調高度：三欄同高，內容超出則各自出現卷軸 */
  --panel-h: 340px;

  display:grid;
  grid-template-columns: minmax(420px, 2fr) minmax(320px, 1fr) minmax(320px, 1fr);
  gap:16px;
  align-items:stretch;  /* 三欄拉齊 */
}

/* 欄位內盒：給三欄統一高度與卷軸用 */
.details-col{
  height: var(--panel-h);
  min-height: 0;          /* 重要：讓 grid 內元素可以正確 overflow */
  background:#fff;
  border:1px solid #e5e7eb;
  border-radius:10px;
  overflow:auto;
  padding:14px 16px;
  box-shadow: 0 1px 2px rgba(0,0,0,.03);
}

/* 中、右欄標題 */
.pax-panel-title{
  margin:0 0 10px;
  font-weight:800;
  font-size:15px;
  color:#0f172a;
  display:flex; align-items:center; gap:6px;
}

/* 中、右欄列表容器（等高卷軸） */
.pax-scroll{
  height: calc(var(--panel-h) - 38px); /* 扣掉標題區高度(約) */
  overflow:auto;
  padding-right:6px;
}

/* RWD：≤980px 回單欄，不要固定高度與卷軸 */
@media (max-width: 980px){
  .details-grid3{ grid-template-columns:1fr; }
  .details-col{ height:auto; overflow:visible; }
  .pax-scroll{ height:auto; overflow:visible; padding-right:0; }
}


/* =============================================================================
   C. 司機資訊（左欄）排版優化
   ========================================================================== */

/* 左欄內的視覺：標題列 */
.driver-info__title{
  display:flex; align-items:center; gap:8px;
  font-weight:800; color:#0f172a;
  margin:2px 0 12px;
}
.driver-info__title .emoji{ font-size:18px; }

/* key-value 版面：整齊對齊成兩欄（標籤 / 內容） */
.driver-kv{
  display:grid;
  grid-template-columns: 92px 1fr;
  row-gap:8px;
  column-gap:10px;
}
.driver-kv .k{
  color:#475569;
  font-weight:600;
  text-align:right;
}
.driver-kv .v{
  color:#111827;
  word-break:break-word;
}

/* 小分隔線群組：讓資訊區塊更乾淨 */
.driver-info__group{
  display:grid; gap:8px;
  padding-bottom:8px;
  border-bottom:1px dashed #e5e7eb;
  margin-bottom:10px;
}
.driver-info__group:last-child{ border-bottom:0; padding-bottom:0; margin-bottom:0; }

/* 次要文字（例如「未提供」、「未定」） */
.text-muted{ color:#6b7280; }

/* RWD：手機時改成單欄 */
@media (max-width: 640px){
  .driver-kv{ grid-template-columns: 86px 1fr; }
}


/* =============================================================================
   D. 你現有的箭頭/卡片/按鈕（如需，保留）
   ========================================================================== */

.arrow{ cursor:pointer; margin-left:6px; min-width:36px; min-height:36px;
  font-size:16px; color:#333; background:transparent; border:0;
  transition: transform .25s ease;
}
.arrow.open{ transform: rotate(90deg); }

.btn-manage{ background:#007bff; color:#fff; border:0; border-radius:6px; padding:6px 10px; }
.btn-manage:hover{ background:#0056b3; }
.btn-join{ background:#28a745; color:#fff; border:0; border-radius:6px; padding:6px 10px; }
.btn-join:hover{ background:#1e7e34; }

/* ==========================================================================
   Modal：通用（遮罩/容器/關閉鈕/區塊）
   ========================================================================== */
/* ===== Passenger Auth Modal (scoped) ===== */
#paxAuthModal{
  /* 用 grid 置中，無視外層任何 margin/padding 影響 */
  display: grid;
  place-items: center;
  position: fixed;
  inset: 0;
  padding: 0;            /* 避免視覺上看起來略上緣 */
  z-index: 1000;
  background: rgba(0,0,0,.55);
}

#paxAuthModal .pax-modal-card{
  margin-top: 50%;
}

#paxAuthModal .pax-desc{
  text-align: center;     /* 說明置中 */
}

/* 小螢幕也維持置中 */
@media (max-width: 520px){
  #paxAuthModal{ padding: 0; /* 用 grid 置中，無視外層任何 margin/padding 影響 */
  display: grid;
  place-items: center;
  position: fixed;
  inset: 0;
  z-index: 1000;
  background: rgba(0,0,0,.55);}
  #paxAuthModal .pax-modal-card{ width: min(520px, 92vw); }
}
#paxAuthModal .pax-modal-card {
  width:min(520px, 92vw);
  background:#fff; border-radius:14px; box-shadow:0 12px 34px rgba(0,0,0,.28);
  display:flex; flex-direction:column; overflow:hidden; animation:fadeIn .18s ease-out;
}
#paxAuthModal .pax-modal-head {
  display:flex; align-items:center; justify-content:space-between; gap:8px;
  padding:16px 18px; border-bottom:1px solid #eee;
}
#paxAuthModal .pax-title-wrap { display:flex; align-items:center; gap:10px; }
#paxAuthModal .pax-lock { font-size:18px; line-height:1; }
#paxAuthModal .pax-title { margin:0; font-size:18px; font-weight:700; color:#222; }

#paxAuthModal .pax-close {
  appearance:none; border:0; background:transparent; cursor:pointer;
  font-size:22px; line-height:1; color:#888; padding:2px 6px; border-radius:8px;
}
#paxAuthModal .pax-close:hover { background:#f2f3f5; color:#222; }

#paxAuthModal .pax-desc { margin:0 0 14px; font-size:14px; color:#666; }

#paxAuthModal .pax-form { margin:0; }
#paxAuthModal .pax-form-row { display:grid; grid-template-columns:94px 1fr; gap:10px 14px; align-items:center; }
#paxAuthModal .pax-form-row label { font-size:14px; color:#333; text-align:right; }
#paxAuthModal .pax-form-row input {
  width:75%; padding:10px 12px; border:1px solid #dcdfe6; border-radius:10px; font-size:15px;
  transition:border-color .15s, box-shadow .15s;
}
#paxAuthModal .pax-form-row input:focus {
  outline:none; border-color:#3b82f6; box-shadow:0 0 0 3px rgba(59,130,246,.15);
}

#paxAuthModal .pax-modal-foot {
  display:flex; justify-content:flex-end; gap:8px;
  padding:12px 18px 16px; border-top:1px solid #eee;
}

#paxAuthModal .btn {
  min-width:88px; height:38px; padding:0 14px; border-radius:10px; border:1px solid transparent;
  font-size:14px; cursor:pointer; transition:background .15s, color .15s, border-color .15s, box-shadow .15s;
}
#paxAuthModal .btn.primary { background:#2563eb; color:#fff; }
#paxAuthModal .btn.primary:hover { background:#1e4fd6; }
#paxAuthModal .btn.ghost { background:#f3f4f6; color:#111827; border-color:#e5e7eb; }
#paxAuthModal .btn.ghost:hover { background:#ebeef2; }

@media (max-width:520px){
  #paxAuthModal .pax-form-row { grid-template-columns:1fr; }
  #paxAuthModal .pax-form-row label { text-align:left; }
}

@keyframes fadeIn { from { opacity:0; transform:translateY(-6px); } to { opacity:1; transform:translateY(0); } }

.modal{
  position:fixed; inset:0; z-index:1000;left: 0; top: 0; background:rgba(0,0,0,.55);
  display:none;justify-content: center; align-items: center;
}

/* ---- 統一卡片樣式（和司機管理一致的圓角/陰影） ---- */
.modal-card{
  width:min(520px, 94vw);
  border-radius:16px;
  box-shadow:0 16px 40px rgba(0,0,0,.18);
  overflow:hidden;
}

.modal-content {
  background: #fff;
  border-radius: 12px;
  padding: 28px 30px;
  width: 90%;
  max-width: 420px;
  text-align: center;   /* 🎯 置中所有文字 */
  box-shadow: 0 6px 18px rgba(0,0,0,0.25);
  position: relative;
  animation: fadeIn 0.3s ease-out;
}
.modal .modal-content{
  display:flex; flex-direction:column;
  width:min(520px,94vw);max-width:640px;; max-height:min(92svh,640px);
  margin:6svh auto; background:#fff; border-radius:12px;
  box-shadow:0 10px 30px rgba(0,0,0,.25);
}
/* header / footer */
.modal-header{
  display:flex; align-items:center; justify-content:space-between;
  padding:16px 18px; border-bottom:1px solid #eee;
}
.modal-footer{
  display:flex; justify-content:flex-end; gap:10px;
  padding:14px 18px; border-top:1px solid #eee;
}
.modal-body{ flex:1 1 auto; overflow-y:auto; padding:14px 16px; }
.close{ background:transparent; border:0; font-size:20px; cursor:pointer; }
.modal-title-row{ display:flex; align-items:center; gap:10px; }
.modal-emoji{ font-size:20px; line-height:1; }
.modal-title{ margin:0; font-size:18px; font-weight:700; letter-spacing:.5px; }

.body-modal-open{ overflow:hidden; }
.modal-desc {
  font-size: 14px;
  color: #666;
  margin: 8px 0 20px;
}

/* close button */
.close{
  background:transparent; border:0; font-size:22px; color:#8a8f98; cursor:pointer; line-height:1;
}
.close:hover{ color:#333; }

/* inline error */
.form-error{
  margin:6px 0 0 120px; color:#d33; font-size:13px; min-height:1em; display:none;
}
.form-error.show{ display:block; }

/* RWD：手機改為上下排列 */
@media (max-width: 480px){
  .form-vertical .form-row{
    grid-template-columns:1fr; gap:6px;
  }
  .form-error{ margin-left:0; }
}
/* 表單欄位 */
.form-group {
  margin-bottom: 20px;
  text-align: center;  /* label 單獨靠左，輸入框保持置中 */
}
.form-group label {
  display: block;
  margin-bottom: 8px;
  font-size: 14px;
  font-weight: 600;
  color: #333;
  text-align: center;    /* 🎯 標籤靠左 */
}
.form-group input {
  width: 50%;
  padding: 12px;
  border-radius: 8px;
  border: 1px solid #ccc;
  font-size: 15px;
  transition: border-color 0.2s;
  text-align: center;   /* 🎯 輸入框文字置中 */
}
.form-group input:focus {
  border-color: #007bff;
  outline: none;
}

/* 按鈕區塊 */
.modal-actions {
  display: flex;
  justify-content: center;  /* 🎯 按鈕置中 */
  gap: 12px;
}
.btn-primary {
  background: #007bff;
  color: #fff;
  border: none;
  padding: 10px 20px;
  border-radius: 6px;
  font-size: 15px;
  cursor: pointer;
  transition: background 0.2s;
}
.btn-primary:hover { background: #0056b3; }

.btn-secondary {
  background: #f1f1f1;
  color: #333;
  border: none;
  padding: 10px 20px;
  border-radius: 6px;
  font-size: 15px;
  cursor: pointer;
  transition: background 0.2s;
}
.btn-secondary:hover { background: #ddd; }

/* 動畫 */
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(-10px); }
  to { opacity: 1; transform: translateY(0); }
}

/* 🎯 手機版 RWD */
@media (max-width: 480px) {
  #driverAuthModal .modal-content {
    width: 70%;
    margin-top: 60%;
  }
  #driverAuthModal.btn-primary, .btn-secondary {
    flex: 1;              /* 按鈕變成等寬 */
    padding: 12px;
  }
  .modal-actions {
    flex-direction: column; /* 🎯 手機版按鈕上下排列 */
  }
}
/* ==========================================================================
   Join Modal：外觀微調（高度較矮、Header/Body/Footer 黏貼）
   ========================================================================== */
/* Join Modal 外觀 */
#joinModal .modal-content {
  width: min(520px, 94vw);
  max-height: min(88svh, 620px);
  margin: 4svh auto;
  border-radius: 14px;
  overflow: hidden;
  box-shadow: 0 14px 34px rgba(0,0,0,.25);
  background: #fff;
  display: flex;
  flex-direction: column;
}

/* Header */
#joinModal .modal-header {
  position: sticky; top: 0; z-index: 2;
  display: flex; align-items: center; justify-content: center;
  min-height: 44px; padding: 8px 16px;
  background: #fff; border-bottom: 1px solid #eee;
}
#joinModal .modal-header .title {
  font-size: 16px; font-weight: 700; color: #111827;
  display: inline-flex; align-items: center; gap: 8px;
}
#joinModal .modal-header .title .emoji { font-size: 18px; }
#joinModal .modal-header .close {
  position: absolute; right: 10px; top: 8px;
  width: 28px; height: 28px;
  display: inline-grid; place-items: center;
  font-size: 18px; color: #6b7280; background: transparent; border: none;
  cursor: pointer; border-radius: 6px;
}
#joinModal .modal-header .close:hover { background: #f3f4f6; color: #111827; }

/* Body */
#joinModal .modal-body {
  flex: 1 1 auto;
  overflow-y: auto;
  padding: 12px 16px;
}

/* Footer */
#joinModal .modal-footer {
  position: sticky; bottom: 0; z-index: 2;
  display: flex; justify-content: flex-end; gap: 8px;
  padding: 10px 16px; background: #fff;
  border-top: 1px solid #eee;
}
#joinModal .btn-cancel, #joinModal .btn-submit {
  border-radius: 10px; padding: 10px 18px;
  font-weight: 700; font-size: 15px;
  border: none; cursor: pointer;
}
#joinModal .btn-cancel { background: #f3f4f6; color: #333; }
#joinModal .btn-cancel:hover { background: #ddd; }
#joinModal .btn-submit { background: #3b82f6; color: #fff; }
#joinModal .btn-submit:hover { background: #2563eb; }

/* 表單欄位 */
#joinModal .join-field {
  display: flex; flex-direction: column;
  gap: 6px; margin: 12px 0;
  align-items: flex-start; /* 標籤靠左 */
}
#joinModal .join-field label {
  font-weight: 600; color: #1f2937; line-height: 1.2;
}
#joinModal .join-field input,
#joinModal .join-field select,
#joinModal .join-field textarea {
  width: 70%;
  padding: 10px 12px;
  border: 1px solid #d1d5db; border-radius: 8px;
  font-size: 14px; line-height: 1.25;
  background: #fff;
  transition: border-color .2s, box-shadow .2s;
}
#joinModal .join-field input:focus,
#joinModal .join-field select:focus,
#joinModal .join-field textarea:focus {
  outline: none;
  border-color: #3b82f6;
  box-shadow: 0 0 0 3px rgba(59,130,246,.15);
}
#joinModal textarea[name="note"] { min-height: 96px; }

/* 手機優化 */
@media (max-width: 480px) {
  #joinModal .modal-content {
    width: 80%; max-height: 90vh;
  }
  #joinModal .modal-footer {
    flex-direction: column;
  }
  #joinModal .btn-cancel, #joinModal .btn-submit {
    width: 100%;
  }
}
  /* Join 表單欄位間距與按鈕高度 */
  #joinModal .join-field{ margin:10px 0; gap:6px; }
  .btn-submit, .btn-cancel{ min-height:44px; font-size:16px; }

  /* JoinModal 再壓縮 header/邊距 */
  #joinModal .modal-content{ max-height:min(92svh,640px); margin:3svh auto; }
  #joinModal .modal-header{ min-height:40px; padding:6px 14px; }
  #joinModal .modal-header .title{ font-size:15px; }
  #joinModal .modal-body{ padding:10px 14px; }
  #joinModal .modal-footer{ padding:8px 14px; }

/* ==========================================================================
   返回頂端按鈕
   ========================================================================== */
#backToTop{
  position:fixed; bottom:20px; right:20px;
  background:#00897b; color:#fff; border:none; border-radius:50%;
  padding:14px; font-size:20px; cursor:pointer;
  box-shadow:0 4px 8px rgba(0,0,0,.2);
  z-index:1200; transition:transform .2s, background .3s;
}
#backToTop:hover{ background:#00695c; transform:scale(1.08); }

/* ==========================================================================
   動畫
   ========================================================================== */
@keyframes fadeInUp{
  from{ opacity:0; transform:translateY(15px); }
  to{ opacity:1; transform:translateY(0); }
}

/* ==========================================================================
   RWD 斷點調整
   ========================================================================== */
/* ≤1024px：卡片與主按鈕微調 */
@media (max-width:1024px){
  .card{ padding:8px 12px 8px 24px; margin:3px; }
  .btn-main{ padding:10px 16px; font-size:15px; }
}
/* ≤768px：字級、小標題、主按鈕等 */
@media (max-width:768px){
  body{ font-size:15px; }
  h1{ font-size:22px; }
  h2{ font-size:18px; margin:14px; }
  .buttons{ padding:0 12px; }
  .btn-main{ width:auto; min-width:44%; }
  #toast-container{ top:env(safe-area-inset-top,16px); right:12px; left:24px; }
}
/* ≤640px：主按鈕滿版、司機卡片三欄改單欄、Modal 更緊湊、Join 表單維持直向 */
@media (max-width:640px){
  /* 主按鈕改單欄滿版 */
  .buttons{ display:grid; grid-template-columns:1fr; gap:10px; padding:0 12px; }
  .btn-main{ width:100%; }

  /* 司機卡片：三欄→單欄 */
  .driver-grid{ display:grid; grid-template-columns:1fr; grid-row-gap:8px; }
  .col-left, .col-middle, .col-actions{ width:100%; }
  .col-left .name-seat{ font-size:16px; margin-bottom:6px; text-align:left; }
  .col-middle .line{ display:block; margin:4px 0; font-size:14px; }

  .col-actions{
    display:grid; grid-template-columns:1fr 1fr auto; align-items:center; gap:8px;
  }
  .btn-manage, .btn-join{ width:100%; min-height:44px; font-size:15px; }
  .arrow{ font-size:18px; min-width:44px; min-height:44px; display:inline-grid; place-items:center; }
  .details{
  margin-top:0px; max-height:0; overflow:hidden; padding:0px 0px;
  background: transparent; border:0 #e6e6e6;
  transition:max-height 1.2s ease, padding 1s ease;
  }
  /* 展開時再加回外觀 */
  .details.open {
    margin-top: 8px;
    max-height: 1200px;
    padding: 10px;
    background: #f9f9f9;
    border-top: 1px solid #e6e6e6;
    border-radius: 6px;
  }
  .details h4{ font-size:15px; margin:6px 0 4px; }
  .details p, .details li{ font-size:14px; margin:2px 0; }

  /* 乘客卡片：主列單欄、操作靠右 */
  .pax-row{ grid-template-columns:1fr; }
  .pax-actions{ justify-content:flex-end; }

  /* 通用 modal 寬度 */
  .modal .modal-content{ width:94vw; margin:4svh auto; }

  /* 返回頂端位置 */
  #backToTop{ right:12px; bottom:16px; }
}
/* ≤400px：字級調整、按鈕與箭頭更小 */
@media (max-width:400px){
  body{ font-size:14px; }
  h1{ font-size:20px; }
  h2{ font-size:16px; margin:10px; }
  .col-left .name-seat{ font-size:15px; }
  .col-middle .line1{ font-size:15px; }
  .col-middle .line2, .col-middle .line3{ font-size:13px; }
  .btn-manage, .btn-join{ font-size:14px; padding:8px 10px; }
  .arrow{ font-size:16px; min-width:40px; min-height:40px; }
}
/* ============================================================================
   Pax Edit Modal 美化（只影響 #paxEditModal）
   ========================================================================== */

/* 彈窗寬度與可卷動 */
.modal .modal-content{ max-width:640px; }
.modal .modal-body{ max-height:72vh; overflow:auto; }
/* 3) 內容區底部加內距，避免被底部按鈕蓋住 */
#paxEditModal .modal-body {
  padding-bottom: 80px; /* 可依喜好 64~96px */
}
/* 4) 底部按鈕：尺寸加大、靠右對齊 */
#paxEditModal .modal-footer {
  position: sticky;        /* 捲動時固定在底部 */
  bottom: 0;
  padding: 12px 16px calc(12px + env(safe-area-inset-bottom, 0px));
  gap: 10px;
  justify-content: flex-end;
  background: #fff;        /* 與內容分層 */
  border-top: 1px solid #eef2f7;
}
#paxEditModal .btn-submit,
#paxEditModal .btn-cancel {
  min-height: 44px;
  padding: 10px 16px;
  border-radius: 10px;
  font-weight: 700;
}
/* 1) 表單欄位填滿一欄（把原本 50% 覆寫成 100%） */
#paxEditModal .join-field input,
#paxEditModal .join-field select,
#paxEditModal .join-field textarea {
  width: 100%;
}

/* 控制項寬度 */
#paxEditForm input,
#paxEditForm select,
#paxEditForm textarea{ width:100%; }

/* 2) 備註：加大高度、可拉伸，且橫跨兩欄 */
#paxEditModal #paxEditForm textarea {
  grid-column: 1 / -1;
  min-height: 120px;
  resize: vertical;
}
.switch{
  display:flex; align-items:center; gap:10px;
  padding:8px 10px; border:1px solid #e9eef5; border-radius:10px; background:#f8fbff;
}

/* 隱藏真正的 checkbox */
.switch input[type="checkbox"]{
  position:absolute; opacity:0; width:0; height:0;
}

/* 這裡改：讓 label.toggle 當滑軌 */
.switch label.toggle{
  position:relative; width:48px; height:26px; border-radius:999px;
  background:#d1d5db; transition:background .2s; cursor:pointer; display:inline-block;
}
.switch label.toggle::after{
  content:""; position:absolute; top:3px; left:3px; width:20px; height:20px;
  background:#fff; border-radius:50%; box-shadow:0 1px 2px rgba(0,0,0,.2); transition:transform .2s;
}

/* 勾選後變色與推動圓點 */
.switch input[type="checkbox"]:checked + label.toggle{
  background:#22c55e;
}
.switch input[type="checkbox"]:checked + label.toggle::after{
  transform:translateX(22px);
}

/* 讓文字也可點 */
.switch .switch-text{ font-weight:600; color:#374151; cursor:pointer; }

/* 禁用狀態（如果你用 JS 設置 disabled） */
.switch input[type="checkbox"]:disabled + label.toggle{
  opacity:.55; cursor:not-allowed; background:#e5e7eb;
}
.switch input[type="checkbox"]:disabled ~ .switch-text{
  color:#9ca3af; cursor:not-allowed;
}

#paxPrivacyHint{ margin-top:6px; font-size:12px; color:#6b7280; }
#paxPrivacyHint.hint-error{ color:#b91c1c; }

/* === Pax Edit 膠囊格子風格 === */
#paxEditModal .join-field input,
#paxEditModal .join-field select,
#paxEditModal .join-field textarea{
  width: 100%;
  height: 42px;                 /* textarea 下面會覆寫成自動高度 */
  padding: 10px 12px;
  border: 1px solid #d9dee7;    /* 淺灰外框 */
  border-radius: 12px;          /* 圓角膠囊 */
  background: #fff;
  box-shadow: inset 0 1px 0 rgba(0,0,0,.02);
  transition: border-color .15s, box-shadow .15s, background .15s;
}

#paxEditModal .join-field textarea{
  min-height: 110px;
  height: auto;                 /* 文字區域不要固定高度 */
  resize: vertical;
}

#paxEditModal .join-field input:focus,
#paxEditModal .join-field select:focus,
#paxEditModal .join-field textarea:focus{
  outline: none;
  border-color: #94b5ff;        /* 你也可改 #3b82f6 */
  box-shadow: 0 0 0 3px rgba(59,130,246,.15);
}

#paxEditModal .join-field ::placeholder{
  color:#9aa3b2;
}

/* 選單的原生箭頭隱藏 + 自訂間距（可選） */
#paxEditModal .join-field select{
  appearance:none; -webkit-appearance:none; -moz-appearance:none;
  padding-right: 34px;
  background-image: none;       /* 如果想加下拉箭頭可以再放 data-URI 圖 */
}
/* 表單標題（label）置中、字大一點、間距加大 */
#paxEditModal .join-field > label{
  font-weight: 700;
  font-size: 16px;         /* 原本 14 → 16 */
  color: #1f2937;
  text-align: center;      /* 置中 */
  margin-bottom: 8px;      /* 與輸入框距離 */
}

/* 欄位格子：字體加大、上下 padding 更厚、圓角維持 */
#paxEditModal .join-field input,
#paxEditModal .join-field select,
#paxEditModal .join-field textarea{
  font-size: 16px;         /* 原本 14 → 16 */
  line-height: 1.4;
  padding: 14px 14px;      /* 上下間距加大 */
  height: auto;            /* 讓高度由 padding 撐開 */
  border: 1px solid #d9dee7;
  border-radius: 12px;
}

/* 文字區塊高度再放鬆一些 */
#paxEditModal .join-field textarea{
  min-height: 120px;
}

/* 隱私設定 switch：整塊置中、字加大 */
#paxEditModal .privacy-switch,
#paxEditModal .switch{
  justify-content: center; /* 水平置中 */
}
#paxEditModal .switch label{
  font-size: 16px;
}

/* Modal 標題本來就置中，這裡再微調字重與字級 */
#paxEditModal .modal-header .title{
  font-size: 18px;
  font-weight: 800;
}

/* 儲存/取消按鈕字更大、觸控面積更好按 */
#paxEditModal .btn-submit,
#paxEditModal .btn-cancel{
  font-size: 16px;
  padding: 12px 18px;
}

@media (max-width: 560px){
  /* 小螢幕下，欄位全寬看起來更舒服 */
  #paxEditModal .join-field input,
  #paxEditModal .join-field select,
  #paxEditModal .join-field textarea{
    width: 100%;
  }
}


/* 小螢幕改一欄 */
@media (max-width:560px){
  #paxEditForm{ grid-template-columns:1fr; }
/* 5) 手機：按鈕滿版、改直向排列 */
@media (max-width: 560px) {
  #paxEditModal .modal-footer {
    flex-direction: column;
    align-items: stretch;
  }
  #paxEditModal .btn-submit,
  #paxEditModal .btn-cancel {
    width: 100%;
  }
}
}
/* ==========================================================================
   排序篩選 美化
   ========================================================================== */
/* 司機/乘客兩個清單底部做一塊不可見的 spacer */
#driver-list::after{
  content: "";
  display: block;
  height: calc(20dvh + var(--safe-bottom)); /* 留一段可視高度 + 固定值 */
}
#passenger-list::after {
  content: "";
  display: block;
  height: calc(1vh + var(--safe-bottom)); /* 留一段可視高度 + 固定值 */
}

/* 若清單外有頁面容器，也建議留 padding-bottom，雙重保險 */
.page,
.container,
.main {
  padding-bottom: calc(10vh + 64px + var(--safe-bottom));
}

:root{ --collapse-ms: 240ms;--safe-bottom: env(safe-area-inset-bottom, 0px); }

.panel{
  border:1px solid #e6e8ec; border-radius:14px; background:#fff; overflow:hidden;
  box-shadow:0 2px 10px rgba(30,41,59,.06);
  margin:.75rem 0 1rem;
}
.panel-hd{
  display:flex; align-items:center; justify-content:space-between; gap:.75rem;
  padding:.8rem 1rem; background:linear-gradient(#f8fafc,#f3f6fb);
  cursor:pointer; user-select:none;
}
.panel-title{ display:flex; align-items:center; gap:.55rem; font-weight:600; color:#0f172a; }
.panel-title .dot{ width:10px; height:10px; border-radius:999px; background:#22c55e; box-shadow:0 0 0 3px rgba(34,197,94,.18); }
.panel-ops{ display:flex; align-items:center; gap:.5rem; }
.panel-toggle{ width:34px; height:34px; border-radius:10px; border:1px solid #dbe0e8; background:#fff; display:grid; place-items:center; }
.panel-toggle svg{ width:18px; height:18px; transition:transform .22s ease; color:#334155; }
.panel[aria-expanded="true"] .panel-toggle svg{ transform:rotate(180deg); }

/* ✅ 只用 max-height/opacity 做動畫—不要再用 display:none/block */
.panel .panel-bd{
  padding:12px 12px 14px;     /* 這裡保留 padding，但不要再加 display:none */
  overflow:hidden;
  max-height:0;
  opacity:0;
  transition:
    max-height var(--collapse-ms) ease,
    opacity    var(--collapse-ms) ease;
}
.panel[aria-expanded="true"] .panel-bd{ opacity:1; }

.panel-title { display:flex; align-items:center; gap:.55rem; font-weight:600; color:#0f172a; }
.panel-title .dot { width:10px; height:10px; border-radius:999px; background:#22c55e; box-shadow:0 0 0 3px rgba(34,197,94,.18); }
.panel-ops { display:flex; align-items:center; gap:.5rem; }
.panel-toggle { width:34px; height:34px; border-radius:10px; border:1px solid #dbe0e8; background:#fff; display:grid; place-items:center; }
.panel-toggle svg { width:18px; height:18px; transition:transform .22s ease; color:#334155; }
.panel[aria-expanded="true"] .panel-toggle svg { transform:rotate(180deg); }
.panel-bd { padding:12px 12px 14px; display:none; }
.panel[aria-expanded="true"] .panel-bd{ display:block; }

/* ====== 排序：膠囊 Segmented Switch ====== */
.sort-wrap{
  display:grid;
  grid-template-columns: repeat(3, minmax(0,1fr)); /* ✅ 三欄 */
  gap:10px;
  align-items:center;
}
/* 小螢幕時自動堆疊成一欄（避免擠不下）—如果你想維持三欄可刪掉這段 */
@media (max-width: 768px){
  .sort-wrap{ grid-template-columns: 1fr; }
}
.seg-box{ flex:1; }     /* 保持每欄等寬 */
.seg-title{ font-size:.9rem; color:#475569; margin:2px 0 4px 6px; }

.seg-switch {
  --h:40px; position:relative; background:#f4f6fb; border:1px solid #e4e8f0;
  border-radius:999px; display:flex; padding:4px; height:var(--h);
  box-shadow:inset 0 1px 3px rgba(0,0,0,.04);
}
.seg-switch .pill {
  position:absolute; top:4px; left:4px; height:calc(var(--h) - 8px); width:calc(50% - 4px);
  background:#fff; border-radius:999px; box-shadow:0 2px 10px rgba(0,0,0,.08);
  transition:left .22s cubic-bezier(.4,0,.2,1), width .22s cubic-bezier(.4,0,.2,1);
}
.seg-switch .opt {
  flex:1; display:flex; align-items:center; justify-content:center; gap:.4rem;
  z-index:1; color:#475569; font-weight:600; cursor:pointer; user-select:none;
}
.seg-switch .opt .ico{ width:16px; height:16px; }
.seg-switch[data-state="right"] .pill { left:calc(50% + 0px); }
.seg-title { font-size:.9rem; color:#475569; margin:2px 0 4px 6px; }

/* 次級分組（出發地排序） */
.seg-group { display:flex; gap:10px; }
.seg-box { flex:1; }

/* ====== 隱藏 select（保相容） ====== */
#sort{ display:none; }

/* ====== 篩選格線 ====== */
.filt-grid{
  display:grid; grid-template-columns:repeat(4,minmax(0,1fr));
  gap:10px 12px; align-items:end; margin-top:6px;
}
@media (max-width:768px){ .filt-grid{ grid-template-columns:repeat(2,minmax(0,1fr)); } .only-desktop-spacer{ display:none; } }

.filt-item{ display:flex; flex-direction:column; gap:6px; min-width:0; }
.filt-item label{ font-size:.86rem; color:#666; }
.ctl{ width:100%; box-sizing:border-box; }
select.ctl{ min-height: 2.6rem; padding:.35rem .55rem; }
input.ctl{ padding:.45rem .6rem; }

.btn{
  display:inline-flex; align-items:center; justify-content:center;
  padding:10px 16px; border-radius:10px; border:0; cursor:pointer; font-weight:600;
  transition:transform .02s ease, box-shadow .2s ease, background .2s ease;
}
.btn.primary{ background:#111; color:#fff; border-color:#111; }
.btn.ghost{ background:#f5f6f8; }

/* ====== 酌收費用 Toggle（≥ / ≤） ====== */
.fare-toggle{ display:flex; align-items:center; gap:.5rem; }
.toggle{
  position:relative; width:160px; height:36px; border-radius:999px; background:#e9edf3; border:1px solid #d8dee8; cursor:pointer;
}
.toggle .knob{
  position:absolute; top:3px; left:3px; width:30px; height:30px; border-radius:50%;
  background:#fff; box-shadow:0 1px 2px rgba(0,0,0,.12);
  transition:left .22s cubic-bezier(.4,0,.2,1), transform .12s ease;
}
.toggle[data-mode="gte"] .knob{ left:127px; }
.toggle .label{ position:absolute; top:50%; transform:translateY(-50%); font-size:.82rem; color:#5a6372; }
.toggle .label.lte{ left:42px; } .toggle .label.gte{ right:42px; }

/* 晶片 */
.chips{display:flex;flex-wrap:wrap;gap:.4rem;margin:.25rem 0 1rem;}
.chip{display:inline-flex;align-items:center;gap:.45rem;padding:.28rem .6rem;border-radius:999px;border:1px solid #e1e4ea;background:#f7f8fb;font-size:.87rem;color:#333;}
.chip .x{display:inline-flex;align-items:center;justify-content:center;width:18px;height:18px;border-radius:50%;background:#e9ecf3;color:#333;cursor:pointer;font-size:.8rem;line-height:1;}
.chip .x:hover{ background:#dfe4ee; }


</style>
<script>
(function () {
  // 改成你實際用的 ID
  const MODAL_ID = 'introModal';     // 原本是 'siteIntroModal'
  const BTN_ID   = 'btnIntro';       // 原本是 'introHelpBtn'

  function $id(id){ return document.getElementById(id); }

  function openIntro() {
    const m = $id(MODAL_ID);
    if (!m) return;
    m.classList.add('is-open');
    document.body.classList.add('body--intro-open');
    const card = m.querySelector('.intro-modal__card');
    card && card.focus();
  }
  function closeIntro() {
    const m = $id(MODAL_ID);
    if (!m) return;
    m.classList.remove('is-open');
    document.body.classList.remove('body--intro-open');
  }

  function bindIntro() {
    // 按鈕開啟
    const btn = $id(BTN_ID);
    btn && btn.addEventListener('click', (e) => {
      e.preventDefault();
      openIntro();
    });

    // Modal 關閉（遮罩或關閉鈕上加 data-intro-close）
    const modal = $id(MODAL_ID);
    if (!modal) return;
    modal.addEventListener('click', (e) => {
      if (e.target.matches('[data-intro-close]')) {
        e.preventDefault();
        closeIntro();
      }
    });

    // ESC 關閉
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && modal.classList.contains('is-open')) {
        closeIntro();
      }
    });

    // 對外暴露
    window.showIntroModalNow = openIntro;
    window.closeIntroModal   = closeIntro;
  }

  document.addEventListener('DOMContentLoaded', bindIntro);
})();
</script>
</head>
<body>
  <h1>🌐 花蓮光復救災交通媒合</h1>

  <div class="hero-actions">
  <button class="btn-main btn-driver" onclick="openDriverModal && openDriverModal()">
    🚗　我要出車（找乘客）
  </button>

  <!-- 說明按鈕 -->
  <button id="btnIntro" class="btn-main btn-ghost" type="button" aria-haspopup="dialog" aria-controls="introModal">
    <span class="ico">❔</span>
    <span>說明</span>
  </button>

  <button class="btn-main btn-passenger" onclick="openJoinModal && openJoinModal()">
    🧍‍♀️　我要搭車（找車）
  </button>
</div>

  <h2>找人資訊（司機提供座位）</h2>
  <ul id="passenger-list">
    {% for p in passengers %}
      {% if not p.is_matched %}
        <li class="card passenger-card">
          <span><b>{{ p.passenger_name }}</b> - 需要 {{ p.seats_needed }} 人
            ({{ p.departure }} → {{ p.destination }}, {{ p.date }})</span>
          <div class="actions">
            <button onclick="openPassengerModal('{{ p.id }}')">編輯</button>
            <button onclick="openJoinModal('{{ p.id }}')">參加</button>
          </div>
        </li>
      {% endif %}
    {% empty %}
      <li class="card passenger-card">目前沒有需求</li>
    {% endfor %}
  </ul>
<h2>找車需求（乘客需要司機）</h2>


{{ filters|json_script:"filtersData" }}

{# 後端 filters 以合法 JSON 注入（供 JS 使用） #}
{{ filters|json_script:"filtersData" }}
<div id="filterPanel" class="panel" aria-expanded="false">
  <div class="panel-hd" id="panelHead">
      <div class="panel-title">
      <span class="dot" aria-hidden="true"></span>
      <span>條件與排序（快速找到你要的車）</span>
    </div>
    <div class="panel-ops">
      <button type="button" class="panel-toggle" aria-label="展開/收合">
        <svg viewBox="0 0 24 24" fill="none"><path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
      </button>
    </div>
  </div>

  <div class="panel-bd">
    <!-- ===== 排序（膠囊） ===== -->
    <div class="sort-wrap" role="group" aria-label="排序選擇">
      <!-- 日期：遠→近 / 近→遠 -->
      <div class="seg-box">
        <div class="seg-title">出發日期</div>
        <div id="segDate" class="seg-switch" data-state="{% if sort == 'date_asc' %}right{% else %}left{% endif %}">
          <div class="pill" aria-hidden="true"></div>
          <button class="opt" type="button" data-sort="date_desc" aria-pressed="{% if sort == 'date_desc' %}true{% else %}false{% endif %}">
            <svg class="ico" viewBox="0 0 24 24" fill="none"><path d="M7 3v4M17 3v4M3 11h18M7 15h5m-5 4h10" stroke="currentColor" stroke-width="1.7" stroke-linecap="round"/></svg>
            遠→近
          </button>
          <button class="opt" type="button" data-sort="date_asc" aria-pressed="{% if sort == 'date_asc' %}true{% else %}false{% endif %}">
            <svg class="ico" viewBox="0 0 24 24" fill="none"><path d="M7 3v4M17 3v4M3 11h18M7 19h5m-5-4h10" stroke="currentColor" stroke-width="1.7" stroke-linecap="round"/></svg>
            近→遠
          </button>
        </div>
      </div>

      <!-- 出發地：北→南 / 南→北（下方另有 A→Z / Z→A 小組） -->
      <div class="seg-box">
        <div class="seg-title">出發地（地理）</div>
        <div id="segGeo" class="seg-switch" data-state="{% if sort == 'dep_s2n' %}right{% else %}left{% endif %}">
          <div class="pill"></div>
          <button class="opt" type="button" data-sort="dep_n2s" aria-pressed="{% if sort == 'dep_n2s' %}true{% else %}false{% endif %}">北→南</button>
          <button class="opt" type="button" data-sort="dep_s2n" aria-pressed="{% if sort == 'dep_s2n' %}true{% else %}false{% endif %}">南→北</button>
        </div>
      </div>

      <div class="seg-box">
        <div class="seg-title">出發地（字母）</div>
        <div id="segAlpha" class="seg-switch" data-state="{% if sort == 'dep_desc' %}right{% else %}left{% endif %}">
          <div class="pill"></div>
          <button class="opt" type="button" data-sort="dep_asc"  aria-pressed="{% if sort == 'dep_asc' %}true{% else %}false{% endif %}">A→Z</button>
          <button class="opt" type="button" data-sort="dep_desc" aria-pressed="{% if sort == 'dep_desc' %}true{% else %}false{% endif %}">Z→A</button>
        </div>
      </div>

      <!-- 隱藏 select（保相容） -->
      <select id="sort" name="sort" hidden>
        <option value="date_desc" {% if sort == 'date_desc' %}selected{% endif %}>日期 新→舊</option>
        <option value="date_asc"  {% if sort == 'date_asc'  %}selected{% endif %}>日期 舊→新</option>
        <option value="dep_n2s"   {% if sort == 'dep_n2s'   %}selected{% endif %}>出發 北→南</option>
        <option value="dep_s2n"   {% if sort == 'dep_s2n'   %}selected{% endif %}>出發 南→北</option>
        <option value="dep_asc"   {% if sort == 'dep_asc'   %}selected{% endif %}>出發地 A→Z</option>
        <option value="dep_desc"  {% if sort == 'dep_desc'  %}selected{% endif %}>出發地 Z→A</option>
      </select>
    </div>

    <!-- ===== 篩選格線 ===== -->
    <form id="filtersForm" class="filt-grid" onsubmit="return false;">
      <!-- row 1 -->
      <div class="filt-item">
        <label for="f-dep">出發地</label>
        <!-- 出發地（多選） -->
          <select id="f-dep" class="ctl" multiple>
            {% for name, n in DEP_WITH_COUNT %}
              <option value="{{ name }}" {% if filters.dep_in and name in filters.dep_in %}selected{% endif %}>
                {{ name }}（{{ n }}）
              </option>
            {% endfor %}
          </select>
      </div>
      <div class="filt-item">
        <label for="f-des">目的地</label>
        <select id="f-des" class="ctl" multiple>
          {% for name, n in DES_WITH_COUNT %}
            <option value="{{ name }}" {% if filters.des_in and name in filters.des_in %}selected{% endif %}>
              {{ name }}（{{ n }}）
            </option>
          {% endfor %}
        </select>
      </div>
      <div class="filt-item">
        <label for="f-date">出發日期</label>
        <select id="f-date" class="ctl" multiple>
          {% for ds in DATE_CHOICES %}<option value="{{ ds }}" {% if filters.date_in and ds in filters.date_in %}selected{% endif %}>{{ ds }}</option>{% endfor %}
        </select>
      </div>
      <div class="filt-item">
        <label for="f-ret">回程日期</label>
        <select id="f-ret" class="ctl" multiple>
          {% for rs in RET_CHOICES %}<option value="{{ rs }}" {% if filters.ret_in and rs in filters.ret_in %}selected{% endif %}>{{ rs }}</option>{% endfor %}
        </select>
      </div>

      <!-- row 2 -->
      <div class="filt-item">
        <label for="f-fare-num">金額</label>
        <input id="f-fare-num" class="ctl" type="number" min="0" step="1"
               value="{% if filters.fare_num %}{{ filters.fare_num }}{% endif %}" placeholder="數字金額">
      </div>
      <!-- <div class="filt-item">
        <label for="f-fare-text">關鍵字</label>
        <input id="f-fare-text" class="ctl" type="text" value="{{ filters.fare_q|default:'' }}" placeholder="如：免費、AA">
      </div> -->
      <div class="filt-item">
        <label for="f-q">關鍵字</label>
        <input id="f-q" class="ctl" type="text" placeholder="搜尋整張卡片（姓名、路線、備註…）"
              value="{{ filters.q|default:'' }}">
      </div>
      <div class="filt-item">
        <label for="f-seats">可用座位</label>
        <input id="f-seats" class="ctl" type="number" min="1" step="1" value="{{ filters.need_seats|default_if_none:'' }}" placeholder="例如 2">
      </div>
      <div class="filt-item">
        <label for="f-gender">司機性別</label>
        <select id="f-gender" class="ctl" multiple>
          <option value="M" {% if filters.gender_in and 'M' in filters.gender_in %}selected{% endif %}>男</option>
          <option value="F" {% if filters.gender_in and 'F' in filters.gender_in %}selected{% endif %}>女</option>
          <option value="X" {% if filters.gender_in and 'X' in filters.gender_in %}selected{% endif %}>不透露</option>
        </select>
      </div>

      <!-- row 3 -->
      <div class="filt-item">
        <label>酌收費用</label>
        <div class="fare-toggle">
          <div id="fareToggle" class="toggle" role="switch" tabindex="0"
               aria-checked="{% if filters.fare_mode == 'gte' %}true{% else %}false{% endif %}"
               data-mode="{% if filters.fare_mode == 'gte' %}gte{% else %}lte{% endif %}">
            <span class="label lte">小於等於</span>
            <span class="label gte">大於等於</span>
            <span class="knob"></span>
          </div>
          <input type="hidden" id="f-fare-mode" value="{% if filters.fare_mode %}{{ filters.fare_mode }}{% else %}lte{% endif %}">
        </div>
      </div>

      <div class="filt-item only-desktop-spacer"></div>

      <div class="filt-item">
        <label class="sr-only">套用篩選</label>
        <button type="button" class="btn primary ctl" id="applyFilters">套用篩選</button>
      </div>
      <div class="filt-item">
        <label class="sr-only">清除</label>
        <button type="button" class="btn ghost ctl" id="clearFilters">清除</button>
      </div>
    </form>

    <div class="chips" id="activeChips"></div>
  </div>
</div>


<script>
(function(){
  /* ---------- 工具 ---------- */
  const $ = (s,r)=> (r||document).querySelector(s);
  const $$= (s,r)=> Array.from((r||document).querySelectorAll(s));
  const getSelVals = (sel)=> Array.from(sel?.selectedOptions||[]).map(o=>o.value).filter(Boolean);
  const saveScrollAndGo = (url)=>{ try{sessionStorage.setItem('scrollY', String(window.scrollY||0));}catch{} location.href=url; };
  const restoreScroll = ()=>{ try{const y=parseInt(sessionStorage.getItem('scrollY')||'0',10); if(!Number.isNaN(y)&&y>0) window.scrollTo({top:y,behavior:'auto'}); sessionStorage.removeItem('scrollY');}catch{} };
  document.addEventListener('DOMContentLoaded', restoreScroll);

  /* ---------- Sorting：膠囊切換 ---------- */
  const selectSort = document.getElementById('sort');
  function setSort(val){
    if (selectSort){ selectSort.value = val; selectSort.dispatchEvent(new Event('change',{bubbles:true})); }
    const url = new URL(location.href); url.searchParams.set('sort', val); saveScrollAndGo(url.toString());
  }
  // 三個雙向膠囊都能切換排序
  $$('#segDate .opt, #segGeo .opt, #segAlpha .opt').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const sw = btn.closest('.seg-switch');
      // 切換膠囊視覺
      sw.setAttribute('data-state', btn.nextElementSibling ? 'left' : 'right'); // 簡單判斷：第一顆在左
      setSort(btn.dataset.sort);
    });
  });

  /* ---------- 篩選、晶片（與你現有後端相容） ---------- */
  const depSel   = document.getElementById('f-dep');
  const desSel   = document.getElementById('f-des');
  const dateSel  = document.getElementById('f-date');
  const retSel   = document.getElementById('f-ret');
  const genderSel= document.getElementById('f-gender');
  const seatsInp = document.getElementById('f-seats');
  const fareNum  = document.getElementById('f-fare-num');
  const fareText = document.getElementById('f-fare-text');
  const fareMode = document.getElementById('f-fare-mode');
  const fareToggle = document.getElementById('fareToggle');
  const chipsBox = document.getElementById('activeChips');

  const FILTERS = (function(){
    try{ const el=document.getElementById('filtersData'); if(el) return JSON.parse(el.textContent||'{}')||{}; }catch{}
    // fallback：從 URL
    const u=new URL(location.href), g=k=>u.searchParams.getAll(k), gi=k=>{const v=u.searchParams.get(k); return v==null?null:(/^\d+$/.test(v)?parseInt(v,10):v);};
    return { dep_in:g('dep'), des_in:g('des'), date_in:g('date'), ret_in:g('ret'), gender_in:g('gender'),
             need_seats:gi('need_seats'), fare_mode:u.searchParams.get('fare_mode')||'', fare_num:gi('fare_num'), fare_q:u.searchParams.get('fare')||'' };
  })();

  function syncFareToggleUI(){
    const mode = (fareMode.value === 'gte') ? 'gte' : 'lte';
    fareToggle.dataset.mode = mode;
    fareToggle.setAttribute('aria-checked', mode==='gte'?'true':'false');
  }
  function toggleFareMode(){
    fareMode.value = (fareMode.value === 'gte') ? 'lte' : 'gte';
    syncFareToggleUI();
  }
  if(fareToggle){ fareToggle.addEventListener('click', toggleFareMode); fareToggle.addEventListener('keydown', e=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); toggleFareMode(); }}); }
  if(!fareMode.value) fareMode.value='lte'; syncFareToggleUI();

  function applyFilters(){
  const url   = new URL(location.href);
  const qInp  = document.getElementById('f-q');        // ★ 關鍵字輸入框
  url.searchParams.set('sort', selectSort?.value || 'date_desc');

  // 先清舊參數（含 q）
  ['q','dep','des','fare','fare_mode','fare_num','date','ret','gender','need_seats']
    .forEach(k => { url.searchParams.delete(k); url.searchParams.delete(k+'[]'); });

  // 多選
  getSelVals(depSel).forEach(v => url.searchParams.append('dep', v));
  getSelVals(desSel).forEach(v => url.searchParams.append('des', v));
  getSelVals(dateSel).forEach(v => url.searchParams.append('date', v));
  getSelVals(retSel ).forEach(v => url.searchParams.append('ret', v));
  getSelVals(genderSel).forEach(v => url.searchParams.append('gender', v));

  // 酌收費用：數字優先，其次文字
  const nr = (fareNum?.value || '').trim();
  const nv = nr ? parseInt(nr, 10) : NaN;
  if (!Number.isNaN(nv)) {
    url.searchParams.set('fare_num', String(nv));
    url.searchParams.set('fare_mode', (fareMode?.value === 'gte') ? 'gte' : 'lte');
  } else if (fareText && fareText.value.trim()) {
    url.searchParams.set('fare', fareText.value.trim());
  }

  // 可用座位
  if (seatsInp && seatsInp.value && Number(seatsInp.value) > 0) {
    url.searchParams.set('need_seats', String(parseInt(seatsInp.value, 10)));
  }

  // ★ 整卡片關鍵字
  if (qInp && qInp.value.trim()) {
    url.searchParams.set('q', qInp.value.trim());
  }

  saveScrollAndGo(url.toString());
}

function clearFilters(){
  // 清多選
  [depSel, desSel, dateSel, retSel, genderSel].forEach(sel => { if (sel) sel.selectedIndex = -1; });

  // 清數字/文字
  if (fareNum)  fareNum.value = '';
  if (fareText) fareText.value = '';
  if (seatsInp) seatsInp.value = '';

  // 清關鍵字 ★
  const qInp = document.getElementById('f-q');
  if (qInp) qInp.value = '';

  // 重置費用模式 → lte
  if (fareMode) fareMode.value = 'lte';
  if (typeof syncFareToggleUI === 'function') syncFareToggleUI();

  applyFilters();
}

  document.getElementById('applyFilters')?.addEventListener('click', applyFilters);
  document.getElementById('clearFilters')?.addEventListener('click', clearFilters);
  document.getElementById('filtersForm')?.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); applyFilters(); } });

  function makeChip(label, key, value){
    const el=document.createElement('span'); el.className='chip'; el.dataset.key=key; el.dataset.value=value;
    el.innerHTML=`${label}<span class="x" aria-label="移除">×</span>`;
    el.querySelector('.x').addEventListener('click', ()=> {
      const url=new URL(location.href);
      if(['dep','des','date','ret','gender'].includes(key)){
        const all=url.searchParams.getAll(key); url.searchParams.delete(key);
        all.filter(v=>v!==value).forEach(v=> url.searchParams.append(key,v));
      }else{
        if (key==='fare_num') url.searchParams.delete('fare_mode');
        url.searchParams.delete(key);
      }
      saveScrollAndGo(url.toString());
    });
    chipsBox.appendChild(el);
  }
  (function renderChips(){
    const f=FILTERS||{}, m={M:'男',F:'女',X:'不透露'};
    if(!chipsBox) return; chipsBox.innerHTML='';
    (f.dep_in||[]).forEach(v=> makeChip(`出發：${v}`, 'dep', v));
    (f.des_in||[]).forEach(v=> makeChip(`目的：${v}`, 'des', v));
    (f.date_in||[]).forEach(v=> makeChip(`出發日：${v}`, 'date', v));
    (f.ret_in ||[]).forEach(v=> makeChip(`回程日：${v}`, 'ret', v));
    (f.gender_in||[]).forEach(v=> makeChip(`性別：${m[v]||v}`, 'gender', v));
    if (f.q) makeChip(`關鍵字：${f.q}`, 'q', f.q);
    if (f.need_seats) makeChip(`可用座位≥${f.need_seats}`, 'need_seats', String(f.need_seats));
    if (f.fare_num !== null && f.fare_num !== undefined) makeChip(`費用 ${(f.fare_mode==='gte')?'≥':'≤'} ${f.fare_num}`, 'fare_num', String(f.fare_num));
    else if (f.fare_q) makeChip(`費用含：${f.fare_q}`, 'fare', f.fare_q);
  })();
})();
</script>


<ul id="driver-list">
  {% include "Find/_driver_list.html" %}
</ul>







  <!-- 回到頂端 -->
  <button id="backToTop" onclick="window.scrollTo({top:0, behavior:'smooth'});">⬆</button>

<!-- 司機管理授權 Modal -->
<div id="driverAuthModal" class="modal" style="display:none;">
  <div class="modal-content">
    <span class="close" onclick="closeDriverAuth()">&times;</span>
    <h3 class="modal-title">🔐 管理授權</h3>
    <p class="modal-desc">請輸入管理密碼以繼續</p>
    <form id="driverAuthForm" method="POST">
      {% csrf_token %}
      <input type="hidden" id="driverAuthId" value="">
      <div class="form-group">
        <label for="driverAuthPassword">管理密碼</label>
        <input id="driverAuthPassword" type="password" name="password" required placeholder="輸入管理密碼">
      </div>
      <div class="modal-actions">
        <button type="submit" class="btn-primary">確認</button>
        <button type="button" class="btn-secondary" onclick="closeDriverAuth()">取消</button>
      </div>
    </form>
  </div>
</div>
<!-- 刪除司機 Modal -->
<div id="deleteDriverModal" class="modal" style="display:none;">
  <div class="modal-content" style="max-width:400px;text-align:center;">
    <h3 style="color:#b91c1c;">⚠️ 確認刪除</h3>
    <p>確定要刪除此司機嗎？<br>此動作會解除所有乘客關聯，且無法復原。</p>
    <div style="margin-top:20px;display:flex;justify-content:center;gap:12px;">
      <button type="button" class="btn-cancel" onclick="closeDeleteDriver()">取消</button>
      <button type="button" class="btn-delete" id="confirmDeleteDriver">刪除</button>
    </div>
  </div>
</div>

<style>
  .btn-cancel{background:#d1d5db;padding:8px 14px;border:0;border-radius:6px;cursor:pointer;}
  .btn-delete{background:#dc2626;color:#fff;padding:8px 14px;border:0;border-radius:6px;cursor:pointer;}
  .btn-delete:hover{background:#b91c1c;}
</style>



<!-- Toast 容器 -->
<div id="toast-container" style="
  position: fixed;
  top: 20px;
  right: 20px;
  z-index: 2000;
"></div>

<!-- 參加行程 Modal -->
<div id="joinModal" class="modal" style="display:none;">
  <div class="modal-content">
    <div class="modal-header">
      <h3>🧍 參加行程</h3>
      <button type="button" class="close" onclick="closeJoinModal()">×</button>
    </div>

    <div class="modal-body">
      <form id="joinForm" method="POST">
        {% csrf_token %}

        <div class="join-field">
          <label>暱稱</label>
          <input type="text" name="passenger_name" required>
        </div>

        <div class="join-field">
          <label>性別</label>
          <select name="gender" required>
            <option value="X" selected>不方便透漏</option>
            <option value="M">男生</option>
            <option value="F">女生</option>
          </select>
        </div>

        <div class="join-field">
          <label>Email <span class="muted">(不公開，用於媒合通知)</span></label>
          <input type="email" name="email" placeholder="選填">
        </div>

        <div class="join-field">
          <label>聯絡方式(選填,未填請自行連絡司機)</label>
          <input type="text" name="contact" placeholder="LINE / IG / Phone 擇一">
        </div>

        <div class="join-field">
          <label>上車人數</label>
          <!-- 保留 input；JS 會視情況把它換成 select -->
          <input id="join-seats" type="number" name="seats_needed" min="1" value="1" required>
          <small id="seats-hint" class="muted"></small>
        </div>

        <div class="join-field">
          <label>願付金額 <span class="muted">（選填，單位 NTS）</span></label>
          <input type="number" name="willing_to_pay" min="0" step="1" placeholder="選填">
        </div>

        <!-- 上車地點（縣市下拉 + 自填） -->
        <div class="join-field">
          <label for="join-pickup-select">上車地點</label>

          <!-- 使用下拉做選擇（沒有 name，避免直接提交） -->
          <select id="join-pickup-select">
            <option value="">請選擇縣市</option>
            <option value="其他">其他</option>
            <option value="花蓮縣光復鄉">花蓮縣光復鄉</option>
            <option value="花蓮縣光復車站以外火車站">花蓮縣光復車站以外火車站</option>
            <option value="花蓮縣光復車站">花蓮縣光復車站</option>
            <option value="光復鄉糖廠">光復鄉糖廠</option>
            <option value="需清淤地區">需清淤地區</option>
            <option value="台北市">台北市</option>
            <option value="新北市">新北市</option>
            <option value="基隆市">基隆市</option>
            <option value="桃園市">桃園市</option>
            <option value="新竹市">新竹市</option>
            <option value="新竹縣">新竹縣</option>
            <option value="苗栗縣">苗栗縣</option>
            <option value="台中市">台中市</option>
            <option value="彰化縣">彰化縣</option>
            <option value="南投縣">南投縣</option>
            <option value="雲林縣">雲林縣</option>
            <option value="嘉義市">嘉義市</option>
            <option value="嘉義縣">嘉義縣</option>
            <option value="台南市">台南市</option>
            <option value="高雄市">高雄市</option>
            <option value="屏東縣">屏東縣</option>
            <option value="宜蘭縣">宜蘭縣</option>
            <option value="花蓮縣">花蓮縣</option>
            <option value="台東縣">台東縣</option>
            <option value="澎湖縣">澎湖縣</option>
            <option value="金門縣">金門縣</option>
            <option value="連江縣">連江縣</option>
          </select>

          <!-- 自填（選「其他」才顯示；無 name） -->
          <input type="text" id="join-pickup-custom" placeholder="輸入自訂上車地點" style="display:none;">

          <!-- 真正提交用（有 name） -->
          <input type="hidden" id="join-pickup" name="departure">
        </div>
        
        

        <div class="join-field">
          <label>目的地</label>
          <input type="text" name="destination">
        </div>



        <!-- 出發日期（必填） -->
        <div class="join-field">
          <label for="join-date">出發日期</label>
          <input type="date" id="join-date" name="date" required>
        </div>
        <!-- 是否一起回程 -->
        <div class="join-field">
          <label>是否一起回程？</label>
          <select name="together_return" id="join-together">
            <option value="" selected>未指定</option>
            <option value="true">是</option>
            <option value="false">否</option>
          </select>
        </div>
        <!-- 回程日期 -->
        <div class="join-field" id="returnField" style="display:none;">
          <label for="join-return">回程日期</label>
          <input type="date" id="join-return" name="return_date">
        </div>


        <div class="join-field">
          <label>管理密碼 <span class="muted">（建議 4 碼，供取消/編輯用，預設0000）</span></label>
          <input type="password" name="password" placeholder="建議 4 碼" defaultValue="0000">
        </div>

        <div class="join-field">
          <label>備註 <span class="muted">（可輸入同行人、具體需求…）</span></label>
          <textarea name="note" rows="3" placeholder=""></textarea>
        </div>
      </form>
    </div>

    <div class="modal-footer">
      <button type="button" class="btn-cancel" onclick="closeJoinModal()">取消</button>
      <button type="submit" form="joinForm" class="btn-submit">送出</button>
    </div>
  </div>
</div>

<!-- 乘客編輯授權 Modal -->
<div id="paxAuthModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="paxAuthTitle" style="display:none;">
  <div class="pax-modal-card">
    <div class="pax-modal-head">
      <div class="pax-title-wrap">
        <span class="pax-lock">🔒</span>
        <h3 id="paxAuthTitle" class="pax-title">管理授權</h3>
      </div>
      <button type="button" class="pax-close" aria-label="關閉" onclick="closePaxAuth()">×</button>
    </div>

    <div class="pax-modal-body">
      <p class="pax-desc">請輸入管理密碼以繼續</p>

      <form id="paxAuthForm" method="POST" class="pax-form">
        {% csrf_token %}
        <input type="hidden" id="paxAuthId" name="id">
        <div class="pax-form-row">
          <label for="paxAuthPassword">管理密碼</label>
          <input
            type="password"
            id="paxAuthPassword"
            name="password"
            placeholder="輸入管理密碼"
            required
            autocomplete="current-password"
          >
        </div>
      </form>
    </div>

    <div class="pax-modal-foot">
      <button type="button" class="btn ghost" onclick="closePaxAuth()">取消</button>
      <button type="button" class="btn primary" onclick="submitPaxAuth()">確認</button>
    </div>
  </div>
</div>
<!-- 乘客編輯 Modal -->
<div id="paxEditModal" class="modal" style="display:none;">
  <div class="modal-content">
    <div class="modal-header">
      <span class="title">✏️ 編輯乘客</span>
      <button class="close" onclick="closePaxEdit()">&times;</button>
    </div>
    <div class="modal-body">
      <form id="paxEditForm">
  {% csrf_token %}
  <input type="hidden" id="paxEditId" name="id">

  <div class="join-field">
    <label>暱稱</label>
    <input type="text" id="paxName" name="passenger_name" required>
  </div>

  <div class="join-field">
    <label>性別</label>
    <select id="paxGender" name="gender">
      <option value="X">不方便透漏</option>
      <option value="M">男生</option>
      <option value="F">女生</option>
    </select>
  </div>

  <!-- Email：全寬 -->
  <div class="join-field full">
    <label>Email（不公開）</label>
    <input type="email" id="paxEmail" name="email" placeholder="可空白">
  </div>

  <!-- 隱私設定：Switch，需 Email 才能啟用（全寬） -->
  <div class="join-field full">
    <label>隱私設定</label>
    <div class="switch">
  <input type="checkbox" id="paxHideContact" name="hide_contact">
  <!-- 原本是 <span class="toggle"></span> -->
  <label class="toggle" for="paxHideContact"></label>
  <label class="switch-text" for="paxHideContact">隱藏個資（聯絡方式）</label>
</div>
<small id="paxPrivacyHint" class="muted">※ 需填寫 Email 才能隱藏；Email 僅供系統通知，不會公開。</small>
  </div>

  <div class="join-field">
    <label>聯絡方式</label>
    <input type="text" id="paxContact" name="contact" placeholder="LINE / IG / Phone">
  </div>

  <div class="join-field">
    <label>上車人數</label>
    <input type="number" id="paxSeats" name="seats_needed" min="1" value="1">
  </div>

  <div class="join-field">
    <label>願付金額（可空）</label>
    <input type="text" id="paxPay" name="willing_to_pay" placeholder="例如 300">
  </div>

  <div class="join-field">
    <label>上車地點</label>
    <input type="text" id="paxDeparture" name="departure">
  </div>

  <div class="join-field">
    <label>目的地</label>
    <input type="text" id="paxDestination" name="destination">
  </div>

  <div class="join-field">
    <label>出發日期</label>
    <input type="date" id="paxDate" name="date">
  </div>

  <div class="join-field">
    <label>回程日期（選填）</label>
    <input type="date" id="paxReturn" name="return_date">
  </div>

  <div class="join-field">
    <label>是否一起回程</label>
    <select id="paxTogether" name="together_return">
      <option value="">未指定</option>
      <option value="true">是</option>
      <option value="false">否</option>
    </select>
  </div>

  <!-- 備註：全寬 -->
  <div class="join-field full">
    <label>備註</label>
    <textarea id="paxNote" name="note" rows="3"></textarea>
  </div>
</form>

    </div>
    <div class="modal-footer">
      <button class="btn-cancel" onclick="closePaxEdit()">取消</button>
      <button class="btn-submit" onclick="submitPaxEdit()">儲存</button>
    </div>
  </div>
</div>

<!-- 乘客刪除 Modal（簡單確認） -->
<div id="paxDelModal" class="modal" style="display:none;">
  <div class="modal-content">
    <div class="modal-header">
      <span class="title">🗑 刪除乘客</span>
      <button class="close" onclick="closePaxDel()">&times;</button>
    </div>
    <div class="modal-body">
      <p>確定要刪除這位乘客嗎？此動作無法復原。</p>
      <input type="hidden" id="paxDelId">
    </div>
    <div class="modal-footer">
      <button class="btn-cancel" onclick="closePaxDel()">取消</button>
      <button class="btn-submit" style="background:#e11d48" onclick="confirmPaxDel()">刪除</button>
    </div>
  </div>
</div>

<!-- ③ 說明 Modal -->
<div class="modal fade" id="introModal"
     data-bs-backdrop="false" data-bs-keyboard="true"
     tabindex="-1" aria-labelledby="introModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content shadow-lg">
      <div class="modal-header">
        <h5 class="modal-title fw-bold" id="introModalLabel">使用說明與個資聲明</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="關閉"></button>
      </div>

      <div class="modal-body">
        <!-- 使用說明 -->
        <div class="card border-0 mb-4">
          <div class="card-header bg-primary text-white">
            <strong>如何使用</strong>
          </div>
          <div class="card-body">
            <ul class="intro-list list-unstyled">
            <li class="intro-row">
              <span class="badge bg-primary rounded-pill px-2 py-1">司機</span>
              <span>點「我要出車」，填寫行程後等候乘客報名；有人加入會寄出 Email 通知司機；司機可選擇「接受／拒絕」。座位滿額後，系統會依規則把聯絡方式寄給需要的一方。</span>
            </li>
            <li class="intro-row">
              <span class="badge bg-danger rounded-pill px-2 py-1">乘客</span>
              <span>點「我要搭車」，填寫需求後會出現在列表。司機可依條件是否符合，選擇直接邀請或接受你的報名。</span>
            </li>
          </ul>
          </div>
        </div>

        <!-- 個資與通知規則 -->
        <div class="card border-0 mb-4">
          <div class="card-header bg-info text-white">
            <strong>個資與通知規則</strong>
          </div>
          <div class="card-body">
            <div class="alert alert-info py-2">
              可勾選 <strong>「隱藏個資（聯絡方式）」</strong>。若勾選，<strong>需提供 Email</strong> 以便系統私訊通知；Email 不公開。
            </div>
            <ul class="list-group list-group-numbered">
              <li class="list-group-item">
                <strong>司機未提供 Email</strong>：司機聯絡方式可能公開在卡片上供乘客聯繫。
              </li>
              <li class="list-group-item">
                <strong>通知寄送邏輯</strong>
                <ul class="mt-2 mb-0 ps-3">
                  <li>司機公開、乘客隱藏 → 系統把乘客聯絡方式 Email 給司機。</li>
                  <li>司機隱藏、乘客公開 → 系統把司機聯絡方式 Email 給乘客。</li>
                  <li>兩邊都公開 → 不另外寄信。</li>
                </ul>
              </li>
              <li class="list-group-item">本網站收集的 Email 僅用於媒合通知，不做其他用途。</li>
            </ul>
          </div>
        </div>

        <!-- 資訊公開／免責 -->
        <div class="card border-0 mb-4">
          <div class="card-header bg-secondary text-white">
            <strong>資訊公開聲明與免責</strong>
          </div>
          <div class="card-body">
            <ul class="list-group list-group-flush">
              <li class="list-group-item">本平台為「花蓮光復救災 交通媒合」之自助工具，協助乘客與司機互相找到資訊。</li>
              <li class="list-group-item">平台不參與金錢往來、不介入雙方交易及行為管理。</li>
              <li class="list-group-item">使用者應自行評估風險並負責自身安全與行為；平台不對任何糾紛、損害、失竊、受傷或其他法律責任負責。</li>
              <li class="list-group-item">若有不當行為或爭議，請立即向警方或主管機關報案。</li>
            </ul>
          </div>
        </div>

        <!-- 個資保護建議 -->
        <div class="card border-0">
          <div class="card-header bg-light">
            <strong>個資保護建議</strong>
          </div>
          <div class="card-body">
            <ul class="list-group list-group-flush">
              <li class="list-group-item">僅提供必要聯絡方式；在意隱私可使用 IG、Line ID 等社群帳號聯絡。</li>
              <li class="list-group-item">勿在公開欄位填寫身分證字號、住址、銀行帳號等敏感資訊。</li>
              <li class="list-group-item">遇到不尋常要求（匯款、傳檔、下載 APP 等）請立即停止並求證。</li>
            </ul>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
      </div>
    </div>
  </div>
</div>


<script>
  document.addEventListener('DOMContentLoaded', function() {
  const urlParams = new URLSearchParams(window.location.search);
  
  // 檢查 URL 中是否有 `auth_required` 參數
  if (urlParams.has('auth_required') && urlParams.get('auth_required') === 'true') {
    // 顯示身份驗證對話框
    showToastSafe("為保護個資，請勿使用網址破解登入。", "warning"); // 顯示提示訊息
  }
});
document.addEventListener('DOMContentLoaded', function() {
  // 假設你使用了 `showToastSafe` 函式來顯示錯誤訊息
  const params = new URLSearchParams(window.location.search);
  const error = params.get("error");
  
  if (error) {
    showToastSafe(error, "error");
  }
});
/* =========================================================================
 * 0) 公用小工具（單一來源）
 * ========================================================================= */
function getCookie(name) {
  const match = document.cookie.match(new RegExp('(^|; )' + name + '=([^;]*)'));
  return match ? decodeURIComponent(match[2]) : null;
}
function getCSRF() { return getCookie('csrftoken'); }
 (function initUtils(){
  if (window.__UTILS_READY__) return;
  window.__UTILS_READY__ = true;

  window.$id = (id) => document.getElementById(id);

  window.getCookie = function(name){
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    return parts.length === 2 ? parts.pop().split(';').shift() : null;
  };

  // 從任一表單或 cookie 取 CSRF（優先表單）
 window.getCSRF = function(form) {
  const el = (form || document).querySelector('input[name="csrfmiddlewaretoken"]');
  return el ? el.value : getCookie('csrftoken') || '';
};

  window.showToastSafe = function(msg, type){
    if (typeof showToast === 'function') showToast(msg, type);
    else alert(msg);
  };

  // 安全 JSON 取回：res 失敗或非 JSON 不拋例外
  window.jsonFetch = async function(url, options = {}) {
  const res = await fetch(url, options);
  let data = {};
  try {
    data = await res.json();
  } catch (e) {
    console.error('JSON parsing error:', e);
    data = { ok: false, error: 'Invalid JSON response' };
  }
  return { res, data };
};
})();

/* =========================================================================
 * 1) WebSocket 初始化（單一來源）+ 事件綁定（使用 addEventListener）
 *    - 支援全量 passengers_html
 *    - 支援單卡片 driver_partial → patchDriverCard()
 * ========================================================================= */
(function initSocket(){
  if (!window.socket) {
    window.socket = new WebSocket(
      (location.protocol === 'https:' ? 'wss://' : 'ws://') + window.location.host + '/ws/find/'
    );
  }
  socket.addEventListener('open',  () => console.log('✅ WebSocket 連線成功'));
  socket.addEventListener('close', () => console.log('❌ WebSocket 已關閉'));
  socket.addEventListener('error', (err) => console.error('⚠️ WebSocket 發生錯誤', err));

  socket.addEventListener('message', (event) => {
    let data;
    try { data = JSON.parse(event.data); } catch { return; }

    // 單一卡片更新
    if (data.type === 'driver_partial') {
      // 期待 payload: { type, driver_id, driver_html, active }
      patchDriverCard(data.driver_id, data.driver_html, data.active);
      return;
    }

    // 全量更新（保留乘客清單）
    if (data.type === 'update') {
      if (data.passengers_html) {
        const plist = $id('passenger-list');
        if (plist) plist.innerHTML = data.passengers_html;
      }
      // drivers_html 建議改走 driver_partial；如仍傳入，可視需求處理
      return;
    }

    if (data.type === 'join_result') {
      if (data.success) showToastSafe('✅ 成功加入乘客行程！', 'success');
      else showToastSafe('⚠️ 加入失敗：' + (data.message || '沒有可用的司機'), 'error');
    }
  });
})();

/* =========================================================================
 * 2) Driver 列表：全量替換（保留展開與卷軸） & 單卡片替換
 * ========================================================================= */


 // 記住目前展開的 driver ids
function snapshotOpenDrivers () {
  return Array
    .from(document.querySelectorAll('#driver-list .details.open'))
    .map(el => el.id.replace('details-', ''));
}
// 還原展開狀態（包含箭頭 aria）
function restoreOpenDrivers (openIds) {
  if (!Array.isArray(openIds) || openIds.length === 0) return;
  openIds.forEach(id => {
    const details = document.getElementById('details-' + id);
    const arrow   = document.getElementById('arrow-' + id);
    if (details) {
      details.classList.add('open');
      details.setAttribute('aria-hidden', 'false');
    }
    if (arrow) {
      arrow.classList.add('open');
      arrow.setAttribute('aria-expanded', 'true');
    }
  });
}
// 全量替換 driver list
function replaceDriverListSafely (newHtml) {
  const list = document.getElementById('driver-list');
  if (!list || typeof newHtml !== 'string') return;
  const openIds     = snapshotOpenDrivers();
  const prevScrollY = window.scrollY;
  list.innerHTML = newHtml;
  restoreOpenDrivers(openIds);
  window.scrollTo(0, prevScrollY);
}
// 同時處理 drivers / passengers
function replaceLists (data) {
  if (!data || typeof data !== 'object') return;
  if (typeof data.drivers_html === 'string') replaceDriverListSafely(data.drivers_html);
  if (typeof data.passengers_html === 'string') {
    const p = document.getElementById('passenger-list');
    if (p) p.innerHTML = data.passengers_html;
  }
}

// 取得卡片狀態
function snapshotCardState(li) {
  if (!li) return null;
  const panel    = li.querySelector('.details');
  if (!panel) return { open: false, scrollP: 0, scrollA: 0 };
  const pending  = panel.querySelector('.pending-scroll');
  const accepted = panel.querySelector('.accepted-scroll');
  return {
    open   : panel.classList.contains('open'),
    scrollP: pending  ? pending.scrollTop  : 0,
    scrollA: accepted ? accepted.scrollTop : 0
  };
}
// 還原卡片狀態
function restoreCardState(li, state) {
  if (!li || !state) return;
  const panel = li.querySelector('.details');
  const arrow = li.querySelector('.arrow');
  if (state.open && panel) {
    panel.classList.add('open');
    panel.setAttribute('aria-hidden', 'false');
    if (arrow) {
      arrow.classList.add('open');
      arrow.setAttribute('aria-expanded', 'true');
    }
  }
  const pending  = li.querySelector('.pending-scroll');
  const accepted = li.querySelector('.accepted-scroll');
  if (pending)  pending.scrollTop  = state.scrollP || 0;
  if (accepted) accepted.scrollTop = state.scrollA || 0;
}
// 單一卡片替換 / 附加 / 移除
function patchDriverCard(driverId, driverHTML, active = true) {
  const list = document.getElementById('driver-list');
  if (!list || !driverId || typeof driverHTML !== 'string') return;
  const selector = `li[data-driver="${CSS.escape(String(driverId))}"]`;
  const oldLi = list.querySelector(selector);

  // 不存在：active=true → append
  if (!oldLi) {
    if (!active) return;
    const tmp = document.createElement('div');
    tmp.innerHTML = driverHTML.trim();
    const newLi = tmp.querySelector('li') || tmp.firstElementChild;
    if (newLi) list.appendChild(newLi);
    return;
  }
  // 下架：移除
  if (!active) { oldLi.remove(); return; }

  const state = snapshotCardState(oldLi);
  const tmp = document.createElement('div');
  tmp.innerHTML = driverHTML.trim();
  const newLi = tmp.querySelector('li') || tmp.firstElementChild;
  if (!newLi) return;
  oldLi.replaceWith(newLi);
  restoreCardState(newLi, state);
}
/* ========= 讓展開面板在手機上成為可捲容器 ========= */
function setDetailsMaxHeight(li){
  if (!li) return;
  const details = li.querySelector('.details');
  if (!details || !details.classList.contains('open')) return;

  // 可見窗口剩餘高度：視窗高 - 卡片目前到視窗頂端距離 - 底部緩衝
  const rect   = li.getBoundingClientRect();
  const topGap = Math.max(0, rect.top);
  const safe   = 16; // 底部留白
  const avail  = Math.max(240, window.innerHeight - topGap - safe);

  details.style.maxHeight = avail + 'px';
  details.style.overflow  = 'auto';
  details.style.webkitOverflowScrolling = 'touch';
}

// ---- 單一來源：卡片展開/收合（防重複）----
(function () {
  if (window.__BIND_CARD_TOGGLE__) return;
  window.__BIND_CARD_TOGGLE__ = true;

  // 可捲高度計算（跟你之前的一樣，這裡包成函式）
  function setDetailsMaxHeightByArrow(arrowEl){
    const li = arrowEl.closest('.driver-card');
    if (!li) return;
    const details = li.querySelector('.details');
    if (!details || !details.classList.contains('open')) return;

    const rect   = li.getBoundingClientRect();
    const topGap = Math.max(0, rect.top);
    const safe   = 16; // 底部留白
    const avail  = Math.max(240, window.innerHeight - topGap - safe);

    details.style.maxHeight = avail + 'px';
    details.style.overflow  = 'auto';
    details.style.webkitOverflowScrolling = 'touch';
  }

  let lastToggleAt = 0;

  document.addEventListener('click', function (e) {
    const btn = e.target.closest('[data-action="toggle"]');
    if (!btn) return;

    // 防雙觸發：擋住後續同一輪 listener、也做個 150ms 節流
    e.preventDefault();
    e.stopPropagation();
    if (typeof e.stopImmediatePropagation === 'function') e.stopImmediatePropagation();
    const now = Date.now();
    if (now - lastToggleAt < 150) return;
    lastToggleAt = now;

    const driverId = btn.dataset.id;
    const details  = document.getElementById('details-' + driverId);
    const arrow    = document.getElementById('arrow-' + driverId) || btn;
    if (!details) return;

    // 改用「顯式狀態」避免 toggle 兩次相互抵銷
    const willOpen = !details.classList.contains('open');
    details.classList.toggle('open', willOpen);
    details.setAttribute('aria-hidden', willOpen ? 'false' : 'true');
    if (arrow) {
      arrow.classList.toggle('open', willOpen);
      arrow.setAttribute('aria-expanded', willOpen ? 'true' : 'false');
    }

    // 打開時設定可捲高度；關閉時清除高度
    if (willOpen) {
      setDetailsMaxHeightByArrow(arrow || details);
    } else {
      details.style.maxHeight = '';
      details.style.overflow  = '';
    }
  }, true); // 用捕獲階段，能先於其他 document click 處理並阻斷

  // 旋轉/縮放時，重算所有打開中的
  window.addEventListener('resize', () => {
    document.querySelectorAll('#driver-list .driver-card .details.open')
      .forEach(d => {
        const arrow = d.closest('.driver-card')?.querySelector('.arrow');
        if (arrow) setDetailsMaxHeightByArrow(arrow);
      });
  });
})();



/* =========================================================================
 * 3) Driver 管理授權（密碼驗證 → 成功跳轉）
 *    - openDriverModal(driverId) / closeDriverAuth()
 * ========================================================================= */
(function initDriverAuth(){
  function bindDriverAuthForm() {
    const form = $id("driverAuthForm");
    if (!form || form.dataset.bound === "1") return;

    const idEl  = $id("driverAuthId");
    const pwdEl = $id("driverAuthPassword");

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const driverId = idEl && idEl.value;
      const password = pwdEl && pwdEl.value;
      if (!driverId) { console.error("缺 driverId"); return; }
      if (!password) { showToastSafe("請輸入密碼", "error"); pwdEl && pwdEl.focus(); return; }

      const btn = form.querySelector('[type="submit"]');
      try {
        if (btn) btn.disabled = true;
        const { res, data } = await jsonFetch(`/find/driver/${driverId}/manage/auth/`, {
          method: "POST",
          credentials: "same-origin",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8",
            "X-CSRFToken": getCSRF(form),
            "X-Requested-With": "XMLHttpRequest",
          },
          body: new URLSearchParams({ password }),
        });

        if (res.ok && data && data.ok && data.url) {
          showToastSafe("✅ 驗證成功，前往管理頁…", "success");
          closeDriverAuth();
          window.location.href = data.url;
        } else {
          const msg = (data && (data.error || data.detail)) || `驗證失敗 (HTTP ${res.status})`;
          showToastSafe(msg, "error");
          pwdEl && pwdEl.focus();
        }
      } catch (err) {
        console.error(err);
        showToastSafe("伺服器錯誤，稍後再試", "error");
      } finally {
        if (btn) btn.disabled = false;
      }
    });

    form.dataset.bound = "1";
  }

  window.openDriverModal = function (driverId) {
    const idEl  = $id("driverAuthId");
    const pwdEl = $id("driverAuthPassword");
    const modal = $id("driverAuthModal");
    if (!idEl || !pwdEl || !modal) { alert("管理視窗元件缺失"); return; }
    idEl.value = driverId;
    pwdEl.value = "";
    modal.style.display = "block";
    bindDriverAuthForm();
    setTimeout(() => pwdEl.focus(), 0);
  };
  window.closeDriverAuth = function () {
    const modal = $id("driverAuthModal");
    if (modal) modal.style.display = "none";
  };
  document.addEventListener("DOMContentLoaded", bindDriverAuthForm);
})();

/* =========================================================================
 * 4) Join / Cancel Modal 開關 + 可選 AJAX 送出
 *    - openJoinModal(driverId) / closeJoinModal()
 *    - openCancelModal(passengerId)
 * ========================================================================= */
function openJoinModal(driverId){
  const m = $id('joinModal');
  const f = $id('joinForm');
  if (!m || !f) return;
  f.action = `/find/driver/${driverId}/join/`;
  m.style.display = 'block';
  document.body.classList.add('body-modal-open');
  setTimeout(() => {
    const first = f.querySelector('input,select,textarea');
    if (first) first.focus();
  }, 0);
}
function closeJoinModal(){
  const m = $id('joinModal');
  if (m) m.style.display = 'none';
  document.body.classList.remove('body-modal-open');
}
function openCancelModal(passengerId){
  const m = $id('cancelModal');
  const f = $id('cancelForm');
  const hidden = $id('cancelPassengerId');
  if (!m || !f || !hidden) return;
  hidden.value = passengerId;
  f.action = `/find/passenger/${passengerId}/cancel/`;
  m.style.display = 'block';
}

// 可選：把 join/cancel 攔截成 AJAX
(function enhanceJoinCancel(){
  const joinForm   = $id('joinForm');
  const cancelForm = $id('cancelForm');

  async function ajaxSubmit(form, okMsg){
    const body = new URLSearchParams(new FormData(form));
    const { res, data } = await jsonFetch(form.action, {
      method: 'POST',
      headers: { 'X-Requested-With': 'XMLHttpRequest' },
      body
    });
    if (res.ok && data.ok) {
      showToastSafe(okMsg || '成功', 'success');
      const modal = form.closest('.modal');
      if (modal) modal.style.display = 'none';
    } else {
      const msg = (data && (data.error || data.detail)) || `失敗（${res.status}）`;
      showToastSafe(msg, 'error');
    }
  }

  if (joinForm) {
    joinForm.addEventListener('submit', async (e) => {
      e.preventDefault();             // 要走同步 POST 的話，移除此行
      await ajaxSubmit(joinForm, '✅ 已送出申請');
    });
  }
  if (cancelForm) {
    cancelForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      await ajaxSubmit(cancelForm, '🗑️ 已取消');
    });
  }
})();

</script>
<script>
(function joinModalBehavior(){
  let currentDriverDate   = "";
  let currentDriverReturn = "";

  // 小工具
  const $id = (id)=> document.getElementById(id);

  function grabJoinEls() {
    return {
      togetherSel: $id("join-together"),
      departInput: $id("join-date"),
      returnWrap : $id("returnField"),
      returnInput: $id("join-return"),
      joinModal  : $id("joinModal"),
      joinForm   : $id("joinForm"),
    };
  }

  // 是否一起回程 → 顯示/隱藏回程欄位 + min
  function handleTogetherChange() {
    const { togetherSel, departInput, returnWrap, returnInput } = grabJoinEls();
    const v = togetherSel ? togetherSel.value : "";

    if (returnInput) {
      const minBase = (departInput && departInput.value) || currentDriverDate || "";
      returnInput.min = minBase;
    }

    if (v === "false") {
      if (returnWrap) returnWrap.style.display = "block";
      if (returnInput) {
        returnInput.readOnly = false;
        if (!returnInput.value && returnInput.min) returnInput.value = returnInput.min;
      }
    } else if (v === "true") {
      const hasReturn = !!currentDriverReturn;
      if (returnWrap) returnWrap.style.display = hasReturn ? "block" : "none";
      if (returnInput) {
        returnInput.readOnly = true;
        returnInput.value = hasReturn ? currentDriverReturn : "";
      }
    } else {
      if (returnWrap) returnWrap.style.display = "none";
      if (returnInput) { returnInput.readOnly = false; returnInput.value = ""; }
    }
  }

  // 回程 min ≧ 出發
  function syncReturnMin() {
    const { departInput, returnInput } = grabJoinEls();
    if (!departInput || !returnInput) return;
    returnInput.min = departInput.value || currentDriverDate || "";
    if (returnInput.value && departInput.value && returnInput.value < departInput.value) {
      returnInput.value = "";
    }
  }

  // 依剩餘座位動態限制 seats（支援 <input> 或 <select>）
  function setupSeatsControl(remaining){
    let field = $id("join-seats") || document.querySelector('[name="seats_needed"]');
    if (!field) return;
    if (!field.id) field.id = "join-seats";

    const hint  = $id("seats-hint");
    const submitBtn = document.querySelector('#joinForm .btn-submit');

    const rm = parseInt(remaining || 0, 10);
    if (hint) hint.textContent = rm > 0 ? `剩餘 ${rm} 位` : '此行程座位已滿，無法申請';
    if (submitBtn) submitBtn.disabled = rm <= 0;

    const isSelect = field.tagName.toLowerCase() === 'select';

    const coerce = (val) => {
      let n = parseInt(val || "1", 10);
      if (!Number.isFinite(n) || n < 1) n = 1;
      if (rm > 0 && n > rm) n = rm;
      return String(n);
    };

    if (rm <= 0) {
      field.value = isSelect ? "0" : "";
      field.setAttribute('disabled','disabled');
      field.setCustomValidity('此行程座位已滿');
      return;
    }

    // 有位子 → 解鎖 + 驗證
    field.removeAttribute('disabled');
    field.setCustomValidity('');

    if (isSelect) {
      field.innerHTML = "";
      for (let i = 1; i <= rm; i++) {
        const opt = document.createElement("option");
        opt.value = String(i);
        opt.textContent = String(i);
        field.appendChild(opt);
      }
      field.value = coerce(field.value);
    } else {
      field.type = "number";
      field.min  = "1";
      field.step = "1";
      field.max  = String(rm);
      field.value = coerce(field.value);

      const validate = () => {
        const v = parseInt(field.value || "0", 10);
        if (!Number.isFinite(v) || v < 1) field.setCustomValidity('人數至少為 1');
        else if (v > rm)            field.setCustomValidity(`最多可選 ${rm} 位`);
        else                        field.setCustomValidity('');
      };
      field.oninput = validate;
      field.onchange = validate;
      validate();
    }
  }

  // === 對外 API：開啟 Join Modal（嚴格使用傳入的 remaining） ===
  window.openJoinModal = function (driverId, driverDate = "", driverReturn = "", driverRemaining = 0, _seq = null) {
    if (_seq !== null && _seq !== window.__joinOpenSeq) {
      // 舊的/無效呼叫，直接忽略
      return;
    }
    
    const { togetherSel, departInput, returnWrap, returnInput, joinModal, joinForm } = grabJoinEls();

    // 日期/回程預填
    currentDriverDate   = driverDate || "";
    currentDriverReturn = driverReturn || "";
    if (departInput && currentDriverDate) departInput.value = currentDriverDate;
    if (togetherSel) togetherSel.value = "";
    if (returnInput) { returnInput.value = ""; returnInput.readOnly = false; }
    if (returnWrap)  returnWrap.style.display = "none";
    syncReturnMin();

    // 表單 action + debug 標記
    if (joinForm)  joinForm.action = `/find/driver/${driverId}/join/`;
    if (joinModal) joinModal.dataset.remaining = String(driverRemaining);

    // 依剩餘座位限制 seats
    setupSeatsControl(driverRemaining);

    // 開窗
    if (joinModal) joinModal.style.display = "block";

    // debug
    console.log('[openJoinModal] args', { driverId, driverDate, driverReturn, driverRemaining });
  };

  window.resetReturnDate = function () {
    const { returnInput } = grabJoinEls();
    if (returnInput) returnInput.value = "";
    syncReturnMin();
  };

  // === 單一全域 click handler：計算 remaining 後呼叫 openJoinModal ===
  if (!window.__BIND_JOIN_CLICK__) {
    window.__BIND_JOIN_CLICK__ = true;

    document.addEventListener('click', function (e) {
      const btn = e.target.closest('[data-action="join"]');
      if (!btn) return;
      e.preventDefault();
      e.stopPropagation();
      e.stopImmediatePropagation();

      const id     = btn.dataset.id;
      const date   = btn.dataset.date   || '';
      const ret    = btn.dataset.return || '';
      const total  = parseInt(btn.dataset.total  || '0', 10) || 0;
      const filled = parseInt(btn.dataset.filled || '0', 10) || 0;
      const remaining = Math.max(0, total - filled);

      // 存一份到全域方便除錯
      window.__lastJoinBtn = btn;
      window.__lastRemaining = remaining;
      // 建立「此次點擊」的序號並存到全域
      const seq = Date.now() + Math.random();
      window.__joinOpenSeq = seq;

      // 也寫回 dataset（你在 Console 會看得到 data-remaining）
      btn.dataset.remaining = String(remaining);

      console.log('[join-click]', { id, remaining, total: btn.dataset.total, filled: btn.dataset.filled });

      openJoinModal(id, date, ret, remaining,seq);
    });

    // 同步回程欄位的聯動
    document.addEventListener("change", function (e) {
      if (e.target && e.target.id === "join-together") handleTogetherChange();
      if (e.target && e.target.id === "join-date")     syncReturnMin();
    });
  }
})();
</script>

<script>

/* =========================================================================
 * 6) 參加表單：上車地點（下拉＋自填）→ 同步到隱藏欄位 name="departure"
 *    元素：
 *      #join-pickup-select（含「其他」）
 *      #join-pickup-custom（輸入框，選「其他」才顯示）
 *      #join-pickup（hidden，真正送後端的 departure）
 *      #joinForm
 * ========================================================================= */
(function pickupFieldBinding(){
  if (window.__PICKUP_BIND__) return; // 防重複
  window.__PICKUP_BIND__ = true;

  const PICKUP_SELECT_ID = "join-pickup-select";
  const PICKUP_CUSTOM_ID = "join-pickup-custom";
  const PICKUP_HIDDEN_ID = "join-pickup";
  const JOIN_FORM_ID     = "joinForm";

  function getEls() {
    return {
      sel   : $id(PICKUP_SELECT_ID),
      custom: $id(PICKUP_CUSTOM_ID),
      hidden: $id(PICKUP_HIDDEN_ID),
      form  : $id(JOIN_FORM_ID),
    };
  }
  function applyPickupUI() {
    const { sel, custom } = getEls();
    if (!sel || !custom) return;
    if (sel.value === "其他") {
      custom.style.display = "block";
    } else {
      custom.style.display = "none";
      custom.value = "";
    }
  }
  function syncHidden() {
    const { sel, custom, hidden } = getEls();
    if (!sel || !custom || !hidden) return;
    hidden.value = (sel.value === "其他") ? (custom.value || "").trim() : (sel.value || "");
  }

  // 事件委派一次搞定
  document.addEventListener("change", (e) => {
    if (e.target && e.target.id === PICKUP_SELECT_ID) {
      applyPickupUI(); syncHidden();
    }
  });
  document.addEventListener("input", (e) => {
    if (e.target && e.target.id === PICKUP_CUSTOM_ID) syncHidden();
  });
  document.addEventListener("submit", (e) => {
    const { form } = getEls();
    if (form && e.target === form) syncHidden();
  });

  // 對外重置（打開 Modal 時可用）
  window.resetPickupField = function(){
    const { sel, custom, hidden } = getEls();
    if (!sel || !custom || !hidden) return;
    sel.value = ""; custom.value = ""; custom.style.display = "none"; hidden.value = "";
  };

  // 初始套用一次
  setTimeout(() => { applyPickupUI(); syncHidden(); }, 0);
})();

/* =========================================================================
 * 7) 乘客：密碼驗證 →（編輯｜刪除）/ 編輯儲存 / 刪除
 *    - 事件委派： [data-pax-edit], [data-pax-del]
 *    - 可用 window.afterPaxChanged?.({action, id}) 作為更新鉤子
 * ========================================================================= */
// Modal 開關
function openPaxAuth (pid) {
  const idEl  = $id('paxAuthId');
  const pwdEl = $id('paxAuthPassword');
  const modal = $id('paxAuthModal');
  if (!idEl || !pwdEl || !modal) return;
  idEl.value = pid; pwdEl.value = '';
  modal.style.display = 'block';
  setTimeout(() => pwdEl.focus(), 0);
}
function closePaxAuth () { const m = $id('paxAuthModal'); if (m) m.style.display = 'none'; }
function openPaxEdit ()  { const m = $id('paxEditModal'); if (m) m.style.display  = 'block'; }
function closePaxEdit () { const m = $id('paxEditModal'); if (m) m.style.display  = 'none'; }

let __paxNextAction = null;

// 委派：編輯 / 刪除 → 先驗證密碼
document.addEventListener('click', (e) => {
  const editBtn = e.target.closest('[data-pax-edit]');
  if (editBtn){ e.preventDefault(); __paxNextAction = 'edit';   openPaxAuth(editBtn.dataset.id); return; }
  const delBtn  = e.target.closest('[data-pax-del]');
  if (delBtn){  e.preventDefault(); __paxNextAction = 'delete'; openPaxAuth(delBtn.dataset.id); return; }
});

async function driverManageAuth(driver_id, password) {
  const csrf_token = getCSRF(); // 假設已經有方法取得 CSRF token
  const res = await fetch(`/find/driver/${driver_id}/manage/auth/`, {
    method: "POST",
    headers: {
      "X-CSRFToken": csrf_token, // 帶上 CSRF token
      "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8",
    },
    body: new URLSearchParams({
      password: password
    }),
  });

  const data = await res.json();
  if (res.ok && data.ok) {
    // 成功，跳轉到管理頁面
    window.location.href = data.url;
  } else {
    alert(data.error || "登入失敗");
  }
}

async function submitPaxAuth () {
  const pid = $id('paxAuthId')?.value;
  const pwd = $id('paxAuthPassword')?.value;
  if (!pid || !pwd) { showToastSafe('請輸入密碼', 'error'); return; }

  try {
    const { res, data } = await jsonFetch(`/find/pax/${pid}/auth/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': getCSRF(),
        'X-Requested-With': 'XMLHttpRequest',
        'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8',
      },
      body: new URLSearchParams({ password: pwd })
    });
    if (!res.ok || !data.ok) { showToastSafe(data.error || '驗證失敗', 'error'); return; }
    closePaxAuth();
    if (__paxNextAction === 'delete') { await doPaxDelete(pid); return; }
    if (__paxNextAction === 'edit')   { await loadPaxAndOpenEdit(pid); return; }
  } catch (err) {
    console.error(err);
    showToastSafe('伺服器錯誤，稍後再試'+err, 'error');
  } finally {
    __paxNextAction = null;
  }
}
window.submitPaxAuth = submitPaxAuth;

async function loadPaxAndOpenEdit(pid) {
  const { res, data } = await jsonFetch(`/find/pax/${pid}/get/`, {
    headers: { 'X-Requested-With': 'XMLHttpRequest' }
  });
  if (!res.ok || !data.ok) {
    showToastSafe(data.error || '讀取資料失敗', 'error');
    return;
  }
  const p = data.p || {};

  (document.getElementById('paxEditId')      || {}).value = p.id ?? '';
  (document.getElementById('paxName')        || {}).value = p.passenger_name ?? '';
  (document.getElementById('paxGender')      || {}).value = p.gender ?? 'X';
  (document.getElementById('email')          || {}).value = p.email ?? '';           // ← 改這裡
  (document.getElementById('paxContact')     || {}).value = p.contact ?? '';
  (document.getElementById('paxSeats')       || {}).value = p.seats_needed ?? 1;
  (document.getElementById('paxPay')         || {}).value = p.willing_to_pay ?? '';
  (document.getElementById('paxDeparture')   || {}).value = p.departure ?? '';
  (document.getElementById('paxDestination') || {}).value = p.destination ?? '';
  (document.getElementById('paxDate')        || {}).value = p.date ?? '';
  (document.getElementById('paxReturn')      || {}).value = p.return_date ?? '';
  (document.getElementById('paxTogether')    || {}).value =
    (p.together_return === true ? 'true' : p.together_return === false ? 'false' : '');
  (document.getElementById('paxNote')        || {}).value = p.note ?? '';

  // 隱私 checkbox
  const hideEl = document.getElementById('hide_contact');   // ← 改這裡
  if (hideEl) {
    hideEl.checked  = !!(p.hide_contact && p.email);        // 有填 email 才能為 true
    hideEl.disabled = !p.email;                              // 沒 email 一律禁用
  }

  openPaxEdit();

  // 讓開關腳本再跑一次（若你有那段 window.syncPrivacySwitch）
  window.syncPrivacySwitch && window.syncPrivacySwitch();
}
window.loadPaxAndOpenEdit = loadPaxAndOpenEdit;



function openPaxEdit () {
  const m = document.getElementById('paxEditModal');
  if (m) m.style.display = 'block';
}
window.openPaxEdit = openPaxEdit;

function closePaxEdit () {
  const m = document.getElementById('paxEditModal');
  if (m) m.style.display = 'none';
}
window.closePaxEdit = closePaxEdit;

async function doPaxDelete (pid) {
  if (!confirm('確定要刪除這位乘客嗎？此動作無法復原。')) return;
  try {
    const { res, data } = await jsonFetch(`/find/pax/${pid}/delete/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': getCSRF(),
        'X-Requested-With': 'XMLHttpRequest',
        'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8',
      },
      body: new URLSearchParams()
    });
    if (!res.ok || !data.ok) { showToastSafe(data.error || '刪除失敗', 'error'); return; }
    showToastSafe('🗑️ 已刪除乘客', 'success');
    window.afterPaxChanged && window.afterPaxChanged({ action: 'delete', id: Number(pid) });
  } catch (err) {
    console.error(err);
    showToastSafe('伺服器錯誤，稍後再試'+err, 'error');
  }
}

/* =========================================================================
 * 8) 乘客編輯 Modal：together_return 與回程日期聯動
 * ========================================================================= */
(function paxEditReturnLink(){
  const togetherSel = document.getElementById('paxTogether');
  const returnInput = document.getElementById('paxReturn');
  function syncReturnState () {
    if (!togetherSel || !returnInput) return;
    const v = togetherSel.value;
    if (v === 'true') {
      returnInput.value = '';
      returnInput.disabled = true;
      returnInput.placeholder = '與司機回程日期相同';
      returnInput.classList.add('is-disabled');
    } else {
      returnInput.disabled = false;
      returnInput.placeholder = '';
      returnInput.classList.remove('is-disabled');
    }
  }
  if (togetherSel && returnInput) {
    togetherSel.addEventListener('change', syncReturnState);
  }
  window.syncPaxReturnOnce = syncReturnState; // 可在打開編輯 Modal 後呼叫一次
})();

/* =========================================================================
 * 9) 頁面級事件委派：管理 / 參加 / 展開（避免動態內容失效）
 * ========================================================================= */
document.addEventListener('click', function (e) {
  const btn = e.target.closest('[data-action]');
  if (!btn) return;

  const action   = btn.dataset.action;
  const driverId = btn.dataset.id;
  if (!action || !driverId) return;

  if (action === 'manage') {
    e.preventDefault();
    openDriverModal(driverId);
    return;
  }
  if (action === 'join') {
    e.preventDefault();
    // 若 _driver_list.html 上有 data-date / data-return 就讀取，否則 fallback
    openJoinModal(driverId, btn.dataset.date || "", btn.dataset.return || "");
    return;
  }
  if (action === 'toggle') {
    e.preventDefault();
    const details = $id('details-' + driverId);
    const arrow   = $id('arrow-' + driverId) || btn;
    if (!details) return;
    const isOpen = details.classList.toggle('open');
    arrow.classList.toggle('open', isOpen);
    arrow.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
    details.setAttribute('aria-hidden', isOpen ? 'false' : 'true');
    return;
  }
});

/* =========================================================================
 * 10) 其他：後端事件（可選）。例：透過 WS 主動告知「管理某司機」
 * ========================================================================= */
// 即時檢查 join 人數是否超過剩餘座位
document.addEventListener('input', function(e){
  if (e.target && e.target.id === 'join-seats') {     // 如果你的 input id 不同，請改這裡
    const wanted = parseInt((e.target.value || '1'), 10);
    const rm = parseInt(($id('joinModal')?.dataset.remaining || '0'), 10);

    if (Number.isFinite(rm) && rm > 0 && wanted > rm) {
      e.target.setCustomValidity(`人數超過剩餘座位（剩 ${rm} 位）`);
    } else {
      e.target.setCustomValidity('');
    }
  }
});

 window.manageDriver = function (driverId) {
  try { socket.send(JSON.stringify({ action: 'driver_manage', driver_id: driverId })); }
  catch (e) { console.warn('WS send 失敗', e); }
};


// 綁定一組出發/回程欄位的防呆
// params: { depart: '#出發input', ret: '#回程input', form: '#表單', msg?: '自訂錯誤訊息' }
function bindDateGuard({ depart, ret, form, msg }){
  const dep = document.querySelector(depart);
  const rtn = document.querySelector(ret);
  const frm = form ? document.querySelector(form) : null;
  if(!dep || !rtn) return;

  // 即時：回程最小日 ≧ 出發
  function syncMin(){
    rtn.min = dep.value || '';
    if(rtn.value && dep.value && rtn.value < dep.value){
      rtn.value = ''; // 自動清空無效值
    }
  }
  dep.addEventListener('change', syncMin);
  // 初始跑一次
  syncMin();

  // 送出時：硬性檢查，不符就擋下
  function checkOnSubmit(e){
    if(dep.value && rtn.value && rtn.value < dep.value){
      e && e.preventDefault();
      alert(msg || '回程日期不可早於出發日期');
      rtn.focus();
      return false;
    }
    return true;
  }

  if(frm){
    frm.addEventListener('submit', checkOnSubmit);
  }
  // 若要在 JS 手動檢查也能呼叫：
  return { check: checkOnSubmit, syncMin };

  document.addEventListener('DOMContentLoaded', () => {
  bindDateGuard({
    depart: '#paxDate',
    ret: '#paxReturn',
    form: '#paxEditForm'
  });
});
}

</script>
<script>
(function(){
  const KEY = 'filterPanelOpen';
  const DURATION_MS = 1500; // 想調整動畫速度就改這裡（同時也改你的 CSS 變數更一致）

  // 1) 統一用事件委派，避免抓不到節點
  document.addEventListener('click', function(e){
    const toggleBtn = e.target.closest('.panel-toggle');
    const headBar   = e.target.closest('#panelHead');
    if (!toggleBtn && !headBar) return;

    const panel = document.getElementById('filterPanel');
    if (!panel) { console.warn('[panel] not found'); return; }

    // 避免點到表單控件時誤觸收合
    if (headBar) {
      const tag = (e.target.tagName || '').toLowerCase();
      if (['select','input','button','textarea','label'].includes(tag)) return;
    }
    e.stopPropagation();
    e.preventDefault();

    __toggleFilterPanel(true); // 帶 true 代表來源於點擊
  });

  // 2) 初始化（等 DOM ready）
  document.addEventListener('DOMContentLoaded', function(){
    const panel = document.getElementById('filterPanel');
    if (!panel) { console.warn('[panel] not found on DOMContentLoaded'); return; }

    const body = panel.querySelector('.panel-bd');
    if (!body) { console.warn('[panel-bd] not found'); return; }

    // ⛏️ 清除任何會破壞動畫的 inline/computed display
    body.style.removeProperty('display');

    // 若有外部 CSS 設了 display:none，這裡強制覆蓋
    const cs = getComputedStyle(body);
    if (cs.display === 'none') {
      body.style.display = 'block';
    }

    // 讀取 localStorage 狀態；沒有就沿用 HTML 的 aria-expanded
    try{
      const saved = localStorage.getItem(KEY);
      if (saved === '1' || saved === '0') {
        panel.setAttribute('aria-expanded', saved === '1' ? 'true' : 'false');
      }
    }catch{}

    const open = panel.getAttribute('aria-expanded') === 'true';
    if (open) {
      body.style.maxHeight = 'none';
      body.style.opacity = '1';
    } else {
      body.style.maxHeight = '0px';
      body.style.opacity = '0';
    }

    console.log('[filterPanel] init',
      { open, aria: panel.getAttribute('aria-expanded'), display: getComputedStyle(body).display });
  });

  // 3) 真正的切換函式（也丟到全域方便 debug）
  function __toggleFilterPanel(fromClick){
    const panel = document.getElementById('filterPanel');
    if (!panel) return;
    const body = panel.querySelector('.panel-bd');
    if (!body) return;

    // 再次保險：移除會干擾動畫的 display 設定
    body.style.removeProperty('display');
    if (getComputedStyle(body).display === 'none') {
      body.style.display = 'block';
    }

    const willOpen = panel.getAttribute('aria-expanded') !== 'true';
    panel.setAttribute('aria-expanded', willOpen ? 'true' : 'false');

    // 動畫：用 max-height 從 0 → scrollHeight，或反向
    body.style.transition = 'none';
    if (willOpen) {
      body.style.maxHeight = '0px';
      body.style.opacity = '0';
      requestAnimationFrame(()=>{
        const h = body.scrollHeight;
        body.style.transition = `max-height ${DURATION_MS}ms ease, opacity ${DURATION_MS}ms ease`;
        body.style.maxHeight = h + 'px';
        body.style.opacity = '1';
      });
    } else {
      const h = body.scrollHeight;
      body.style.maxHeight = h + 'px';
      body.style.opacity = '1';
      requestAnimationFrame(()=>{
        body.style.transition = `max-height ${DURATION_MS}ms ease, opacity ${DURATION_MS}ms ease`;
        body.style.maxHeight = '0px';
        body.style.opacity = '0';
      });
    }

    try{ localStorage.setItem(KEY, willOpen ? '1' : '0'); }catch{}

    console.log('[filterPanel] toggle',
      { fromClick: !!fromClick, willOpen,
        aria: panel.getAttribute('aria-expanded'),
        display: getComputedStyle(body).display });
  }
  window.__toggleFilterPanel = __toggleFilterPanel;

  // 4) 動畫結束後如果是展開就清 max-height，保持自適應高度
  document.addEventListener('transitionend', function(e){
    const el = e.target;
    if (!el.classList || !el.classList.contains('panel-bd')) return;
    if (e.propertyName !== 'max-height') return;

    const panel = document.getElementById('filterPanel');
    if (!panel) return;
    const open = panel.getAttribute('aria-expanded') === 'true';
    if (open) {
      el.style.transition = 'none';
      el.style.maxHeight = 'none';
      requestAnimationFrame(()=>{ el.style.transition = ''; });
    }
  });
})();


async function submitPaxEdit() {
  try {
    const form = document.getElementById('paxEditForm');
    const fd   = new FormData(form);

    // 後端會用 on/true/1/yes 判斷，checkbox 未勾不會出現在 FormData → 不用特別處理
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || "";

    const url = form.dataset.postUrl || form.getAttribute('action') || `/find/pax/${document.getElementById('paxEditId').value}/update/`;

    const res = await fetch(url, {
      method: "POST",
      headers: {
        "X-Requested-With": "XMLHttpRequest",
        "X-CSRFToken": csrftoken
      },
      body: fd
    });

    const raw = await res.text();
    let data; try { data = JSON.parse(raw); } catch { data = null; }
    console.log("[pax-update] status:", res.status, "body:", raw);

    if (!res.ok || !data || data.ok !== true) {
      alert(`更新失敗${!res.ok ? `（HTTP ${res.status}）` : ''}`);
      return;
    }

    // 成功：關掉 modal，等 WebSocket 廣播把列表與管理頁兩側刷新
    closePaxEdit();
  } catch (e) {
    console.error(e);
    alert("更新失敗（前端例外）");
  }
}


function initPaxPrivacyBinding () {
  const email = document.getElementById('paxEmail');
  const hide  = document.getElementById('paxHideContact');
  const hint  = document.getElementById('paxPrivacyHint');

  function sync() {
    const hasEmail = !!(email && email.value && email.value.includes('@'));
    if (hide) {
      hide.disabled = !hasEmail;
      if (!hasEmail) hide.checked = false;
    }
    if (hint) {
      if (hasEmail) {
        hint.classList.remove('hint-error');
        hint.textContent = '※ 需填寫 Email 才能隱私；Email 僅供系統通知，不會公開。';
      } else {
        hint.classList.add('hint-error');
        hint.textContent = '※ 尚未填寫 Email，無法隱藏聯絡方式。';
      }
    }
  }

  // 解除舊的監聽，避免重複綁定
  if (email && email._syncPrivacy) email.removeEventListener('input', email._syncPrivacy);
  if (email) {
    email._syncPrivacy = sync;
    email.addEventListener('input', sync);
  }
  sync();
}
window.initPaxPrivacyBinding = initPaxPrivacyBinding;

// --- Email 與隱藏開關的可用性連動 (司機) ---
(function bindDriverPrivacy(){
  const mail = document.getElementById('driverEmail');
  const sw   = document.getElementById('driverHide');
  if (!mail || !sw) return;

  const sync = ()=> {
    const hasEmail = !!(mail.value && mail.value.includes('@'));
    sw.disabled = !hasEmail;
    if (!hasEmail) sw.checked = false;
  };
  mail.addEventListener('input', sync);
  sync();

  // 可選：立即送出到後端（若你是分開的儲存鈕，就略過這段）
  sw.addEventListener('change', async ()=>{
    const driverId = document.getElementById('driverIdHidden')?.value || '{{ d.id }}';
    const {res, data} = await jsonFetch(`/find/driver/${driverId}/privacy/`, {
      method: 'POST',
      headers: {'X-CSRFToken': getCSRF(), 'X-Requested-With':'XMLHttpRequest','Content-Type':'application/x-www-form-urlencoded;charset=UTF-8'},
      body: new URLSearchParams({ hide: sw.checked ? 'true' : 'false' })
    });
    if (res.ok && data?.ok) showToastSafe(sw.checked?'🔒 已隱藏聯絡方式':'👁️ 已顯示聯絡方式','success');
    else { showToastSafe(data?.error||'切換失敗','error'); sw.checked = !sw.checked; }
  });
})();

// --- 乘客（編輯 Modal） ---
(function bindPaxPrivacy(){
  const mail = document.getElementById('paxEmail');
  const sw   = document.getElementById('paxHide');
  if (!mail || !sw) return;

  const sync = ()=> {
    const hasEmail = !!(mail.value && mail.value.includes('@'));
    sw.disabled = !hasEmail;
    if (!hasEmail) sw.checked = false;
  };
  mail.addEventListener('input', sync);
  sync();

  // 送出
  sw.addEventListener('change', async ()=>{
    const paxId = document.getElementById('paxEditId')?.value;
    if (!paxId){ sw.checked = !sw.checked; return; }
    const {res, data} = await jsonFetch(`/find/pax/${paxId}/privacy/`, {
      method: 'POST',
      headers: {'X-CSRFToken': getCSRF(), 'X-Requested-With':'XMLHttpRequest','Content-Type':'application/x-www-form-urlencoded;charset=UTF-8'},
      body: new URLSearchParams({ hide: sw.checked ? 'true' : 'false' })
    });
    if (res.ok && data?.ok) showToastSafe(sw.checked?'🔒 已隱藏聯絡方式':'👁️ 已顯示聯絡方式','success');
    else { showToastSafe(data?.error||'切換失敗','error'); sw.checked = !sw.checked; }
  });
})();


</script>




</body>
</html>
<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>ğŸŒ èŠ±è“®å…‰å¾©æ•‘ç½äº¤é€šåª’åˆ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script defer src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <!-- <link
  href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
  rel="stylesheet"
  integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
  crossorigin="anonymous"
/> -->
<!-- <script
  src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
  integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
  crossorigin="anonymous"
></script> -->
<style>
/* ==========================================================================
   å…¨ç«™åŸºç¤ï¼šå­—é«”ã€èƒŒæ™¯ã€ä¸»æ¨™é¡Œ/å°æ¨™é¡Œ
   ========================================================================== */
body{
  font-family:"Microsoft JhengHei",sans-serif;
  margin:0; padding:0;
  background:linear-gradient(to right,#eaf8ff,#f7fff7);
  color:#222;
}
h1{ text-align:center; padding:20px; color:#005c4b; }
h2{ color:#00695c; margin:20px; font-size:20px; }

/* ==========================================================================
   é¦–é 3é¡†ä¸»åŠŸèƒ½æŒ‰éˆ•
   ========================================================================== */
/* ä¸»æ“ä½œå€ï¼šæ¡Œæ©Ÿç½®ä¸­ã€æ‰‹æ©Ÿä¸‰æ¬„ä¸€åˆ— */
.hero-actions{
  display:flex;
  gap:14px;
  align-items:center;
  justify-content:center;
  margin:10px 0 18px;
}

/* å…±ç”¨ä¸»æŒ‰éˆ•å¤–è§€ï¼ˆä½ åŸæœ¬ btn-main å¯æ²¿ç”¨ï¼›é€™è£¡è£œäº›ç´°ç¯€ï¼‰ */
.btn-main{
  display:inline-flex; align-items:center; justify-content:center;
  gap:.5rem; padding:12px 22px; border-radius:999px;
  font-weight:800; letter-spacing:.5px; border:1px solid transparent;
  box-shadow:0 6px 24px rgba(0,0,0,.08); cursor:pointer;
  transition:transform .08s ease, box-shadow .2s ease, background .2s ease, border-color .2s ease;
}
.btn-main .ico{ font-size:1.05rem; line-height:1; }

/* ä¸‰ç¨®è‰²ç³» */
.btn-driver   { background:#0b74ff; color:#fff; }
.btn-driver:hover{ background:#0a61d6; transform:translateY(-1px); }

.btn-passenger{ background:#e53545; color:#fff; }
.btn-passenger:hover{ background:#c92f3e; transform:translateY(-1px); }

/* èªªæ˜ï¼å¹½éˆè† å›ŠæŒ‰éˆ•ï¼ˆäº®è‰²æé‚Š + ç»ç’ƒæ„Ÿï¼‰ */
.btn-ghost{
  background:rgba(255,255,255,.75);
  color:#334155;
  border-color:#d9e1ec;
  backdrop-filter:saturate(180%) blur(6px);
}
.btn-ghost:hover{
  background:#f2f6fb;
  border-color:#c7d3e4;
  color:#0f172a;
  transform:translateY(-1px);
}
.btn-ghost:focus-visible{
  outline:none;
  box-shadow:0 0 0 3px rgba(59,130,246,.25);
}

/* æ‰‹æ©Ÿï¼šä¸‰æ¬„ä¸€åˆ—ã€æ»¿ç‰ˆæŒ‰éˆ• */
@media (max-width:640px){
  .hero-actions{
    display:grid;
    grid-template-columns:repeat(3,1fr);  /* ä¸‰æ¬„ä¸€åˆ— */
    gap:10px;
    padding:0 10px;
  }
  .btn-main{ width:100%; padding:12px 10px; font-size:15px; }
  .btn-main .ico{ font-size:1rem; }
}

/* =============== èªªæ˜æŒ‰éˆ•ï¼ˆå’Œä½ ç¾æœ‰è—è‰²ç³»ä¸€è‡´ï¼‰ =============== */
/* èªªæ˜å€ç¸®æ’ï¼ˆå¾½ç« å·¦ã€æ–‡å­—å³ï¼›æ›è¡Œè‡ªå‹•å°é½Šï¼‰ */
.intro-list { margin: 0; padding-left: 0; }
.intro-row {
  display: grid;
  grid-template-columns: auto 1fr; /* å¾½ç« å›ºå®šå¯¬ã€æ–‡å­—ä½”æ»¿ */
  column-gap: .5rem;
  row-gap: .25rem;
  align-items: start;
  margin-bottom: .5rem;            /* æ¯æ¢ä¹‹é–“é–“è· */
}
.intro-row .badge {
  white-space: nowrap;             /* å¾½ç« ä¸æ›è¡Œ */
  font-weight: 600;
}
.intro-row span:last-child {
  line-height: 1.7;                /* æ–‡å­—è¡Œè·èˆ’é© */
}

/* ==========================================================================
   å¡ç‰‡ï¼ˆDriver/Passenger åˆ—è¡¨ï¼‰ï¼‹ å·¦å´è‰²æ¢
   ========================================================================== */
/* æ›´è²¼å·¦ã€è¼ƒè–„çš„å¡ç‰‡ */
.card{
  display:flex;
  align-items:left;
  justify-content:space-between;
  background:#fff;
  margin:3px;                 /* å–æ¶ˆå¥‡æ€ªçš„è² é‚Šè·ï¼Œå·¦å³ä¸ç¸®é€² */
  padding:8px 12px 8px 24px;    /* ä¸Šä¸‹è®Šè–„ã€å·¦é‚Šå¤šä¸€é»ç©ºé–“çµ¦è‰²æ¢ */
  border-radius:8px;            /* æ¯” 1px å¥½çœ‹è¨±å¤š */
  box-shadow:0 2px 6px rgba(0,0,0,.08);
  position:relative;
  flex-wrap:wrap;
  animation:fadeInUp .3s ease-out;
}

/* è®“è‰²æ¢å¾®å¾®çªå‡ºåˆ°å¡ç‰‡å¤–ï¼Œè¦–è¦ºä¸Šæ›´é å·¦ï¼Œä½†ä¸éœ€è¦è² é‚Šè· */
.card::before{
  content:"";
  position:absolute;
  top:0;
  bottom:0;       /* ç­‰åŒæ–¼ height:100% + æ›´ç©©å®š */
  left:10px;      /* å‘å·¦çªå‡º 8pxï¼Œé”åˆ°ã€Œè²¼å·¦ã€æ•ˆæœ */
  width:6px;
  border-radius:6px 0 0 6px;
}

.driver-card::before{ background:#2196f3; }
.passenger-card::before{ background:#f44336; }

/* 1) å–æ¶ˆ UL é è¨­ç¸®æ’ï¼šå¡ç‰‡ä¸è¦è¢«æ¨åˆ°å³å´ */
#driver-list,
#passenger-list {
  list-style: none;
  margin: 0;
  padding: 0;        /* â† é€™è¡Œæ˜¯é‡é» */
}

/* å¦‚æœæœ‰å…¶å®ƒå®¹å™¨å° ul/li åšäº† padding-leftï¼Œä¹Ÿä¸€ä½µæ­¸é›¶ */
#driver-list > li,
#passenger-list > li {
  margin-left: 0;
}

/* ==========================================================================
   å¸æ©Ÿå¡ç‰‡ä¸‰æ¬„æ’ç‰ˆï¼ˆå·¦ï¼šæš±ç¨±åº§ä½ / ä¸­ï¼šä¸‰è¡Œ / å³ï¼šæ“ä½œèˆ‡ç®­é ­ï¼‰
   ========================================================================== */
.driver-grid{
  display:grid; grid-template-columns:minmax(140px,200px) 1fr auto;
  column-gap:10px; align-items:center; width:100%;
}
/* å·¦æ¬„ï¼šæš±ç¨± - åº§ä½ */
.col-left{ display:flex; align-items:center; justify-content:flex-start; height:100%; font-size:15px; }
.name-seat{ font-size:15px; color:#222; margin:0; }
/* ä¸­æ¬„ï¼šä¸‰è¡Œè³‡è¨Š */
.col-middle .line{ display:block; margin:2px 0; }
.col-middle .line1{ font-size:16px; color:#222; }
.col-middle .line2, .col-middle .line3{ font-size:14px; color:#444; }
/* å³æ¬„ï¼šæ“ä½œæŒ‰éˆ•ï¼‹ç®­é ­ */
.col-actions{ display:flex; align-items:center; justify-content:flex-end; gap:6px; }

/* å±•é–‹å€å¡Šé‹ªæ»¿æ•´åˆ— */
.details{ grid-column:1 / -1; }

/* ==========================================================================
   å±•é–‹/æ”¶åˆï¼šç®­é ­æ—‹è½‰ã€çµ²æ»‘é–‹åˆï¼›ç®¡ç†/åƒåŠ æŒ‰éˆ•è‰²ç³»
   ========================================================================== */
.driver-card .arrow{
  cursor:pointer; margin-left:6px; min-width:36px; min-height:36px;
  font-size:16px; color:#333; background:transparent; border:0;
  transition:transform .25s ease;
}
.driver-card .arrow.open{ transform:rotate(90deg); }

.driver-card .details{
  margin-top:0px; max-height:0; overflow:hidden; padding:0px 0px;
  background: transparent; border:0 #e6e6e6;
  transition:max-height 1.2s ease, padding 1s ease;
}
/* å±•é–‹æ™‚å†åŠ å›å¤–è§€ */
.driver-card .details.open {
  margin-top: 8px;
  max-height: 650px;
  padding: 10px;
  background: #f9f9f9;
  border-top: 1px solid #e6e6e6;
  border-radius: 6px;
}

.driver-card .btn-manage{ background:#007bff; color:#fff; border:0; border-radius:6px; padding:6px 10px; }
.driver-card .btn-manage:hover{ background:#0056b3; }
.driver-card .btn-join{ background:#28a745; color:#fff; border:0; border-radius:6px; padding:6px 10px; }
.driver-card .btn-join:hover{ background:#1e7e34; }

/* æ‰‹æ©Ÿä¸Šï¼šå±•é–‹é¢æ¿æœ¬èº«å¯æ²ï¼Œå…©å€‹ä¹˜å®¢æ¸…å–®ä¹Ÿå„è‡ªå¯æ² */
@media (max-width: 640px) {
  .driver-card .details.open {
    /* JS æœƒå¡ max-heightï¼Œé€™è£¡ä¿ä¸€å€‹ä¿åº•å€¼ */
    max-height: 72svh;
    overflow: auto;
    -webkit-overflow-scrolling: touch;
    margin-bottom: 12px;
    background: #fff;
    border-radius: 10px;
    box-shadow: 0 6px 16px rgba(0,0,0,.08);
  }
  .driver-card .pax-scroll {
    max-height: 28svh;         /* æ¯æ¬„å„è‡ªä¸Šé™ï¼Œé¿å…æ’ç ´ */
    overflow: auto;
    -webkit-overflow-scrolling: touch;
  }
}

/* =============================================================================
   A. ä¹˜å®¢æ¸…å–®ï¼ˆå¾…ç¢ºèª / å·²æ¥å—ï¼‰å¡ç‰‡æ¨£å¼
   ========================================================================== */

/* æ¸…å–®å®¹å™¨ï¼ˆèˆŠ two-col ä¿ç•™ï¼ŒæŸäº›é é¢å¯èƒ½ä»åœ¨ç”¨ï¼‰ */
.pax-section{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:16px;
  align-items:start;
}
@media (max-width: 860px){
  .pax-section{ grid-template-columns: 1fr; }
}

.pax-list{ list-style:none; padding:0; margin:8px 0 0; }
.pax-item{
  box-sizing:border-box;
  background:#fff;
  border:1px solid #e5e7eb;
  border-radius:10px;
  padding:12px 14px;
  margin:8px 0;
}

/* æ¯ç­†ï¼šå·¦æ–‡å­—ï¼ˆå…©è¡Œï¼‰ + å³æŒ‰éˆ• */
.pax-2col{
  display:grid;
  grid-template-columns: 1fr auto;
  column-gap: 12px;
  align-items:center;
}
.pax-left{ min-width:0; }
.pax-title{
  font-weight:700;
  font-size:15px;
  color:#111827;
  line-height:1.25;
}
.pax-sub{
  margin-top:2px;
  font-size:13px;
  color:#4b5563;
  line-height:1.3;
}
.pax-actions{ display:inline-flex; gap:8px; white-space:nowrap; }

.btn-mini{
  border:0; border-radius:8px; padding:6px 10px; background:#e5e7eb; cursor:pointer;
}
.btn-mini:hover{ background:#d1d5db; }
.btn-mini.danger{ background:#fecaca; color:#7f1d1d; }
.btn-mini.danger:hover{ background:#fca5a5; }

/* å·²æ¥å—ï¼šç¶ è‰²åº•æç¤º */
.pax-item.pax-accepted{ background:#f0fdf4; border:1px solid #bbf7d0; }
.pax-item.pax-accepted .pax-title .check{
  display:inline-block; margin-right:6px; color:#16a34a; font-weight:800;
}
.pax-item.pax-accepted .btn-mini{ background:#e7f5ec; }
.pax-item.pax-accepted .btn-mini:hover{ background:#d9f0e4; }

/* æ‰‹æ©ŸæŒ‰éˆ•è½åˆ°ä¸‹æ–¹ */
@media (max-width: 640px){
  .pax-2col{ grid-template-columns:1fr; row-gap:8px; align-items:start; }
  .pax-actions{ justify-content:flex-start; }
}

/* è‡ªè¨‚å·è»¸ï¼ˆæ·¡æ·¡çš„ï¼‰ */
.pax-scroll::-webkit-scrollbar,
.pending-scroll::-webkit-scrollbar{ width:8px; }
.pax-scroll::-webkit-scrollbar-thumb,
.pending-scroll::-webkit-scrollbar-thumb{ background:#d5d9e0; border-radius:6px; }
.pax-scroll::-webkit-scrollbar-track,
.pending-scroll::-webkit-scrollbar-track{ background:transparent; }


/* =============================================================================
   B. è©³ç´°å€å¡Šï¼šä¸‰æ¬„ï¼ˆæ¡Œæ©Ÿï¼‰= å·¦ï¼šå¸æ©Ÿè³‡è¨Š / ä¸­ï¼šå¾…ç¢ºèª / å³ï¼šå·²æ¥å—
   ========================================================================== */

/* ä½ çš„ details é–‹é—”å‹•ç•«ï¼ˆä¿ç•™ï¼‰ */
.details{
  margin-top:8px; max-height:0; overflow:hidden; padding:8px 10px;
  background:#f9f9f9; border-top:1px solid #e6e6e6; border-radius:6px;
  transition:max-height .35s ease, padding .25s ease;
}
.details.open{ max-height:1200px; padding:10px; }

/* ä¸‰æ¬„å®¹å™¨ï¼ˆæ¡Œæ©Ÿï¼‰ */
.details-grid3{
  /* å¯èª¿é«˜åº¦ï¼šä¸‰æ¬„åŒé«˜ï¼Œå…§å®¹è¶…å‡ºå‰‡å„è‡ªå‡ºç¾å·è»¸ */
  --panel-h: 340px;

  display:grid;
  grid-template-columns: minmax(420px, 2fr) minmax(320px, 1fr) minmax(320px, 1fr);
  gap:16px;
  align-items:stretch;  /* ä¸‰æ¬„æ‹‰é½Š */
}

/* æ¬„ä½å…§ç›’ï¼šçµ¦ä¸‰æ¬„çµ±ä¸€é«˜åº¦èˆ‡å·è»¸ç”¨ */
.details-col{
  height: var(--panel-h);
  min-height: 0;          /* é‡è¦ï¼šè®“ grid å…§å…ƒç´ å¯ä»¥æ­£ç¢º overflow */
  background:#fff;
  border:1px solid #e5e7eb;
  border-radius:10px;
  overflow:auto;
  padding:14px 16px;
  box-shadow: 0 1px 2px rgba(0,0,0,.03);
}

/* ä¸­ã€å³æ¬„æ¨™é¡Œ */
.pax-panel-title{
  margin:0 0 10px;
  font-weight:800;
  font-size:15px;
  color:#0f172a;
  display:flex; align-items:center; gap:6px;
}

/* ä¸­ã€å³æ¬„åˆ—è¡¨å®¹å™¨ï¼ˆç­‰é«˜å·è»¸ï¼‰ */
.pax-scroll{
  height: calc(var(--panel-h) - 38px); /* æ‰£æ‰æ¨™é¡Œå€é«˜åº¦(ç´„) */
  overflow:auto;
  padding-right:6px;
}

/* RWDï¼šâ‰¤980px å›å–®æ¬„ï¼Œä¸è¦å›ºå®šé«˜åº¦èˆ‡å·è»¸ */
@media (max-width: 980px){
  .details-grid3{ grid-template-columns:1fr; }
  .details-col{ height:auto; overflow:visible; }
  .pax-scroll{ height:auto; overflow:visible; padding-right:0; }
}


/* =============================================================================
   C. å¸æ©Ÿè³‡è¨Šï¼ˆå·¦æ¬„ï¼‰æ’ç‰ˆå„ªåŒ–
   ========================================================================== */

/* å·¦æ¬„å…§çš„è¦–è¦ºï¼šæ¨™é¡Œåˆ— */
.driver-info__title{
  display:flex; align-items:center; gap:8px;
  font-weight:800; color:#0f172a;
  margin:2px 0 12px;
}
.driver-info__title .emoji{ font-size:18px; }

/* key-value ç‰ˆé¢ï¼šæ•´é½Šå°é½Šæˆå…©æ¬„ï¼ˆæ¨™ç±¤ / å…§å®¹ï¼‰ */
.driver-kv{
  display:grid;
  grid-template-columns: 92px 1fr;
  row-gap:8px;
  column-gap:10px;
}
.driver-kv .k{
  color:#475569;
  font-weight:600;
  text-align:right;
}
.driver-kv .v{
  color:#111827;
  word-break:break-word;
}

/* å°åˆ†éš”ç·šç¾¤çµ„ï¼šè®“è³‡è¨Šå€å¡Šæ›´ä¹¾æ·¨ */
.driver-info__group{
  display:grid; gap:8px;
  padding-bottom:8px;
  border-bottom:1px dashed #e5e7eb;
  margin-bottom:10px;
}
.driver-info__group:last-child{ border-bottom:0; padding-bottom:0; margin-bottom:0; }

/* æ¬¡è¦æ–‡å­—ï¼ˆä¾‹å¦‚ã€Œæœªæä¾›ã€ã€ã€Œæœªå®šã€ï¼‰ */
.text-muted{ color:#6b7280; }

/* RWDï¼šæ‰‹æ©Ÿæ™‚æ”¹æˆå–®æ¬„ */
@media (max-width: 640px){
  .driver-kv{ grid-template-columns: 86px 1fr; }
}


/* =============================================================================
   D. ä½ ç¾æœ‰çš„ç®­é ­/å¡ç‰‡/æŒ‰éˆ•ï¼ˆå¦‚éœ€ï¼Œä¿ç•™ï¼‰
   ========================================================================== */

.arrow{ cursor:pointer; margin-left:6px; min-width:36px; min-height:36px;
  font-size:16px; color:#333; background:transparent; border:0;
  transition: transform .25s ease;
}
.arrow.open{ transform: rotate(90deg); }

.btn-manage{ background:#007bff; color:#fff; border:0; border-radius:6px; padding:6px 10px; }
.btn-manage:hover{ background:#0056b3; }
.btn-join{ background:#28a745; color:#fff; border:0; border-radius:6px; padding:6px 10px; }
.btn-join:hover{ background:#1e7e34; }

/* ==========================================================================
   Modalï¼šé€šç”¨ï¼ˆé®ç½©/å®¹å™¨/é—œé–‰éˆ•/å€å¡Šï¼‰
   ========================================================================== */
/* ===== Passenger Auth Modal (scoped) ===== */
#paxAuthModal{
  /* ç”¨ grid ç½®ä¸­ï¼Œç„¡è¦–å¤–å±¤ä»»ä½• margin/padding å½±éŸ¿ */
  display: grid;
  place-items: center;
  position: fixed;
  inset: 0;
  padding: 0;            /* é¿å…è¦–è¦ºä¸Šçœ‹èµ·ä¾†ç•¥ä¸Šç·£ */
  z-index: 1000;
  background: rgba(0,0,0,.55);
}

#paxAuthModal .pax-modal-card{
  margin-top: 50%;
}

#paxAuthModal .pax-desc{
  text-align: center;     /* èªªæ˜ç½®ä¸­ */
}

/* å°è¢å¹•ä¹Ÿç¶­æŒç½®ä¸­ */
@media (max-width: 520px){
  #paxAuthModal{ padding: 0; /* ç”¨ grid ç½®ä¸­ï¼Œç„¡è¦–å¤–å±¤ä»»ä½• margin/padding å½±éŸ¿ */
  display: grid;
  place-items: center;
  position: fixed;
  inset: 0;
  z-index: 1000;
  background: rgba(0,0,0,.55);}
  #paxAuthModal .pax-modal-card{ width: min(520px, 92vw); }
}
#paxAuthModal .pax-modal-card {
  width:min(520px, 92vw);
  background:#fff; border-radius:14px; box-shadow:0 12px 34px rgba(0,0,0,.28);
  display:flex; flex-direction:column; overflow:hidden; animation:fadeIn .18s ease-out;
}
#paxAuthModal .pax-modal-head {
  display:flex; align-items:center; justify-content:space-between; gap:8px;
  padding:16px 18px; border-bottom:1px solid #eee;
}
#paxAuthModal .pax-title-wrap { display:flex; align-items:center; gap:10px; }
#paxAuthModal .pax-lock { font-size:18px; line-height:1; }
#paxAuthModal .pax-title { margin:0; font-size:18px; font-weight:700; color:#222; }

#paxAuthModal .pax-close {
  appearance:none; border:0; background:transparent; cursor:pointer;
  font-size:22px; line-height:1; color:#888; padding:2px 6px; border-radius:8px;
}
#paxAuthModal .pax-close:hover { background:#f2f3f5; color:#222; }

#paxAuthModal .pax-desc { margin:0 0 14px; font-size:14px; color:#666; }

#paxAuthModal .pax-form { margin:0; }
#paxAuthModal .pax-form-row { display:grid; grid-template-columns:94px 1fr; gap:10px 14px; align-items:center; }
#paxAuthModal .pax-form-row label { font-size:14px; color:#333; text-align:right; }
#paxAuthModal .pax-form-row input {
  width:75%; padding:10px 12px; border:1px solid #dcdfe6; border-radius:10px; font-size:15px;
  transition:border-color .15s, box-shadow .15s;
}
#paxAuthModal .pax-form-row input:focus {
  outline:none; border-color:#3b82f6; box-shadow:0 0 0 3px rgba(59,130,246,.15);
}

#paxAuthModal .pax-modal-foot {
  display:flex; justify-content:flex-end; gap:8px;
  padding:12px 18px 16px; border-top:1px solid #eee;
}

#paxAuthModal .btn {
  min-width:88px; height:38px; padding:0 14px; border-radius:10px; border:1px solid transparent;
  font-size:14px; cursor:pointer; transition:background .15s, color .15s, border-color .15s, box-shadow .15s;
}
#paxAuthModal .btn.primary { background:#2563eb; color:#fff; }
#paxAuthModal .btn.primary:hover { background:#1e4fd6; }
#paxAuthModal .btn.ghost { background:#f3f4f6; color:#111827; border-color:#e5e7eb; }
#paxAuthModal .btn.ghost:hover { background:#ebeef2; }

@media (max-width:520px){
  #paxAuthModal .pax-form-row { grid-template-columns:1fr; }
  #paxAuthModal .pax-form-row label { text-align:left; }
}

@keyframes fadeIn { from { opacity:0; transform:translateY(-6px); } to { opacity:1; transform:translateY(0); } }

.modal{
  position:fixed; inset:0; z-index:1000;left: 0; top: 0; background:rgba(0,0,0,.55);
  display:none;justify-content: center; align-items: center;
}

/* ---- çµ±ä¸€å¡ç‰‡æ¨£å¼ï¼ˆå’Œå¸æ©Ÿç®¡ç†ä¸€è‡´çš„åœ“è§’/é™°å½±ï¼‰ ---- */
.modal-card{
  width:min(520px, 94vw);
  border-radius:16px;
  box-shadow:0 16px 40px rgba(0,0,0,.18);
  overflow:hidden;
}

.modal-content {
  background: #fff;
  border-radius: 12px;
  padding: 28px 30px;
  width: 90%;
  max-width: 420px;
  text-align: center;   /* ğŸ¯ ç½®ä¸­æ‰€æœ‰æ–‡å­— */
  box-shadow: 0 6px 18px rgba(0,0,0,0.25);
  position: relative;
  animation: fadeIn 0.3s ease-out;
}
.modal .modal-content{
  display:flex; flex-direction:column;
  width:min(520px,94vw);max-width:640px;; max-height:min(92svh,640px);
  margin:6svh auto; background:#fff; border-radius:12px;
  box-shadow:0 10px 30px rgba(0,0,0,.25);
}
/* header / footer */
.modal-header{
  display:flex; align-items:center; justify-content:space-between;
  padding:16px 18px; border-bottom:1px solid #eee;
}
.modal-footer{
  display:flex; justify-content:flex-end; gap:10px;
  padding:14px 18px; border-top:1px solid #eee;
}
.modal-body{ flex:1 1 auto; overflow-y:auto; padding:14px 16px; }
.close{ background:transparent; border:0; font-size:20px; cursor:pointer; }
.modal-title-row{ display:flex; align-items:center; gap:10px; }
.modal-emoji{ font-size:20px; line-height:1; }
.modal-title{ margin:0; font-size:18px; font-weight:700; letter-spacing:.5px; }

.body-modal-open{ overflow:hidden; }
.modal-desc {
  font-size: 14px;
  color: #666;
  margin: 8px 0 20px;
}

/* close button */
.close{
  background:transparent; border:0; font-size:22px; color:#8a8f98; cursor:pointer; line-height:1;
}
.close:hover{ color:#333; }

/* inline error */
.form-error{
  margin:6px 0 0 120px; color:#d33; font-size:13px; min-height:1em; display:none;
}
.form-error.show{ display:block; }

/* RWDï¼šæ‰‹æ©Ÿæ”¹ç‚ºä¸Šä¸‹æ’åˆ— */
@media (max-width: 480px){
  .form-vertical .form-row{
    grid-template-columns:1fr; gap:6px;
  }
  .form-error{ margin-left:0; }
}
/* è¡¨å–®æ¬„ä½ */
.form-group {
  margin-bottom: 20px;
  text-align: center;  /* label å–®ç¨é å·¦ï¼Œè¼¸å…¥æ¡†ä¿æŒç½®ä¸­ */
}
.form-group label {
  display: block;
  margin-bottom: 8px;
  font-size: 14px;
  font-weight: 600;
  color: #333;
  text-align: center;    /* ğŸ¯ æ¨™ç±¤é å·¦ */
}
.form-group input {
  width: 50%;
  padding: 12px;
  border-radius: 8px;
  border: 1px solid #ccc;
  font-size: 15px;
  transition: border-color 0.2s;
  text-align: center;   /* ğŸ¯ è¼¸å…¥æ¡†æ–‡å­—ç½®ä¸­ */
}
.form-group input:focus {
  border-color: #007bff;
  outline: none;
}

/* æŒ‰éˆ•å€å¡Š */
.modal-actions {
  display: flex;
  justify-content: center;  /* ğŸ¯ æŒ‰éˆ•ç½®ä¸­ */
  gap: 12px;
}
.btn-primary {
  background: #007bff;
  color: #fff;
  border: none;
  padding: 10px 20px;
  border-radius: 6px;
  font-size: 15px;
  cursor: pointer;
  transition: background 0.2s;
}
.btn-primary:hover { background: #0056b3; }

.btn-secondary {
  background: #f1f1f1;
  color: #333;
  border: none;
  padding: 10px 20px;
  border-radius: 6px;
  font-size: 15px;
  cursor: pointer;
  transition: background 0.2s;
}
.btn-secondary:hover { background: #ddd; }

/* å‹•ç•« */
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(-10px); }
  to { opacity: 1; transform: translateY(0); }
}

/* ğŸ¯ æ‰‹æ©Ÿç‰ˆ RWD */
@media (max-width: 480px) {
  #driverAuthModal .modal-content {
    width: 70%;
    margin-top: 60%;
  }
  #driverAuthModal.btn-primary, .btn-secondary {
    flex: 1;              /* æŒ‰éˆ•è®Šæˆç­‰å¯¬ */
    padding: 12px;
  }
  .modal-actions {
    flex-direction: column; /* ğŸ¯ æ‰‹æ©Ÿç‰ˆæŒ‰éˆ•ä¸Šä¸‹æ’åˆ— */
  }
}
/* ==========================================================================
   Join Modalï¼šå¤–è§€å¾®èª¿ï¼ˆé«˜åº¦è¼ƒçŸ®ã€Header/Body/Footer é»è²¼ï¼‰
   ========================================================================== */
/* Join Modal å¤–è§€ */
#joinModal .modal-content {
  width: min(520px, 94vw);
  max-height: min(88svh, 620px);
  margin: 4svh auto;
  border-radius: 14px;
  overflow: hidden;
  box-shadow: 0 14px 34px rgba(0,0,0,.25);
  background: #fff;
  display: flex;
  flex-direction: column;
}

/* Header */
#joinModal .modal-header {
  position: sticky; top: 0; z-index: 2;
  display: flex; align-items: center; justify-content: center;
  min-height: 44px; padding: 8px 16px;
  background: #fff; border-bottom: 1px solid #eee;
}
#joinModal .modal-header .title {
  font-size: 16px; font-weight: 700; color: #111827;
  display: inline-flex; align-items: center; gap: 8px;
}
#joinModal .modal-header .title .emoji { font-size: 18px; }
#joinModal .modal-header .close {
  position: absolute; right: 10px; top: 8px;
  width: 28px; height: 28px;
  display: inline-grid; place-items: center;
  font-size: 18px; color: #6b7280; background: transparent; border: none;
  cursor: pointer; border-radius: 6px;
}
#joinModal .modal-header .close:hover { background: #f3f4f6; color: #111827; }

/* Body */
#joinModal .modal-body {
  flex: 1 1 auto;
  overflow-y: auto;
  padding: 12px 16px;
}

/* Footer */
#joinModal .modal-footer {
  position: sticky; bottom: 0; z-index: 2;
  display: flex; justify-content: flex-end; gap: 8px;
  padding: 10px 16px; background: #fff;
  border-top: 1px solid #eee;
}
#joinModal .btn-cancel, #joinModal .btn-submit {
  border-radius: 10px; padding: 10px 18px;
  font-weight: 700; font-size: 15px;
  border: none; cursor: pointer;
}
#joinModal .btn-cancel { background: #f3f4f6; color: #333; }
#joinModal .btn-cancel:hover { background: #ddd; }
#joinModal .btn-submit { background: #3b82f6; color: #fff; }
#joinModal .btn-submit:hover { background: #2563eb; }

/* è¡¨å–®æ¬„ä½ */
#joinModal .join-field {
  display: flex; flex-direction: column;
  gap: 6px; margin: 12px 0;
  align-items: flex-start; /* æ¨™ç±¤é å·¦ */
}
#joinModal .join-field label {
  font-weight: 600; color: #1f2937; line-height: 1.2;
}
#joinModal .join-field input,
#joinModal .join-field select,
#joinModal .join-field textarea {
  width: 70%;
  padding: 10px 12px;
  border: 1px solid #d1d5db; border-radius: 8px;
  font-size: 14px; line-height: 1.25;
  background: #fff;
  transition: border-color .2s, box-shadow .2s;
}
#joinModal .join-field input:focus,
#joinModal .join-field select:focus,
#joinModal .join-field textarea:focus {
  outline: none;
  border-color: #3b82f6;
  box-shadow: 0 0 0 3px rgba(59,130,246,.15);
}
#joinModal textarea[name="note"] { min-height: 96px; }

/* æ‰‹æ©Ÿå„ªåŒ– */
@media (max-width: 480px) {
  #joinModal .modal-content {
    width: 80%; max-height: 90vh;
  }
  #joinModal .modal-footer {
    flex-direction: column;
  }
  #joinModal .btn-cancel, #joinModal .btn-submit {
    width: 100%;
  }
}
  /* Join è¡¨å–®æ¬„ä½é–“è·èˆ‡æŒ‰éˆ•é«˜åº¦ */
  #joinModal .join-field{ margin:10px 0; gap:6px; }
  .btn-submit, .btn-cancel{ min-height:44px; font-size:16px; }

  /* JoinModal å†å£“ç¸® header/é‚Šè· */
  #joinModal .modal-content{ max-height:min(92svh,640px); margin:3svh auto; }
  #joinModal .modal-header{ min-height:40px; padding:6px 14px; }
  #joinModal .modal-header .title{ font-size:15px; }
  #joinModal .modal-body{ padding:10px 14px; }
  #joinModal .modal-footer{ padding:8px 14px; }

/* ==========================================================================
   è¿”å›é ‚ç«¯æŒ‰éˆ•
   ========================================================================== */
#backToTop{
  position:fixed; bottom:20px; right:20px;
  background:#00897b; color:#fff; border:none; border-radius:50%;
  padding:14px; font-size:20px; cursor:pointer;
  box-shadow:0 4px 8px rgba(0,0,0,.2);
  z-index:1200; transition:transform .2s, background .3s;
}
#backToTop:hover{ background:#00695c; transform:scale(1.08); }

/* ==========================================================================
   å‹•ç•«
   ========================================================================== */
@keyframes fadeInUp{
  from{ opacity:0; transform:translateY(15px); }
  to{ opacity:1; transform:translateY(0); }
}

/* ==========================================================================
   RWD æ–·é»èª¿æ•´
   ========================================================================== */
/* â‰¤1024pxï¼šå¡ç‰‡èˆ‡ä¸»æŒ‰éˆ•å¾®èª¿ */
@media (max-width:1024px){
  .card{ padding:8px 12px 8px 24px; margin:3px; }
  .btn-main{ padding:10px 16px; font-size:15px; }
}
/* â‰¤768pxï¼šå­—ç´šã€å°æ¨™é¡Œã€ä¸»æŒ‰éˆ•ç­‰ */
@media (max-width:768px){
  body{ font-size:15px; }
  h1{ font-size:22px; }
  h2{ font-size:18px; margin:14px; }
  .buttons{ padding:0 12px; }
  .btn-main{ width:auto; min-width:44%; }
  #toast-container{ top:env(safe-area-inset-top,16px); right:12px; left:24px; }
}
/* â‰¤640pxï¼šä¸»æŒ‰éˆ•æ»¿ç‰ˆã€å¸æ©Ÿå¡ç‰‡ä¸‰æ¬„æ”¹å–®æ¬„ã€Modal æ›´ç·Šæ¹Šã€Join è¡¨å–®ç¶­æŒç›´å‘ */
@media (max-width:640px){
  /* ä¸»æŒ‰éˆ•æ”¹å–®æ¬„æ»¿ç‰ˆ */
  .buttons{ display:grid; grid-template-columns:1fr; gap:10px; padding:0 12px; }
  .btn-main{ width:100%; }

  /* å¸æ©Ÿå¡ç‰‡ï¼šä¸‰æ¬„â†’å–®æ¬„ */
  .driver-grid{ display:grid; grid-template-columns:1fr; grid-row-gap:8px; }
  .col-left, .col-middle, .col-actions{ width:100%; }
  .col-left .name-seat{ font-size:16px; margin-bottom:6px; text-align:left; }
  .col-middle .line{ display:block; margin:4px 0; font-size:14px; }

  .col-actions{
    display:grid; grid-template-columns:1fr 1fr auto; align-items:center; gap:8px;
  }
  .btn-manage, .btn-join{ width:100%; min-height:44px; font-size:15px; }
  .arrow{ font-size:18px; min-width:44px; min-height:44px; display:inline-grid; place-items:center; }
  .details{
  margin-top:0px; max-height:0; overflow:hidden; padding:0px 0px;
  background: transparent; border:0 #e6e6e6;
  transition:max-height 1.2s ease, padding 1s ease;
  }
  /* å±•é–‹æ™‚å†åŠ å›å¤–è§€ */
  .details.open {
    margin-top: 8px;
    max-height: 1200px;
    padding: 10px;
    background: #f9f9f9;
    border-top: 1px solid #e6e6e6;
    border-radius: 6px;
  }
  .details h4{ font-size:15px; margin:6px 0 4px; }
  .details p, .details li{ font-size:14px; margin:2px 0; }

  /* ä¹˜å®¢å¡ç‰‡ï¼šä¸»åˆ—å–®æ¬„ã€æ“ä½œé å³ */
  .pax-row{ grid-template-columns:1fr; }
  .pax-actions{ justify-content:flex-end; }

  /* é€šç”¨ modal å¯¬åº¦ */
  .modal .modal-content{ width:94vw; margin:4svh auto; }

  /* è¿”å›é ‚ç«¯ä½ç½® */
  #backToTop{ right:12px; bottom:16px; }
}
/* â‰¤400pxï¼šå­—ç´šèª¿æ•´ã€æŒ‰éˆ•èˆ‡ç®­é ­æ›´å° */
@media (max-width:400px){
  body{ font-size:14px; }
  h1{ font-size:20px; }
  h2{ font-size:16px; margin:10px; }
  .col-left .name-seat{ font-size:15px; }
  .col-middle .line1{ font-size:15px; }
  .col-middle .line2, .col-middle .line3{ font-size:13px; }
  .btn-manage, .btn-join{ font-size:14px; padding:8px 10px; }
  .arrow{ font-size:16px; min-width:40px; min-height:40px; }
}
/* ============================================================================
   Pax Edit Modal ç¾åŒ–ï¼ˆåªå½±éŸ¿ #paxEditModalï¼‰
   ========================================================================== */

/* å½ˆçª—å¯¬åº¦èˆ‡å¯å·å‹• */
.modal .modal-content{ max-width:640px; }
.modal .modal-body{ max-height:72vh; overflow:auto; }
/* 3) å…§å®¹å€åº•éƒ¨åŠ å…§è·ï¼Œé¿å…è¢«åº•éƒ¨æŒ‰éˆ•è“‹ä½ */
#paxEditModal .modal-body {
  padding-bottom: 80px; /* å¯ä¾å–œå¥½ 64~96px */
}
/* 4) åº•éƒ¨æŒ‰éˆ•ï¼šå°ºå¯¸åŠ å¤§ã€é å³å°é½Š */
#paxEditModal .modal-footer {
  position: sticky;        /* æ²å‹•æ™‚å›ºå®šåœ¨åº•éƒ¨ */
  bottom: 0;
  padding: 12px 16px calc(12px + env(safe-area-inset-bottom, 0px));
  gap: 10px;
  justify-content: flex-end;
  background: #fff;        /* èˆ‡å…§å®¹åˆ†å±¤ */
  border-top: 1px solid #eef2f7;
}
#paxEditModal .btn-submit,
#paxEditModal .btn-cancel {
  min-height: 44px;
  padding: 10px 16px;
  border-radius: 10px;
  font-weight: 700;
}
/* 1) è¡¨å–®æ¬„ä½å¡«æ»¿ä¸€æ¬„ï¼ˆæŠŠåŸæœ¬ 50% è¦†å¯«æˆ 100%ï¼‰ */
#paxEditModal .join-field input,
#paxEditModal .join-field select,
#paxEditModal .join-field textarea {
  width: 100%;
}

/* æ§åˆ¶é …å¯¬åº¦ */
#paxEditForm input,
#paxEditForm select,
#paxEditForm textarea{ width:100%; }

/* 2) å‚™è¨»ï¼šåŠ å¤§é«˜åº¦ã€å¯æ‹‰ä¼¸ï¼Œä¸”æ©«è·¨å…©æ¬„ */
#paxEditModal #paxEditForm textarea {
  grid-column: 1 / -1;
  min-height: 120px;
  resize: vertical;
}
.switch{
  display:flex; align-items:center; gap:10px;
  padding:8px 10px; border:1px solid #e9eef5; border-radius:10px; background:#f8fbff;
}

/* éš±è—çœŸæ­£çš„ checkbox */
.switch input[type="checkbox"]{
  position:absolute; opacity:0; width:0; height:0;
}

/* é€™è£¡æ”¹ï¼šè®“ label.toggle ç•¶æ»‘è»Œ */
.switch label.toggle{
  position:relative; width:48px; height:26px; border-radius:999px;
  background:#d1d5db; transition:background .2s; cursor:pointer; display:inline-block;
}
.switch label.toggle::after{
  content:""; position:absolute; top:3px; left:3px; width:20px; height:20px;
  background:#fff; border-radius:50%; box-shadow:0 1px 2px rgba(0,0,0,.2); transition:transform .2s;
}

/* å‹¾é¸å¾Œè®Šè‰²èˆ‡æ¨å‹•åœ“é» */
.switch input[type="checkbox"]:checked + label.toggle{
  background:#22c55e;
}
.switch input[type="checkbox"]:checked + label.toggle::after{
  transform:translateX(22px);
}

/* è®“æ–‡å­—ä¹Ÿå¯é» */
.switch .switch-text{ font-weight:600; color:#374151; cursor:pointer; }

/* ç¦ç”¨ç‹€æ…‹ï¼ˆå¦‚æœä½ ç”¨ JS è¨­ç½® disabledï¼‰ */
.switch input[type="checkbox"]:disabled + label.toggle{
  opacity:.55; cursor:not-allowed; background:#e5e7eb;
}
.switch input[type="checkbox"]:disabled ~ .switch-text{
  color:#9ca3af; cursor:not-allowed;
}

#paxPrivacyHint{ margin-top:6px; font-size:12px; color:#6b7280; }
#paxPrivacyHint.hint-error{ color:#b91c1c; }

/* === Pax Edit è† å›Šæ ¼å­é¢¨æ ¼ === */
#paxEditModal .join-field input,
#paxEditModal .join-field select,
#paxEditModal .join-field textarea{
  width: 100%;
  height: 42px;                 /* textarea ä¸‹é¢æœƒè¦†å¯«æˆè‡ªå‹•é«˜åº¦ */
  padding: 10px 12px;
  border: 1px solid #d9dee7;    /* æ·ºç°å¤–æ¡† */
  border-radius: 12px;          /* åœ“è§’è† å›Š */
  background: #fff;
  box-shadow: inset 0 1px 0 rgba(0,0,0,.02);
  transition: border-color .15s, box-shadow .15s, background .15s;
}

#paxEditModal .join-field textarea{
  min-height: 110px;
  height: auto;                 /* æ–‡å­—å€åŸŸä¸è¦å›ºå®šé«˜åº¦ */
  resize: vertical;
}

#paxEditModal .join-field input:focus,
#paxEditModal .join-field select:focus,
#paxEditModal .join-field textarea:focus{
  outline: none;
  border-color: #94b5ff;        /* ä½ ä¹Ÿå¯æ”¹ #3b82f6 */
  box-shadow: 0 0 0 3px rgba(59,130,246,.15);
}

#paxEditModal .join-field ::placeholder{
  color:#9aa3b2;
}

/* é¸å–®çš„åŸç”Ÿç®­é ­éš±è— + è‡ªè¨‚é–“è·ï¼ˆå¯é¸ï¼‰ */
#paxEditModal .join-field select{
  appearance:none; -webkit-appearance:none; -moz-appearance:none;
  padding-right: 34px;
  background-image: none;       /* å¦‚æœæƒ³åŠ ä¸‹æ‹‰ç®­é ­å¯ä»¥å†æ”¾ data-URI åœ– */
}
/* è¡¨å–®æ¨™é¡Œï¼ˆlabelï¼‰ç½®ä¸­ã€å­—å¤§ä¸€é»ã€é–“è·åŠ å¤§ */
#paxEditModal .join-field > label{
  font-weight: 700;
  font-size: 16px;         /* åŸæœ¬ 14 â†’ 16 */
  color: #1f2937;
  text-align: center;      /* ç½®ä¸­ */
  margin-bottom: 8px;      /* èˆ‡è¼¸å…¥æ¡†è·é›¢ */
}

/* æ¬„ä½æ ¼å­ï¼šå­—é«”åŠ å¤§ã€ä¸Šä¸‹ padding æ›´åšã€åœ“è§’ç¶­æŒ */
#paxEditModal .join-field input,
#paxEditModal .join-field select,
#paxEditModal .join-field textarea{
  font-size: 16px;         /* åŸæœ¬ 14 â†’ 16 */
  line-height: 1.4;
  padding: 14px 14px;      /* ä¸Šä¸‹é–“è·åŠ å¤§ */
  height: auto;            /* è®“é«˜åº¦ç”± padding æ’é–‹ */
  border: 1px solid #d9dee7;
  border-radius: 12px;
}

/* æ–‡å­—å€å¡Šé«˜åº¦å†æ”¾é¬†ä¸€äº› */
#paxEditModal .join-field textarea{
  min-height: 120px;
}

/* éš±ç§è¨­å®š switchï¼šæ•´å¡Šç½®ä¸­ã€å­—åŠ å¤§ */
#paxEditModal .privacy-switch,
#paxEditModal .switch{
  justify-content: center; /* æ°´å¹³ç½®ä¸­ */
}
#paxEditModal .switch label{
  font-size: 16px;
}

/* Modal æ¨™é¡Œæœ¬ä¾†å°±ç½®ä¸­ï¼Œé€™è£¡å†å¾®èª¿å­—é‡èˆ‡å­—ç´š */
#paxEditModal .modal-header .title{
  font-size: 18px;
  font-weight: 800;
}

/* å„²å­˜/å–æ¶ˆæŒ‰éˆ•å­—æ›´å¤§ã€è§¸æ§é¢ç©æ›´å¥½æŒ‰ */
#paxEditModal .btn-submit,
#paxEditModal .btn-cancel{
  font-size: 16px;
  padding: 12px 18px;
}

@media (max-width: 560px){
  /* å°è¢å¹•ä¸‹ï¼Œæ¬„ä½å…¨å¯¬çœ‹èµ·ä¾†æ›´èˆ’æœ */
  #paxEditModal .join-field input,
  #paxEditModal .join-field select,
  #paxEditModal .join-field textarea{
    width: 100%;
  }
}


/* å°è¢å¹•æ”¹ä¸€æ¬„ */
@media (max-width:560px){
  #paxEditForm{ grid-template-columns:1fr; }
/* 5) æ‰‹æ©Ÿï¼šæŒ‰éˆ•æ»¿ç‰ˆã€æ”¹ç›´å‘æ’åˆ— */
@media (max-width: 560px) {
  #paxEditModal .modal-footer {
    flex-direction: column;
    align-items: stretch;
  }
  #paxEditModal .btn-submit,
  #paxEditModal .btn-cancel {
    width: 100%;
  }
}
}
/* ==========================================================================
   æ’åºç¯©é¸ ç¾åŒ–
   ========================================================================== */
/* å¸æ©Ÿ/ä¹˜å®¢å…©å€‹æ¸…å–®åº•éƒ¨åšä¸€å¡Šä¸å¯è¦‹çš„ spacer */
#driver-list::after{
  content: "";
  display: block;
  height: calc(20dvh + var(--safe-bottom)); /* ç•™ä¸€æ®µå¯è¦–é«˜åº¦ + å›ºå®šå€¼ */
}
#passenger-list::after {
  content: "";
  display: block;
  height: calc(1vh + var(--safe-bottom)); /* ç•™ä¸€æ®µå¯è¦–é«˜åº¦ + å›ºå®šå€¼ */
}

/* è‹¥æ¸…å–®å¤–æœ‰é é¢å®¹å™¨ï¼Œä¹Ÿå»ºè­°ç•™ padding-bottomï¼Œé›™é‡ä¿éšª */
.page,
.container,
.main {
  padding-bottom: calc(10vh + 64px + var(--safe-bottom));
}

:root{ --collapse-ms: 240ms;--safe-bottom: env(safe-area-inset-bottom, 0px); }

.panel{
  border:1px solid #e6e8ec; border-radius:14px; background:#fff; overflow:hidden;
  box-shadow:0 2px 10px rgba(30,41,59,.06);
  margin:.75rem 0 1rem;
}
.panel-hd{
  display:flex; align-items:center; justify-content:space-between; gap:.75rem;
  padding:.8rem 1rem; background:linear-gradient(#f8fafc,#f3f6fb);
  cursor:pointer; user-select:none;
}
.panel-title{ display:flex; align-items:center; gap:.55rem; font-weight:600; color:#0f172a; }
.panel-title .dot{ width:10px; height:10px; border-radius:999px; background:#22c55e; box-shadow:0 0 0 3px rgba(34,197,94,.18); }
.panel-ops{ display:flex; align-items:center; gap:.5rem; }
.panel-toggle{ width:34px; height:34px; border-radius:10px; border:1px solid #dbe0e8; background:#fff; display:grid; place-items:center; }
.panel-toggle svg{ width:18px; height:18px; transition:transform .22s ease; color:#334155; }
.panel[aria-expanded="true"] .panel-toggle svg{ transform:rotate(180deg); }

/* âœ… åªç”¨ max-height/opacity åšå‹•ç•«â€”ä¸è¦å†ç”¨ display:none/block */
.panel .panel-bd{
  padding:12px 12px 14px;     /* é€™è£¡ä¿ç•™ paddingï¼Œä½†ä¸è¦å†åŠ  display:none */
  overflow:hidden;
  max-height:0;
  opacity:0;
  transition:
    max-height var(--collapse-ms) ease,
    opacity    var(--collapse-ms) ease;
}
.panel[aria-expanded="true"] .panel-bd{ opacity:1; }

.panel-title { display:flex; align-items:center; gap:.55rem; font-weight:600; color:#0f172a; }
.panel-title .dot { width:10px; height:10px; border-radius:999px; background:#22c55e; box-shadow:0 0 0 3px rgba(34,197,94,.18); }
.panel-ops { display:flex; align-items:center; gap:.5rem; }
.panel-toggle { width:34px; height:34px; border-radius:10px; border:1px solid #dbe0e8; background:#fff; display:grid; place-items:center; }
.panel-toggle svg { width:18px; height:18px; transition:transform .22s ease; color:#334155; }
.panel[aria-expanded="true"] .panel-toggle svg { transform:rotate(180deg); }
.panel-bd { padding:12px 12px 14px; display:none; }
.panel[aria-expanded="true"] .panel-bd{ display:block; }

/* ====== æ’åºï¼šè† å›Š Segmented Switch ====== */
.sort-wrap{
  display:grid;
  grid-template-columns: repeat(3, minmax(0,1fr)); /* âœ… ä¸‰æ¬„ */
  gap:10px;
  align-items:center;
}
/* å°è¢å¹•æ™‚è‡ªå‹•å †ç–Šæˆä¸€æ¬„ï¼ˆé¿å…æ“ ä¸ä¸‹ï¼‰â€”å¦‚æœä½ æƒ³ç¶­æŒä¸‰æ¬„å¯åˆªæ‰é€™æ®µ */
@media (max-width: 768px){
  .sort-wrap{ grid-template-columns: 1fr; }
}
.seg-box{ flex:1; }     /* ä¿æŒæ¯æ¬„ç­‰å¯¬ */
.seg-title{ font-size:.9rem; color:#475569; margin:2px 0 4px 6px; }

.seg-switch {
  --h:40px; position:relative; background:#f4f6fb; border:1px solid #e4e8f0;
  border-radius:999px; display:flex; padding:4px; height:var(--h);
  box-shadow:inset 0 1px 3px rgba(0,0,0,.04);
}
.seg-switch .pill {
  position:absolute; top:4px; left:4px; height:calc(var(--h) - 8px); width:calc(50% - 4px);
  background:#fff; border-radius:999px; box-shadow:0 2px 10px rgba(0,0,0,.08);
  transition:left .22s cubic-bezier(.4,0,.2,1), width .22s cubic-bezier(.4,0,.2,1);
}
.seg-switch .opt {
  flex:1; display:flex; align-items:center; justify-content:center; gap:.4rem;
  z-index:1; color:#475569; font-weight:600; cursor:pointer; user-select:none;
}
.seg-switch .opt .ico{ width:16px; height:16px; }
.seg-switch[data-state="right"] .pill { left:calc(50% + 0px); }
.seg-title { font-size:.9rem; color:#475569; margin:2px 0 4px 6px; }

/* æ¬¡ç´šåˆ†çµ„ï¼ˆå‡ºç™¼åœ°æ’åºï¼‰ */
.seg-group { display:flex; gap:10px; }
.seg-box { flex:1; }

/* ====== éš±è— selectï¼ˆä¿ç›¸å®¹ï¼‰ ====== */
#sort{ display:none; }

/* ====== ç¯©é¸æ ¼ç·š ====== */
.filt-grid{
  display:grid; grid-template-columns:repeat(4,minmax(0,1fr));
  gap:10px 12px; align-items:end; margin-top:6px;
}
@media (max-width:768px){ .filt-grid{ grid-template-columns:repeat(2,minmax(0,1fr)); } .only-desktop-spacer{ display:none; } }

.filt-item{ display:flex; flex-direction:column; gap:6px; min-width:0; }
.filt-item label{ font-size:.86rem; color:#666; }
.ctl{ width:100%; box-sizing:border-box; }
select.ctl{ min-height: 2.6rem; padding:.35rem .55rem; }
input.ctl{ padding:.45rem .6rem; }

.btn{
  display:inline-flex; align-items:center; justify-content:center;
  padding:10px 16px; border-radius:10px; border:0; cursor:pointer; font-weight:600;
  transition:transform .02s ease, box-shadow .2s ease, background .2s ease;
}
.btn.primary{ background:#111; color:#fff; border-color:#111; }
.btn.ghost{ background:#f5f6f8; }

/* ====== é…Œæ”¶è²»ç”¨ Toggleï¼ˆâ‰¥ / â‰¤ï¼‰ ====== */
.fare-toggle{ display:flex; align-items:center; gap:.5rem; }
.toggle{
  position:relative; width:160px; height:36px; border-radius:999px; background:#e9edf3; border:1px solid #d8dee8; cursor:pointer;
}
.toggle .knob{
  position:absolute; top:3px; left:3px; width:30px; height:30px; border-radius:50%;
  background:#fff; box-shadow:0 1px 2px rgba(0,0,0,.12);
  transition:left .22s cubic-bezier(.4,0,.2,1), transform .12s ease;
}
.toggle[data-mode="gte"] .knob{ left:127px; }
.toggle .label{ position:absolute; top:50%; transform:translateY(-50%); font-size:.82rem; color:#5a6372; }
.toggle .label.lte{ left:42px; } .toggle .label.gte{ right:42px; }

/* æ™¶ç‰‡ */
.chips{display:flex;flex-wrap:wrap;gap:.4rem;margin:.25rem 0 1rem;}
.chip{display:inline-flex;align-items:center;gap:.45rem;padding:.28rem .6rem;border-radius:999px;border:1px solid #e1e4ea;background:#f7f8fb;font-size:.87rem;color:#333;}
.chip .x{display:inline-flex;align-items:center;justify-content:center;width:18px;height:18px;border-radius:50%;background:#e9ecf3;color:#333;cursor:pointer;font-size:.8rem;line-height:1;}
.chip .x:hover{ background:#dfe4ee; }


</style>
<script>
(function () {
  // æ”¹æˆä½ å¯¦éš›ç”¨çš„ ID
  const MODAL_ID = 'introModal';     // åŸæœ¬æ˜¯ 'siteIntroModal'
  const BTN_ID   = 'btnIntro';       // åŸæœ¬æ˜¯ 'introHelpBtn'

  function $id(id){ return document.getElementById(id); }

  function openIntro() {
    const m = $id(MODAL_ID);
    if (!m) return;
    m.classList.add('is-open');
    document.body.classList.add('body--intro-open');
    const card = m.querySelector('.intro-modal__card');
    card && card.focus();
  }
  function closeIntro() {
    const m = $id(MODAL_ID);
    if (!m) return;
    m.classList.remove('is-open');
    document.body.classList.remove('body--intro-open');
  }

  function bindIntro() {
    // æŒ‰éˆ•é–‹å•Ÿ
    const btn = $id(BTN_ID);
    btn && btn.addEventListener('click', (e) => {
      e.preventDefault();
      openIntro();
    });

    // Modal é—œé–‰ï¼ˆé®ç½©æˆ–é—œé–‰éˆ•ä¸ŠåŠ  data-intro-closeï¼‰
    const modal = $id(MODAL_ID);
    if (!modal) return;
    modal.addEventListener('click', (e) => {
      if (e.target.matches('[data-intro-close]')) {
        e.preventDefault();
        closeIntro();
      }
    });

    // ESC é—œé–‰
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && modal.classList.contains('is-open')) {
        closeIntro();
      }
    });

    // å°å¤–æš´éœ²
    window.showIntroModalNow = openIntro;
    window.closeIntroModal   = closeIntro;
  }

  document.addEventListener('DOMContentLoaded', bindIntro);
})();
</script>
</head>
<body>
  <h1>ğŸŒ èŠ±è“®å…‰å¾©æ•‘ç½äº¤é€šåª’åˆ</h1>

  <div class="hero-actions">
  <button class="btn-main btn-driver" onclick="openDriverModal && openDriverModal()">
    ğŸš—ã€€æˆ‘è¦å‡ºè»Šï¼ˆæ‰¾ä¹˜å®¢ï¼‰
  </button>

  <!-- èªªæ˜æŒ‰éˆ• -->
  <button id="btnIntro" class="btn-main btn-ghost" type="button" aria-haspopup="dialog" aria-controls="introModal">
    <span class="ico">â”</span>
    <span>èªªæ˜</span>
  </button>

  <button class="btn-main btn-passenger" onclick="openJoinModal && openJoinModal()">
    ğŸ§â€â™€ï¸ã€€æˆ‘è¦æ­è»Šï¼ˆæ‰¾è»Šï¼‰
  </button>
</div>

  <h2>æ‰¾äººè³‡è¨Šï¼ˆå¸æ©Ÿæä¾›åº§ä½ï¼‰</h2>
  <ul id="passenger-list">
    {% for p in passengers %}
      {% if not p.is_matched %}
        <li class="card passenger-card">
          <span><b>{{ p.passenger_name }}</b> - éœ€è¦ {{ p.seats_needed }} äºº
            ({{ p.departure }} â†’ {{ p.destination }}, {{ p.date }})</span>
          <div class="actions">
            <button onclick="openPassengerModal('{{ p.id }}')">ç·¨è¼¯</button>
            <button onclick="openJoinModal('{{ p.id }}')">åƒåŠ </button>
          </div>
        </li>
      {% endif %}
    {% empty %}
      <li class="card passenger-card">ç›®å‰æ²’æœ‰éœ€æ±‚</li>
    {% endfor %}
  </ul>
<h2>æ‰¾è»Šéœ€æ±‚ï¼ˆä¹˜å®¢éœ€è¦å¸æ©Ÿï¼‰</h2>


{{ filters|json_script:"filtersData" }}

{# å¾Œç«¯ filters ä»¥åˆæ³• JSON æ³¨å…¥ï¼ˆä¾› JS ä½¿ç”¨ï¼‰ #}
{{ filters|json_script:"filtersData" }}
<div id="filterPanel" class="panel" aria-expanded="false">
  <div class="panel-hd" id="panelHead">
      <div class="panel-title">
      <span class="dot" aria-hidden="true"></span>
      <span>æ¢ä»¶èˆ‡æ’åºï¼ˆå¿«é€Ÿæ‰¾åˆ°ä½ è¦çš„è»Šï¼‰</span>
    </div>
    <div class="panel-ops">
      <button type="button" class="panel-toggle" aria-label="å±•é–‹/æ”¶åˆ">
        <svg viewBox="0 0 24 24" fill="none"><path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
      </button>
    </div>
  </div>

  <div class="panel-bd">
    <!-- ===== æ’åºï¼ˆè† å›Šï¼‰ ===== -->
    <div class="sort-wrap" role="group" aria-label="æ’åºé¸æ“‡">
      <!-- æ—¥æœŸï¼šé â†’è¿‘ / è¿‘â†’é  -->
      <div class="seg-box">
        <div class="seg-title">å‡ºç™¼æ—¥æœŸ</div>
        <div id="segDate" class="seg-switch" data-state="{% if sort == 'date_asc' %}right{% else %}left{% endif %}">
          <div class="pill" aria-hidden="true"></div>
          <button class="opt" type="button" data-sort="date_desc" aria-pressed="{% if sort == 'date_desc' %}true{% else %}false{% endif %}">
            <svg class="ico" viewBox="0 0 24 24" fill="none"><path d="M7 3v4M17 3v4M3 11h18M7 15h5m-5 4h10" stroke="currentColor" stroke-width="1.7" stroke-linecap="round"/></svg>
            é â†’è¿‘
          </button>
          <button class="opt" type="button" data-sort="date_asc" aria-pressed="{% if sort == 'date_asc' %}true{% else %}false{% endif %}">
            <svg class="ico" viewBox="0 0 24 24" fill="none"><path d="M7 3v4M17 3v4M3 11h18M7 19h5m-5-4h10" stroke="currentColor" stroke-width="1.7" stroke-linecap="round"/></svg>
            è¿‘â†’é 
          </button>
        </div>
      </div>

      <!-- å‡ºç™¼åœ°ï¼šåŒ—â†’å— / å—â†’åŒ—ï¼ˆä¸‹æ–¹å¦æœ‰ Aâ†’Z / Zâ†’A å°çµ„ï¼‰ -->
      <div class="seg-box">
        <div class="seg-title">å‡ºç™¼åœ°ï¼ˆåœ°ç†ï¼‰</div>
        <div id="segGeo" class="seg-switch" data-state="{% if sort == 'dep_s2n' %}right{% else %}left{% endif %}">
          <div class="pill"></div>
          <button class="opt" type="button" data-sort="dep_n2s" aria-pressed="{% if sort == 'dep_n2s' %}true{% else %}false{% endif %}">åŒ—â†’å—</button>
          <button class="opt" type="button" data-sort="dep_s2n" aria-pressed="{% if sort == 'dep_s2n' %}true{% else %}false{% endif %}">å—â†’åŒ—</button>
        </div>
      </div>

      <div class="seg-box">
        <div class="seg-title">å‡ºç™¼åœ°ï¼ˆå­—æ¯ï¼‰</div>
        <div id="segAlpha" class="seg-switch" data-state="{% if sort == 'dep_desc' %}right{% else %}left{% endif %}">
          <div class="pill"></div>
          <button class="opt" type="button" data-sort="dep_asc"  aria-pressed="{% if sort == 'dep_asc' %}true{% else %}false{% endif %}">Aâ†’Z</button>
          <button class="opt" type="button" data-sort="dep_desc" aria-pressed="{% if sort == 'dep_desc' %}true{% else %}false{% endif %}">Zâ†’A</button>
        </div>
      </div>

      <!-- éš±è— selectï¼ˆä¿ç›¸å®¹ï¼‰ -->
      <select id="sort" name="sort" hidden>
        <option value="date_desc" {% if sort == 'date_desc' %}selected{% endif %}>æ—¥æœŸ æ–°â†’èˆŠ</option>
        <option value="date_asc"  {% if sort == 'date_asc'  %}selected{% endif %}>æ—¥æœŸ èˆŠâ†’æ–°</option>
        <option value="dep_n2s"   {% if sort == 'dep_n2s'   %}selected{% endif %}>å‡ºç™¼ åŒ—â†’å—</option>
        <option value="dep_s2n"   {% if sort == 'dep_s2n'   %}selected{% endif %}>å‡ºç™¼ å—â†’åŒ—</option>
        <option value="dep_asc"   {% if sort == 'dep_asc'   %}selected{% endif %}>å‡ºç™¼åœ° Aâ†’Z</option>
        <option value="dep_desc"  {% if sort == 'dep_desc'  %}selected{% endif %}>å‡ºç™¼åœ° Zâ†’A</option>
      </select>
    </div>

    <!-- ===== ç¯©é¸æ ¼ç·š ===== -->
    <form id="filtersForm" class="filt-grid" onsubmit="return false;">
      <!-- row 1 -->
      <div class="filt-item">
        <label for="f-dep">å‡ºç™¼åœ°</label>
        <!-- å‡ºç™¼åœ°ï¼ˆå¤šé¸ï¼‰ -->
          <select id="f-dep" class="ctl" multiple>
            {% for name, n in DEP_WITH_COUNT %}
              <option value="{{ name }}" {% if filters.dep_in and name in filters.dep_in %}selected{% endif %}>
                {{ name }}ï¼ˆ{{ n }}ï¼‰
              </option>
            {% endfor %}
          </select>
      </div>
      <div class="filt-item">
        <label for="f-des">ç›®çš„åœ°</label>
        <select id="f-des" class="ctl" multiple>
          {% for name, n in DES_WITH_COUNT %}
            <option value="{{ name }}" {% if filters.des_in and name in filters.des_in %}selected{% endif %}>
              {{ name }}ï¼ˆ{{ n }}ï¼‰
            </option>
          {% endfor %}
        </select>
      </div>
      <div class="filt-item">
        <label for="f-date">å‡ºç™¼æ—¥æœŸ</label>
        <select id="f-date" class="ctl" multiple>
          {% for ds in DATE_CHOICES %}<option value="{{ ds }}" {% if filters.date_in and ds in filters.date_in %}selected{% endif %}>{{ ds }}</option>{% endfor %}
        </select>
      </div>
      <div class="filt-item">
        <label for="f-ret">å›ç¨‹æ—¥æœŸ</label>
        <select id="f-ret" class="ctl" multiple>
          {% for rs in RET_CHOICES %}<option value="{{ rs }}" {% if filters.ret_in and rs in filters.ret_in %}selected{% endif %}>{{ rs }}</option>{% endfor %}
        </select>
      </div>

      <!-- row 2 -->
      <div class="filt-item">
        <label for="f-fare-num">é‡‘é¡</label>
        <input id="f-fare-num" class="ctl" type="number" min="0" step="1"
               value="{% if filters.fare_num %}{{ filters.fare_num }}{% endif %}" placeholder="æ•¸å­—é‡‘é¡">
      </div>
      <!-- <div class="filt-item">
        <label for="f-fare-text">é—œéµå­—</label>
        <input id="f-fare-text" class="ctl" type="text" value="{{ filters.fare_q|default:'' }}" placeholder="å¦‚ï¼šå…è²»ã€AA">
      </div> -->
      <div class="filt-item">
        <label for="f-q">é—œéµå­—</label>
        <input id="f-q" class="ctl" type="text" placeholder="æœå°‹æ•´å¼µå¡ç‰‡ï¼ˆå§“åã€è·¯ç·šã€å‚™è¨»â€¦ï¼‰"
              value="{{ filters.q|default:'' }}">
      </div>
      <div class="filt-item">
        <label for="f-seats">å¯ç”¨åº§ä½</label>
        <input id="f-seats" class="ctl" type="number" min="1" step="1" value="{{ filters.need_seats|default_if_none:'' }}" placeholder="ä¾‹å¦‚ 2">
      </div>
      <div class="filt-item">
        <label for="f-gender">å¸æ©Ÿæ€§åˆ¥</label>
        <select id="f-gender" class="ctl" multiple>
          <option value="M" {% if filters.gender_in and 'M' in filters.gender_in %}selected{% endif %}>ç”·</option>
          <option value="F" {% if filters.gender_in and 'F' in filters.gender_in %}selected{% endif %}>å¥³</option>
          <option value="X" {% if filters.gender_in and 'X' in filters.gender_in %}selected{% endif %}>ä¸é€éœ²</option>
        </select>
      </div>

      <!-- row 3 -->
      <div class="filt-item">
        <label>é…Œæ”¶è²»ç”¨</label>
        <div class="fare-toggle">
          <div id="fareToggle" class="toggle" role="switch" tabindex="0"
               aria-checked="{% if filters.fare_mode == 'gte' %}true{% else %}false{% endif %}"
               data-mode="{% if filters.fare_mode == 'gte' %}gte{% else %}lte{% endif %}">
            <span class="label lte">å°æ–¼ç­‰æ–¼</span>
            <span class="label gte">å¤§æ–¼ç­‰æ–¼</span>
            <span class="knob"></span>
          </div>
          <input type="hidden" id="f-fare-mode" value="{% if filters.fare_mode %}{{ filters.fare_mode }}{% else %}lte{% endif %}">
        </div>
      </div>

      <div class="filt-item only-desktop-spacer"></div>

      <div class="filt-item">
        <label class="sr-only">å¥—ç”¨ç¯©é¸</label>
        <button type="button" class="btn primary ctl" id="applyFilters">å¥—ç”¨ç¯©é¸</button>
      </div>
      <div class="filt-item">
        <label class="sr-only">æ¸…é™¤</label>
        <button type="button" class="btn ghost ctl" id="clearFilters">æ¸…é™¤</button>
      </div>
    </form>

    <div class="chips" id="activeChips"></div>
  </div>
</div>


<script>
(function(){
  /* ---------- å·¥å…· ---------- */
  const $ = (s,r)=> (r||document).querySelector(s);
  const $$= (s,r)=> Array.from((r||document).querySelectorAll(s));
  const getSelVals = (sel)=> Array.from(sel?.selectedOptions||[]).map(o=>o.value).filter(Boolean);
  const saveScrollAndGo = (url)=>{ try{sessionStorage.setItem('scrollY', String(window.scrollY||0));}catch{} location.href=url; };
  const restoreScroll = ()=>{ try{const y=parseInt(sessionStorage.getItem('scrollY')||'0',10); if(!Number.isNaN(y)&&y>0) window.scrollTo({top:y,behavior:'auto'}); sessionStorage.removeItem('scrollY');}catch{} };
  document.addEventListener('DOMContentLoaded', restoreScroll);

  /* ---------- Sortingï¼šè† å›Šåˆ‡æ› ---------- */
  const selectSort = document.getElementById('sort');
  function setSort(val){
    if (selectSort){ selectSort.value = val; selectSort.dispatchEvent(new Event('change',{bubbles:true})); }
    const url = new URL(location.href); url.searchParams.set('sort', val); saveScrollAndGo(url.toString());
  }
  // ä¸‰å€‹é›™å‘è† å›Šéƒ½èƒ½åˆ‡æ›æ’åº
  $$('#segDate .opt, #segGeo .opt, #segAlpha .opt').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const sw = btn.closest('.seg-switch');
      // åˆ‡æ›è† å›Šè¦–è¦º
      sw.setAttribute('data-state', btn.nextElementSibling ? 'left' : 'right'); // ç°¡å–®åˆ¤æ–·ï¼šç¬¬ä¸€é¡†åœ¨å·¦
      setSort(btn.dataset.sort);
    });
  });

  /* ---------- ç¯©é¸ã€æ™¶ç‰‡ï¼ˆèˆ‡ä½ ç¾æœ‰å¾Œç«¯ç›¸å®¹ï¼‰ ---------- */
  const depSel   = document.getElementById('f-dep');
  const desSel   = document.getElementById('f-des');
  const dateSel  = document.getElementById('f-date');
  const retSel   = document.getElementById('f-ret');
  const genderSel= document.getElementById('f-gender');
  const seatsInp = document.getElementById('f-seats');
  const fareNum  = document.getElementById('f-fare-num');
  const fareText = document.getElementById('f-fare-text');
  const fareMode = document.getElementById('f-fare-mode');
  const fareToggle = document.getElementById('fareToggle');
  const chipsBox = document.getElementById('activeChips');

  const FILTERS = (function(){
    try{ const el=document.getElementById('filtersData'); if(el) return JSON.parse(el.textContent||'{}')||{}; }catch{}
    // fallbackï¼šå¾ URL
    const u=new URL(location.href), g=k=>u.searchParams.getAll(k), gi=k=>{const v=u.searchParams.get(k); return v==null?null:(/^\d+$/.test(v)?parseInt(v,10):v);};
    return { dep_in:g('dep'), des_in:g('des'), date_in:g('date'), ret_in:g('ret'), gender_in:g('gender'),
             need_seats:gi('need_seats'), fare_mode:u.searchParams.get('fare_mode')||'', fare_num:gi('fare_num'), fare_q:u.searchParams.get('fare')||'' };
  })();

  function syncFareToggleUI(){
    const mode = (fareMode.value === 'gte') ? 'gte' : 'lte';
    fareToggle.dataset.mode = mode;
    fareToggle.setAttribute('aria-checked', mode==='gte'?'true':'false');
  }
  function toggleFareMode(){
    fareMode.value = (fareMode.value === 'gte') ? 'lte' : 'gte';
    syncFareToggleUI();
  }
  if(fareToggle){ fareToggle.addEventListener('click', toggleFareMode); fareToggle.addEventListener('keydown', e=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); toggleFareMode(); }}); }
  if(!fareMode.value) fareMode.value='lte'; syncFareToggleUI();

  function applyFilters(){
  const url   = new URL(location.href);
  const qInp  = document.getElementById('f-q');        // â˜… é—œéµå­—è¼¸å…¥æ¡†
  url.searchParams.set('sort', selectSort?.value || 'date_desc');

  // å…ˆæ¸…èˆŠåƒæ•¸ï¼ˆå« qï¼‰
  ['q','dep','des','fare','fare_mode','fare_num','date','ret','gender','need_seats']
    .forEach(k => { url.searchParams.delete(k); url.searchParams.delete(k+'[]'); });

  // å¤šé¸
  getSelVals(depSel).forEach(v => url.searchParams.append('dep', v));
  getSelVals(desSel).forEach(v => url.searchParams.append('des', v));
  getSelVals(dateSel).forEach(v => url.searchParams.append('date', v));
  getSelVals(retSel ).forEach(v => url.searchParams.append('ret', v));
  getSelVals(genderSel).forEach(v => url.searchParams.append('gender', v));

  // é…Œæ”¶è²»ç”¨ï¼šæ•¸å­—å„ªå…ˆï¼Œå…¶æ¬¡æ–‡å­—
  const nr = (fareNum?.value || '').trim();
  const nv = nr ? parseInt(nr, 10) : NaN;
  if (!Number.isNaN(nv)) {
    url.searchParams.set('fare_num', String(nv));
    url.searchParams.set('fare_mode', (fareMode?.value === 'gte') ? 'gte' : 'lte');
  } else if (fareText && fareText.value.trim()) {
    url.searchParams.set('fare', fareText.value.trim());
  }

  // å¯ç”¨åº§ä½
  if (seatsInp && seatsInp.value && Number(seatsInp.value) > 0) {
    url.searchParams.set('need_seats', String(parseInt(seatsInp.value, 10)));
  }

  // â˜… æ•´å¡ç‰‡é—œéµå­—
  if (qInp && qInp.value.trim()) {
    url.searchParams.set('q', qInp.value.trim());
  }

  saveScrollAndGo(url.toString());
}

function clearFilters(){
  // æ¸…å¤šé¸
  [depSel, desSel, dateSel, retSel, genderSel].forEach(sel => { if (sel) sel.selectedIndex = -1; });

  // æ¸…æ•¸å­—/æ–‡å­—
  if (fareNum)  fareNum.value = '';
  if (fareText) fareText.value = '';
  if (seatsInp) seatsInp.value = '';

  // æ¸…é—œéµå­— â˜…
  const qInp = document.getElementById('f-q');
  if (qInp) qInp.value = '';

  // é‡ç½®è²»ç”¨æ¨¡å¼ â†’ lte
  if (fareMode) fareMode.value = 'lte';
  if (typeof syncFareToggleUI === 'function') syncFareToggleUI();

  applyFilters();
}

  document.getElementById('applyFilters')?.addEventListener('click', applyFilters);
  document.getElementById('clearFilters')?.addEventListener('click', clearFilters);
  document.getElementById('filtersForm')?.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); applyFilters(); } });

  function makeChip(label, key, value){
    const el=document.createElement('span'); el.className='chip'; el.dataset.key=key; el.dataset.value=value;
    el.innerHTML=`${label}<span class="x" aria-label="ç§»é™¤">Ã—</span>`;
    el.querySelector('.x').addEventListener('click', ()=> {
      const url=new URL(location.href);
      if(['dep','des','date','ret','gender'].includes(key)){
        const all=url.searchParams.getAll(key); url.searchParams.delete(key);
        all.filter(v=>v!==value).forEach(v=> url.searchParams.append(key,v));
      }else{
        if (key==='fare_num') url.searchParams.delete('fare_mode');
        url.searchParams.delete(key);
      }
      saveScrollAndGo(url.toString());
    });
    chipsBox.appendChild(el);
  }
  (function renderChips(){
    const f=FILTERS||{}, m={M:'ç”·',F:'å¥³',X:'ä¸é€éœ²'};
    if(!chipsBox) return; chipsBox.innerHTML='';
    (f.dep_in||[]).forEach(v=> makeChip(`å‡ºç™¼ï¼š${v}`, 'dep', v));
    (f.des_in||[]).forEach(v=> makeChip(`ç›®çš„ï¼š${v}`, 'des', v));
    (f.date_in||[]).forEach(v=> makeChip(`å‡ºç™¼æ—¥ï¼š${v}`, 'date', v));
    (f.ret_in ||[]).forEach(v=> makeChip(`å›ç¨‹æ—¥ï¼š${v}`, 'ret', v));
    (f.gender_in||[]).forEach(v=> makeChip(`æ€§åˆ¥ï¼š${m[v]||v}`, 'gender', v));
    if (f.q) makeChip(`é—œéµå­—ï¼š${f.q}`, 'q', f.q);
    if (f.need_seats) makeChip(`å¯ç”¨åº§ä½â‰¥${f.need_seats}`, 'need_seats', String(f.need_seats));
    if (f.fare_num !== null && f.fare_num !== undefined) makeChip(`è²»ç”¨ ${(f.fare_mode==='gte')?'â‰¥':'â‰¤'} ${f.fare_num}`, 'fare_num', String(f.fare_num));
    else if (f.fare_q) makeChip(`è²»ç”¨å«ï¼š${f.fare_q}`, 'fare', f.fare_q);
  })();
})();
</script>


<ul id="driver-list">
  {% include "Find/_driver_list.html" %}
</ul>







  <!-- å›åˆ°é ‚ç«¯ -->
  <button id="backToTop" onclick="window.scrollTo({top:0, behavior:'smooth'});">â¬†</button>

<!-- å¸æ©Ÿç®¡ç†æˆæ¬Š Modal -->
<div id="driverAuthModal" class="modal" style="display:none;">
  <div class="modal-content">
    <span class="close" onclick="closeDriverAuth()">&times;</span>
    <h3 class="modal-title">ğŸ” ç®¡ç†æˆæ¬Š</h3>
    <p class="modal-desc">è«‹è¼¸å…¥ç®¡ç†å¯†ç¢¼ä»¥ç¹¼çºŒ</p>
    <form id="driverAuthForm" method="POST">
      {% csrf_token %}
      <input type="hidden" id="driverAuthId" value="">
      <div class="form-group">
        <label for="driverAuthPassword">ç®¡ç†å¯†ç¢¼</label>
        <input id="driverAuthPassword" type="password" name="password" required placeholder="è¼¸å…¥ç®¡ç†å¯†ç¢¼">
      </div>
      <div class="modal-actions">
        <button type="submit" class="btn-primary">ç¢ºèª</button>
        <button type="button" class="btn-secondary" onclick="closeDriverAuth()">å–æ¶ˆ</button>
      </div>
    </form>
  </div>
</div>
<!-- åˆªé™¤å¸æ©Ÿ Modal -->
<div id="deleteDriverModal" class="modal" style="display:none;">
  <div class="modal-content" style="max-width:400px;text-align:center;">
    <h3 style="color:#b91c1c;">âš ï¸ ç¢ºèªåˆªé™¤</h3>
    <p>ç¢ºå®šè¦åˆªé™¤æ­¤å¸æ©Ÿå—ï¼Ÿ<br>æ­¤å‹•ä½œæœƒè§£é™¤æ‰€æœ‰ä¹˜å®¢é—œè¯ï¼Œä¸”ç„¡æ³•å¾©åŸã€‚</p>
    <div style="margin-top:20px;display:flex;justify-content:center;gap:12px;">
      <button type="button" class="btn-cancel" onclick="closeDeleteDriver()">å–æ¶ˆ</button>
      <button type="button" class="btn-delete" id="confirmDeleteDriver">åˆªé™¤</button>
    </div>
  </div>
</div>

<style>
  .btn-cancel{background:#d1d5db;padding:8px 14px;border:0;border-radius:6px;cursor:pointer;}
  .btn-delete{background:#dc2626;color:#fff;padding:8px 14px;border:0;border-radius:6px;cursor:pointer;}
  .btn-delete:hover{background:#b91c1c;}
</style>



<!-- Toast å®¹å™¨ -->
<div id="toast-container" style="
  position: fixed;
  top: 20px;
  right: 20px;
  z-index: 2000;
"></div>

<!-- åƒåŠ è¡Œç¨‹ Modal -->
<div id="joinModal" class="modal" style="display:none;">
  <div class="modal-content">
    <div class="modal-header">
      <h3>ğŸ§ åƒåŠ è¡Œç¨‹</h3>
      <button type="button" class="close" onclick="closeJoinModal()">Ã—</button>
    </div>

    <div class="modal-body">
      <form id="joinForm" method="POST">
        {% csrf_token %}

        <div class="join-field">
          <label>æš±ç¨±</label>
          <input type="text" name="passenger_name" required>
        </div>

        <div class="join-field">
          <label>æ€§åˆ¥</label>
          <select name="gender" required>
            <option value="X" selected>ä¸æ–¹ä¾¿é€æ¼</option>
            <option value="M">ç”·ç”Ÿ</option>
            <option value="F">å¥³ç”Ÿ</option>
          </select>
        </div>

        <div class="join-field">
          <label>Email <span class="muted">(ä¸å…¬é–‹ï¼Œç”¨æ–¼åª’åˆé€šçŸ¥)</span></label>
          <input type="email" name="email" placeholder="é¸å¡«">
        </div>

        <div class="join-field">
          <label>è¯çµ¡æ–¹å¼(é¸å¡«,æœªå¡«è«‹è‡ªè¡Œé€£çµ¡å¸æ©Ÿ)</label>
          <input type="text" name="contact" placeholder="LINE / IG / Phone æ“‡ä¸€">
        </div>

        <div class="join-field">
          <label>ä¸Šè»Šäººæ•¸</label>
          <!-- ä¿ç•™ inputï¼›JS æœƒè¦–æƒ…æ³æŠŠå®ƒæ›æˆ select -->
          <input id="join-seats" type="number" name="seats_needed" min="1" value="1" required>
          <small id="seats-hint" class="muted"></small>
        </div>

        <div class="join-field">
          <label>é¡˜ä»˜é‡‘é¡ <span class="muted">ï¼ˆé¸å¡«ï¼Œå–®ä½ NTSï¼‰</span></label>
          <input type="number" name="willing_to_pay" min="0" step="1" placeholder="é¸å¡«">
        </div>

        <!-- ä¸Šè»Šåœ°é»ï¼ˆç¸£å¸‚ä¸‹æ‹‰ + è‡ªå¡«ï¼‰ -->
        <div class="join-field">
          <label for="join-pickup-select">ä¸Šè»Šåœ°é»</label>

          <!-- ä½¿ç”¨ä¸‹æ‹‰åšé¸æ“‡ï¼ˆæ²’æœ‰ nameï¼Œé¿å…ç›´æ¥æäº¤ï¼‰ -->
          <select id="join-pickup-select">
            <option value="">è«‹é¸æ“‡ç¸£å¸‚</option>
            <option value="å…¶ä»–">å…¶ä»–</option>
            <option value="èŠ±è“®ç¸£å…‰å¾©é„‰">èŠ±è“®ç¸£å…‰å¾©é„‰</option>
            <option value="èŠ±è“®ç¸£å…‰å¾©è»Šç«™ä»¥å¤–ç«è»Šç«™">èŠ±è“®ç¸£å…‰å¾©è»Šç«™ä»¥å¤–ç«è»Šç«™</option>
            <option value="èŠ±è“®ç¸£å…‰å¾©è»Šç«™">èŠ±è“®ç¸£å…‰å¾©è»Šç«™</option>
            <option value="å…‰å¾©é„‰ç³–å» ">å…‰å¾©é„‰ç³–å» </option>
            <option value="éœ€æ¸…æ·¤åœ°å€">éœ€æ¸…æ·¤åœ°å€</option>
            <option value="å°åŒ—å¸‚">å°åŒ—å¸‚</option>
            <option value="æ–°åŒ—å¸‚">æ–°åŒ—å¸‚</option>
            <option value="åŸºéš†å¸‚">åŸºéš†å¸‚</option>
            <option value="æ¡ƒåœ’å¸‚">æ¡ƒåœ’å¸‚</option>
            <option value="æ–°ç«¹å¸‚">æ–°ç«¹å¸‚</option>
            <option value="æ–°ç«¹ç¸£">æ–°ç«¹ç¸£</option>
            <option value="è‹—æ —ç¸£">è‹—æ —ç¸£</option>
            <option value="å°ä¸­å¸‚">å°ä¸­å¸‚</option>
            <option value="å½°åŒ–ç¸£">å½°åŒ–ç¸£</option>
            <option value="å—æŠ•ç¸£">å—æŠ•ç¸£</option>
            <option value="é›²æ—ç¸£">é›²æ—ç¸£</option>
            <option value="å˜‰ç¾©å¸‚">å˜‰ç¾©å¸‚</option>
            <option value="å˜‰ç¾©ç¸£">å˜‰ç¾©ç¸£</option>
            <option value="å°å—å¸‚">å°å—å¸‚</option>
            <option value="é«˜é›„å¸‚">é«˜é›„å¸‚</option>
            <option value="å±æ±ç¸£">å±æ±ç¸£</option>
            <option value="å®œè˜­ç¸£">å®œè˜­ç¸£</option>
            <option value="èŠ±è“®ç¸£">èŠ±è“®ç¸£</option>
            <option value="å°æ±ç¸£">å°æ±ç¸£</option>
            <option value="æ¾æ¹–ç¸£">æ¾æ¹–ç¸£</option>
            <option value="é‡‘é–€ç¸£">é‡‘é–€ç¸£</option>
            <option value="é€£æ±Ÿç¸£">é€£æ±Ÿç¸£</option>
          </select>

          <!-- è‡ªå¡«ï¼ˆé¸ã€Œå…¶ä»–ã€æ‰é¡¯ç¤ºï¼›ç„¡ nameï¼‰ -->
          <input type="text" id="join-pickup-custom" placeholder="è¼¸å…¥è‡ªè¨‚ä¸Šè»Šåœ°é»" style="display:none;">

          <!-- çœŸæ­£æäº¤ç”¨ï¼ˆæœ‰ nameï¼‰ -->
          <input type="hidden" id="join-pickup" name="departure">
        </div>
        
        

        <div class="join-field">
          <label>ç›®çš„åœ°</label>
          <input type="text" name="destination">
        </div>



        <!-- å‡ºç™¼æ—¥æœŸï¼ˆå¿…å¡«ï¼‰ -->
        <div class="join-field">
          <label for="join-date">å‡ºç™¼æ—¥æœŸ</label>
          <input type="date" id="join-date" name="date" required>
        </div>
        <!-- æ˜¯å¦ä¸€èµ·å›ç¨‹ -->
        <div class="join-field">
          <label>æ˜¯å¦ä¸€èµ·å›ç¨‹ï¼Ÿ</label>
          <select name="together_return" id="join-together">
            <option value="" selected>æœªæŒ‡å®š</option>
            <option value="true">æ˜¯</option>
            <option value="false">å¦</option>
          </select>
        </div>
        <!-- å›ç¨‹æ—¥æœŸ -->
        <div class="join-field" id="returnField" style="display:none;">
          <label for="join-return">å›ç¨‹æ—¥æœŸ</label>
          <input type="date" id="join-return" name="return_date">
        </div>


        <div class="join-field">
          <label>ç®¡ç†å¯†ç¢¼ <span class="muted">ï¼ˆå»ºè­° 4 ç¢¼ï¼Œä¾›å–æ¶ˆ/ç·¨è¼¯ç”¨ï¼Œé è¨­0000ï¼‰</span></label>
          <input type="password" name="password" placeholder="å»ºè­° 4 ç¢¼" defaultValue="0000">
        </div>

        <div class="join-field">
          <label>å‚™è¨» <span class="muted">ï¼ˆå¯è¼¸å…¥åŒè¡Œäººã€å…·é«”éœ€æ±‚â€¦ï¼‰</span></label>
          <textarea name="note" rows="3" placeholder=""></textarea>
        </div>
      </form>
    </div>

    <div class="modal-footer">
      <button type="button" class="btn-cancel" onclick="closeJoinModal()">å–æ¶ˆ</button>
      <button type="submit" form="joinForm" class="btn-submit">é€å‡º</button>
    </div>
  </div>
</div>

<!-- ä¹˜å®¢ç·¨è¼¯æˆæ¬Š Modal -->
<div id="paxAuthModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="paxAuthTitle" style="display:none;">
  <div class="pax-modal-card">
    <div class="pax-modal-head">
      <div class="pax-title-wrap">
        <span class="pax-lock">ğŸ”’</span>
        <h3 id="paxAuthTitle" class="pax-title">ç®¡ç†æˆæ¬Š</h3>
      </div>
      <button type="button" class="pax-close" aria-label="é—œé–‰" onclick="closePaxAuth()">Ã—</button>
    </div>

    <div class="pax-modal-body">
      <p class="pax-desc">è«‹è¼¸å…¥ç®¡ç†å¯†ç¢¼ä»¥ç¹¼çºŒ</p>

      <form id="paxAuthForm" method="POST" class="pax-form">
        {% csrf_token %}
        <input type="hidden" id="paxAuthId" name="id">
        <div class="pax-form-row">
          <label for="paxAuthPassword">ç®¡ç†å¯†ç¢¼</label>
          <input
            type="password"
            id="paxAuthPassword"
            name="password"
            placeholder="è¼¸å…¥ç®¡ç†å¯†ç¢¼"
            required
            autocomplete="current-password"
          >
        </div>
      </form>
    </div>

    <div class="pax-modal-foot">
      <button type="button" class="btn ghost" onclick="closePaxAuth()">å–æ¶ˆ</button>
      <button type="button" class="btn primary" onclick="submitPaxAuth()">ç¢ºèª</button>
    </div>
  </div>
</div>
<!-- ä¹˜å®¢ç·¨è¼¯ Modal -->
<div id="paxEditModal" class="modal" style="display:none;">
  <div class="modal-content">
    <div class="modal-header">
      <span class="title">âœï¸ ç·¨è¼¯ä¹˜å®¢</span>
      <button class="close" onclick="closePaxEdit()">&times;</button>
    </div>
    <div class="modal-body">
      <form id="paxEditForm">
  {% csrf_token %}
  <input type="hidden" id="paxEditId" name="id">

  <div class="join-field">
    <label>æš±ç¨±</label>
    <input type="text" id="paxName" name="passenger_name" required>
  </div>

  <div class="join-field">
    <label>æ€§åˆ¥</label>
    <select id="paxGender" name="gender">
      <option value="X">ä¸æ–¹ä¾¿é€æ¼</option>
      <option value="M">ç”·ç”Ÿ</option>
      <option value="F">å¥³ç”Ÿ</option>
    </select>
  </div>

  <!-- Emailï¼šå…¨å¯¬ -->
  <div class="join-field full">
    <label>Emailï¼ˆä¸å…¬é–‹ï¼‰</label>
    <input type="email" id="paxEmail" name="email" placeholder="å¯ç©ºç™½">
  </div>

  <!-- éš±ç§è¨­å®šï¼šSwitchï¼Œéœ€ Email æ‰èƒ½å•Ÿç”¨ï¼ˆå…¨å¯¬ï¼‰ -->
  <div class="join-field full">
    <label>éš±ç§è¨­å®š</label>
    <div class="switch">
  <input type="checkbox" id="paxHideContact" name="hide_contact">
  <!-- åŸæœ¬æ˜¯ <span class="toggle"></span> -->
  <label class="toggle" for="paxHideContact"></label>
  <label class="switch-text" for="paxHideContact">éš±è—å€‹è³‡ï¼ˆè¯çµ¡æ–¹å¼ï¼‰</label>
</div>
<small id="paxPrivacyHint" class="muted">â€» éœ€å¡«å¯« Email æ‰èƒ½éš±è—ï¼›Email åƒ…ä¾›ç³»çµ±é€šçŸ¥ï¼Œä¸æœƒå…¬é–‹ã€‚</small>
  </div>

  <div class="join-field">
    <label>è¯çµ¡æ–¹å¼</label>
    <input type="text" id="paxContact" name="contact" placeholder="LINE / IG / Phone">
  </div>

  <div class="join-field">
    <label>ä¸Šè»Šäººæ•¸</label>
    <input type="number" id="paxSeats" name="seats_needed" min="1" value="1">
  </div>

  <div class="join-field">
    <label>é¡˜ä»˜é‡‘é¡ï¼ˆå¯ç©ºï¼‰</label>
    <input type="text" id="paxPay" name="willing_to_pay" placeholder="ä¾‹å¦‚ 300">
  </div>

  <div class="join-field">
    <label>ä¸Šè»Šåœ°é»</label>
    <input type="text" id="paxDeparture" name="departure">
  </div>

  <div class="join-field">
    <label>ç›®çš„åœ°</label>
    <input type="text" id="paxDestination" name="destination">
  </div>

  <div class="join-field">
    <label>å‡ºç™¼æ—¥æœŸ</label>
    <input type="date" id="paxDate" name="date">
  </div>

  <div class="join-field">
    <label>å›ç¨‹æ—¥æœŸï¼ˆé¸å¡«ï¼‰</label>
    <input type="date" id="paxReturn" name="return_date">
  </div>

  <div class="join-field">
    <label>æ˜¯å¦ä¸€èµ·å›ç¨‹</label>
    <select id="paxTogether" name="together_return">
      <option value="">æœªæŒ‡å®š</option>
      <option value="true">æ˜¯</option>
      <option value="false">å¦</option>
    </select>
  </div>

  <!-- å‚™è¨»ï¼šå…¨å¯¬ -->
  <div class="join-field full">
    <label>å‚™è¨»</label>
    <textarea id="paxNote" name="note" rows="3"></textarea>
  </div>
</form>

    </div>
    <div class="modal-footer">
      <button class="btn-cancel" onclick="closePaxEdit()">å–æ¶ˆ</button>
      <button class="btn-submit" onclick="submitPaxEdit()">å„²å­˜</button>
    </div>
  </div>
</div>

<!-- ä¹˜å®¢åˆªé™¤ Modalï¼ˆç°¡å–®ç¢ºèªï¼‰ -->
<div id="paxDelModal" class="modal" style="display:none;">
  <div class="modal-content">
    <div class="modal-header">
      <span class="title">ğŸ—‘ åˆªé™¤ä¹˜å®¢</span>
      <button class="close" onclick="closePaxDel()">&times;</button>
    </div>
    <div class="modal-body">
      <p>ç¢ºå®šè¦åˆªé™¤é€™ä½ä¹˜å®¢å—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚</p>
      <input type="hidden" id="paxDelId">
    </div>
    <div class="modal-footer">
      <button class="btn-cancel" onclick="closePaxDel()">å–æ¶ˆ</button>
      <button class="btn-submit" style="background:#e11d48" onclick="confirmPaxDel()">åˆªé™¤</button>
    </div>
  </div>
</div>

<!-- â‘¢ èªªæ˜ Modal -->
<div class="modal fade" id="introModal"
     data-bs-backdrop="false" data-bs-keyboard="true"
     tabindex="-1" aria-labelledby="introModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content shadow-lg">
      <div class="modal-header">
        <h5 class="modal-title fw-bold" id="introModalLabel">ä½¿ç”¨èªªæ˜èˆ‡å€‹è³‡è²æ˜</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="é—œé–‰"></button>
      </div>

      <div class="modal-body">
        <!-- ä½¿ç”¨èªªæ˜ -->
        <div class="card border-0 mb-4">
          <div class="card-header bg-primary text-white">
            <strong>å¦‚ä½•ä½¿ç”¨</strong>
          </div>
          <div class="card-body">
            <ul class="intro-list list-unstyled">
            <li class="intro-row">
              <span class="badge bg-primary rounded-pill px-2 py-1">å¸æ©Ÿ</span>
              <span>é»ã€Œæˆ‘è¦å‡ºè»Šã€ï¼Œå¡«å¯«è¡Œç¨‹å¾Œç­‰å€™ä¹˜å®¢å ±åï¼›æœ‰äººåŠ å…¥æœƒå¯„å‡º Email é€šçŸ¥å¸æ©Ÿï¼›å¸æ©Ÿå¯é¸æ“‡ã€Œæ¥å—ï¼æ‹’çµ•ã€ã€‚åº§ä½æ»¿é¡å¾Œï¼Œç³»çµ±æœƒä¾è¦å‰‡æŠŠè¯çµ¡æ–¹å¼å¯„çµ¦éœ€è¦çš„ä¸€æ–¹ã€‚</span>
            </li>
            <li class="intro-row">
              <span class="badge bg-danger rounded-pill px-2 py-1">ä¹˜å®¢</span>
              <span>é»ã€Œæˆ‘è¦æ­è»Šã€ï¼Œå¡«å¯«éœ€æ±‚å¾Œæœƒå‡ºç¾åœ¨åˆ—è¡¨ã€‚å¸æ©Ÿå¯ä¾æ¢ä»¶æ˜¯å¦ç¬¦åˆï¼Œé¸æ“‡ç›´æ¥é‚€è«‹æˆ–æ¥å—ä½ çš„å ±åã€‚</span>
            </li>
          </ul>
          </div>
        </div>

        <!-- å€‹è³‡èˆ‡é€šçŸ¥è¦å‰‡ -->
        <div class="card border-0 mb-4">
          <div class="card-header bg-info text-white">
            <strong>å€‹è³‡èˆ‡é€šçŸ¥è¦å‰‡</strong>
          </div>
          <div class="card-body">
            <div class="alert alert-info py-2">
              å¯å‹¾é¸ <strong>ã€Œéš±è—å€‹è³‡ï¼ˆè¯çµ¡æ–¹å¼ï¼‰ã€</strong>ã€‚è‹¥å‹¾é¸ï¼Œ<strong>éœ€æä¾› Email</strong> ä»¥ä¾¿ç³»çµ±ç§è¨Šé€šçŸ¥ï¼›Email ä¸å…¬é–‹ã€‚
            </div>
            <ul class="list-group list-group-numbered">
              <li class="list-group-item">
                <strong>å¸æ©Ÿæœªæä¾› Email</strong>ï¼šå¸æ©Ÿè¯çµ¡æ–¹å¼å¯èƒ½å…¬é–‹åœ¨å¡ç‰‡ä¸Šä¾›ä¹˜å®¢è¯ç¹«ã€‚
              </li>
              <li class="list-group-item">
                <strong>é€šçŸ¥å¯„é€é‚è¼¯</strong>
                <ul class="mt-2 mb-0 ps-3">
                  <li>å¸æ©Ÿå…¬é–‹ã€ä¹˜å®¢éš±è— â†’ ç³»çµ±æŠŠä¹˜å®¢è¯çµ¡æ–¹å¼ Email çµ¦å¸æ©Ÿã€‚</li>
                  <li>å¸æ©Ÿéš±è—ã€ä¹˜å®¢å…¬é–‹ â†’ ç³»çµ±æŠŠå¸æ©Ÿè¯çµ¡æ–¹å¼ Email çµ¦ä¹˜å®¢ã€‚</li>
                  <li>å…©é‚Šéƒ½å…¬é–‹ â†’ ä¸å¦å¤–å¯„ä¿¡ã€‚</li>
                </ul>
              </li>
              <li class="list-group-item">æœ¬ç¶²ç«™æ”¶é›†çš„ Email åƒ…ç”¨æ–¼åª’åˆé€šçŸ¥ï¼Œä¸åšå…¶ä»–ç”¨é€”ã€‚</li>
            </ul>
          </div>
        </div>

        <!-- è³‡è¨Šå…¬é–‹ï¼å…è²¬ -->
        <div class="card border-0 mb-4">
          <div class="card-header bg-secondary text-white">
            <strong>è³‡è¨Šå…¬é–‹è²æ˜èˆ‡å…è²¬</strong>
          </div>
          <div class="card-body">
            <ul class="list-group list-group-flush">
              <li class="list-group-item">æœ¬å¹³å°ç‚ºã€ŒèŠ±è“®å…‰å¾©æ•‘ç½ äº¤é€šåª’åˆã€ä¹‹è‡ªåŠ©å·¥å…·ï¼Œå”åŠ©ä¹˜å®¢èˆ‡å¸æ©Ÿäº’ç›¸æ‰¾åˆ°è³‡è¨Šã€‚</li>
              <li class="list-group-item">å¹³å°ä¸åƒèˆ‡é‡‘éŒ¢å¾€ä¾†ã€ä¸ä»‹å…¥é›™æ–¹äº¤æ˜“åŠè¡Œç‚ºç®¡ç†ã€‚</li>
              <li class="list-group-item">ä½¿ç”¨è€…æ‡‰è‡ªè¡Œè©•ä¼°é¢¨éšªä¸¦è² è²¬è‡ªèº«å®‰å…¨èˆ‡è¡Œç‚ºï¼›å¹³å°ä¸å°ä»»ä½•ç³¾ç´›ã€æå®³ã€å¤±ç«Šã€å—å‚·æˆ–å…¶ä»–æ³•å¾‹è²¬ä»»è² è²¬ã€‚</li>
              <li class="list-group-item">è‹¥æœ‰ä¸ç•¶è¡Œç‚ºæˆ–çˆ­è­°ï¼Œè«‹ç«‹å³å‘è­¦æ–¹æˆ–ä¸»ç®¡æ©Ÿé—œå ±æ¡ˆã€‚</li>
            </ul>
          </div>
        </div>

        <!-- å€‹è³‡ä¿è­·å»ºè­° -->
        <div class="card border-0">
          <div class="card-header bg-light">
            <strong>å€‹è³‡ä¿è­·å»ºè­°</strong>
          </div>
          <div class="card-body">
            <ul class="list-group list-group-flush">
              <li class="list-group-item">åƒ…æä¾›å¿…è¦è¯çµ¡æ–¹å¼ï¼›åœ¨æ„éš±ç§å¯ä½¿ç”¨ IGã€Line ID ç­‰ç¤¾ç¾¤å¸³è™Ÿè¯çµ¡ã€‚</li>
              <li class="list-group-item">å‹¿åœ¨å…¬é–‹æ¬„ä½å¡«å¯«èº«åˆ†è­‰å­—è™Ÿã€ä½å€ã€éŠ€è¡Œå¸³è™Ÿç­‰æ•æ„Ÿè³‡è¨Šã€‚</li>
              <li class="list-group-item">é‡åˆ°ä¸å°‹å¸¸è¦æ±‚ï¼ˆåŒ¯æ¬¾ã€å‚³æª”ã€ä¸‹è¼‰ APP ç­‰ï¼‰è«‹ç«‹å³åœæ­¢ä¸¦æ±‚è­‰ã€‚</li>
            </ul>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é—œé–‰</button>
      </div>
    </div>
  </div>
</div>


<script>
  document.addEventListener('DOMContentLoaded', function() {
  const urlParams = new URLSearchParams(window.location.search);
  
  // æª¢æŸ¥ URL ä¸­æ˜¯å¦æœ‰ `auth_required` åƒæ•¸
  if (urlParams.has('auth_required') && urlParams.get('auth_required') === 'true') {
    // é¡¯ç¤ºèº«ä»½é©—è­‰å°è©±æ¡†
    showToastSafe("ç‚ºä¿è­·å€‹è³‡ï¼Œè«‹å‹¿ä½¿ç”¨ç¶²å€ç ´è§£ç™»å…¥ã€‚", "warning"); // é¡¯ç¤ºæç¤ºè¨Šæ¯
  }
});
document.addEventListener('DOMContentLoaded', function() {
  // å‡è¨­ä½ ä½¿ç”¨äº† `showToastSafe` å‡½å¼ä¾†é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
  const params = new URLSearchParams(window.location.search);
  const error = params.get("error");
  
  if (error) {
    showToastSafe(error, "error");
  }
});
/* =========================================================================
 * 0) å…¬ç”¨å°å·¥å…·ï¼ˆå–®ä¸€ä¾†æºï¼‰
 * ========================================================================= */
function getCookie(name) {
  const match = document.cookie.match(new RegExp('(^|; )' + name + '=([^;]*)'));
  return match ? decodeURIComponent(match[2]) : null;
}
function getCSRF() { return getCookie('csrftoken'); }
 (function initUtils(){
  if (window.__UTILS_READY__) return;
  window.__UTILS_READY__ = true;

  window.$id = (id) => document.getElementById(id);

  window.getCookie = function(name){
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    return parts.length === 2 ? parts.pop().split(';').shift() : null;
  };

  // å¾ä»»ä¸€è¡¨å–®æˆ– cookie å– CSRFï¼ˆå„ªå…ˆè¡¨å–®ï¼‰
 window.getCSRF = function(form) {
  const el = (form || document).querySelector('input[name="csrfmiddlewaretoken"]');
  return el ? el.value : getCookie('csrftoken') || '';
};

  window.showToastSafe = function(msg, type){
    if (typeof showToast === 'function') showToast(msg, type);
    else alert(msg);
  };

  // å®‰å…¨ JSON å–å›ï¼šres å¤±æ•—æˆ–é JSON ä¸æ‹‹ä¾‹å¤–
  window.jsonFetch = async function(url, options = {}) {
  const res = await fetch(url, options);
  let data = {};
  try {
    data = await res.json();
  } catch (e) {
    console.error('JSON parsing error:', e);
    data = { ok: false, error: 'Invalid JSON response' };
  }
  return { res, data };
};
})();

/* =========================================================================
 * 1) WebSocket åˆå§‹åŒ–ï¼ˆå–®ä¸€ä¾†æºï¼‰+ äº‹ä»¶ç¶å®šï¼ˆä½¿ç”¨ addEventListenerï¼‰
 *    - æ”¯æ´å…¨é‡ passengers_html
 *    - æ”¯æ´å–®å¡ç‰‡ driver_partial â†’ patchDriverCard()
 * ========================================================================= */
(function initSocket(){
  if (!window.socket) {
    window.socket = new WebSocket(
      (location.protocol === 'https:' ? 'wss://' : 'ws://') + window.location.host + '/ws/find/'
    );
  }
  socket.addEventListener('open',  () => console.log('âœ… WebSocket é€£ç·šæˆåŠŸ'));
  socket.addEventListener('close', () => console.log('âŒ WebSocket å·²é—œé–‰'));
  socket.addEventListener('error', (err) => console.error('âš ï¸ WebSocket ç™¼ç”ŸéŒ¯èª¤', err));

  socket.addEventListener('message', (event) => {
    let data;
    try { data = JSON.parse(event.data); } catch { return; }

    // å–®ä¸€å¡ç‰‡æ›´æ–°
    if (data.type === 'driver_partial') {
      // æœŸå¾… payload: { type, driver_id, driver_html, active }
      patchDriverCard(data.driver_id, data.driver_html, data.active);
      return;
    }

    // å…¨é‡æ›´æ–°ï¼ˆä¿ç•™ä¹˜å®¢æ¸…å–®ï¼‰
    if (data.type === 'update') {
      if (data.passengers_html) {
        const plist = $id('passenger-list');
        if (plist) plist.innerHTML = data.passengers_html;
      }
      // drivers_html å»ºè­°æ”¹èµ° driver_partialï¼›å¦‚ä»å‚³å…¥ï¼Œå¯è¦–éœ€æ±‚è™•ç†
      return;
    }

    if (data.type === 'join_result') {
      if (data.success) showToastSafe('âœ… æˆåŠŸåŠ å…¥ä¹˜å®¢è¡Œç¨‹ï¼', 'success');
      else showToastSafe('âš ï¸ åŠ å…¥å¤±æ•—ï¼š' + (data.message || 'æ²’æœ‰å¯ç”¨çš„å¸æ©Ÿ'), 'error');
    }
  });
})();

/* =========================================================================
 * 2) Driver åˆ—è¡¨ï¼šå…¨é‡æ›¿æ›ï¼ˆä¿ç•™å±•é–‹èˆ‡å·è»¸ï¼‰ & å–®å¡ç‰‡æ›¿æ›
 * ========================================================================= */


 // è¨˜ä½ç›®å‰å±•é–‹çš„ driver ids
function snapshotOpenDrivers () {
  return Array
    .from(document.querySelectorAll('#driver-list .details.open'))
    .map(el => el.id.replace('details-', ''));
}
// é‚„åŸå±•é–‹ç‹€æ…‹ï¼ˆåŒ…å«ç®­é ­ ariaï¼‰
function restoreOpenDrivers (openIds) {
  if (!Array.isArray(openIds) || openIds.length === 0) return;
  openIds.forEach(id => {
    const details = document.getElementById('details-' + id);
    const arrow   = document.getElementById('arrow-' + id);
    if (details) {
      details.classList.add('open');
      details.setAttribute('aria-hidden', 'false');
    }
    if (arrow) {
      arrow.classList.add('open');
      arrow.setAttribute('aria-expanded', 'true');
    }
  });
}
// å…¨é‡æ›¿æ› driver list
function replaceDriverListSafely (newHtml) {
  const list = document.getElementById('driver-list');
  if (!list || typeof newHtml !== 'string') return;
  const openIds     = snapshotOpenDrivers();
  const prevScrollY = window.scrollY;
  list.innerHTML = newHtml;
  restoreOpenDrivers(openIds);
  window.scrollTo(0, prevScrollY);
}
// åŒæ™‚è™•ç† drivers / passengers
function replaceLists (data) {
  if (!data || typeof data !== 'object') return;
  if (typeof data.drivers_html === 'string') replaceDriverListSafely(data.drivers_html);
  if (typeof data.passengers_html === 'string') {
    const p = document.getElementById('passenger-list');
    if (p) p.innerHTML = data.passengers_html;
  }
}

// å–å¾—å¡ç‰‡ç‹€æ…‹
function snapshotCardState(li) {
  if (!li) return null;
  const panel    = li.querySelector('.details');
  if (!panel) return { open: false, scrollP: 0, scrollA: 0 };
  const pending  = panel.querySelector('.pending-scroll');
  const accepted = panel.querySelector('.accepted-scroll');
  return {
    open   : panel.classList.contains('open'),
    scrollP: pending  ? pending.scrollTop  : 0,
    scrollA: accepted ? accepted.scrollTop : 0
  };
}
// é‚„åŸå¡ç‰‡ç‹€æ…‹
function restoreCardState(li, state) {
  if (!li || !state) return;
  const panel = li.querySelector('.details');
  const arrow = li.querySelector('.arrow');
  if (state.open && panel) {
    panel.classList.add('open');
    panel.setAttribute('aria-hidden', 'false');
    if (arrow) {
      arrow.classList.add('open');
      arrow.setAttribute('aria-expanded', 'true');
    }
  }
  const pending  = li.querySelector('.pending-scroll');
  const accepted = li.querySelector('.accepted-scroll');
  if (pending)  pending.scrollTop  = state.scrollP || 0;
  if (accepted) accepted.scrollTop = state.scrollA || 0;
}
// å–®ä¸€å¡ç‰‡æ›¿æ› / é™„åŠ  / ç§»é™¤
function patchDriverCard(driverId, driverHTML, active = true) {
  const list = document.getElementById('driver-list');
  if (!list || !driverId || typeof driverHTML !== 'string') return;
  const selector = `li[data-driver="${CSS.escape(String(driverId))}"]`;
  const oldLi = list.querySelector(selector);

  // ä¸å­˜åœ¨ï¼šactive=true â†’ append
  if (!oldLi) {
    if (!active) return;
    const tmp = document.createElement('div');
    tmp.innerHTML = driverHTML.trim();
    const newLi = tmp.querySelector('li') || tmp.firstElementChild;
    if (newLi) list.appendChild(newLi);
    return;
  }
  // ä¸‹æ¶ï¼šç§»é™¤
  if (!active) { oldLi.remove(); return; }

  const state = snapshotCardState(oldLi);
  const tmp = document.createElement('div');
  tmp.innerHTML = driverHTML.trim();
  const newLi = tmp.querySelector('li') || tmp.firstElementChild;
  if (!newLi) return;
  oldLi.replaceWith(newLi);
  restoreCardState(newLi, state);
}
/* ========= è®“å±•é–‹é¢æ¿åœ¨æ‰‹æ©Ÿä¸Šæˆç‚ºå¯æ²å®¹å™¨ ========= */
function setDetailsMaxHeight(li){
  if (!li) return;
  const details = li.querySelector('.details');
  if (!details || !details.classList.contains('open')) return;

  // å¯è¦‹çª—å£å‰©é¤˜é«˜åº¦ï¼šè¦–çª—é«˜ - å¡ç‰‡ç›®å‰åˆ°è¦–çª—é ‚ç«¯è·é›¢ - åº•éƒ¨ç·©è¡
  const rect   = li.getBoundingClientRect();
  const topGap = Math.max(0, rect.top);
  const safe   = 16; // åº•éƒ¨ç•™ç™½
  const avail  = Math.max(240, window.innerHeight - topGap - safe);

  details.style.maxHeight = avail + 'px';
  details.style.overflow  = 'auto';
  details.style.webkitOverflowScrolling = 'touch';
}

// ---- å–®ä¸€ä¾†æºï¼šå¡ç‰‡å±•é–‹/æ”¶åˆï¼ˆé˜²é‡è¤‡ï¼‰----
(function () {
  if (window.__BIND_CARD_TOGGLE__) return;
  window.__BIND_CARD_TOGGLE__ = true;

  // å¯æ²é«˜åº¦è¨ˆç®—ï¼ˆè·Ÿä½ ä¹‹å‰çš„ä¸€æ¨£ï¼Œé€™è£¡åŒ…æˆå‡½å¼ï¼‰
  function setDetailsMaxHeightByArrow(arrowEl){
    const li = arrowEl.closest('.driver-card');
    if (!li) return;
    const details = li.querySelector('.details');
    if (!details || !details.classList.contains('open')) return;

    const rect   = li.getBoundingClientRect();
    const topGap = Math.max(0, rect.top);
    const safe   = 16; // åº•éƒ¨ç•™ç™½
    const avail  = Math.max(240, window.innerHeight - topGap - safe);

    details.style.maxHeight = avail + 'px';
    details.style.overflow  = 'auto';
    details.style.webkitOverflowScrolling = 'touch';
  }

  let lastToggleAt = 0;

  document.addEventListener('click', function (e) {
    const btn = e.target.closest('[data-action="toggle"]');
    if (!btn) return;

    // é˜²é›™è§¸ç™¼ï¼šæ“‹ä½å¾ŒçºŒåŒä¸€è¼ª listenerã€ä¹Ÿåšå€‹ 150ms ç¯€æµ
    e.preventDefault();
    e.stopPropagation();
    if (typeof e.stopImmediatePropagation === 'function') e.stopImmediatePropagation();
    const now = Date.now();
    if (now - lastToggleAt < 150) return;
    lastToggleAt = now;

    const driverId = btn.dataset.id;
    const details  = document.getElementById('details-' + driverId);
    const arrow    = document.getElementById('arrow-' + driverId) || btn;
    if (!details) return;

    // æ”¹ç”¨ã€Œé¡¯å¼ç‹€æ…‹ã€é¿å… toggle å…©æ¬¡ç›¸äº’æŠµéŠ·
    const willOpen = !details.classList.contains('open');
    details.classList.toggle('open', willOpen);
    details.setAttribute('aria-hidden', willOpen ? 'false' : 'true');
    if (arrow) {
      arrow.classList.toggle('open', willOpen);
      arrow.setAttribute('aria-expanded', willOpen ? 'true' : 'false');
    }

    // æ‰“é–‹æ™‚è¨­å®šå¯æ²é«˜åº¦ï¼›é—œé–‰æ™‚æ¸…é™¤é«˜åº¦
    if (willOpen) {
      setDetailsMaxHeightByArrow(arrow || details);
    } else {
      details.style.maxHeight = '';
      details.style.overflow  = '';
    }
  }, true); // ç”¨æ•ç²éšæ®µï¼Œèƒ½å…ˆæ–¼å…¶ä»– document click è™•ç†ä¸¦é˜»æ–·

  // æ—‹è½‰/ç¸®æ”¾æ™‚ï¼Œé‡ç®—æ‰€æœ‰æ‰“é–‹ä¸­çš„
  window.addEventListener('resize', () => {
    document.querySelectorAll('#driver-list .driver-card .details.open')
      .forEach(d => {
        const arrow = d.closest('.driver-card')?.querySelector('.arrow');
        if (arrow) setDetailsMaxHeightByArrow(arrow);
      });
  });
})();



/* =========================================================================
 * 3) Driver ç®¡ç†æˆæ¬Šï¼ˆå¯†ç¢¼é©—è­‰ â†’ æˆåŠŸè·³è½‰ï¼‰
 *    - openDriverModal(driverId) / closeDriverAuth()
 * ========================================================================= */
(function initDriverAuth(){
  function bindDriverAuthForm() {
    const form = $id("driverAuthForm");
    if (!form || form.dataset.bound === "1") return;

    const idEl  = $id("driverAuthId");
    const pwdEl = $id("driverAuthPassword");

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const driverId = idEl && idEl.value;
      const password = pwdEl && pwdEl.value;
      if (!driverId) { console.error("ç¼º driverId"); return; }
      if (!password) { showToastSafe("è«‹è¼¸å…¥å¯†ç¢¼", "error"); pwdEl && pwdEl.focus(); return; }

      const btn = form.querySelector('[type="submit"]');
      try {
        if (btn) btn.disabled = true;
        const { res, data } = await jsonFetch(`/find/driver/${driverId}/manage/auth/`, {
          method: "POST",
          credentials: "same-origin",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8",
            "X-CSRFToken": getCSRF(form),
            "X-Requested-With": "XMLHttpRequest",
          },
          body: new URLSearchParams({ password }),
        });

        if (res.ok && data && data.ok && data.url) {
          showToastSafe("âœ… é©—è­‰æˆåŠŸï¼Œå‰å¾€ç®¡ç†é â€¦", "success");
          closeDriverAuth();
          window.location.href = data.url;
        } else {
          const msg = (data && (data.error || data.detail)) || `é©—è­‰å¤±æ•— (HTTP ${res.status})`;
          showToastSafe(msg, "error");
          pwdEl && pwdEl.focus();
        }
      } catch (err) {
        console.error(err);
        showToastSafe("ä¼ºæœå™¨éŒ¯èª¤ï¼Œç¨å¾Œå†è©¦", "error");
      } finally {
        if (btn) btn.disabled = false;
      }
    });

    form.dataset.bound = "1";
  }

  window.openDriverModal = function (driverId) {
    const idEl  = $id("driverAuthId");
    const pwdEl = $id("driverAuthPassword");
    const modal = $id("driverAuthModal");
    if (!idEl || !pwdEl || !modal) { alert("ç®¡ç†è¦–çª—å…ƒä»¶ç¼ºå¤±"); return; }
    idEl.value = driverId;
    pwdEl.value = "";
    modal.style.display = "block";
    bindDriverAuthForm();
    setTimeout(() => pwdEl.focus(), 0);
  };
  window.closeDriverAuth = function () {
    const modal = $id("driverAuthModal");
    if (modal) modal.style.display = "none";
  };
  document.addEventListener("DOMContentLoaded", bindDriverAuthForm);
})();

/* =========================================================================
 * 4) Join / Cancel Modal é–‹é—œ + å¯é¸ AJAX é€å‡º
 *    - openJoinModal(driverId) / closeJoinModal()
 *    - openCancelModal(passengerId)
 * ========================================================================= */
function openJoinModal(driverId){
  const m = $id('joinModal');
  const f = $id('joinForm');
  if (!m || !f) return;
  f.action = `/find/driver/${driverId}/join/`;
  m.style.display = 'block';
  document.body.classList.add('body-modal-open');
  setTimeout(() => {
    const first = f.querySelector('input,select,textarea');
    if (first) first.focus();
  }, 0);
}
function closeJoinModal(){
  const m = $id('joinModal');
  if (m) m.style.display = 'none';
  document.body.classList.remove('body-modal-open');
}
function openCancelModal(passengerId){
  const m = $id('cancelModal');
  const f = $id('cancelForm');
  const hidden = $id('cancelPassengerId');
  if (!m || !f || !hidden) return;
  hidden.value = passengerId;
  f.action = `/find/passenger/${passengerId}/cancel/`;
  m.style.display = 'block';
}

// å¯é¸ï¼šæŠŠ join/cancel æ””æˆªæˆ AJAX
(function enhanceJoinCancel(){
  const joinForm   = $id('joinForm');
  const cancelForm = $id('cancelForm');

  async function ajaxSubmit(form, okMsg){
    const body = new URLSearchParams(new FormData(form));
    const { res, data } = await jsonFetch(form.action, {
      method: 'POST',
      headers: { 'X-Requested-With': 'XMLHttpRequest' },
      body
    });
    if (res.ok && data.ok) {
      showToastSafe(okMsg || 'æˆåŠŸ', 'success');
      const modal = form.closest('.modal');
      if (modal) modal.style.display = 'none';
    } else {
      const msg = (data && (data.error || data.detail)) || `å¤±æ•—ï¼ˆ${res.status}ï¼‰`;
      showToastSafe(msg, 'error');
    }
  }

  if (joinForm) {
    joinForm.addEventListener('submit', async (e) => {
      e.preventDefault();             // è¦èµ°åŒæ­¥ POST çš„è©±ï¼Œç§»é™¤æ­¤è¡Œ
      await ajaxSubmit(joinForm, 'âœ… å·²é€å‡ºç”³è«‹');
    });
  }
  if (cancelForm) {
    cancelForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      await ajaxSubmit(cancelForm, 'ğŸ—‘ï¸ å·²å–æ¶ˆ');
    });
  }
})();

</script>
<script>
(function joinModalBehavior(){
  let currentDriverDate   = "";
  let currentDriverReturn = "";

  // å°å·¥å…·
  const $id = (id)=> document.getElementById(id);

  function grabJoinEls() {
    return {
      togetherSel: $id("join-together"),
      departInput: $id("join-date"),
      returnWrap : $id("returnField"),
      returnInput: $id("join-return"),
      joinModal  : $id("joinModal"),
      joinForm   : $id("joinForm"),
    };
  }

  // æ˜¯å¦ä¸€èµ·å›ç¨‹ â†’ é¡¯ç¤º/éš±è—å›ç¨‹æ¬„ä½ + min
  function handleTogetherChange() {
    const { togetherSel, departInput, returnWrap, returnInput } = grabJoinEls();
    const v = togetherSel ? togetherSel.value : "";

    if (returnInput) {
      const minBase = (departInput && departInput.value) || currentDriverDate || "";
      returnInput.min = minBase;
    }

    if (v === "false") {
      if (returnWrap) returnWrap.style.display = "block";
      if (returnInput) {
        returnInput.readOnly = false;
        if (!returnInput.value && returnInput.min) returnInput.value = returnInput.min;
      }
    } else if (v === "true") {
      const hasReturn = !!currentDriverReturn;
      if (returnWrap) returnWrap.style.display = hasReturn ? "block" : "none";
      if (returnInput) {
        returnInput.readOnly = true;
        returnInput.value = hasReturn ? currentDriverReturn : "";
      }
    } else {
      if (returnWrap) returnWrap.style.display = "none";
      if (returnInput) { returnInput.readOnly = false; returnInput.value = ""; }
    }
  }

  // å›ç¨‹ min â‰§ å‡ºç™¼
  function syncReturnMin() {
    const { departInput, returnInput } = grabJoinEls();
    if (!departInput || !returnInput) return;
    returnInput.min = departInput.value || currentDriverDate || "";
    if (returnInput.value && departInput.value && returnInput.value < departInput.value) {
      returnInput.value = "";
    }
  }

  // ä¾å‰©é¤˜åº§ä½å‹•æ…‹é™åˆ¶ seatsï¼ˆæ”¯æ´ <input> æˆ– <select>ï¼‰
  function setupSeatsControl(remaining){
    let field = $id("join-seats") || document.querySelector('[name="seats_needed"]');
    if (!field) return;
    if (!field.id) field.id = "join-seats";

    const hint  = $id("seats-hint");
    const submitBtn = document.querySelector('#joinForm .btn-submit');

    const rm = parseInt(remaining || 0, 10);
    if (hint) hint.textContent = rm > 0 ? `å‰©é¤˜ ${rm} ä½` : 'æ­¤è¡Œç¨‹åº§ä½å·²æ»¿ï¼Œç„¡æ³•ç”³è«‹';
    if (submitBtn) submitBtn.disabled = rm <= 0;

    const isSelect = field.tagName.toLowerCase() === 'select';

    const coerce = (val) => {
      let n = parseInt(val || "1", 10);
      if (!Number.isFinite(n) || n < 1) n = 1;
      if (rm > 0 && n > rm) n = rm;
      return String(n);
    };

    if (rm <= 0) {
      field.value = isSelect ? "0" : "";
      field.setAttribute('disabled','disabled');
      field.setCustomValidity('æ­¤è¡Œç¨‹åº§ä½å·²æ»¿');
      return;
    }

    // æœ‰ä½å­ â†’ è§£é– + é©—è­‰
    field.removeAttribute('disabled');
    field.setCustomValidity('');

    if (isSelect) {
      field.innerHTML = "";
      for (let i = 1; i <= rm; i++) {
        const opt = document.createElement("option");
        opt.value = String(i);
        opt.textContent = String(i);
        field.appendChild(opt);
      }
      field.value = coerce(field.value);
    } else {
      field.type = "number";
      field.min  = "1";
      field.step = "1";
      field.max  = String(rm);
      field.value = coerce(field.value);

      const validate = () => {
        const v = parseInt(field.value || "0", 10);
        if (!Number.isFinite(v) || v < 1) field.setCustomValidity('äººæ•¸è‡³å°‘ç‚º 1');
        else if (v > rm)            field.setCustomValidity(`æœ€å¤šå¯é¸ ${rm} ä½`);
        else                        field.setCustomValidity('');
      };
      field.oninput = validate;
      field.onchange = validate;
      validate();
    }
  }

  // === å°å¤– APIï¼šé–‹å•Ÿ Join Modalï¼ˆåš´æ ¼ä½¿ç”¨å‚³å…¥çš„ remainingï¼‰ ===
  window.openJoinModal = function (driverId, driverDate = "", driverReturn = "", driverRemaining = 0, _seq = null) {
    if (_seq !== null && _seq !== window.__joinOpenSeq) {
      // èˆŠçš„/ç„¡æ•ˆå‘¼å«ï¼Œç›´æ¥å¿½ç•¥
      return;
    }
    
    const { togetherSel, departInput, returnWrap, returnInput, joinModal, joinForm } = grabJoinEls();

    // æ—¥æœŸ/å›ç¨‹é å¡«
    currentDriverDate   = driverDate || "";
    currentDriverReturn = driverReturn || "";
    if (departInput && currentDriverDate) departInput.value = currentDriverDate;
    if (togetherSel) togetherSel.value = "";
    if (returnInput) { returnInput.value = ""; returnInput.readOnly = false; }
    if (returnWrap)  returnWrap.style.display = "none";
    syncReturnMin();

    // è¡¨å–® action + debug æ¨™è¨˜
    if (joinForm)  joinForm.action = `/find/driver/${driverId}/join/`;
    if (joinModal) joinModal.dataset.remaining = String(driverRemaining);

    // ä¾å‰©é¤˜åº§ä½é™åˆ¶ seats
    setupSeatsControl(driverRemaining);

    // é–‹çª—
    if (joinModal) joinModal.style.display = "block";

    // debug
    console.log('[openJoinModal] args', { driverId, driverDate, driverReturn, driverRemaining });
  };

  window.resetReturnDate = function () {
    const { returnInput } = grabJoinEls();
    if (returnInput) returnInput.value = "";
    syncReturnMin();
  };

  // === å–®ä¸€å…¨åŸŸ click handlerï¼šè¨ˆç®— remaining å¾Œå‘¼å« openJoinModal ===
  if (!window.__BIND_JOIN_CLICK__) {
    window.__BIND_JOIN_CLICK__ = true;

    document.addEventListener('click', function (e) {
      const btn = e.target.closest('[data-action="join"]');
      if (!btn) return;
      e.preventDefault();
      e.stopPropagation();
      e.stopImmediatePropagation();

      const id     = btn.dataset.id;
      const date   = btn.dataset.date   || '';
      const ret    = btn.dataset.return || '';
      const total  = parseInt(btn.dataset.total  || '0', 10) || 0;
      const filled = parseInt(btn.dataset.filled || '0', 10) || 0;
      const remaining = Math.max(0, total - filled);

      // å­˜ä¸€ä»½åˆ°å…¨åŸŸæ–¹ä¾¿é™¤éŒ¯
      window.__lastJoinBtn = btn;
      window.__lastRemaining = remaining;
      // å»ºç«‹ã€Œæ­¤æ¬¡é»æ“Šã€çš„åºè™Ÿä¸¦å­˜åˆ°å…¨åŸŸ
      const seq = Date.now() + Math.random();
      window.__joinOpenSeq = seq;

      // ä¹Ÿå¯«å› datasetï¼ˆä½ åœ¨ Console æœƒçœ‹å¾—åˆ° data-remainingï¼‰
      btn.dataset.remaining = String(remaining);

      console.log('[join-click]', { id, remaining, total: btn.dataset.total, filled: btn.dataset.filled });

      openJoinModal(id, date, ret, remaining,seq);
    });

    // åŒæ­¥å›ç¨‹æ¬„ä½çš„è¯å‹•
    document.addEventListener("change", function (e) {
      if (e.target && e.target.id === "join-together") handleTogetherChange();
      if (e.target && e.target.id === "join-date")     syncReturnMin();
    });
  }
})();
</script>

<script>

/* =========================================================================
 * 6) åƒåŠ è¡¨å–®ï¼šä¸Šè»Šåœ°é»ï¼ˆä¸‹æ‹‰ï¼‹è‡ªå¡«ï¼‰â†’ åŒæ­¥åˆ°éš±è—æ¬„ä½ name="departure"
 *    å…ƒç´ ï¼š
 *      #join-pickup-selectï¼ˆå«ã€Œå…¶ä»–ã€ï¼‰
 *      #join-pickup-customï¼ˆè¼¸å…¥æ¡†ï¼Œé¸ã€Œå…¶ä»–ã€æ‰é¡¯ç¤ºï¼‰
 *      #join-pickupï¼ˆhiddenï¼ŒçœŸæ­£é€å¾Œç«¯çš„ departureï¼‰
 *      #joinForm
 * ========================================================================= */
(function pickupFieldBinding(){
  if (window.__PICKUP_BIND__) return; // é˜²é‡è¤‡
  window.__PICKUP_BIND__ = true;

  const PICKUP_SELECT_ID = "join-pickup-select";
  const PICKUP_CUSTOM_ID = "join-pickup-custom";
  const PICKUP_HIDDEN_ID = "join-pickup";
  const JOIN_FORM_ID     = "joinForm";

  function getEls() {
    return {
      sel   : $id(PICKUP_SELECT_ID),
      custom: $id(PICKUP_CUSTOM_ID),
      hidden: $id(PICKUP_HIDDEN_ID),
      form  : $id(JOIN_FORM_ID),
    };
  }
  function applyPickupUI() {
    const { sel, custom } = getEls();
    if (!sel || !custom) return;
    if (sel.value === "å…¶ä»–") {
      custom.style.display = "block";
    } else {
      custom.style.display = "none";
      custom.value = "";
    }
  }
  function syncHidden() {
    const { sel, custom, hidden } = getEls();
    if (!sel || !custom || !hidden) return;
    hidden.value = (sel.value === "å…¶ä»–") ? (custom.value || "").trim() : (sel.value || "");
  }

  // äº‹ä»¶å§”æ´¾ä¸€æ¬¡æå®š
  document.addEventListener("change", (e) => {
    if (e.target && e.target.id === PICKUP_SELECT_ID) {
      applyPickupUI(); syncHidden();
    }
  });
  document.addEventListener("input", (e) => {
    if (e.target && e.target.id === PICKUP_CUSTOM_ID) syncHidden();
  });
  document.addEventListener("submit", (e) => {
    const { form } = getEls();
    if (form && e.target === form) syncHidden();
  });

  // å°å¤–é‡ç½®ï¼ˆæ‰“é–‹ Modal æ™‚å¯ç”¨ï¼‰
  window.resetPickupField = function(){
    const { sel, custom, hidden } = getEls();
    if (!sel || !custom || !hidden) return;
    sel.value = ""; custom.value = ""; custom.style.display = "none"; hidden.value = "";
  };

  // åˆå§‹å¥—ç”¨ä¸€æ¬¡
  setTimeout(() => { applyPickupUI(); syncHidden(); }, 0);
})();

/* =========================================================================
 * 7) ä¹˜å®¢ï¼šå¯†ç¢¼é©—è­‰ â†’ï¼ˆç·¨è¼¯ï½œåˆªé™¤ï¼‰/ ç·¨è¼¯å„²å­˜ / åˆªé™¤
 *    - äº‹ä»¶å§”æ´¾ï¼š [data-pax-edit], [data-pax-del]
 *    - å¯ç”¨ window.afterPaxChanged?.({action, id}) ä½œç‚ºæ›´æ–°é‰¤å­
 * ========================================================================= */
// Modal é–‹é—œ
function openPaxAuth (pid) {
  const idEl  = $id('paxAuthId');
  const pwdEl = $id('paxAuthPassword');
  const modal = $id('paxAuthModal');
  if (!idEl || !pwdEl || !modal) return;
  idEl.value = pid; pwdEl.value = '';
  modal.style.display = 'block';
  setTimeout(() => pwdEl.focus(), 0);
}
function closePaxAuth () { const m = $id('paxAuthModal'); if (m) m.style.display = 'none'; }
function openPaxEdit ()  { const m = $id('paxEditModal'); if (m) m.style.display  = 'block'; }
function closePaxEdit () { const m = $id('paxEditModal'); if (m) m.style.display  = 'none'; }

let __paxNextAction = null;

// å§”æ´¾ï¼šç·¨è¼¯ / åˆªé™¤ â†’ å…ˆé©—è­‰å¯†ç¢¼
document.addEventListener('click', (e) => {
  const editBtn = e.target.closest('[data-pax-edit]');
  if (editBtn){ e.preventDefault(); __paxNextAction = 'edit';   openPaxAuth(editBtn.dataset.id); return; }
  const delBtn  = e.target.closest('[data-pax-del]');
  if (delBtn){  e.preventDefault(); __paxNextAction = 'delete'; openPaxAuth(delBtn.dataset.id); return; }
});

async function driverManageAuth(driver_id, password) {
  const csrf_token = getCSRF(); // å‡è¨­å·²ç¶“æœ‰æ–¹æ³•å–å¾— CSRF token
  const res = await fetch(`/find/driver/${driver_id}/manage/auth/`, {
    method: "POST",
    headers: {
      "X-CSRFToken": csrf_token, // å¸¶ä¸Š CSRF token
      "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8",
    },
    body: new URLSearchParams({
      password: password
    }),
  });

  const data = await res.json();
  if (res.ok && data.ok) {
    // æˆåŠŸï¼Œè·³è½‰åˆ°ç®¡ç†é é¢
    window.location.href = data.url;
  } else {
    alert(data.error || "ç™»å…¥å¤±æ•—");
  }
}

async function submitPaxAuth () {
  const pid = $id('paxAuthId')?.value;
  const pwd = $id('paxAuthPassword')?.value;
  if (!pid || !pwd) { showToastSafe('è«‹è¼¸å…¥å¯†ç¢¼', 'error'); return; }

  try {
    const { res, data } = await jsonFetch(`/find/pax/${pid}/auth/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': getCSRF(),
        'X-Requested-With': 'XMLHttpRequest',
        'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8',
      },
      body: new URLSearchParams({ password: pwd })
    });
    if (!res.ok || !data.ok) { showToastSafe(data.error || 'é©—è­‰å¤±æ•—', 'error'); return; }
    closePaxAuth();
    if (__paxNextAction === 'delete') { await doPaxDelete(pid); return; }
    if (__paxNextAction === 'edit')   { await loadPaxAndOpenEdit(pid); return; }
  } catch (err) {
    console.error(err);
    showToastSafe('ä¼ºæœå™¨éŒ¯èª¤ï¼Œç¨å¾Œå†è©¦'+err, 'error');
  } finally {
    __paxNextAction = null;
  }
}
window.submitPaxAuth = submitPaxAuth;

async function loadPaxAndOpenEdit(pid) {
  const { res, data } = await jsonFetch(`/find/pax/${pid}/get/`, {
    headers: { 'X-Requested-With': 'XMLHttpRequest' }
  });
  if (!res.ok || !data.ok) {
    showToastSafe(data.error || 'è®€å–è³‡æ–™å¤±æ•—', 'error');
    return;
  }
  const p = data.p || {};

  (document.getElementById('paxEditId')      || {}).value = p.id ?? '';
  (document.getElementById('paxName')        || {}).value = p.passenger_name ?? '';
  (document.getElementById('paxGender')      || {}).value = p.gender ?? 'X';
  (document.getElementById('email')          || {}).value = p.email ?? '';           // â† æ”¹é€™è£¡
  (document.getElementById('paxContact')     || {}).value = p.contact ?? '';
  (document.getElementById('paxSeats')       || {}).value = p.seats_needed ?? 1;
  (document.getElementById('paxPay')         || {}).value = p.willing_to_pay ?? '';
  (document.getElementById('paxDeparture')   || {}).value = p.departure ?? '';
  (document.getElementById('paxDestination') || {}).value = p.destination ?? '';
  (document.getElementById('paxDate')        || {}).value = p.date ?? '';
  (document.getElementById('paxReturn')      || {}).value = p.return_date ?? '';
  (document.getElementById('paxTogether')    || {}).value =
    (p.together_return === true ? 'true' : p.together_return === false ? 'false' : '');
  (document.getElementById('paxNote')        || {}).value = p.note ?? '';

  // éš±ç§ checkbox
  const hideEl = document.getElementById('hide_contact');   // â† æ”¹é€™è£¡
  if (hideEl) {
    hideEl.checked  = !!(p.hide_contact && p.email);        // æœ‰å¡« email æ‰èƒ½ç‚º true
    hideEl.disabled = !p.email;                              // æ²’ email ä¸€å¾‹ç¦ç”¨
  }

  openPaxEdit();

  // è®“é–‹é—œè…³æœ¬å†è·‘ä¸€æ¬¡ï¼ˆè‹¥ä½ æœ‰é‚£æ®µ window.syncPrivacySwitchï¼‰
  window.syncPrivacySwitch && window.syncPrivacySwitch();
}
window.loadPaxAndOpenEdit = loadPaxAndOpenEdit;



function openPaxEdit () {
  const m = document.getElementById('paxEditModal');
  if (m) m.style.display = 'block';
}
window.openPaxEdit = openPaxEdit;

function closePaxEdit () {
  const m = document.getElementById('paxEditModal');
  if (m) m.style.display = 'none';
}
window.closePaxEdit = closePaxEdit;

async function doPaxDelete (pid) {
  if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™ä½ä¹˜å®¢å—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚')) return;
  try {
    const { res, data } = await jsonFetch(`/find/pax/${pid}/delete/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': getCSRF(),
        'X-Requested-With': 'XMLHttpRequest',
        'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8',
      },
      body: new URLSearchParams()
    });
    if (!res.ok || !data.ok) { showToastSafe(data.error || 'åˆªé™¤å¤±æ•—', 'error'); return; }
    showToastSafe('ğŸ—‘ï¸ å·²åˆªé™¤ä¹˜å®¢', 'success');
    window.afterPaxChanged && window.afterPaxChanged({ action: 'delete', id: Number(pid) });
  } catch (err) {
    console.error(err);
    showToastSafe('ä¼ºæœå™¨éŒ¯èª¤ï¼Œç¨å¾Œå†è©¦'+err, 'error');
  }
}

/* =========================================================================
 * 8) ä¹˜å®¢ç·¨è¼¯ Modalï¼štogether_return èˆ‡å›ç¨‹æ—¥æœŸè¯å‹•
 * ========================================================================= */
(function paxEditReturnLink(){
  const togetherSel = document.getElementById('paxTogether');
  const returnInput = document.getElementById('paxReturn');
  function syncReturnState () {
    if (!togetherSel || !returnInput) return;
    const v = togetherSel.value;
    if (v === 'true') {
      returnInput.value = '';
      returnInput.disabled = true;
      returnInput.placeholder = 'èˆ‡å¸æ©Ÿå›ç¨‹æ—¥æœŸç›¸åŒ';
      returnInput.classList.add('is-disabled');
    } else {
      returnInput.disabled = false;
      returnInput.placeholder = '';
      returnInput.classList.remove('is-disabled');
    }
  }
  if (togetherSel && returnInput) {
    togetherSel.addEventListener('change', syncReturnState);
  }
  window.syncPaxReturnOnce = syncReturnState; // å¯åœ¨æ‰“é–‹ç·¨è¼¯ Modal å¾Œå‘¼å«ä¸€æ¬¡
})();

/* =========================================================================
 * 9) é é¢ç´šäº‹ä»¶å§”æ´¾ï¼šç®¡ç† / åƒåŠ  / å±•é–‹ï¼ˆé¿å…å‹•æ…‹å…§å®¹å¤±æ•ˆï¼‰
 * ========================================================================= */
document.addEventListener('click', function (e) {
  const btn = e.target.closest('[data-action]');
  if (!btn) return;

  const action   = btn.dataset.action;
  const driverId = btn.dataset.id;
  if (!action || !driverId) return;

  if (action === 'manage') {
    e.preventDefault();
    openDriverModal(driverId);
    return;
  }
  if (action === 'join') {
    e.preventDefault();
    // è‹¥ _driver_list.html ä¸Šæœ‰ data-date / data-return å°±è®€å–ï¼Œå¦å‰‡ fallback
    openJoinModal(driverId, btn.dataset.date || "", btn.dataset.return || "");
    return;
  }
  if (action === 'toggle') {
    e.preventDefault();
    const details = $id('details-' + driverId);
    const arrow   = $id('arrow-' + driverId) || btn;
    if (!details) return;
    const isOpen = details.classList.toggle('open');
    arrow.classList.toggle('open', isOpen);
    arrow.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
    details.setAttribute('aria-hidden', isOpen ? 'false' : 'true');
    return;
  }
});

/* =========================================================================
 * 10) å…¶ä»–ï¼šå¾Œç«¯äº‹ä»¶ï¼ˆå¯é¸ï¼‰ã€‚ä¾‹ï¼šé€é WS ä¸»å‹•å‘ŠçŸ¥ã€Œç®¡ç†æŸå¸æ©Ÿã€
 * ========================================================================= */
// å³æ™‚æª¢æŸ¥ join äººæ•¸æ˜¯å¦è¶…éå‰©é¤˜åº§ä½
document.addEventListener('input', function(e){
  if (e.target && e.target.id === 'join-seats') {     // å¦‚æœä½ çš„ input id ä¸åŒï¼Œè«‹æ”¹é€™è£¡
    const wanted = parseInt((e.target.value || '1'), 10);
    const rm = parseInt(($id('joinModal')?.dataset.remaining || '0'), 10);

    if (Number.isFinite(rm) && rm > 0 && wanted > rm) {
      e.target.setCustomValidity(`äººæ•¸è¶…éå‰©é¤˜åº§ä½ï¼ˆå‰© ${rm} ä½ï¼‰`);
    } else {
      e.target.setCustomValidity('');
    }
  }
});

 window.manageDriver = function (driverId) {
  try { socket.send(JSON.stringify({ action: 'driver_manage', driver_id: driverId })); }
  catch (e) { console.warn('WS send å¤±æ•—', e); }
};


// ç¶å®šä¸€çµ„å‡ºç™¼/å›ç¨‹æ¬„ä½çš„é˜²å‘†
// params: { depart: '#å‡ºç™¼input', ret: '#å›ç¨‹input', form: '#è¡¨å–®', msg?: 'è‡ªè¨‚éŒ¯èª¤è¨Šæ¯' }
function bindDateGuard({ depart, ret, form, msg }){
  const dep = document.querySelector(depart);
  const rtn = document.querySelector(ret);
  const frm = form ? document.querySelector(form) : null;
  if(!dep || !rtn) return;

  // å³æ™‚ï¼šå›ç¨‹æœ€å°æ—¥ â‰§ å‡ºç™¼
  function syncMin(){
    rtn.min = dep.value || '';
    if(rtn.value && dep.value && rtn.value < dep.value){
      rtn.value = ''; // è‡ªå‹•æ¸…ç©ºç„¡æ•ˆå€¼
    }
  }
  dep.addEventListener('change', syncMin);
  // åˆå§‹è·‘ä¸€æ¬¡
  syncMin();

  // é€å‡ºæ™‚ï¼šç¡¬æ€§æª¢æŸ¥ï¼Œä¸ç¬¦å°±æ“‹ä¸‹
  function checkOnSubmit(e){
    if(dep.value && rtn.value && rtn.value < dep.value){
      e && e.preventDefault();
      alert(msg || 'å›ç¨‹æ—¥æœŸä¸å¯æ—©æ–¼å‡ºç™¼æ—¥æœŸ');
      rtn.focus();
      return false;
    }
    return true;
  }

  if(frm){
    frm.addEventListener('submit', checkOnSubmit);
  }
  // è‹¥è¦åœ¨ JS æ‰‹å‹•æª¢æŸ¥ä¹Ÿèƒ½å‘¼å«ï¼š
  return { check: checkOnSubmit, syncMin };

  document.addEventListener('DOMContentLoaded', () => {
  bindDateGuard({
    depart: '#paxDate',
    ret: '#paxReturn',
    form: '#paxEditForm'
  });
});
}

</script>
<script>
(function(){
  const KEY = 'filterPanelOpen';
  const DURATION_MS = 1500; // æƒ³èª¿æ•´å‹•ç•«é€Ÿåº¦å°±æ”¹é€™è£¡ï¼ˆåŒæ™‚ä¹Ÿæ”¹ä½ çš„ CSS è®Šæ•¸æ›´ä¸€è‡´ï¼‰

  // 1) çµ±ä¸€ç”¨äº‹ä»¶å§”æ´¾ï¼Œé¿å…æŠ“ä¸åˆ°ç¯€é»
  document.addEventListener('click', function(e){
    const toggleBtn = e.target.closest('.panel-toggle');
    const headBar   = e.target.closest('#panelHead');
    if (!toggleBtn && !headBar) return;

    const panel = document.getElementById('filterPanel');
    if (!panel) { console.warn('[panel] not found'); return; }

    // é¿å…é»åˆ°è¡¨å–®æ§ä»¶æ™‚èª¤è§¸æ”¶åˆ
    if (headBar) {
      const tag = (e.target.tagName || '').toLowerCase();
      if (['select','input','button','textarea','label'].includes(tag)) return;
    }
    e.stopPropagation();
    e.preventDefault();

    __toggleFilterPanel(true); // å¸¶ true ä»£è¡¨ä¾†æºæ–¼é»æ“Š
  });

  // 2) åˆå§‹åŒ–ï¼ˆç­‰ DOM readyï¼‰
  document.addEventListener('DOMContentLoaded', function(){
    const panel = document.getElementById('filterPanel');
    if (!panel) { console.warn('[panel] not found on DOMContentLoaded'); return; }

    const body = panel.querySelector('.panel-bd');
    if (!body) { console.warn('[panel-bd] not found'); return; }

    // â›ï¸ æ¸…é™¤ä»»ä½•æœƒç ´å£å‹•ç•«çš„ inline/computed display
    body.style.removeProperty('display');

    // è‹¥æœ‰å¤–éƒ¨ CSS è¨­äº† display:noneï¼Œé€™è£¡å¼·åˆ¶è¦†è“‹
    const cs = getComputedStyle(body);
    if (cs.display === 'none') {
      body.style.display = 'block';
    }

    // è®€å– localStorage ç‹€æ…‹ï¼›æ²’æœ‰å°±æ²¿ç”¨ HTML çš„ aria-expanded
    try{
      const saved = localStorage.getItem(KEY);
      if (saved === '1' || saved === '0') {
        panel.setAttribute('aria-expanded', saved === '1' ? 'true' : 'false');
      }
    }catch{}

    const open = panel.getAttribute('aria-expanded') === 'true';
    if (open) {
      body.style.maxHeight = 'none';
      body.style.opacity = '1';
    } else {
      body.style.maxHeight = '0px';
      body.style.opacity = '0';
    }

    console.log('[filterPanel] init',
      { open, aria: panel.getAttribute('aria-expanded'), display: getComputedStyle(body).display });
  });

  // 3) çœŸæ­£çš„åˆ‡æ›å‡½å¼ï¼ˆä¹Ÿä¸Ÿåˆ°å…¨åŸŸæ–¹ä¾¿ debugï¼‰
  function __toggleFilterPanel(fromClick){
    const panel = document.getElementById('filterPanel');
    if (!panel) return;
    const body = panel.querySelector('.panel-bd');
    if (!body) return;

    // å†æ¬¡ä¿éšªï¼šç§»é™¤æœƒå¹²æ“¾å‹•ç•«çš„ display è¨­å®š
    body.style.removeProperty('display');
    if (getComputedStyle(body).display === 'none') {
      body.style.display = 'block';
    }

    const willOpen = panel.getAttribute('aria-expanded') !== 'true';
    panel.setAttribute('aria-expanded', willOpen ? 'true' : 'false');

    // å‹•ç•«ï¼šç”¨ max-height å¾ 0 â†’ scrollHeightï¼Œæˆ–åå‘
    body.style.transition = 'none';
    if (willOpen) {
      body.style.maxHeight = '0px';
      body.style.opacity = '0';
      requestAnimationFrame(()=>{
        const h = body.scrollHeight;
        body.style.transition = `max-height ${DURATION_MS}ms ease, opacity ${DURATION_MS}ms ease`;
        body.style.maxHeight = h + 'px';
        body.style.opacity = '1';
      });
    } else {
      const h = body.scrollHeight;
      body.style.maxHeight = h + 'px';
      body.style.opacity = '1';
      requestAnimationFrame(()=>{
        body.style.transition = `max-height ${DURATION_MS}ms ease, opacity ${DURATION_MS}ms ease`;
        body.style.maxHeight = '0px';
        body.style.opacity = '0';
      });
    }

    try{ localStorage.setItem(KEY, willOpen ? '1' : '0'); }catch{}

    console.log('[filterPanel] toggle',
      { fromClick: !!fromClick, willOpen,
        aria: panel.getAttribute('aria-expanded'),
        display: getComputedStyle(body).display });
  }
  window.__toggleFilterPanel = __toggleFilterPanel;

  // 4) å‹•ç•«çµæŸå¾Œå¦‚æœæ˜¯å±•é–‹å°±æ¸… max-heightï¼Œä¿æŒè‡ªé©æ‡‰é«˜åº¦
  document.addEventListener('transitionend', function(e){
    const el = e.target;
    if (!el.classList || !el.classList.contains('panel-bd')) return;
    if (e.propertyName !== 'max-height') return;

    const panel = document.getElementById('filterPanel');
    if (!panel) return;
    const open = panel.getAttribute('aria-expanded') === 'true';
    if (open) {
      el.style.transition = 'none';
      el.style.maxHeight = 'none';
      requestAnimationFrame(()=>{ el.style.transition = ''; });
    }
  });
})();


async function submitPaxEdit() {
  try {
    const form = document.getElementById('paxEditForm');
    const fd   = new FormData(form);

    // å¾Œç«¯æœƒç”¨ on/true/1/yes åˆ¤æ–·ï¼Œcheckbox æœªå‹¾ä¸æœƒå‡ºç¾åœ¨ FormData â†’ ä¸ç”¨ç‰¹åˆ¥è™•ç†
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || "";

    const url = form.dataset.postUrl || form.getAttribute('action') || `/find/pax/${document.getElementById('paxEditId').value}/update/`;

    const res = await fetch(url, {
      method: "POST",
      headers: {
        "X-Requested-With": "XMLHttpRequest",
        "X-CSRFToken": csrftoken
      },
      body: fd
    });

    const raw = await res.text();
    let data; try { data = JSON.parse(raw); } catch { data = null; }
    console.log("[pax-update] status:", res.status, "body:", raw);

    if (!res.ok || !data || data.ok !== true) {
      alert(`æ›´æ–°å¤±æ•—${!res.ok ? `ï¼ˆHTTP ${res.status}ï¼‰` : ''}`);
      return;
    }

    // æˆåŠŸï¼šé—œæ‰ modalï¼Œç­‰ WebSocket å»£æ’­æŠŠåˆ—è¡¨èˆ‡ç®¡ç†é å…©å´åˆ·æ–°
    closePaxEdit();
  } catch (e) {
    console.error(e);
    alert("æ›´æ–°å¤±æ•—ï¼ˆå‰ç«¯ä¾‹å¤–ï¼‰");
  }
}


function initPaxPrivacyBinding () {
  const email = document.getElementById('paxEmail');
  const hide  = document.getElementById('paxHideContact');
  const hint  = document.getElementById('paxPrivacyHint');

  function sync() {
    const hasEmail = !!(email && email.value && email.value.includes('@'));
    if (hide) {
      hide.disabled = !hasEmail;
      if (!hasEmail) hide.checked = false;
    }
    if (hint) {
      if (hasEmail) {
        hint.classList.remove('hint-error');
        hint.textContent = 'â€» éœ€å¡«å¯« Email æ‰èƒ½éš±ç§ï¼›Email åƒ…ä¾›ç³»çµ±é€šçŸ¥ï¼Œä¸æœƒå…¬é–‹ã€‚';
      } else {
        hint.classList.add('hint-error');
        hint.textContent = 'â€» å°šæœªå¡«å¯« Emailï¼Œç„¡æ³•éš±è—è¯çµ¡æ–¹å¼ã€‚';
      }
    }
  }

  // è§£é™¤èˆŠçš„ç›£è½ï¼Œé¿å…é‡è¤‡ç¶å®š
  if (email && email._syncPrivacy) email.removeEventListener('input', email._syncPrivacy);
  if (email) {
    email._syncPrivacy = sync;
    email.addEventListener('input', sync);
  }
  sync();
}
window.initPaxPrivacyBinding = initPaxPrivacyBinding;

// --- Email èˆ‡éš±è—é–‹é—œçš„å¯ç”¨æ€§é€£å‹• (å¸æ©Ÿ) ---
(function bindDriverPrivacy(){
  const mail = document.getElementById('driverEmail');
  const sw   = document.getElementById('driverHide');
  if (!mail || !sw) return;

  const sync = ()=> {
    const hasEmail = !!(mail.value && mail.value.includes('@'));
    sw.disabled = !hasEmail;
    if (!hasEmail) sw.checked = false;
  };
  mail.addEventListener('input', sync);
  sync();

  // å¯é¸ï¼šç«‹å³é€å‡ºåˆ°å¾Œç«¯ï¼ˆè‹¥ä½ æ˜¯åˆ†é–‹çš„å„²å­˜éˆ•ï¼Œå°±ç•¥éé€™æ®µï¼‰
  sw.addEventListener('change', async ()=>{
    const driverId = document.getElementById('driverIdHidden')?.value || '{{ d.id }}';
    const {res, data} = await jsonFetch(`/find/driver/${driverId}/privacy/`, {
      method: 'POST',
      headers: {'X-CSRFToken': getCSRF(), 'X-Requested-With':'XMLHttpRequest','Content-Type':'application/x-www-form-urlencoded;charset=UTF-8'},
      body: new URLSearchParams({ hide: sw.checked ? 'true' : 'false' })
    });
    if (res.ok && data?.ok) showToastSafe(sw.checked?'ğŸ”’ å·²éš±è—è¯çµ¡æ–¹å¼':'ğŸ‘ï¸ å·²é¡¯ç¤ºè¯çµ¡æ–¹å¼','success');
    else { showToastSafe(data?.error||'åˆ‡æ›å¤±æ•—','error'); sw.checked = !sw.checked; }
  });
})();

// --- ä¹˜å®¢ï¼ˆç·¨è¼¯ Modalï¼‰ ---
(function bindPaxPrivacy(){
  const mail = document.getElementById('paxEmail');
  const sw   = document.getElementById('paxHide');
  if (!mail || !sw) return;

  const sync = ()=> {
    const hasEmail = !!(mail.value && mail.value.includes('@'));
    sw.disabled = !hasEmail;
    if (!hasEmail) sw.checked = false;
  };
  mail.addEventListener('input', sync);
  sync();

  // é€å‡º
  sw.addEventListener('change', async ()=>{
    const paxId = document.getElementById('paxEditId')?.value;
    if (!paxId){ sw.checked = !sw.checked; return; }
    const {res, data} = await jsonFetch(`/find/pax/${paxId}/privacy/`, {
      method: 'POST',
      headers: {'X-CSRFToken': getCSRF(), 'X-Requested-With':'XMLHttpRequest','Content-Type':'application/x-www-form-urlencoded;charset=UTF-8'},
      body: new URLSearchParams({ hide: sw.checked ? 'true' : 'false' })
    });
    if (res.ok && data?.ok) showToastSafe(sw.checked?'ğŸ”’ å·²éš±è—è¯çµ¡æ–¹å¼':'ğŸ‘ï¸ å·²é¡¯ç¤ºè¯çµ¡æ–¹å¼','success');
    else { showToastSafe(data?.error||'åˆ‡æ›å¤±æ•—','error'); sw.checked = !sw.checked; }
  });
})();


</script>




</body>
</html>
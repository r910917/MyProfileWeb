<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>ğŸŒ èŠ±è“®å…‰å¾©æ•‘ç½äº¤é€šåª’åˆ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<style>
/* ==========================================================================
   å…¨ç«™åŸºç¤ï¼šå­—é«”ã€èƒŒæ™¯ã€ä¸»æ¨™é¡Œ/å°æ¨™é¡Œ
   ========================================================================== */
body{
  font-family:"Microsoft JhengHei",sans-serif;
  margin:0; padding:0;
  background:linear-gradient(to right,#eaf8ff,#f7fff7);
  color:#222;
}
h1{ text-align:center; padding:20px; color:#005c4b; }
h2{ color:#00695c; margin:20px; font-size:20px; }

/* ==========================================================================
   é¦–é å…©é¡†ä¸»åŠŸèƒ½æŒ‰éˆ•
   ========================================================================== */
.buttons{ text-align:center; margin:20px 0; }
.btn-main{
  display:inline-flex; align-items:center; gap:6px;
  padding:12px 24px; font-size:16px; border-radius:8px;
  border:none; cursor:pointer; margin:0 6px; color:#fff; font-weight:bold;
  transition:transform .2s, background .3s;
}
.btn-driver{ background:#007bff; }
.btn-driver:hover{ background:#0056b3; transform:scale(1.05); }
.btn-passenger{ background:#dc3545; }
.btn-passenger:hover{ background:#a71d2a; transform:scale(1.05); }

/* ==========================================================================
   å¡ç‰‡ï¼ˆDriver/Passenger åˆ—è¡¨ï¼‰ï¼‹ å·¦å´è‰²æ¢
   ========================================================================== */
/* æ›´è²¼å·¦ã€è¼ƒè–„çš„å¡ç‰‡ */
.card{
  display:flex;
  align-items:left;
  justify-content:space-between;
  background:#fff;
  margin:3px;                 /* å–æ¶ˆå¥‡æ€ªçš„è² é‚Šè·ï¼Œå·¦å³ä¸ç¸®é€² */
  padding:8px 12px 8px 24px;    /* ä¸Šä¸‹è®Šè–„ã€å·¦é‚Šå¤šä¸€é»ç©ºé–“çµ¦è‰²æ¢ */
  border-radius:8px;            /* æ¯” 1px å¥½çœ‹è¨±å¤š */
  box-shadow:0 2px 6px rgba(0,0,0,.08);
  position:relative;
  flex-wrap:wrap;
  animation:fadeInUp .3s ease-out;
}

/* è®“è‰²æ¢å¾®å¾®çªå‡ºåˆ°å¡ç‰‡å¤–ï¼Œè¦–è¦ºä¸Šæ›´é å·¦ï¼Œä½†ä¸éœ€è¦è² é‚Šè· */
.card::before{
  content:"";
  position:absolute;
  top:0;
  bottom:0;       /* ç­‰åŒæ–¼ height:100% + æ›´ç©©å®š */
  left:10px;      /* å‘å·¦çªå‡º 8pxï¼Œé”åˆ°ã€Œè²¼å·¦ã€æ•ˆæœ */
  width:6px;
  border-radius:6px 0 0 6px;
}

.driver-card::before{ background:#2196f3; }
.passenger-card::before{ background:#f44336; }

/* 1) å–æ¶ˆ UL é è¨­ç¸®æ’ï¼šå¡ç‰‡ä¸è¦è¢«æ¨åˆ°å³å´ */
#driver-list,
#passenger-list {
  list-style: none;
  margin: 0;
  padding: 0;        /* â† é€™è¡Œæ˜¯é‡é» */
}

/* å¦‚æœæœ‰å…¶å®ƒå®¹å™¨å° ul/li åšäº† padding-leftï¼Œä¹Ÿä¸€ä½µæ­¸é›¶ */
#driver-list > li,
#passenger-list > li {
  margin-left: 0;
}

/* ==========================================================================
   å¸æ©Ÿå¡ç‰‡ä¸‰æ¬„æ’ç‰ˆï¼ˆå·¦ï¼šæš±ç¨±åº§ä½ / ä¸­ï¼šä¸‰è¡Œ / å³ï¼šæ“ä½œèˆ‡ç®­é ­ï¼‰
   ========================================================================== */
.driver-grid{
  display:grid; grid-template-columns:minmax(140px,200px) 1fr auto;
  column-gap:10px; align-items:center; width:100%;
}
/* å·¦æ¬„ï¼šæš±ç¨± - åº§ä½ */
.col-left{ display:flex; align-items:center; justify-content:flex-start; height:100%; font-size:15px; }
.name-seat{ font-size:15px; color:#222; margin:0; }
/* ä¸­æ¬„ï¼šä¸‰è¡Œè³‡è¨Š */
.col-middle .line{ display:block; margin:2px 0; }
.col-middle .line1{ font-size:16px; color:#222; }
.col-middle .line2, .col-middle .line3{ font-size:14px; color:#444; }
/* å³æ¬„ï¼šæ“ä½œæŒ‰éˆ•ï¼‹ç®­é ­ */
.col-actions{ display:flex; align-items:center; justify-content:flex-end; gap:6px; }

/* å±•é–‹å€å¡Šé‹ªæ»¿æ•´åˆ— */
.details{ grid-column:1 / -1; }

/* ==========================================================================
   å±•é–‹/æ”¶åˆï¼šç®­é ­æ—‹è½‰ã€çµ²æ»‘é–‹åˆï¼›ç®¡ç†/åƒåŠ æŒ‰éˆ•è‰²ç³»
   ========================================================================== */
.driver-card .arrow{
  cursor:pointer; margin-left:6px; min-width:36px; min-height:36px;
  font-size:16px; color:#333; background:transparent; border:0;
  transition:transform .25s ease;
}
.driver-card .arrow.open{ transform:rotate(90deg); }

.driver-card .details{
  margin-top:0px; max-height:0; overflow:hidden; padding:0px 0px;
  background: transparent; border:0 #e6e6e6;
  transition:max-height 1.2s ease, padding 1s ease;
}
/* å±•é–‹æ™‚å†åŠ å›å¤–è§€ */
.driver-card .details.open {
  margin-top: 8px;
  max-height: 650px;
  padding: 10px;
  background: #f9f9f9;
  border-top: 1px solid #e6e6e6;
  border-radius: 6px;
}

.driver-card .btn-manage{ background:#007bff; color:#fff; border:0; border-radius:6px; padding:6px 10px; }
.driver-card .btn-manage:hover{ background:#0056b3; }
.driver-card .btn-join{ background:#28a745; color:#fff; border:0; border-radius:6px; padding:6px 10px; }
.driver-card .btn-join:hover{ background:#1e7e34; }

/* =============================================================================
   A. ä¹˜å®¢æ¸…å–®ï¼ˆå¾…ç¢ºèª / å·²æ¥å—ï¼‰å¡ç‰‡æ¨£å¼
   ========================================================================== */

/* æ¸…å–®å®¹å™¨ï¼ˆèˆŠ two-col ä¿ç•™ï¼ŒæŸäº›é é¢å¯èƒ½ä»åœ¨ç”¨ï¼‰ */
.pax-section{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:16px;
  align-items:start;
}
@media (max-width: 860px){
  .pax-section{ grid-template-columns: 1fr; }
}

.pax-list{ list-style:none; padding:0; margin:8px 0 0; }
.pax-item{
  box-sizing:border-box;
  background:#fff;
  border:1px solid #e5e7eb;
  border-radius:10px;
  padding:12px 14px;
  margin:8px 0;
}

/* æ¯ç­†ï¼šå·¦æ–‡å­—ï¼ˆå…©è¡Œï¼‰ + å³æŒ‰éˆ• */
.pax-2col{
  display:grid;
  grid-template-columns: 1fr auto;
  column-gap: 12px;
  align-items:center;
}
.pax-left{ min-width:0; }
.pax-title{
  font-weight:700;
  font-size:15px;
  color:#111827;
  line-height:1.25;
}
.pax-sub{
  margin-top:2px;
  font-size:13px;
  color:#4b5563;
  line-height:1.3;
}
.pax-actions{ display:inline-flex; gap:8px; white-space:nowrap; }

.btn-mini{
  border:0; border-radius:8px; padding:6px 10px; background:#e5e7eb; cursor:pointer;
}
.btn-mini:hover{ background:#d1d5db; }
.btn-mini.danger{ background:#fecaca; color:#7f1d1d; }
.btn-mini.danger:hover{ background:#fca5a5; }

/* å·²æ¥å—ï¼šç¶ è‰²åº•æç¤º */
.pax-item.pax-accepted{ background:#f0fdf4; border:1px solid #bbf7d0; }
.pax-item.pax-accepted .pax-title .check{
  display:inline-block; margin-right:6px; color:#16a34a; font-weight:800;
}
.pax-item.pax-accepted .btn-mini{ background:#e7f5ec; }
.pax-item.pax-accepted .btn-mini:hover{ background:#d9f0e4; }

/* æ‰‹æ©ŸæŒ‰éˆ•è½åˆ°ä¸‹æ–¹ */
@media (max-width: 640px){
  .pax-2col{ grid-template-columns:1fr; row-gap:8px; align-items:start; }
  .pax-actions{ justify-content:flex-start; }
}

/* è‡ªè¨‚å·è»¸ï¼ˆæ·¡æ·¡çš„ï¼‰ */
.pax-scroll::-webkit-scrollbar,
.pending-scroll::-webkit-scrollbar{ width:8px; }
.pax-scroll::-webkit-scrollbar-thumb,
.pending-scroll::-webkit-scrollbar-thumb{ background:#d5d9e0; border-radius:6px; }
.pax-scroll::-webkit-scrollbar-track,
.pending-scroll::-webkit-scrollbar-track{ background:transparent; }


/* =============================================================================
   B. è©³ç´°å€å¡Šï¼šä¸‰æ¬„ï¼ˆæ¡Œæ©Ÿï¼‰= å·¦ï¼šå¸æ©Ÿè³‡è¨Š / ä¸­ï¼šå¾…ç¢ºèª / å³ï¼šå·²æ¥å—
   ========================================================================== */

/* ä½ çš„ details é–‹é—”å‹•ç•«ï¼ˆä¿ç•™ï¼‰ */
.details{
  margin-top:8px; max-height:0; overflow:hidden; padding:8px 10px;
  background:#f9f9f9; border-top:1px solid #e6e6e6; border-radius:6px;
  transition:max-height .35s ease, padding .25s ease;
}
.details.open{ max-height:1200px; padding:10px; }

/* ä¸‰æ¬„å®¹å™¨ï¼ˆæ¡Œæ©Ÿï¼‰ */
.details-grid3{
  /* å¯èª¿é«˜åº¦ï¼šä¸‰æ¬„åŒé«˜ï¼Œå…§å®¹è¶…å‡ºå‰‡å„è‡ªå‡ºç¾å·è»¸ */
  --panel-h: 340px;

  display:grid;
  grid-template-columns: minmax(420px, 2fr) minmax(320px, 1fr) minmax(320px, 1fr);
  gap:16px;
  align-items:stretch;  /* ä¸‰æ¬„æ‹‰é½Š */
}

/* æ¬„ä½å…§ç›’ï¼šçµ¦ä¸‰æ¬„çµ±ä¸€é«˜åº¦èˆ‡å·è»¸ç”¨ */
.details-col{
  height: var(--panel-h);
  min-height: 0;          /* é‡è¦ï¼šè®“ grid å…§å…ƒç´ å¯ä»¥æ­£ç¢º overflow */
  background:#fff;
  border:1px solid #e5e7eb;
  border-radius:10px;
  overflow:auto;
  padding:14px 16px;
  box-shadow: 0 1px 2px rgba(0,0,0,.03);
}

/* ä¸­ã€å³æ¬„æ¨™é¡Œ */
.pax-panel-title{
  margin:0 0 10px;
  font-weight:800;
  font-size:15px;
  color:#0f172a;
  display:flex; align-items:center; gap:6px;
}

/* ä¸­ã€å³æ¬„åˆ—è¡¨å®¹å™¨ï¼ˆç­‰é«˜å·è»¸ï¼‰ */
.pax-scroll{
  height: calc(var(--panel-h) - 38px); /* æ‰£æ‰æ¨™é¡Œå€é«˜åº¦(ç´„) */
  overflow:auto;
  padding-right:6px;
}

/* RWDï¼šâ‰¤980px å›å–®æ¬„ï¼Œä¸è¦å›ºå®šé«˜åº¦èˆ‡å·è»¸ */
@media (max-width: 980px){
  .details-grid3{ grid-template-columns:1fr; }
  .details-col{ height:auto; overflow:visible; }
  .pax-scroll{ height:auto; overflow:visible; padding-right:0; }
}


/* =============================================================================
   C. å¸æ©Ÿè³‡è¨Šï¼ˆå·¦æ¬„ï¼‰æ’ç‰ˆå„ªåŒ–
   ========================================================================== */

/* å·¦æ¬„å…§çš„è¦–è¦ºï¼šæ¨™é¡Œåˆ— */
.driver-info__title{
  display:flex; align-items:center; gap:8px;
  font-weight:800; color:#0f172a;
  margin:2px 0 12px;
}
.driver-info__title .emoji{ font-size:18px; }

/* key-value ç‰ˆé¢ï¼šæ•´é½Šå°é½Šæˆå…©æ¬„ï¼ˆæ¨™ç±¤ / å…§å®¹ï¼‰ */
.driver-kv{
  display:grid;
  grid-template-columns: 92px 1fr;
  row-gap:8px;
  column-gap:10px;
}
.driver-kv .k{
  color:#475569;
  font-weight:600;
  text-align:right;
}
.driver-kv .v{
  color:#111827;
  word-break:break-word;
}

/* å°åˆ†éš”ç·šç¾¤çµ„ï¼šè®“è³‡è¨Šå€å¡Šæ›´ä¹¾æ·¨ */
.driver-info__group{
  display:grid; gap:8px;
  padding-bottom:8px;
  border-bottom:1px dashed #e5e7eb;
  margin-bottom:10px;
}
.driver-info__group:last-child{ border-bottom:0; padding-bottom:0; margin-bottom:0; }

/* æ¬¡è¦æ–‡å­—ï¼ˆä¾‹å¦‚ã€Œæœªæä¾›ã€ã€ã€Œæœªå®šã€ï¼‰ */
.text-muted{ color:#6b7280; }

/* RWDï¼šæ‰‹æ©Ÿæ™‚æ”¹æˆå–®æ¬„ */
@media (max-width: 640px){
  .driver-kv{ grid-template-columns: 86px 1fr; }
}


/* =============================================================================
   D. ä½ ç¾æœ‰çš„ç®­é ­/å¡ç‰‡/æŒ‰éˆ•ï¼ˆå¦‚éœ€ï¼Œä¿ç•™ï¼‰
   ========================================================================== */

.arrow{ cursor:pointer; margin-left:6px; min-width:36px; min-height:36px;
  font-size:16px; color:#333; background:transparent; border:0;
  transition: transform .25s ease;
}
.arrow.open{ transform: rotate(90deg); }

.btn-manage{ background:#007bff; color:#fff; border:0; border-radius:6px; padding:6px 10px; }
.btn-manage:hover{ background:#0056b3; }
.btn-join{ background:#28a745; color:#fff; border:0; border-radius:6px; padding:6px 10px; }
.btn-join:hover{ background:#1e7e34; }

/* ==========================================================================
   Modalï¼šé€šç”¨ï¼ˆé®ç½©/å®¹å™¨/é—œé–‰éˆ•/å€å¡Šï¼‰
   ========================================================================== */
.modal{
  position:fixed; inset:0; z-index:1000;left: 0; top: 0; background:rgba(0,0,0,.55);
  display:none;justify-content: center; align-items: center;
}
.modal-content {
  background: #fff;
  border-radius: 12px;
  padding: 28px 30px;
  width: 90%;
  max-width: 420px;
  text-align: center;   /* ğŸ¯ ç½®ä¸­æ‰€æœ‰æ–‡å­— */
  box-shadow: 0 6px 18px rgba(0,0,0,0.25);
  position: relative;
  animation: fadeIn 0.3s ease-out;
}
.modal .modal-content{
  display:flex; flex-direction:column;
  width:min(520px,94vw); max-height:min(92svh,640px);
  margin:6svh auto; background:#fff; border-radius:12px;
  box-shadow:0 10px 30px rgba(0,0,0,.25);
}
.modal-header, .modal-footer{
  flex:0 0 auto; padding:14px 16px; border-bottom:1px solid #eee;
}
.modal-footer{ border-top:1px solid #eee; border-bottom:0; display:flex; justify-content:flex-end; gap:8px; }
.modal-body{ flex:1 1 auto; overflow-y:auto; padding:14px 16px; }
.close{ background:transparent; border:0; font-size:20px; cursor:pointer; }
/* èƒŒæ™¯é åœ¨ modal é–‹å•Ÿæ™‚ä¸è¦æ²å‹•ï¼ˆå¯é¸ï¼‰ */
.body-modal-open{ overflow:hidden; }
/* æ¨™é¡Œèˆ‡æè¿° */
.modal-title {
  margin: 0;
  font-size: 20px;
  font-weight: bold;
  color: #333;
}
.modal-desc {
  font-size: 14px;
  color: #666;
  margin: 8px 0 20px;
}

/* é—œé–‰æŒ‰éˆ• */
.close {
  position: absolute;
  top: 12px; right: 16px;
  font-size: 22px;
  font-weight: bold;
  color: #888;
  cursor: pointer;
}
.close:hover { color: #000; }

/* è¡¨å–®æ¬„ä½ */
.form-group {
  margin-bottom: 20px;
  text-align: center;  /* label å–®ç¨é å·¦ï¼Œè¼¸å…¥æ¡†ä¿æŒç½®ä¸­ */
}
.form-group label {
  display: block;
  margin-bottom: 8px;
  font-size: 14px;
  font-weight: 600;
  color: #333;
  text-align: center;    /* ğŸ¯ æ¨™ç±¤é å·¦ */
}
.form-group input {
  width: 50%;
  padding: 12px;
  border-radius: 8px;
  border: 1px solid #ccc;
  font-size: 15px;
  transition: border-color 0.2s;
  text-align: center;   /* ğŸ¯ è¼¸å…¥æ¡†æ–‡å­—ç½®ä¸­ */
}
.form-group input:focus {
  border-color: #007bff;
  outline: none;
}

/* æŒ‰éˆ•å€å¡Š */
.modal-actions {
  display: flex;
  justify-content: center;  /* ğŸ¯ æŒ‰éˆ•ç½®ä¸­ */
  gap: 12px;
}
.btn-primary {
  background: #007bff;
  color: #fff;
  border: none;
  padding: 10px 20px;
  border-radius: 6px;
  font-size: 15px;
  cursor: pointer;
  transition: background 0.2s;
}
.btn-primary:hover { background: #0056b3; }

.btn-secondary {
  background: #f1f1f1;
  color: #333;
  border: none;
  padding: 10px 20px;
  border-radius: 6px;
  font-size: 15px;
  cursor: pointer;
  transition: background 0.2s;
}
.btn-secondary:hover { background: #ddd; }

/* å‹•ç•« */
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(-10px); }
  to { opacity: 1; transform: translateY(0); }
}

/* ğŸ¯ æ‰‹æ©Ÿç‰ˆ RWD */
@media (max-width: 480px) {
  #driverAuthModal .modal-content {
    width: 70%;
    margin-top: 60%;
  }
  #driverAuthModal.btn-primary, .btn-secondary {
    flex: 1;              /* æŒ‰éˆ•è®Šæˆç­‰å¯¬ */
    padding: 12px;
  }
  .modal-actions {
    flex-direction: column; /* ğŸ¯ æ‰‹æ©Ÿç‰ˆæŒ‰éˆ•ä¸Šä¸‹æ’åˆ— */
  }
}
/* ==========================================================================
   Join Modalï¼šå¤–è§€å¾®èª¿ï¼ˆé«˜åº¦è¼ƒçŸ®ã€Header/Body/Footer é»è²¼ï¼‰
   ========================================================================== */
/* Join Modal å¤–è§€ */
#joinModal .modal-content {
  width: min(520px, 94vw);
  max-height: min(88svh, 620px);
  margin: 4svh auto;
  border-radius: 14px;
  overflow: hidden;
  box-shadow: 0 14px 34px rgba(0,0,0,.25);
  background: #fff;
  display: flex;
  flex-direction: column;
}

/* Header */
#joinModal .modal-header {
  position: sticky; top: 0; z-index: 2;
  display: flex; align-items: center; justify-content: center;
  min-height: 44px; padding: 8px 16px;
  background: #fff; border-bottom: 1px solid #eee;
}
#joinModal .modal-header .title {
  font-size: 16px; font-weight: 700; color: #111827;
  display: inline-flex; align-items: center; gap: 8px;
}
#joinModal .modal-header .title .emoji { font-size: 18px; }
#joinModal .modal-header .close {
  position: absolute; right: 10px; top: 8px;
  width: 28px; height: 28px;
  display: inline-grid; place-items: center;
  font-size: 18px; color: #6b7280; background: transparent; border: none;
  cursor: pointer; border-radius: 6px;
}
#joinModal .modal-header .close:hover { background: #f3f4f6; color: #111827; }

/* Body */
#joinModal .modal-body {
  flex: 1 1 auto;
  overflow-y: auto;
  padding: 12px 16px;
}

/* Footer */
#joinModal .modal-footer {
  position: sticky; bottom: 0; z-index: 2;
  display: flex; justify-content: flex-end; gap: 8px;
  padding: 10px 16px; background: #fff;
  border-top: 1px solid #eee;
}
#joinModal .btn-cancel, #joinModal .btn-submit {
  border-radius: 10px; padding: 10px 18px;
  font-weight: 700; font-size: 15px;
  border: none; cursor: pointer;
}
#joinModal .btn-cancel { background: #f3f4f6; color: #333; }
#joinModal .btn-cancel:hover { background: #ddd; }
#joinModal .btn-submit { background: #3b82f6; color: #fff; }
#joinModal .btn-submit:hover { background: #2563eb; }

/* è¡¨å–®æ¬„ä½ */
#joinModal .join-field {
  display: flex; flex-direction: column;
  gap: 6px; margin: 12px 0;
  align-items: flex-start; /* æ¨™ç±¤é å·¦ */
}
#joinModal .join-field label {
  font-weight: 600; color: #1f2937; line-height: 1.2;
}
#joinModal .join-field input,
#joinModal .join-field select,
#joinModal .join-field textarea {
  width: 70%;
  padding: 10px 12px;
  border: 1px solid #d1d5db; border-radius: 8px;
  font-size: 14px; line-height: 1.25;
  background: #fff;
  transition: border-color .2s, box-shadow .2s;
}
#joinModal .join-field input:focus,
#joinModal .join-field select:focus,
#joinModal .join-field textarea:focus {
  outline: none;
  border-color: #3b82f6;
  box-shadow: 0 0 0 3px rgba(59,130,246,.15);
}
#joinModal textarea[name="note"] { min-height: 96px; }

/* æ‰‹æ©Ÿå„ªåŒ– */
@media (max-width: 480px) {
  #joinModal .modal-content {
    width: 80%; max-height: 90vh;
  }
  #joinModal .modal-footer {
    flex-direction: column;
  }
  #joinModal .btn-cancel, #joinModal .btn-submit {
    width: 100%;
  }
}
  /* Join è¡¨å–®æ¬„ä½é–“è·èˆ‡æŒ‰éˆ•é«˜åº¦ */
  #joinModal .join-field{ margin:10px 0; gap:6px; }
  .btn-submit, .btn-cancel{ min-height:44px; font-size:16px; }

  /* JoinModal å†å£“ç¸® header/é‚Šè· */
  #joinModal .modal-content{ max-height:min(92svh,640px); margin:3svh auto; }
  #joinModal .modal-header{ min-height:40px; padding:6px 14px; }
  #joinModal .modal-header .title{ font-size:15px; }
  #joinModal .modal-body{ padding:10px 14px; }
  #joinModal .modal-footer{ padding:8px 14px; }

/* ==========================================================================
   è¿”å›é ‚ç«¯æŒ‰éˆ•
   ========================================================================== */
#backToTop{
  position:fixed; bottom:20px; right:20px;
  background:#00897b; color:#fff; border:none; border-radius:50%;
  padding:14px; font-size:20px; cursor:pointer;
  box-shadow:0 4px 8px rgba(0,0,0,.2);
  z-index:1200; transition:transform .2s, background .3s;
}
#backToTop:hover{ background:#00695c; transform:scale(1.08); }

/* ==========================================================================
   å‹•ç•«
   ========================================================================== */
@keyframes fadeInUp{
  from{ opacity:0; transform:translateY(15px); }
  to{ opacity:1; transform:translateY(0); }
}

/* ==========================================================================
   RWD æ–·é»èª¿æ•´
   ========================================================================== */
/* â‰¤1024pxï¼šå¡ç‰‡èˆ‡ä¸»æŒ‰éˆ•å¾®èª¿ */
@media (max-width:1024px){
  .card{ padding:8px 12px 8px 24px; margin:3px; }
  .btn-main{ padding:10px 16px; font-size:15px; }
}
/* â‰¤768pxï¼šå­—ç´šã€å°æ¨™é¡Œã€ä¸»æŒ‰éˆ•ç­‰ */
@media (max-width:768px){
  body{ font-size:15px; }
  h1{ font-size:22px; }
  h2{ font-size:18px; margin:14px; }
  .buttons{ padding:0 12px; }
  .btn-main{ width:auto; min-width:44%; }
  #toast-container{ top:env(safe-area-inset-top,16px); right:12px; left:24px; }
}
/* â‰¤640pxï¼šä¸»æŒ‰éˆ•æ»¿ç‰ˆã€å¸æ©Ÿå¡ç‰‡ä¸‰æ¬„æ”¹å–®æ¬„ã€Modal æ›´ç·Šæ¹Šã€Join è¡¨å–®ç¶­æŒç›´å‘ */
@media (max-width:640px){
  /* ä¸»æŒ‰éˆ•æ”¹å–®æ¬„æ»¿ç‰ˆ */
  .buttons{ display:grid; grid-template-columns:1fr; gap:10px; padding:0 12px; }
  .btn-main{ width:100%; }

  /* å¸æ©Ÿå¡ç‰‡ï¼šä¸‰æ¬„â†’å–®æ¬„ */
  .driver-grid{ display:grid; grid-template-columns:1fr; grid-row-gap:8px; }
  .col-left, .col-middle, .col-actions{ width:100%; }
  .col-left .name-seat{ font-size:16px; margin-bottom:6px; text-align:left; }
  .col-middle .line{ display:block; margin:4px 0; font-size:14px; }

  .col-actions{
    display:grid; grid-template-columns:1fr 1fr auto; align-items:center; gap:8px;
  }
  .btn-manage, .btn-join{ width:100%; min-height:44px; font-size:15px; }
  .arrow{ font-size:18px; min-width:44px; min-height:44px; display:inline-grid; place-items:center; }
  .details{
  margin-top:0px; max-height:0; overflow:hidden; padding:0px 0px;
  background: transparent; border:0 #e6e6e6;
  transition:max-height 1.2s ease, padding 1s ease;
  }
  /* å±•é–‹æ™‚å†åŠ å›å¤–è§€ */
  .details.open {
    margin-top: 8px;
    max-height: 1200px;
    padding: 10px;
    background: #f9f9f9;
    border-top: 1px solid #e6e6e6;
    border-radius: 6px;
  }
  .details h4{ font-size:15px; margin:6px 0 4px; }
  .details p, .details li{ font-size:14px; margin:2px 0; }

  /* ä¹˜å®¢å¡ç‰‡ï¼šä¸»åˆ—å–®æ¬„ã€æ“ä½œé å³ */
  .pax-row{ grid-template-columns:1fr; }
  .pax-actions{ justify-content:flex-end; }

  /* é€šç”¨ modal å¯¬åº¦ */
  .modal .modal-content{ width:94vw; margin:4svh auto; }

  /* è¿”å›é ‚ç«¯ä½ç½® */
  #backToTop{ right:12px; bottom:16px; }
}
/* â‰¤400pxï¼šå­—ç´šèª¿æ•´ã€æŒ‰éˆ•èˆ‡ç®­é ­æ›´å° */
@media (max-width:400px){
  body{ font-size:14px; }
  h1{ font-size:20px; }
  h2{ font-size:16px; margin:10px; }
  .col-left .name-seat{ font-size:15px; }
  .col-middle .line1{ font-size:15px; }
  .col-middle .line2, .col-middle .line3{ font-size:13px; }
  .btn-manage, .btn-join{ font-size:14px; padding:8px 10px; }
  .arrow{ font-size:16px; min-width:40px; min-height:40px; }
}
/* ============================================================================
   Pax Edit Modal ç¾åŒ–ï¼ˆåªå½±éŸ¿ #paxEditModalï¼‰
   ========================================================================== */

/* èƒŒæ™¯ï¼šåŠé€æ˜ï¼‹è¼•å¾®æ¨¡ç³Š */
#paxEditModal.modal{
  position: fixed; inset: 0; z-index: 1200;
  background: rgba(15, 23, 42, .45);
  backdrop-filter: blur(2px);
  display: none; /* ç”¨ JS æ§åˆ¶ show/hide */
}

/* å®¹å™¨ï¼šç½®ä¸­ã€åœ“è§’ã€é™°å½±ã€flex ç›´å‘ */
#paxEditModal .modal-content{
  width: min(560px, 94vw);
  max-height: min(88svh, 680px);
  margin: 5svh auto;
  background: #ffffff;
  border-radius: 14px;
  box-shadow: 0 18px 40px rgba(2, 6, 23, .25);
  overflow: hidden;
  display: flex;
  flex-direction: column;
}

/* Header / Footer é»ä½é ‚åº•ï¼Œå…§å®¹å€å¯æ²å‹• */
#paxEditModal .modal-header,
#paxEditModal .modal-footer{
  flex: 0 0 auto;
  padding: 12px 16px;
  background: #fff;
  border-bottom: 1px solid #eef2f7;
}
#paxEditModal .modal-footer{
  border-top: 1px solid #eef2f7;
  border-bottom: 0;
  display: flex;
  justify-content: flex-end;
  gap: 10px;
}

/* æ¨™é¡Œèˆ‡é—œé–‰éˆ• */
#paxEditModal .modal-header{
  position: sticky; top: 0; z-index: 2;
  display: flex; align-items: center; justify-content: center;
}
#paxEditModal .modal-header .title{
  font-weight: 800; color: #0f172a; font-size: 16px;
  display: inline-flex; gap: 8px; align-items: center;
}
#paxEditModal .modal-header .close{
  position: absolute; right: 10px; top: 8px;
  width: 32px; height: 32px;
  border: 0; border-radius: 8px;
  display: inline-grid; place-items: center;
  font-size: 18px; line-height: 1; color: #6b7280;
  background: transparent; cursor: pointer;
  transition: color .15s ease;
}
#paxEditModal .modal-header .close:hover{
  background: #f3f4f6; color: #111827;
}

/* å…§å®¹å¯æ²å‹• + å…§è· */
#paxEditModal .modal-body{
  flex: 1 1 auto; overflow: auto;
  padding: 14px 16px;
}

/* è¡¨å–®ï¼šæ¡Œæ©Ÿå…©æ¬„ã€æ‰‹æ©Ÿå–®æ¬„ */
#paxEditModal #paxEditForm{
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px 14px;
}
@media (max-width: 640px){
  #paxEditModal #paxEditForm{ grid-template-columns: 1fr; }
}

/* å–®æ¬„æ¬„ä½ï¼ˆåŸæœ¬çš„ .join-fieldï¼‰çµ±ä¸€è¦–è¦º */
#paxEditModal .join-field{
  display: flex; flex-direction: column; gap: 6px;
}

/* è®“è¼ƒé•·çš„æ¬„ä½ï¼ˆå‚™è¨»ï¼‰è‡ªå‹•ä½”å…©æ¬„ */
#paxEditModal textarea{ grid-column: 1 / -1; }

/* Label */
#paxEditModal .join-field > label{
  font-weight: 600; color: #1f2937; line-height: 1.2;
}

/* Input / Select / Textarea ä¸€è‡´åŒ– */
#paxEditModal .join-field input,
#paxEditModal .join-field select,
#paxEditModal .join-field textarea{
  width: 50%;
  padding: 10px 12px;
  border: 1px solid #d7dde6;
  border-radius: 10px;
  font-size: 14px; line-height: 1.25;
  transition: border-color .18s ease, box-shadow .18s ease;
}

/* Focus ring */
#paxEditModal .join-field input:focus,
#paxEditModal .join-field select:focus,
#paxEditModal .join-field textarea:focus{
  outline: none;
  border-color: #3b82f6;
  box-shadow: 0 0 0 3px rgba(59,130,246,.18);
}

/* placeholder æ·¡ä¸€é» */
#paxEditModal ::placeholder{ color: #9ca3af; }

/* number å°ç®­é ­éš±è—ï¼ˆä¸€è‡´é«˜åº¦ï¼‰ */
#paxEditModal input[type="number"]::-webkit-inner-spin-button,
#paxEditModal input[type="number"]::-webkit-outer-spin-button{
  -webkit-appearance: none; margin: 0;
}
#paxEditModal input[type="number"]{ -moz-appearance: textfield; }

/* æŒ‰éˆ• */
#paxEditModal .btn-cancel,
#paxEditModal .btn-submit{
  border: 0; border-radius: 10px;
  padding: 10px 16px; font-weight: 700; cursor: pointer;
  transition: transform .06s ease, box-shadow .2s ease;
}
#paxEditModal .btn-cancel{ background: #eef2f7; color: #111827; }
#paxEditModal .btn-cancel:hover{ background: #e5eaf2; }
#paxEditModal .btn-submit{ background: #2563eb; color: #fff; }
#paxEditModal .btn-submit:hover{ background: #1e4fd6; }
#paxEditModal .btn-cancel:active,
#paxEditModal .btn-submit:active{ transform: translateY(1px); }

/* å°è¢å¹•å¾®èª¿ */
@media (max-width: 640px){
  #paxEditModal .modal-content{
    width: 94vw; max-height: min(92svh, 700px); margin: 4svh auto;
  }
  #paxEditModal .modal-body{ padding: 12px 14px; }
  #paxEditModal .modal-footer{ padding: 10px 14px; }
}

 #paxDelModal .btn-cancel{background:#d1d5db;padding:8px 14px;border:0;border-radius:6px;cursor:pointer;}
 #paxDelModal .btn-delete{background:#dc2626;color:#fff;padding:8px 14px;border:0;border-radius:6px;cursor:pointer;}
 #paxDelModal .btn-delete:hover{background:#b91c1c;}

</style>

</head>
<body>
  <h1>ğŸŒ èŠ±è“®å…‰å¾©æ•‘ç½äº¤é€šåª’åˆ</h1>

  <div class="buttons">
    <a href="{% url 'find_car' %}">
      <button class="btn-main btn-driver">ğŸš— æˆ‘è¦å‡ºè»Šï¼ˆæ‰¾ä¹˜å®¢ï¼‰</button>
    </a>
    <a href="{% url 'find_people' %}">
      <button class="btn-main btn-passenger">ğŸ§ æˆ‘è¦æ­è»Šï¼ˆæ‰¾è»Šï¼‰</button>
    </a>
  </div>

  <h2>æ‰¾äººè³‡è¨Šï¼ˆå¸æ©Ÿæä¾›åº§ä½ï¼‰</h2>
  <ul id="passenger-list">
    {% for p in passengers %}
      {% if not p.is_matched %}
        <li class="card passenger-card">
          <span><b>{{ p.passenger_name }}</b> - éœ€è¦ {{ p.seats_needed }} äºº
            ({{ p.departure }} â†’ {{ p.destination }}, {{ p.date }})</span>
          <div class="actions">
            <button onclick="openPassengerModal('{{ p.id }}')">ç·¨è¼¯</button>
            <button onclick="openJoinModal('{{ p.id }}')">åƒåŠ </button>
          </div>
        </li>
      {% endif %}
    {% empty %}
      <li class="card passenger-card">ç›®å‰æ²’æœ‰éœ€æ±‚</li>
    {% endfor %}
  </ul>

<h2>æ‰¾è»Šéœ€æ±‚ï¼ˆä¹˜å®¢éœ€è¦å¸æ©Ÿï¼‰</h2>
<ul id="driver-list">
  {% include "Find/_driver_list.html" %}
</ul>


  <!-- å›åˆ°é ‚ç«¯ -->
  <button id="backToTop" onclick="window.scrollTo({top:0, behavior:'smooth'});">â¬†</button>

<!-- å¸æ©Ÿç®¡ç†æˆæ¬Š Modal -->
<div id="driverAuthModal" class="modal" style="display:none;">
  <div class="modal-content">
    <span class="close" onclick="closeDriverAuth()">&times;</span>
    <h3 class="modal-title">ğŸ” ç®¡ç†æˆæ¬Š</h3>
    <p class="modal-desc">è«‹è¼¸å…¥ç®¡ç†å¯†ç¢¼ä»¥ç¹¼çºŒ</p>
    <form id="driverAuthForm" method="POST">
      {% csrf_token %}
      <input type="hidden" id="driverAuthId" value="">
      <div class="form-group">
        <label for="driverAuthPassword">ç®¡ç†å¯†ç¢¼</label>
        <input id="driverAuthPassword" type="password" name="password" required placeholder="è¼¸å…¥ç®¡ç†å¯†ç¢¼">
      </div>
      <div class="modal-actions">
        <button type="submit" class="btn-primary">ç¢ºèª</button>
        <button type="button" class="btn-secondary" onclick="closeDriverAuth()">å–æ¶ˆ</button>
      </div>
    </form>
  </div>
</div>
<!-- åˆªé™¤å¸æ©Ÿ Modal -->
<div id="deleteDriverModal" class="modal" style="display:none;">
  <div class="modal-content" style="max-width:400px;text-align:center;">
    <h3 style="color:#b91c1c;">âš ï¸ ç¢ºèªåˆªé™¤</h3>
    <p>ç¢ºå®šè¦åˆªé™¤æ­¤å¸æ©Ÿå—ï¼Ÿ<br>æ­¤å‹•ä½œæœƒè§£é™¤æ‰€æœ‰ä¹˜å®¢é—œè¯ï¼Œä¸”ç„¡æ³•å¾©åŸã€‚</p>
    <div style="margin-top:20px;display:flex;justify-content:center;gap:12px;">
      <button type="button" class="btn-cancel" onclick="closeDeleteDriver()">å–æ¶ˆ</button>
      <button type="button" class="btn-delete" id="confirmDeleteDriver">åˆªé™¤</button>
    </div>
  </div>
</div>

<style>
  .btn-cancel{background:#d1d5db;padding:8px 14px;border:0;border-radius:6px;cursor:pointer;}
  .btn-delete{background:#dc2626;color:#fff;padding:8px 14px;border:0;border-radius:6px;cursor:pointer;}
  .btn-delete:hover{background:#b91c1c;}
</style>



<!-- Toast å®¹å™¨ -->
<div id="toast-container" style="
  position: fixed;
  top: 20px;
  right: 20px;
  z-index: 2000;
"></div>

<!-- åƒåŠ è¡Œç¨‹ Modal -->
<div id="joinModal" class="modal" style="display:none;">
  <div class="modal-content">
    <div class="modal-header">
      <h3>ğŸ§ åƒåŠ è¡Œç¨‹</h3>
      <button type="button" class="close" onclick="closeJoinModal()">Ã—</button>
    </div>

    <div class="modal-body">
      <form id="joinForm" method="POST">
        {% csrf_token %}

        <div class="join-field">
          <label>æš±ç¨±</label>
          <input type="text" name="passenger_name" required>
        </div>

        <div class="join-field">
          <label>æ€§åˆ¥</label>
          <select name="gender" required>
            <option value="X" selected>ä¸æ–¹ä¾¿é€æ¼</option>
            <option value="M">ç”·ç”Ÿ</option>
            <option value="F">å¥³ç”Ÿ</option>
          </select>
        </div>

        <div class="join-field">
          <label>Email <span class="muted">(ä¸å…¬é–‹ï¼Œç”¨æ–¼åª’åˆé€šçŸ¥)</span></label>
          <input type="email" name="email" placeholder="é¸å¡«">
        </div>

        <div class="join-field">
          <label>è¯çµ¡æ–¹å¼(é¸å¡«,æœªå¡«è«‹è‡ªè¡Œé€£çµ¡å¸æ©Ÿ)</label>
          <input type="text" name="contact" placeholder="LINE / IG / Phone æ“‡ä¸€">
        </div>

        <div class="join-field">
          <label>ä¸Šè»Šäººæ•¸</label>
          <input type="number" name="seats_needed" min="1" value="1" required>
        </div>

        <div class="join-field">
          <label>é¡˜ä»˜é‡‘é¡ <span class="muted">ï¼ˆé¸å¡«ï¼Œå–®ä½ NTSï¼‰</span></label>
          <input type="number" name="willing_to_pay" min="0" step="1" placeholder="é¸å¡«">
        </div>

        <!-- ä¸Šè»Šåœ°é»ï¼ˆç¸£å¸‚ä¸‹æ‹‰ + è‡ªå¡«ï¼‰ -->
        <div class="join-field">
          <label for="join-pickup-select">ä¸Šè»Šåœ°é»</label>

          <!-- ä½¿ç”¨ä¸‹æ‹‰åšé¸æ“‡ï¼ˆæ²’æœ‰ nameï¼Œé¿å…ç›´æ¥æäº¤ï¼‰ -->
          <select id="join-pickup-select">
            <option value="">è«‹é¸æ“‡ç¸£å¸‚</option>
            <option value="å…¶ä»–">å…¶ä»–</option>
            <option value="èŠ±è“®ç¸£å…‰å¾©é„‰">èŠ±è“®ç¸£å…‰å¾©é„‰</option>
            <option value="èŠ±è“®ç¸£å…‰å¾©è»Šç«™ä»¥å¤–ç«è»Šç«™">èŠ±è“®ç¸£å…‰å¾©è»Šç«™ä»¥å¤–ç«è»Šç«™</option>
            <option value="èŠ±è“®ç¸£å…‰å¾©è»Šç«™">èŠ±è“®ç¸£å…‰å¾©è»Šç«™</option>
            <option value="å…‰å¾©é„‰ç³–å» ">å…‰å¾©é„‰ç³–å» </option>
            <option value="éœ€æ¸…æ·¤åœ°å€">éœ€æ¸…æ·¤åœ°å€</option>
            <option value="å°åŒ—å¸‚">å°åŒ—å¸‚</option>
            <option value="æ–°åŒ—å¸‚">æ–°åŒ—å¸‚</option>
            <option value="åŸºéš†å¸‚">åŸºéš†å¸‚</option>
            <option value="æ¡ƒåœ’å¸‚">æ¡ƒåœ’å¸‚</option>
            <option value="æ–°ç«¹å¸‚">æ–°ç«¹å¸‚</option>
            <option value="æ–°ç«¹ç¸£">æ–°ç«¹ç¸£</option>
            <option value="è‹—æ —ç¸£">è‹—æ —ç¸£</option>
            <option value="å°ä¸­å¸‚">å°ä¸­å¸‚</option>
            <option value="å½°åŒ–ç¸£">å½°åŒ–ç¸£</option>
            <option value="å—æŠ•ç¸£">å—æŠ•ç¸£</option>
            <option value="é›²æ—ç¸£">é›²æ—ç¸£</option>
            <option value="å˜‰ç¾©å¸‚">å˜‰ç¾©å¸‚</option>
            <option value="å˜‰ç¾©ç¸£">å˜‰ç¾©ç¸£</option>
            <option value="å°å—å¸‚">å°å—å¸‚</option>
            <option value="é«˜é›„å¸‚">é«˜é›„å¸‚</option>
            <option value="å±æ±ç¸£">å±æ±ç¸£</option>
            <option value="å®œè˜­ç¸£">å®œè˜­ç¸£</option>
            <option value="èŠ±è“®ç¸£">èŠ±è“®ç¸£</option>
            <option value="å°æ±ç¸£">å°æ±ç¸£</option>
            <option value="æ¾æ¹–ç¸£">æ¾æ¹–ç¸£</option>
            <option value="é‡‘é–€ç¸£">é‡‘é–€ç¸£</option>
            <option value="é€£æ±Ÿç¸£">é€£æ±Ÿç¸£</option>
          </select>

          <!-- è‡ªå¡«ï¼ˆé¸ã€Œå…¶ä»–ã€æ‰é¡¯ç¤ºï¼›ç„¡ nameï¼‰ -->
          <input type="text" id="join-pickup-custom" placeholder="è¼¸å…¥è‡ªè¨‚ä¸Šè»Šåœ°é»" style="display:none;">

          <!-- çœŸæ­£æäº¤ç”¨ï¼ˆæœ‰ nameï¼‰ -->
          <input type="hidden" id="join-pickup" name="departure">
        </div>
        
        

        <div class="join-field">
          <label>ç›®çš„åœ°</label>
          <input type="text" name="destination">
        </div>



        <!-- å‡ºç™¼æ—¥æœŸï¼ˆå¿…å¡«ï¼‰ -->
        <div class="join-field">
          <label for="join-date">å‡ºç™¼æ—¥æœŸ</label>
          <input type="date" id="join-date" name="date" required>
        </div>
        <!-- æ˜¯å¦ä¸€èµ·å›ç¨‹ -->
        <div class="join-field">
          <label>æ˜¯å¦ä¸€èµ·å›ç¨‹ï¼Ÿ</label>
          <select name="together_return" id="join-together">
            <option value="" selected>æœªæŒ‡å®š</option>
            <option value="true">æ˜¯</option>
            <option value="false">å¦</option>
          </select>
        </div>
        <!-- å›ç¨‹æ—¥æœŸ -->
        <div class="join-field" id="returnField" style="display:none;">
          <label for="join-return">å›ç¨‹æ—¥æœŸ</label>
          <input type="date" id="join-return" name="return_date">
        </div>


        <div class="join-field">
          <label>ç®¡ç†å¯†ç¢¼ <span class="muted">ï¼ˆå»ºè­° 4 ç¢¼ï¼Œä¾›å–æ¶ˆ/ç·¨è¼¯ç”¨ï¼Œé è¨­0000ï¼‰</span></label>
          <input type="password" name="password" placeholder="å»ºè­° 4 ç¢¼" defaultValue="0000">
        </div>

        <div class="join-field">
          <label>å‚™è¨» <span class="muted">ï¼ˆå¯è¼¸å…¥åŒè¡Œäººã€å…·é«”éœ€æ±‚â€¦ï¼‰</span></label>
          <textarea name="note" rows="3" placeholder=""></textarea>
        </div>
      </form>
    </div>

    <div class="modal-footer">
      <button type="button" class="btn-cancel" onclick="closeJoinModal()">å–æ¶ˆ</button>
      <button type="submit" form="joinForm" class="btn-submit">é€å‡º</button>
    </div>
  </div>
</div>

<!-- ä¹˜å®¢ç·¨è¼¯æˆæ¬Š Modal -->
<div id="paxAuthModal" class="modal" style="display:none;">
  <div class="modal-content" style="max-width:420px;">
    <div class="modal-header">
      <span class="title">ğŸ” ç·¨è¼¯æˆæ¬Š</span>
      <button class="close" onclick="closePaxAuth()">&times;</button>
    </div>
    <div class="modal-body">
      <form id="paxAuthForm" method="POST">
        {% csrf_token %}
        <input type="hidden" id="paxAuthId" name="id">
        <div class="join-field">
          <label>ç®¡ç†å¯†ç¢¼</label>
          <input type="password" id="paxAuthPassword" name="password" placeholder="è«‹è¼¸å…¥ä¹˜å®¢ç®¡ç†å¯†ç¢¼" required>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn-cancel" onclick="closePaxAuth()">å–æ¶ˆ</button>
      <button class="btn-submit" onclick="submitPaxAuth()">ç¢ºèª</button>
    </div>
  </div>
</div>
<!-- ä¹˜å®¢ç·¨è¼¯ Modal -->
<div id="paxEditModal" class="modal" style="display:none;">
  <div class="modal-content">
    <div class="modal-header">
      <span class="title">âœï¸ ç·¨è¼¯ä¹˜å®¢</span>
      <button class="close" onclick="closePaxEdit()">&times;</button>
    </div>
    <div class="modal-body">
      <form id="paxEditForm">
        {% csrf_token %}
        <input type="hidden" id="paxEditId" name="id">

        <div class="join-field">
          <label>æš±ç¨±</label>
          <input type="text" id="paxName" name="passenger_name" required>
        </div>

        <div class="join-field">
          <label>æ€§åˆ¥</label>
          <select id="paxGender" name="gender">
            <option value="X">ä¸æ–¹ä¾¿é€æ¼</option>
            <option value="M">ç”·ç”Ÿ</option>
            <option value="F">å¥³ç”Ÿ</option>
          </select>
        </div>

        <div class="join-field">
          <label>Emailï¼ˆä¸å…¬é–‹ï¼‰</label>
          <input type="email" id="paxEmail" name="email" placeholder="å¯ç©ºç™½">
        </div>

        <div class="join-field">
          <label>è¯çµ¡æ–¹å¼</label>
          <input type="text" id="paxContact" name="contact" placeholder="LINE / IG / Phone">
        </div>

        <div class="join-field">
          <label>ä¸Šè»Šäººæ•¸</label>
          <input type="number" id="paxSeats" name="seats_needed" min="1" value="1">
        </div>

        <div class="join-field">
          <label>é¡˜ä»˜é‡‘é¡ï¼ˆå¯ç©ºï¼‰</label>
          <input type="text" id="paxPay" name="willing_to_pay" placeholder="ä¾‹å¦‚ 300">
        </div>

        <div class="join-field">
          <label>ä¸Šè»Šåœ°é»</label>
          <input type="text" id="paxDeparture" name="departure">
        </div>

        <div class="join-field">
          <label>ç›®çš„åœ°</label>
          <input type="text" id="paxDestination" name="destination">
        </div>

        <div class="join-field">
          <label>å‡ºç™¼æ—¥æœŸ</label>
          <input type="date" id="paxDate" name="date">
        </div>

        <div class="join-field">
          <label>å›ç¨‹æ—¥æœŸï¼ˆé¸å¡«ï¼‰</label>
          <input type="date" id="paxReturn" name="return_date">
        </div>

        <div class="join-field">
          <label>æ˜¯å¦ä¸€èµ·å›ç¨‹</label>
          <select id="paxTogether" name="together_return">
            <option value="">æœªæŒ‡å®š</option>
            <option value="true">æ˜¯</option>
            <option value="false">å¦</option>
          </select>
        </div>

        <div class="join-field">
          <label>å‚™è¨»</label>
          <textarea id="paxNote" name="note" rows="3"></textarea>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn-cancel" onclick="closePaxEdit()">å–æ¶ˆ</button>
      <button class="btn-submit" onclick="submitPaxEdit()">å„²å­˜</button>
    </div>
  </div>
</div>

<!-- ä¹˜å®¢åˆªé™¤ Modalï¼ˆç°¡å–®ç¢ºèªï¼‰ -->
<div id="paxDelModal" class="modal" style="display:none;">
  <div class="modal-content">
    <div class="modal-header">
      <span class="title">ğŸ—‘ åˆªé™¤ä¹˜å®¢</span>
      <button class="close" onclick="closePaxDel()">&times;</button>
    </div>
    <div class="modal-body">
      <p>ç¢ºå®šè¦åˆªé™¤é€™ä½ä¹˜å®¢å—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚</p>
      <input type="hidden" id="paxDelId">
    </div>
    <div class="modal-footer">
      <button class="btn-cancel" onclick="closePaxDel()">å–æ¶ˆ</button>
      <button class="btn-submit" style="background:#e11d48" onclick="confirmPaxDel()">åˆªé™¤</button>
    </div>
  </div>
</div>



<script>
/* =========================================================================
 * 0) å…¬ç”¨å°å·¥å…·ï¼ˆå–®ä¸€ä¾†æºï¼‰
 * ========================================================================= */
(function initUtils(){
  if (window.__UTILS_READY__) return;
  window.__UTILS_READY__ = true;

  window.$id = (id) => document.getElementById(id);

  window.getCookie = function(name){
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    return parts.length === 2 ? parts.pop().split(';').shift() : null;
  };

  // å¾ä»»ä¸€è¡¨å–®æˆ– cookie å– CSRFï¼ˆå„ªå…ˆè¡¨å–®ï¼‰
  window.getCSRF = function(form){
    const el = (form || document).querySelector('input[name="csrfmiddlewaretoken"]');
    return (el && el.value) || getCookie('csrftoken') || '';
  };

  window.showToastSafe = function(msg, type){
    if (typeof showToast === 'function') showToast(msg, type);
    else alert(msg);
  };

  // å®‰å…¨ JSON å–å›ï¼šres å¤±æ•—æˆ–é JSON ä¸æ‹‹ä¾‹å¤–
  window.jsonFetch = async function(url, options = {}){
    const res = await fetch(url, options);
    let data = {};
    try { data = await res.json(); } catch(_) {}
    return { res, data };
  };
})();

/* =========================================================================
 * 1) WebSocket åˆå§‹åŒ–ï¼ˆå–®ä¸€ä¾†æºï¼‰+ äº‹ä»¶ç¶å®šï¼ˆä½¿ç”¨ addEventListenerï¼‰
 *    - æ”¯æ´å…¨é‡ passengers_html
 *    - æ”¯æ´å–®å¡ç‰‡ driver_partial â†’ patchDriverCard()
 * ========================================================================= */
(function initSocket(){
  if (!window.socket) {
    window.socket = new WebSocket(
      (location.protocol === 'https:' ? 'wss://' : 'ws://') + window.location.host + '/ws/find/'
    );
  }
  socket.addEventListener('open',  () => console.log('âœ… WebSocket é€£ç·šæˆåŠŸ'));
  socket.addEventListener('close', () => console.log('âŒ WebSocket å·²é—œé–‰'));
  socket.addEventListener('error', (err) => console.error('âš ï¸ WebSocket ç™¼ç”ŸéŒ¯èª¤', err));

  socket.addEventListener('message', (event) => {
    let data;
    try { data = JSON.parse(event.data); } catch { return; }

    // å–®ä¸€å¡ç‰‡æ›´æ–°
    if (data.type === 'driver_partial') {
      // æœŸå¾… payload: { type, driver_id, driver_html, active }
      patchDriverCard(data.driver_id, data.driver_html, data.active);
      return;
    }

    // å…¨é‡æ›´æ–°ï¼ˆä¿ç•™ä¹˜å®¢æ¸…å–®ï¼‰
    if (data.type === 'update') {
      if (data.passengers_html) {
        const plist = $id('passenger-list');
        if (plist) plist.innerHTML = data.passengers_html;
      }
      // drivers_html å»ºè­°æ”¹èµ° driver_partialï¼›å¦‚ä»å‚³å…¥ï¼Œå¯è¦–éœ€æ±‚è™•ç†
      return;
    }

    if (data.type === 'join_result') {
      if (data.success) showToastSafe('âœ… æˆåŠŸåŠ å…¥ä¹˜å®¢è¡Œç¨‹ï¼', 'success');
      else showToastSafe('âš ï¸ åŠ å…¥å¤±æ•—ï¼š' + (data.message || 'æ²’æœ‰å¯ç”¨çš„å¸æ©Ÿ'), 'error');
    }
  });
})();

/* =========================================================================
 * 2) Driver åˆ—è¡¨ï¼šå…¨é‡æ›¿æ›ï¼ˆä¿ç•™å±•é–‹èˆ‡å·è»¸ï¼‰ & å–®å¡ç‰‡æ›¿æ›
 * ========================================================================= */
// è¨˜ä½ç›®å‰å±•é–‹çš„ driver ids
function snapshotOpenDrivers () {
  return Array
    .from(document.querySelectorAll('#driver-list .details.open'))
    .map(el => el.id.replace('details-', ''));
}
// é‚„åŸå±•é–‹ç‹€æ…‹ï¼ˆåŒ…å«ç®­é ­ ariaï¼‰
function restoreOpenDrivers (openIds) {
  if (!Array.isArray(openIds) || openIds.length === 0) return;
  openIds.forEach(id => {
    const details = document.getElementById('details-' + id);
    const arrow   = document.getElementById('arrow-' + id);
    if (details) {
      details.classList.add('open');
      details.setAttribute('aria-hidden', 'false');
    }
    if (arrow) {
      arrow.classList.add('open');
      arrow.setAttribute('aria-expanded', 'true');
    }
  });
}
// å…¨é‡æ›¿æ› driver list
function replaceDriverListSafely (newHtml) {
  const list = document.getElementById('driver-list');
  if (!list || typeof newHtml !== 'string') return;
  const openIds     = snapshotOpenDrivers();
  const prevScrollY = window.scrollY;
  list.innerHTML = newHtml;
  restoreOpenDrivers(openIds);
  window.scrollTo(0, prevScrollY);
}
// åŒæ™‚è™•ç† drivers / passengers
function replaceLists (data) {
  if (!data || typeof data !== 'object') return;
  if (typeof data.drivers_html === 'string') replaceDriverListSafely(data.drivers_html);
  if (typeof data.passengers_html === 'string') {
    const p = document.getElementById('passenger-list');
    if (p) p.innerHTML = data.passengers_html;
  }
}

// å–å¾—å¡ç‰‡ç‹€æ…‹
function snapshotCardState(li) {
  if (!li) return null;
  const panel    = li.querySelector('.details');
  if (!panel) return { open: false, scrollP: 0, scrollA: 0 };
  const pending  = panel.querySelector('.pending-scroll');
  const accepted = panel.querySelector('.accepted-scroll');
  return {
    open   : panel.classList.contains('open'),
    scrollP: pending  ? pending.scrollTop  : 0,
    scrollA: accepted ? accepted.scrollTop : 0
  };
}
// é‚„åŸå¡ç‰‡ç‹€æ…‹
function restoreCardState(li, state) {
  if (!li || !state) return;
  const panel = li.querySelector('.details');
  const arrow = li.querySelector('.arrow');
  if (state.open && panel) {
    panel.classList.add('open');
    panel.setAttribute('aria-hidden', 'false');
    if (arrow) {
      arrow.classList.add('open');
      arrow.setAttribute('aria-expanded', 'true');
    }
  }
  const pending  = li.querySelector('.pending-scroll');
  const accepted = li.querySelector('.accepted-scroll');
  if (pending)  pending.scrollTop  = state.scrollP || 0;
  if (accepted) accepted.scrollTop = state.scrollA || 0;
}
// å–®ä¸€å¡ç‰‡æ›¿æ› / é™„åŠ  / ç§»é™¤
function patchDriverCard(driverId, driverHTML, active = true) {
  const list = document.getElementById('driver-list');
  if (!list || !driverId || typeof driverHTML !== 'string') return;
  const selector = `li[data-driver="${CSS.escape(String(driverId))}"]`;
  const oldLi = list.querySelector(selector);

  // ä¸å­˜åœ¨ï¼šactive=true â†’ append
  if (!oldLi) {
    if (!active) return;
    const tmp = document.createElement('div');
    tmp.innerHTML = driverHTML.trim();
    const newLi = tmp.querySelector('li') || tmp.firstElementChild;
    if (newLi) list.appendChild(newLi);
    return;
  }
  // ä¸‹æ¶ï¼šç§»é™¤
  if (!active) { oldLi.remove(); return; }

  const state = snapshotCardState(oldLi);
  const tmp = document.createElement('div');
  tmp.innerHTML = driverHTML.trim();
  const newLi = tmp.querySelector('li') || tmp.firstElementChild;
  if (!newLi) return;
  oldLi.replaceWith(newLi);
  restoreCardState(newLi, state);
}

/* =========================================================================
 * 3) Driver ç®¡ç†æˆæ¬Šï¼ˆå¯†ç¢¼é©—è­‰ â†’ æˆåŠŸè·³è½‰ï¼‰
 *    - openDriverModal(driverId) / closeDriverAuth()
 * ========================================================================= */
(function initDriverAuth(){
  function bindDriverAuthForm() {
    const form = $id("driverAuthForm");
    if (!form || form.dataset.bound === "1") return;

    const idEl  = $id("driverAuthId");
    const pwdEl = $id("driverAuthPassword");

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const driverId = idEl && idEl.value;
      const password = pwdEl && pwdEl.value;
      if (!driverId) { console.error("ç¼º driverId"); return; }
      if (!password) { showToastSafe("è«‹è¼¸å…¥å¯†ç¢¼", "error"); pwdEl && pwdEl.focus(); return; }

      const btn = form.querySelector('[type="submit"]');
      try {
        if (btn) btn.disabled = true;
        const { res, data } = await jsonFetch(`/find/driver/${driverId}/manage/auth/`, {
          method: "POST",
          credentials: "same-origin",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8",
            "X-CSRFToken": getCSRF(form),
            "X-Requested-With": "XMLHttpRequest",
          },
          body: new URLSearchParams({ password }),
        });

        if (res.ok && data && data.ok && data.url) {
          showToastSafe("âœ… é©—è­‰æˆåŠŸï¼Œå‰å¾€ç®¡ç†é â€¦", "success");
          closeDriverAuth();
          window.location.href = data.url;
        } else {
          const msg = (data && (data.error || data.detail)) || `é©—è­‰å¤±æ•— (HTTP ${res.status})`;
          showToastSafe(msg, "error");
          pwdEl && pwdEl.focus();
        }
      } catch (err) {
        console.error(err);
        showToastSafe("ä¼ºæœå™¨éŒ¯èª¤ï¼Œç¨å¾Œå†è©¦", "error");
      } finally {
        if (btn) btn.disabled = false;
      }
    });

    form.dataset.bound = "1";
  }

  window.openDriverModal = function (driverId) {
    const idEl  = $id("driverAuthId");
    const pwdEl = $id("driverAuthPassword");
    const modal = $id("driverAuthModal");
    if (!idEl || !pwdEl || !modal) { alert("ç®¡ç†è¦–çª—å…ƒä»¶ç¼ºå¤±"); return; }
    idEl.value = driverId;
    pwdEl.value = "";
    modal.style.display = "block";
    bindDriverAuthForm();
    setTimeout(() => pwdEl.focus(), 0);
  };
  window.closeDriverAuth = function () {
    const modal = $id("driverAuthModal");
    if (modal) modal.style.display = "none";
  };
  document.addEventListener("DOMContentLoaded", bindDriverAuthForm);
})();

/* =========================================================================
 * 4) Join / Cancel Modal é–‹é—œ + å¯é¸ AJAX é€å‡º
 *    - openJoinModal(driverId) / closeJoinModal()
 *    - openCancelModal(passengerId)
 * ========================================================================= */
function openJoinModal(driverId){
  const m = $id('joinModal');
  const f = $id('joinForm');
  if (!m || !f) return;
  f.action = `/find/driver/${driverId}/join/`;
  m.style.display = 'block';
  document.body.classList.add('body-modal-open');
  setTimeout(() => {
    const first = f.querySelector('input,select,textarea');
    if (first) first.focus();
  }, 0);
}
function closeJoinModal(){
  const m = $id('joinModal');
  if (m) m.style.display = 'none';
  document.body.classList.remove('body-modal-open');
}
function openCancelModal(passengerId){
  const m = $id('cancelModal');
  const f = $id('cancelForm');
  const hidden = $id('cancelPassengerId');
  if (!m || !f || !hidden) return;
  hidden.value = passengerId;
  f.action = `/find/passenger/${passengerId}/cancel/`;
  m.style.display = 'block';
}

// å¯é¸ï¼šæŠŠ join/cancel æ””æˆªæˆ AJAX
(function enhanceJoinCancel(){
  const joinForm   = $id('joinForm');
  const cancelForm = $id('cancelForm');

  async function ajaxSubmit(form, okMsg){
    const body = new URLSearchParams(new FormData(form));
    const { res, data } = await jsonFetch(form.action, {
      method: 'POST',
      headers: { 'X-Requested-With': 'XMLHttpRequest' },
      body
    });
    if (res.ok && data.ok) {
      showToastSafe(okMsg || 'æˆåŠŸ', 'success');
      const modal = form.closest('.modal');
      if (modal) modal.style.display = 'none';
    } else {
      const msg = (data && (data.error || data.detail)) || `å¤±æ•—ï¼ˆ${res.status}ï¼‰`;
      showToastSafe(msg, 'error');
    }
  }

  if (joinForm) {
    joinForm.addEventListener('submit', async (e) => {
      e.preventDefault();             // è¦èµ°åŒæ­¥ POST çš„è©±ï¼Œç§»é™¤æ­¤è¡Œ
      await ajaxSubmit(joinForm, 'âœ… å·²é€å‡ºç”³è«‹');
    });
  }
  if (cancelForm) {
    cancelForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      await ajaxSubmit(cancelForm, 'ğŸ—‘ï¸ å·²å–æ¶ˆ');
    });
  }
})();

/* =========================================================================
 * 5) Join Modal è¡Œç‚ºï¼ˆå¸¶å…¥å¸æ©Ÿæ—¥æœŸã€æ§åˆ¶å›ç¨‹æ¬„ä½ã€æœ€å°æ—¥æœŸé™åˆ¶ï¼‰
 *    - openJoinModal(driverId, driverDate?, driverReturn?)
 *    - resetReturnDate()ï¼ˆå¯é¸ï¼‰
 * ========================================================================= */
(function joinModalBehavior(){
  let currentDriverDate   = "";
  let currentDriverReturn = "";

  function grabJoinEls() {
    return {
      togetherSel: $id("join-together"),
      departInput: $id("join-date"),
      returnWrap : $id("returnField"),
      returnInput: $id("join-return"),
      joinModal  : $id("joinModal"),
      joinForm   : $id("joinForm"),
    };
  }

  function handleTogetherChange() {
    const { togetherSel, departInput, returnWrap, returnInput } = grabJoinEls();
    const v = togetherSel ? togetherSel.value : "";
    if (returnInput) {
      const minBase = (departInput && departInput.value) || currentDriverDate || "";
      returnInput.min = minBase;
    }
    if (v === "false") {
      if (returnWrap) returnWrap.style.display = "block";
      if (returnInput) {
        returnInput.readOnly = false;
        if (!returnInput.value && returnInput.min) returnInput.value = returnInput.min;
      }
    } else if (v === "true") {
      const hasReturn = !!currentDriverReturn;
      if (returnWrap) returnWrap.style.display = hasReturn ? "block" : "none";
      if (returnInput) {
        returnInput.readOnly = true;
        returnInput.value = hasReturn ? currentDriverReturn : "";
      }
    } else {
      if (returnWrap) returnWrap.style.display = "none";
      if (returnInput) { returnInput.readOnly = false; returnInput.value = ""; }
    }
  }

  function syncReturnMin() {
    const { departInput, returnInput } = grabJoinEls();
    if (!departInput || !returnInput) return;
    returnInput.min = departInput.value || currentDriverDate || "";
    if (returnInput.value && departInput.value && returnInput.value < departInput.value) {
      returnInput.value = "";
    }
  }

  window.openJoinModal = function (driverId, driverDate = "", driverReturn = "") {
    const { togetherSel, departInput, returnWrap, returnInput, joinModal, joinForm } = grabJoinEls();
    currentDriverDate   = driverDate || "";
    currentDriverReturn = driverReturn || "";
    if (departInput && currentDriverDate) departInput.value = currentDriverDate;
    if (togetherSel) togetherSel.value = "";
    if (returnInput) { returnInput.value = ""; returnInput.readOnly = false; }
    if (returnWrap) returnWrap.style.display = "none";
    syncReturnMin();
    if (joinForm)  joinForm.action  = `/find/driver/${driverId}/join/`;
    if (joinModal) joinModal.style.display = "block";
  };

  window.resetReturnDate = function () {
    const { returnInput } = grabJoinEls();
    if (returnInput) returnInput.value = "";
    syncReturnMin();
  };

  // ç¶å®šï¼ˆä¸€æ¬¡ï¼‰
  if (!window.__JOIN_MODAL_BOUND__) {
    window.__JOIN_MODAL_BOUND__ = true;
    document.addEventListener("change", function (e) {
      if (e.target && e.target.id === "join-together") handleTogetherChange();
      if (e.target && e.target.id === "join-date")     syncReturnMin();
    });
    // è®“ data-action="join" çš„æŒ‰éˆ•å¯å°‡ data-date / data-return å¸¶å…¥
    document.addEventListener("click", function (e) {
      const btn = e.target.closest('[data-action="join"]');
      if (!btn) return;
      e.preventDefault();
      openJoinModal(btn.dataset.id, btn.dataset.date || "", btn.dataset.return || "");
    });
  }
})();

/* =========================================================================
 * 6) åƒåŠ è¡¨å–®ï¼šä¸Šè»Šåœ°é»ï¼ˆä¸‹æ‹‰ï¼‹è‡ªå¡«ï¼‰â†’ åŒæ­¥åˆ°éš±è—æ¬„ä½ name="departure"
 *    å…ƒç´ ï¼š
 *      #join-pickup-selectï¼ˆå«ã€Œå…¶ä»–ã€ï¼‰
 *      #join-pickup-customï¼ˆè¼¸å…¥æ¡†ï¼Œé¸ã€Œå…¶ä»–ã€æ‰é¡¯ç¤ºï¼‰
 *      #join-pickupï¼ˆhiddenï¼ŒçœŸæ­£é€å¾Œç«¯çš„ departureï¼‰
 *      #joinForm
 * ========================================================================= */
(function pickupFieldBinding(){
  if (window.__PICKUP_BIND__) return; // é˜²é‡è¤‡
  window.__PICKUP_BIND__ = true;

  const PICKUP_SELECT_ID = "join-pickup-select";
  const PICKUP_CUSTOM_ID = "join-pickup-custom";
  const PICKUP_HIDDEN_ID = "join-pickup";
  const JOIN_FORM_ID     = "joinForm";

  function getEls() {
    return {
      sel   : $id(PICKUP_SELECT_ID),
      custom: $id(PICKUP_CUSTOM_ID),
      hidden: $id(PICKUP_HIDDEN_ID),
      form  : $id(JOIN_FORM_ID),
    };
  }
  function applyPickupUI() {
    const { sel, custom } = getEls();
    if (!sel || !custom) return;
    if (sel.value === "å…¶ä»–") {
      custom.style.display = "block";
    } else {
      custom.style.display = "none";
      custom.value = "";
    }
  }
  function syncHidden() {
    const { sel, custom, hidden } = getEls();
    if (!sel || !custom || !hidden) return;
    hidden.value = (sel.value === "å…¶ä»–") ? (custom.value || "").trim() : (sel.value || "");
  }

  // äº‹ä»¶å§”æ´¾ä¸€æ¬¡æå®š
  document.addEventListener("change", (e) => {
    if (e.target && e.target.id === PICKUP_SELECT_ID) {
      applyPickupUI(); syncHidden();
    }
  });
  document.addEventListener("input", (e) => {
    if (e.target && e.target.id === PICKUP_CUSTOM_ID) syncHidden();
  });
  document.addEventListener("submit", (e) => {
    const { form } = getEls();
    if (form && e.target === form) syncHidden();
  });

  // å°å¤–é‡ç½®ï¼ˆæ‰“é–‹ Modal æ™‚å¯ç”¨ï¼‰
  window.resetPickupField = function(){
    const { sel, custom, hidden } = getEls();
    if (!sel || !custom || !hidden) return;
    sel.value = ""; custom.value = ""; custom.style.display = "none"; hidden.value = "";
  };

  // åˆå§‹å¥—ç”¨ä¸€æ¬¡
  setTimeout(() => { applyPickupUI(); syncHidden(); }, 0);
})();

/* =========================================================================
 * 7) ä¹˜å®¢ï¼šå¯†ç¢¼é©—è­‰ â†’ï¼ˆç·¨è¼¯ï½œåˆªé™¤ï¼‰/ ç·¨è¼¯å„²å­˜ / åˆªé™¤
 *    - äº‹ä»¶å§”æ´¾ï¼š [data-pax-edit], [data-pax-del]
 *    - å¯ç”¨ window.afterPaxChanged?.({action, id}) ä½œç‚ºæ›´æ–°é‰¤å­
 * ========================================================================= */
// Modal é–‹é—œ
function openPaxAuth (pid) {
  const idEl  = $id('paxAuthId');
  const pwdEl = $id('paxAuthPassword');
  const modal = $id('paxAuthModal');
  if (!idEl || !pwdEl || !modal) return;
  idEl.value = pid; pwdEl.value = '';
  modal.style.display = 'block';
  setTimeout(() => pwdEl.focus(), 0);
}
function closePaxAuth () { const m = $id('paxAuthModal'); if (m) m.style.display = 'none'; }
function openPaxEdit ()  { const m = $id('paxEditModal'); if (m) m.style.display  = 'block'; }
function closePaxEdit () { const m = $id('paxEditModal'); if (m) m.style.display  = 'none'; }

let __paxNextAction = null;

// å§”æ´¾ï¼šç·¨è¼¯ / åˆªé™¤ â†’ å…ˆé©—è­‰å¯†ç¢¼
document.addEventListener('click', (e) => {
  const editBtn = e.target.closest('[data-pax-edit]');
  if (editBtn){ e.preventDefault(); __paxNextAction = 'edit';   openPaxAuth(editBtn.dataset.id); return; }
  const delBtn  = e.target.closest('[data-pax-del]');
  if (delBtn){  e.preventDefault(); __paxNextAction = 'delete'; openPaxAuth(delBtn.dataset.id); return; }
});

async function submitPaxAuth () {
  const pid = $id('paxAuthId')?.value;
  const pwd = $id('paxAuthPassword')?.value;
  if (!pid || !pwd) { showToastSafe('è«‹è¼¸å…¥å¯†ç¢¼', 'error'); return; }

  try {
    const { res, data } = await jsonFetch(`/find/pax/${pid}/auth/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': getCSRF(),
        'X-Requested-With': 'XMLHttpRequest',
        'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8',
      },
      body: new URLSearchParams({ password: pwd })
    });
    if (!res.ok || !data.ok) { showToastSafe(data.error || 'é©—è­‰å¤±æ•—', 'error'); return; }
    closePaxAuth();
    if (__paxNextAction === 'delete') { await doPaxDelete(pid); return; }
    if (__paxNextAction === 'edit')   { await loadPaxAndOpenEdit(pid); return; }
  } catch (err) {
    console.error(err);
    showToastSafe('ä¼ºæœå™¨éŒ¯èª¤ï¼Œç¨å¾Œå†è©¦', 'error');
  } finally {
    __paxNextAction = null;
  }
}
window.submitPaxAuth = submitPaxAuth;

async function loadPaxAndOpenEdit (pid) {
  const { res, data } = await jsonFetch(`/find/pax/${pid}/get/`, {
    headers: { 'X-Requested-With': 'XMLHttpRequest' }
  });
  if (!res.ok || !data.ok) { showToastSafe(data.error || 'è®€å–è³‡æ–™å¤±æ•—', 'error'); return; }
  const p = data.p || {};
  ($id('paxEditId')       || {}).value = p.id ?? '';
  ($id('paxName')         || {}).value = p.passenger_name ?? '';
  ($id('paxGender')       || {}).value = p.gender ?? 'X';
  ($id('paxEmail')        || {}).value = p.email ?? '';
  ($id('paxContact')      || {}).value = p.contact ?? '';
  ($id('paxSeats')        || {}).value = p.seats_needed ?? 1;
  ($id('paxPay')          || {}).value = p.willing_to_pay ?? '';
  ($id('paxDeparture')    || {}).value = p.departure ?? '';
  ($id('paxDestination')  || {}).value = p.destination ?? '';
  ($id('paxDate')         || {}).value = p.date ?? '';
  ($id('paxReturn')       || {}).value = p.return_date ?? '';
  ($id('paxTogether')     || {}).value = p.together_return ?? '';
  ($id('paxNote')         || {}).value = p.note ?? '';
  openPaxEdit();
}

async function submitPaxEdit () {
  const form = $id('paxEditForm');
  const pid  = $id('paxEditId')?.value;
  if (!form || !pid) return;
  const btn = form.querySelector('[type="button"],[type="submit"]');
  if (btn) btn.disabled = true;
  try {
    const body = new URLSearchParams(new FormData(form));
    const { res, data } = await jsonFetch(`/find/pax/${pid}/update/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': getCSRF(),
        'X-Requested-With': 'XMLHttpRequest',
        'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8',
      },
      body
    });
    if (!res.ok || !data.ok) { showToastSafe(data.error || 'æ›´æ–°å¤±æ•—', 'error'); return; }
    showToastSafe('âœ… å·²æ›´æ–°ä¹˜å®¢è³‡æ–™', 'success');
    closePaxEdit();
    window.afterPaxChanged && window.afterPaxChanged({ action: 'update', id: Number(pid) });
  } catch (err) {
    console.error(err);
    showToastSafe('ä¼ºæœå™¨éŒ¯èª¤ï¼Œç¨å¾Œå†è©¦', 'error');
  } finally {
    if (btn) btn.disabled = false;
  }
}
window.submitPaxEdit = submitPaxEdit;

async function doPaxDelete (pid) {
  if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™ä½ä¹˜å®¢å—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚')) return;
  try {
    const { res, data } = await jsonFetch(`/find/pax/${pid}/delete/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': getCSRF(),
        'X-Requested-With': 'XMLHttpRequest',
        'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8',
      },
      body: new URLSearchParams()
    });
    if (!res.ok || !data.ok) { showToastSafe(data.error || 'åˆªé™¤å¤±æ•—', 'error'); return; }
    showToastSafe('ğŸ—‘ï¸ å·²åˆªé™¤ä¹˜å®¢', 'success');
    window.afterPaxChanged && window.afterPaxChanged({ action: 'delete', id: Number(pid) });
  } catch (err) {
    console.error(err);
    showToastSafe('ä¼ºæœå™¨éŒ¯èª¤ï¼Œç¨å¾Œå†è©¦', 'error');
  }
}

/* =========================================================================
 * 8) ä¹˜å®¢ç·¨è¼¯ Modalï¼štogether_return èˆ‡å›ç¨‹æ—¥æœŸè¯å‹•
 * ========================================================================= */
(function paxEditReturnLink(){
  const togetherSel = document.getElementById('paxTogether');
  const returnInput = document.getElementById('paxReturn');
  function syncReturnState () {
    if (!togetherSel || !returnInput) return;
    const v = togetherSel.value;
    if (v === 'true') {
      returnInput.value = '';
      returnInput.disabled = true;
      returnInput.placeholder = 'èˆ‡å¸æ©Ÿå›ç¨‹æ—¥æœŸç›¸åŒ';
      returnInput.classList.add('is-disabled');
    } else {
      returnInput.disabled = false;
      returnInput.placeholder = '';
      returnInput.classList.remove('is-disabled');
    }
  }
  if (togetherSel && returnInput) {
    togetherSel.addEventListener('change', syncReturnState);
  }
  window.syncPaxReturnOnce = syncReturnState; // å¯åœ¨æ‰“é–‹ç·¨è¼¯ Modal å¾Œå‘¼å«ä¸€æ¬¡
})();

/* =========================================================================
 * 9) é é¢ç´šäº‹ä»¶å§”æ´¾ï¼šç®¡ç† / åƒåŠ  / å±•é–‹ï¼ˆé¿å…å‹•æ…‹å…§å®¹å¤±æ•ˆï¼‰
 * ========================================================================= */
document.addEventListener('click', function (e) {
  const btn = e.target.closest('[data-action]');
  if (!btn) return;

  const action   = btn.dataset.action;
  const driverId = btn.dataset.id;
  if (!action || !driverId) return;

  if (action === 'manage') {
    e.preventDefault();
    openDriverModal(driverId);
    return;
  }
  if (action === 'join') {
    e.preventDefault();
    // è‹¥ _driver_list.html ä¸Šæœ‰ data-date / data-return å°±è®€å–ï¼Œå¦å‰‡ fallback
    openJoinModal(driverId, btn.dataset.date || "", btn.dataset.return || "");
    return;
  }
  if (action === 'toggle') {
    e.preventDefault();
    const details = $id('details-' + driverId);
    const arrow   = $id('arrow-' + driverId) || btn;
    if (!details) return;
    const isOpen = details.classList.toggle('open');
    arrow.classList.toggle('open', isOpen);
    arrow.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
    details.setAttribute('aria-hidden', isOpen ? 'false' : 'true');
    return;
  }
});

/* =========================================================================
 * 10) å…¶ä»–ï¼šå¾Œç«¯äº‹ä»¶ï¼ˆå¯é¸ï¼‰ã€‚ä¾‹ï¼šé€é WS ä¸»å‹•å‘ŠçŸ¥ã€Œç®¡ç†æŸå¸æ©Ÿã€
 * ========================================================================= */
window.manageDriver = function (driverId) {
  try { socket.send(JSON.stringify({ action: 'driver_manage', driver_id: driverId })); }
  catch (e) { console.warn('WS send å¤±æ•—', e); }
};


// ç¶å®šä¸€çµ„å‡ºç™¼/å›ç¨‹æ¬„ä½çš„é˜²å‘†
// params: { depart: '#å‡ºç™¼input', ret: '#å›ç¨‹input', form: '#è¡¨å–®', msg?: 'è‡ªè¨‚éŒ¯èª¤è¨Šæ¯' }
function bindDateGuard({ depart, ret, form, msg }){
  const dep = document.querySelector(depart);
  const rtn = document.querySelector(ret);
  const frm = form ? document.querySelector(form) : null;
  if(!dep || !rtn) return;

  // å³æ™‚ï¼šå›ç¨‹æœ€å°æ—¥ â‰§ å‡ºç™¼
  function syncMin(){
    rtn.min = dep.value || '';
    if(rtn.value && dep.value && rtn.value < dep.value){
      rtn.value = ''; // è‡ªå‹•æ¸…ç©ºç„¡æ•ˆå€¼
    }
  }
  dep.addEventListener('change', syncMin);
  // åˆå§‹è·‘ä¸€æ¬¡
  syncMin();

  // é€å‡ºæ™‚ï¼šç¡¬æ€§æª¢æŸ¥ï¼Œä¸ç¬¦å°±æ“‹ä¸‹
  function checkOnSubmit(e){
    if(dep.value && rtn.value && rtn.value < dep.value){
      e && e.preventDefault();
      alert(msg || 'å›ç¨‹æ—¥æœŸä¸å¯æ—©æ–¼å‡ºç™¼æ—¥æœŸ');
      rtn.focus();
      return false;
    }
    return true;
  }

  if(frm){
    frm.addEventListener('submit', checkOnSubmit);
  }
  // è‹¥è¦åœ¨ JS æ‰‹å‹•æª¢æŸ¥ä¹Ÿèƒ½å‘¼å«ï¼š
  return { check: checkOnSubmit, syncMin };

  document.addEventListener('DOMContentLoaded', () => {
  bindDateGuard({
    depart: '#paxDate',
    ret: '#paxReturn',
    form: '#paxEditForm'
  });
});
}
</script>



</body>
</html>
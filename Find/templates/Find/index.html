<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>ğŸŒ èŠ±è“®å…‰å¾©æ•‘ç½äº¤é€šåª’åˆ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<style>
  
  
  body {
    font-family: "Microsoft JhengHei", sans-serif;
    margin: 0;
    padding: 0;
    background: linear-gradient(to right, #eaf8ff, #f7fff7);
    color: #222;
  }

  /* é é¢æ¨™é¡Œ */
  h1 {
    text-align: center;
    padding: 20px;
    color: #005c4b;
  }

  /* å°æ¨™é¡Œ */
  h2 {
    color: #00695c;
    margin: 20px;
    font-size: 20px;
  }

  /* æŒ‰éˆ•ç¾¤çµ„ */
  .buttons {
    text-align: center;
    margin: 20px 0;
  }

  /* ä¸»åŠŸèƒ½æŒ‰éˆ• */
  .btn-main {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 12px 24px;
    font-size: 16px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    margin: 0 6px;
    color: #fff;
    font-weight: bold;
    transition: transform 0.2s, background 0.3s;
  }

  .btn-driver {
    background: #007bff;
  }
  .btn-driver:hover {
    background: #0056b3;
    transform: scale(1.05);
  }

  .btn-passenger {
    background: #dc3545;
  }
  .btn-passenger:hover {
    background: #a71d2a;
    transform: scale(1.05);
  }

  /* å¡ç‰‡ */
  .card {
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: #fff;
    margin: 10px 20px;
    padding: 15px;
    border-radius: 8px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    animation: fadeInUp 0.4s ease-in-out;
    position: relative;
    flex-wrap: wrap; /* âœ…é¿å…å°è¢å¹•çˆ†ç‰ˆ */
  }

  .card::before {
    content: "";
    display: block;
    width: 6px;
    height: 100%;
    border-radius: 6px 0 0 6px;
    margin-right: 10px;
    position: absolute;
    left: 0;
    top: 0;
  }

  .driver-card::before {
    background: #2196f3;
  }

  .passenger-card::before {
    background: #f44336;
  }

.pax-list { margin: 6px 0 10px; padding-left: 0; list-style: none; }
.pax-item {
  display: grid;
  grid-template-columns: auto 1fr auto;
  gap: 6px 12px;
  align-items: center;
  padding: 8px 10px;
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  margin-bottom: 6px;
  background: #fff;
}
.pax-item .check { color: #16a34a; font-weight: 700; }
.pax-pending { background: #fff; }
.pax-accepted { background: #ecfdf5; border-color: #a7f3d0; } /* ç¶ åº• */
.pax-name { font-weight: 700; }
.pax-meta { color: #4b5563; font-size: 13px; }
.pax-actions { display: flex; gap: 6px; }
.btn-mini {
  border: 0; border-radius: 6px; padding: 6px 10px; cursor: pointer;
  background: #e5e7eb; color: #111827; font-size: 12px; font-weight: 700;
}
.btn-mini:hover { background: #d1d5db; }
.btn-mini.danger { background: #f87171; color: #fff; }
.btn-mini.danger:hover { background: #ef4444; }
.pax-empty { color: #6b7280; padding: 4px 2px; }


/* ç‰ˆé¢ï¼šå·¦(æš±ç¨±åº§ä½) / ä¸­(ä¸‰è¡Œ) / å³(æŒ‰éˆ•èˆ‡ç®­é ­) */
.driver-grid {
  display: grid;
  grid-template-columns: 220px 1fr 200px;
  gap: 12px;
  align-items: center;
  width: 100%;
}

/* å·¦æ¬„ï¼šç½®ä¸­é¡¯ç¤ºæš±ç¨±-åº§ä½ */
.col-left {
  display: flex;
  align-items: center;
  justify-content: flex-start;
  height: 100%;
}
.name-seat {
  font-size: 16px;
  color: #222;
}

/* ä¸­æ¬„ï¼šä¸‰è¡Œ */
.col-middle .line { display: block; margin: 3px 0; }
.col-middle .line1 { font-size: 16px; color: #222; }
.col-middle .line2,
.col-middle .line3 { font-size: 14px; color: #444; }

/* å³æ¬„ï¼šæŒ‰éˆ•èˆ‡ç®­é ­é å³å°é½Š */
.col-actions {
  display: flex;
  align-items: center;
  justify-content: flex-end;
  gap: 8px;
}

/* è©³ç´°å±•é–‹é‹ªæ»¿æ•´åˆ— */
.details { grid-column: 1 / -1; }

/* ä½ åŸæœ¬çš„æ¨£å¼ï¼ˆä¿ç•™ï¼‰ï¼šç®­é ­æ—‹è½‰ + çµ²æ»‘å±•é–‹ + æŒ‰éˆ•è‰²ç³» */
.arrow { cursor: pointer; margin-left: 12px; font-size: 16px; color: #333;
  background: transparent; border: 0; transition: transform .25s ease; }
.arrow.open { transform: rotate(90deg); }

.details { max-height: 0; overflow: hidden; padding: 0 10px;
  background: #f9f9f9; border-top: 1px solid #e6e6e6; border-radius: 0 0 8px 8px;
  transition: max-height .35s ease, padding .25s ease; }
.details.open { max-height: 650px; padding: 10px; }

.btn-manage { background: #007bff; color: #fff; border: 0; border-radius: 6px; padding: 6px 12px; }
.btn-manage:hover { background: #0056b3; }
.btn-join { background: #28a745; color: #fff; border: 0; border-radius: 6px; padding: 6px 12px; }
.btn-join:hover { background: #1e7e34; }

/* éŸ¿æ‡‰å¼ï¼šçª„è¢å¹•æ”¹æˆä¸Šä¸‹å †ç–Š */
@media (max-width: 720px) {
  .driver-grid { grid-template-columns: 1fr; }
  .col-actions { justify-content: flex-start; }
}

  /* Modal */
  .modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.6);
  }

  .modal-content {
    background: #fff;
    margin: 10% auto;
    padding: 20px;
    border-radius: 10px;
    width: 90%;
    max-width: 450px;
  }

  .close {
    float: right;
    font-size: 20px;
    cursor: pointer;
  }

  /* å‹•ç•« */
  @keyframes fadeInUp {
    from {opacity: 0; transform: translateY(15px);}
    to {opacity: 1; transform: translateY(0);}
  }

  /* å›åˆ°é ‚ç«¯æŒ‰éˆ• */
  #backToTop {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: #00897b;
    color: #fff;
    border: none;
    border-radius: 50%;
    padding: 14px;
    font-size: 20px;
    cursor: pointer;
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    z-index: 1200;
    transition: transform 0.2s, background 0.3s;
  }

  #backToTop:hover {
    background: #00695c;
    transform: scale(1.08);
  }

/* ===== Join Modalï¼šçµæ§‹èˆ‡æ»¾å‹• ===== */
.modal{
  position: fixed; inset: 0; z-index: 1000;
  background: rgba(0,0,0,.55);
  display: none;
}
.modal .modal-content{
  display: flex; flex-direction: column;
  width: min(520px, 94vw);
  max-height: min(92svh, 640px);
  margin: 6svh auto;
  background: #fff; border-radius: 12px;
  box-shadow: 0 10px 30px rgba(0,0,0,.25);
}
.modal-header, .modal-footer{
  flex: 0 0 auto;
  padding: 14px 16px;
  border-bottom: 1px solid #eee;
}
.modal-footer{ border-top: 1px solid #eee; border-bottom: 0; display: flex; justify-content: flex-end; gap: 8px; }
.modal-body{
  flex: 1 1 auto;
  overflow-y: auto;
  padding: 14px 16px;
}
.close{ background: transparent; border: 0; font-size: 20px; cursor: pointer; }

/* èƒŒæ™¯é åœ¨ modal é–‹å•Ÿæ™‚ä¸è¦æ²å‹•ï¼ˆå¯é¸ï¼‰ */
.body-modal-open{ overflow: hidden; }

/* ===== Join Modal ç¾åŒ–ï¼ˆå–®æ¬„ï¼‰ ===== */

/* ===== Join Modalï¼šç·Šæ¹Šç¾åŒ–ï¼ˆåªå¥—ç”¨åœ¨ #joinModalï¼‰ ===== */
#joinModal .modal-content{
  width: min(520px, 94vw);
  max-height: min(88svh, 620px);        /* å†çŸ®ä¸€é»ï¼Œé¿å…é ‚ä½ */
  margin: 4svh auto;                     /* ä¸Šä¸‹ç•™ç™½ç¸®å° */
  border-radius: 14px;
  overflow: hidden;                       /* åœ“è§’æ›´ä¹¾æ·¨ */
  box-shadow: 0 14px 34px rgba(0,0,0,.25);
  background: #fff;
  display: flex; flex-direction: column;
}

/* Header æ›´è–„ã€ç½®ä¸­ã€é»åœ¨é ‚ç«¯ï¼ˆæ»¾å‹•æ™‚å›ºå®šï¼‰ */
#joinModal .modal-header{
  position: sticky; top: 0; z-index: 2;
  display: flex; align-items: center; justify-content: center;
  min-height: 44px;
  padding: 8px 16px;                      /* âœ… é€™è£¡ç¸®å°é«˜åº¦ */
  background: #fff;
  border-bottom: 1px solid #eee;
}
#joinModal .modal-header .title{
  font-size: 16px; font-weight: 700; color: #111827;
  display: inline-flex; align-items: center; gap: 8px;
}
#joinModal .modal-header .title .emoji{ font-size: 18px; line-height: 1; }

/* é—œé–‰éˆ•æ”¾å³ä¸Šè§’ã€è¼ƒå°ã€ä¸çªå…€ */
#joinModal .modal-header .close{
  position: absolute; right: 10px; top: 8px;
  width: 28px; height: 28px; border-radius: 6px;
  display: inline-grid; place-items: center;
  font-size: 18px; color: #6b7280; border: 0; background: transparent;
  cursor: pointer;
}
#joinModal .modal-header .close:hover{ background: #f3f4f6; color: #111827; }

/* Body è®Šæˆå¯æ²å‹•å€åŸŸ */
#joinModal .modal-body{
  flex: 1 1 auto; overflow-y: auto;
  padding: 12px 16px;                     /* æ¯”åŸæœ¬å†è–„ä¸€é» */
}

/* Footer é»åœ¨åº•éƒ¨ï¼ŒæŒ‰éˆ•æ›´åœ“ã€å°é½Š */
#joinModal .modal-footer{
  position: sticky; bottom: 0; z-index: 2;
  display: flex; justify-content: flex-end; gap: 8px;
  padding: 10px 16px;
  background: #fff; border-top: 1px solid #eee;
}
#joinModal .btn-cancel, 
#joinModal .btn-submit{
  border-radius: 10px; padding: 10px 18px; font-weight: 700;
}

/* è¡¨å–®æ¬„ä½ï¼šè¡Œè·å¾®èª¿ã€æ¨™ç±¤æ›´ç·Šæ¹Š */
/* è®“æ¯å€‹æ¬„ä½èµ°ã€ä¸Šæ–¹æ¨™ç±¤ã€ä¸‹æ–¹è¼¸å…¥æ¡†ã€çš„ç›´å‘æ’ç‰ˆ */
#joinModal .join-field {
  display: flex;
  flex-direction: column;   /* ç›´å‘æ’åˆ—ï¼šç¬¬ä¸€è¡Œ labelã€ç¬¬äºŒè¡Œè¼¸å…¥æ¡† */
  gap: 6px;                 /* æ¨™ç±¤èˆ‡è¼¸å…¥æ¡†çš„å‚ç›´é–“è· */
  margin: 12px 0;
}

/* æ¨™ç±¤ä½”æ»¿ä¸€è¡Œ */
#joinModal .join-field label {
  display: block;
  font-weight: 600;
  color: #1f2937;
  line-height: 1.2;
}

/* è¼¸å…¥æ¡†ä½”æ»¿ä¸‹ä¸€è¡Œ */
#joinModal .join-field input,
#joinModal .join-field select,
#joinModal .join-field textarea {
  width: 50%;
  padding: 10px 12px;
  border: 1px solid #d1d5db;
  border-radius: 8px;
  background: #fff;
  font-size: 14px;
  line-height: 1.25;
  transition: border-color .2s, box-shadow .2s;
}

#joinModal .join-field input:focus,
#joinModal .join-field select:focus,
#joinModal .join-field textarea:focus {
  outline: none;
  border-color: #3b82f6;
  box-shadow: 0 0 0 3px rgba(59,130,246,.15);
}

/* å¯é¸ï¼šå‚™è¨»æ‹‰é«˜ä¸€é»æ¯”è¼ƒå¥½æ‰“ */
#joinModal textarea[name="note"] {
  min-height: 96px;
}

/* è¡Œå‹•è£ç½®ç¶­æŒåŒæ¨£çš„ã€Œä¸€è¡Œæ¨™ç±¤ + ä¸€è¡Œè¼¸å…¥æ¡†ã€ */
@media (max-width: 640px) {
  #joinModal .join-field { margin: 10px 0; gap: 6px; }
}

/* å°è¢å¹•ï¼šå†å£“ç¸® header/é‚Šè· */
@media (max-width: 640px){
  #joinModal .modal-content{ max-height: min(92svh, 640px); margin: 3svh auto; }
  #joinModal .modal-header{ min-height: 40px; padding: 6px 14px; }
  #joinModal .modal-header .title{ font-size: 15px; }
  #joinModal .modal-body{ padding: 10px 14px; }
  #joinModal .modal-footer{ padding: 8px 14px; }
}


/* æ‰‹æ©Ÿ RWD */
@media (max-width: 640px){
  .modal .modal-content{ width:94vw; margin: 4svh auto; }
  .join-field{ margin:10px 0; }
  .btn-submit, .btn-cancel{ min-height:44px; font-size:16px; }
}

/* å…¶å®ƒæ—¢æœ‰æ¨£å¼ä¸€ä½µä¿ç•™ */
.arrow{ transition: transform .25s ease; }
.arrow.open{ transform: rotate(90deg); }

/* ä½ åŸæœ¬çš„ RWD å°èª¿æ•´ï¼ˆä¿ç•™ï¼‰ */
@media (max-width: 1024px){ .card{ padding:14px 12px; margin:10px 12px; } .btn-main{ padding:10px 16px; font-size:15px; } }
@media (max-width: 768px){
  body{ font-size:15px; }
  h1{ font-size:22px; }
  h2{ font-size:18px; margin:14px; }
  .buttons{ padding:0 12px; }
  .btn-main{ width:auto; min-width:44%; }
  #toast-container{ top: env(safe-area-inset-top,16px); right:12px; left:12px; }
}
@media (max-width: 640px){
  .buttons{ display:grid; grid-template-columns:1fr; gap:10px; padding:0 12px; }
  .btn-main{ width:100%; }
  .driver-grid{ display:grid; grid-template-columns:1fr; grid-row-gap:8px; }
  .col-left, .col-middle, .col-actions{ width:100%; }
  .col-left .name-seat{ font-size:16px; margin-bottom:6px; text-align:left; }
  .col-middle .line{ display:block; margin:4px 0; font-size:14px; }
  .col-actions{ display:grid; grid-template-columns:1fr 1fr auto; align-items:center; gap:8px; }
  .btn-manage, .btn-join{ width:100%; min-height:44px; font-size:15px; }
  .arrow{ font-size:18px; min-width:44px; min-height:44px; display:inline-grid; place-items:center; }
  .details{ padding:8px 10px; }
  .details.open{ padding:10px 12px; }
  .details h4{ font-size:15px; margin:8px 0 4px; }
  .details p, .details li{ font-size:14px; }
  #backToTop{ right:12px; bottom:16px; }
}
@media (max-width: 400px){
  body{ font-size:14px; }
  h1{ font-size:20px; }
  h2{ font-size:16px; margin:10px; }
  .col-left .name-seat{ font-size:15px; }
  .col-middle .line1{ font-size:15px; }
  .col-middle .line2, .col-middle .line3{ font-size:13px; }
  .btn-manage, .btn-join{ font-size:14px; padding:8px 10px; }
  .arrow{ font-size:16px; min-width:40px; min-height:40px; }
}
</style>

</head>
<body>
  <h1>ğŸŒ èŠ±è“®å…‰å¾©æ•‘ç½äº¤é€šåª’åˆ</h1>

  <div class="buttons">
    <a href="{% url 'find_car' %}">
      <button class="btn-main btn-driver">ğŸš— æˆ‘è¦å‡ºè»Šï¼ˆæ‰¾ä¹˜å®¢ï¼‰</button>
    </a>
    <a href="{% url 'find_people' %}">
      <button class="btn-main btn-passenger">ğŸ§ æˆ‘è¦æ­è»Šï¼ˆæ‰¾è»Šï¼‰</button>
    </a>
  </div>

  <h2>æ‰¾äººè³‡è¨Šï¼ˆå¸æ©Ÿæä¾›åº§ä½ï¼‰</h2>
  <ul id="passenger-list">
    {% for p in passengers %}
      {% if not p.is_matched %}
        <li class="card passenger-card">
          <span><b>{{ p.passenger_name }}</b> - éœ€è¦ {{ p.seats_needed }} äºº
            ({{ p.departure }} â†’ {{ p.destination }}, {{ p.date }})</span>
          <div class="actions">
            <button onclick="openPassengerModal('{{ p.id }}')">ç·¨è¼¯</button>
            <button onclick="openJoinModal('{{ p.id }}')">åƒåŠ </button>
          </div>
        </li>
      {% endif %}
    {% empty %}
      <li class="card passenger-card">ç›®å‰æ²’æœ‰éœ€æ±‚</li>
    {% endfor %}
  </ul>

<h2>æ‰¾è»Šéœ€æ±‚ï¼ˆä¹˜å®¢éœ€è¦å¸æ©Ÿï¼‰</h2>
<ul id="driver-list">
  {% include "Find/_driver_list.html" %}
</ul>


  <!-- å›åˆ°é ‚ç«¯ -->
  <button id="backToTop" onclick="window.scrollTo({top:0, behavior:'smooth'});">â¬†</button>

 <script>
/* ---------- å°å·¥å…· ---------- */
function $id(id){ return document.getElementById(id); }
function getCookie(name) {
  const value = `; ${document.cookie}`;
  const parts = value.split(`; ${name}=`);
  if (parts.length === 2) return parts.pop().split(";").shift();
  return null;
}
function getFormCSRF() {
  const el = document.querySelector('#driverAuthForm input[name="csrfmiddlewaretoken"]');
  return el ? el.value : "";
}
function getCSRF() {
  return getCookie("csrftoken") || getFormCSRF() || "";
}
function showToastSafe(msg, type) {
  if (typeof showToast === "function") showToast(msg, type);
  else alert(msg);
}

/* ---------- ç®¡ç†æˆæ¬Š Modal ---------- */
function openDriverModal(id){
  const modal = $id("driverAuthModal");
  const idEl  = $id("driverAuthId");
  const pwdEl = $id("driverAuthPassword");
  if(!modal || !idEl || !pwdEl){
    alert("ç®¡ç†è¦–çª—å…ƒä»¶ç¼ºå¤±");
    return;
  }
  idEl.value = id;
  pwdEl.value = "";
  modal.style.display = "block";
  setTimeout(()=>pwdEl.focus(), 0);
}
window.closeDriverAuth = function(){
  const modal = $id("driverAuthModal");
  if(modal) modal.style.display = "none";
};

/* ---------- WebSocket å³æ™‚æ›´æ–° ---------- */
const socket = new WebSocket(
  (location.protocol === "https:" ? "wss://" : "ws://") + window.location.host + "/ws/find/"
);
socket.onopen  = () => console.log("âœ… WebSocket é€£ç·šæˆåŠŸ");
socket.onclose = () => console.log("âŒ WebSocket å·²é—œé–‰");
socket.onerror = (err) => console.error("âš ï¸ WebSocket ç™¼ç”ŸéŒ¯èª¤", err);

socket.onmessage = function (event) {
  try {
    const data = JSON.parse(event.data);

    if (data.type === "update") {
      if (data.passengers_html) {
        const plist = $id("passenger-list");
        if (plist) plist.innerHTML = data.passengers_html;
      }
      if (data.drivers_html) {
        const dlist = $id("driver-list");
        if (dlist) dlist.innerHTML = data.drivers_html;
      }
    }

    if (data.type === "join_result") {
      if (data.success) showToastSafe("âœ… æˆåŠŸåŠ å…¥ä¹˜å®¢è¡Œç¨‹ï¼", "success");
      else showToastSafe("âš ï¸ åŠ å…¥å¤±æ•—ï¼š" + (data.message || "æ²’æœ‰å¯ç”¨çš„å¸æ©Ÿ"), "error");
    }
  } catch (err) {
    console.error("âš ï¸ è§£æè¨Šæ¯å¤±æ•—", err, event.data);
  }
};

/* ---------- äº‹ä»¶å§”æ´¾ï¼šç®¡ç† / åƒåŠ  / å±•é–‹ ---------- */
document.addEventListener("click", function (e) {
  const btn = e.target.closest("[data-action]");
  if (!btn) return;

  const action   = btn.dataset.action;
  const driverId = btn.dataset.id;
  if (!action || !driverId) return;

  if (action === "manage") {
    e.preventDefault();
    openDriverModal(driverId);
    return;
  }

  if (action === "join") {
    e.preventDefault();
    const joinModal = $id("joinModal");
    const joinForm  = $id("joinForm");
    if (joinModal && joinForm) {
      joinForm.action = `/find/driver/${driverId}/join/`;
      joinModal.style.display = "block";
    }
    return;
  }

  if (action === "toggle") {
    e.preventDefault();
    const details = $id("details-" + driverId);
    const arrow   = $id("arrow-" + driverId) || btn;
    if (!details) return;

    const isOpen = details.classList.toggle("open");
    arrow.classList.toggle("open", isOpen);
    arrow.setAttribute("aria-expanded", isOpen ? "true" : "false");
    details.setAttribute("aria-hidden", isOpen ? "false" : "true");
    return;
  }
});

/* ---------- ä¾› WebSocket ç®¡ç†æ›´æ–°ï¼ˆè‹¥æœ‰éœ€è¦ï¼‰ ---------- */
window.manageDriver = function (driverId) {
  socket.send(JSON.stringify({ action: "driver_manage", driver_id: driverId }));
};


// æ‰“é–‹åƒåŠ  Modalï¼ˆä½ åœ¨ _driver_list.html çš„ã€ŒåƒåŠ ã€æŒ‰éˆ•è¦å‘¼å« openJoinModal(id)ï¼‰
  function openJoinModal(driverId){
    const m = document.getElementById('joinModal');
    const f = document.getElementById('joinForm');
    // å¾Œç«¯ç”¨é€™å€‹è·¯ç”±è™•ç†åŠ å…¥ï¼š/find/driver/<id>/join/
    f.action = `/find/driver/${driverId}/join/`;
    m.style.display = 'block';
    document.body.classList.add('body-modal-open');
    // è‡ªå‹•èšç„¦ç¬¬ä¸€å€‹æ¬„ä½
    setTimeout(() => {
      const first = f.querySelector('input,select,textarea');
      if (first) first.focus();
    }, 0);
  }

  // ä¸Šè»Šåœ°é»ï¼šä¸‹æ‹‰/è‡ªå¡« â†’ åŒæ­¥åˆ°éš±è—æ¬„ä½ name="departure"
function updateJoinPickup() {
  const sel    = document.getElementById("join-pickup-select");
  const custom = document.getElementById("join-pickup-custom");
  const hidden = document.getElementById("join-pickup");
  if (!sel || !custom || !hidden) return;

  if (sel.value === "è‡ªå¡«") {
    custom.style.display = "block";
    custom.required = true;
    hidden.value = custom.value.trim();
  } else {
    custom.style.display = "none";
    custom.required = false;
    hidden.value = sel.value;     // ç›´æ¥å¯«å…¥é¸åˆ°çš„ç¸£å¸‚
  }
}

// äº‹ä»¶ç¶å®šï¼ˆé é¢è¼‰å…¥ä¸€æ¬¡å°±å¥½ï¼‰
document.getElementById("join-pickup-select")?.addEventListener("change", updateJoinPickup);
document.getElementById("join-pickup-custom")?.addEventListener("input", updateJoinPickup);

// æ‰“é–‹åƒåŠ è¦–çª—æ™‚åˆå§‹åŒ–ä¸€æ¬¡ï¼ˆç¢ºä¿ hidden æœ‰å€¼ï¼‰
const _origOpenJoinModal = window.openJoinModal;
window.openJoinModal = function(driverId) {
  // å¦‚æœä½ å·²æœ‰ openJoinModalï¼Œä¿ç•™åŸè¡Œç‚º
  if (typeof _origOpenJoinModal === "function") {
    _origOpenJoinModal(driverId);
  } else {
    // æ²’æœ‰çš„è©±ï¼Œè‡³å°‘æŠŠ modal æ‰“é–‹ & è¨­å®š action
    document.getElementById("joinModal").style.display = "block";
    document.getElementById("joinForm").action = `/find/driver/${driverId}/join/`;
  }
  // åˆå§‹åŒ–ä¸Šè»Šåœ°é»ç‹€æ…‹
  setTimeout(updateJoinPickup, 0);
};

  function closeJoinModal(){
    document.getElementById('joinModal').style.display = 'none';
    document.body.classList.remove('body-modal-open');
  }
  // æ‰“é–‹å–æ¶ˆ Modalï¼ˆä½ åœ¨ä¹˜å®¢æ¸…å–®é‚£é‚Šæ”¾ä¸€é¡†ã€Œå–æ¶ˆã€æŒ‰éˆ•å‘¼å« openCancelModal(pid)ï¼‰
  function openCancelModal(passengerId) {
    const m = document.getElementById("cancelModal");
    const f = document.getElementById("cancelForm");
    document.getElementById("cancelPassengerId").value = passengerId;
    // å¾Œç«¯è·¯ç”±ï¼š/find/passenger/<pid>/cancel/
    f.action = `/find/passenger/${passengerId}/cancel/`;
    m.style.display = "block";
  }

  //ï¼ˆå¯é¸ï¼‰æ””æˆª join/cancel ä»¥ AJAX é€å‡ºï¼ŒæˆåŠŸå¾Œé—œé–‰ modal + showToast
  // å¦‚æœä½ è¦ä¿ç•™ä¸€èˆ¬ POST é‡æ–°å°å‘ä¹Ÿ OKï¼Œé€™æ®µå°±ä¸å¿…åŠ ã€‚
  (function enhanceJoinCancel() {
    const joinForm   = document.getElementById("joinForm");
    const cancelForm = document.getElementById("cancelForm");

    async function ajaxSubmit(form, okMsg) {
      const url  = form.action;
      const body = new URLSearchParams(new FormData(form));
      const res  = await fetch(url, {
        method: "POST",
        headers: { "X-Requested-With": "XMLHttpRequest" },
        body
      });
      let data = {};
      try { data = await res.json(); } catch {}
      if (res.ok && data.ok) {
        if (typeof showToast === "function") showToast(okMsg || "æˆåŠŸ", "success");
        // é—œ Modal
        form.closest(".modal").style.display = "none";
      } else {
        const msg = (data && (data.error || data.detail)) || `å¤±æ•—ï¼ˆ${res.status}ï¼‰`;
        if (typeof showToast === "function") showToast(msg, "error");
      }
    }

    if (joinForm) {
      joinForm.addEventListener("submit", async function(e) {
        // ç›´æ¥ç”¨ AJAXï¼›è‹¥æƒ³æ­£å¸¸ POST å°±æŠŠ preventDefault æ‹”æ‰
        e.preventDefault();
        await ajaxSubmit(joinForm, "âœ… å·²é€å‡ºç”³è«‹");
      });
    }
    if (cancelForm) {
      cancelForm.addEventListener("submit", async function(e) {
        e.preventDefault();
        await ajaxSubmit(cancelForm, "ğŸ—‘ï¸ å·²å–æ¶ˆ");
      });
    }
  })();


</script>
<script>
/* ====== å·¥å…· ====== */
function getCookie(name) {
  const value = `; ${document.cookie}`;
  const parts = value.split(`; ${name}=`);
  if (parts.length === 2) return parts.pop().split(";").shift();
  return null;
}
function showToastSafe(msg, type) {
  if (typeof showToast === "function") showToast(msg, type);
  else alert(msg);
}

/* ====== ç¶å®šæˆæ¬Šè¡¨å–®ï¼ˆå¯é‡å…¥ï¼‰ ====== */
function bindDriverAuthForm() {
  const form   = document.getElementById("driverAuthForm");
  if (!form || form.dataset.bound === "1") return;

  const idEl  = document.getElementById("driverAuthId");
  const pwdEl = document.getElementById("driverAuthPassword");

  function getFormCSRF() {
    const el = form.querySelector('input[name="csrfmiddlewaretoken"]');
    return el ? el.value : null;
  }
  function getCSRF() {
    return getFormCSRF() || getCookie("csrftoken") || "";
  }

  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    const driverId = idEl && idEl.value;
    const password = pwdEl && pwdEl.value;

    if (!driverId) { console.error("ç¼º driverId"); return; }
    if (!password) { showToastSafe("è«‹è¼¸å…¥å¯†ç¢¼", "error"); pwdEl && pwdEl.focus(); return; }

    const url = `/find/driver/${driverId}/manage/auth/`;

    try {
      const res = await fetch(url, {
        method: "POST",
        credentials: "same-origin",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8",
          "X-CSRFToken": getCSRF(),
          "X-Requested-With": "XMLHttpRequest"
        },
        body: new URLSearchParams({ password })
      });

      let data = {};
      try { data = await res.json(); } catch (_) {}

      console.log("[auth] status:", res.status, data);

      if (res.ok && data && data.ok && data.url) {
        showToastSafe("âœ… é©—è­‰æˆåŠŸï¼Œå‰å¾€ç®¡ç†é â€¦", "success");
        // é—œæ‰ modal å†è·³è½‰
        const modal = document.getElementById("driverAuthModal");
        if (modal) modal.style.display = "none";
        window.location.href = data.url;
      } else {
        const msg = (data && (data.error || data.detail)) || `é©—è­‰å¤±æ•— (HTTP ${res.status})`;
        showToastSafe(msg, "error");
        pwdEl && pwdEl.focus();
      }
    } catch (err) {
      console.error(err);
      showToastSafe("ä¼ºæœå™¨éŒ¯èª¤ï¼Œç¨å¾Œå†è©¦", "error");
    }
  });

  form.dataset.bound = "1";
}

/* ====== é–‹é—œ Modal ====== */
window.openDriverModal = function (driverId) {
  const idEl  = document.getElementById("driverAuthId");
  const pwdEl = document.getElementById("driverAuthPassword");
  const modal = document.getElementById("driverAuthModal");
  if (!idEl || !pwdEl || !modal) { alert("ç®¡ç†è¦–çª—å…ƒä»¶ç¼ºå¤±"); return; }

  idEl.value = driverId;
  pwdEl.value = "";
  modal.style.display = "block";
  // ç¢ºä¿æ­¤æ™‚ä¹Ÿå·²ç¶åˆ° submitï¼ˆé¿å…å…ˆå‰æ²’ç¶ä¸Šï¼‰
  bindDriverAuthForm();
  setTimeout(() => pwdEl.focus(), 0);
};
window.closeDriverAuth = function () {
  const modal = document.getElementById("driverAuthModal");
  if (modal) modal.style.display = "none";
};

/* é¦–æ¬¡è¼‰å…¥æ™‚ç¶ä¸€æ¬¡ï¼ˆå¦‚æœ script åœ¨ body å°¾ç«¯ï¼Œé€™ä¸€æ­¥å°±èƒ½ç¶ä¸Šï¼‰ */
document.addEventListener("DOMContentLoaded", bindDriverAuthForm);


document.addEventListener("click", async (e) => {
  // ç·¨è¼¯
  const editBtn = e.target.closest("[data-pax-edit]");
  if (editBtn) {
    const paxId = editBtn.dataset.id;
    const password = prompt("è«‹è¼¸å…¥ä¹˜å®¢ç®¡ç†å¯†ç¢¼ï¼ˆç”¨æ–¼ç·¨è¼¯ï¼‰");
    if (!password) return;

    // é€™è£¡ç¤ºç¯„æœ€å°å¯è¡Œï¼šåªæ”¹ã€Œæš±ç¨± / äººæ•¸ / å‚™è¨»ã€ä¸‰é …
    const passenger_name = prompt("æ–°çš„æš±ç¨±ï¼ˆç•™ç©ºä¸è®Šï¼‰") || "";
    const seats_needed   = prompt("ä¸Šè»Šäººæ•¸ï¼ˆç•™ç©ºä¸è®Šï¼‰") || "";
    const note           = prompt("å‚™è¨»ï¼ˆç•™ç©ºä¸è®Šï¼‰") || "";

    const body = new URLSearchParams({ password, passenger_name, seats_needed, note });
    const res = await fetch(`/find/passenger/${paxId}/update/`, {
      method: "POST",
      headers: { "X-CSRFToken": getCSRF(), "X-Requested-With": "XMLHttpRequest" },
      body
    });
    const data = await res.json().catch(()=>({}));
    if (res.ok && data.ok) {
      showToast("å·²æ›´æ–°ä¹˜å®¢è³‡æ–™", "success");
    } else {
      showToast(data.error || "ç·¨è¼¯å¤±æ•—", "error");
    }
    return;
  }

  // åˆªé™¤
  const delBtn = e.target.closest("[data-pax-del]");
  if (delBtn) {
    const paxId = delBtn.dataset.id;
    const password = prompt("è«‹è¼¸å…¥ä¹˜å®¢ç®¡ç†å¯†ç¢¼ä»¥åˆªé™¤ï¼å–æ¶ˆ");
    if (!password) return;

    const body = new URLSearchParams({ password });
    const res = await fetch(`/find/passenger/${paxId}/delete/`, {
      method: "POST",
      headers: { "X-CSRFToken": getCSRF(), "X-Requested-With": "XMLHttpRequest" },
      body
    });
    const data = await res.json().catch(()=>({}));
    if (res.ok && data.ok) {
      showToast("å·²åˆªé™¤/å–æ¶ˆ", "success");
    } else {
      showToast(data.error || "åˆªé™¤å¤±æ•—", "error");
    }
    return;
  }
});

</script>



<!-- å¸æ©Ÿç®¡ç†æˆæ¬Š Modal -->
<div id="driverAuthModal" class="modal" style="display:none;">
  <div class="modal-content">
    <span class="close" onclick="closeDriverAuth()">&times;</span>
    <h3>ğŸ” ç®¡ç†æˆæ¬Š</h3>
    <form id="driverAuthForm" method="POST">
  {% csrf_token %}
  <input type="hidden" id="driverAuthId" value="">
  <input id="driverAuthPassword" type="password" name="password" required>
  <button type="submit">ç¢ºèª</button>
</form>
  </div>
</div>

<!-- Toast å®¹å™¨ -->
<div id="toast-container" style="
  position: fixed;
  top: 20px;
  right: 20px;
  z-index: 2000;
"></div>

<!-- åƒåŠ è¡Œç¨‹ Modal -->
<div id="joinModal" class="modal" style="display:none;">
  <div class="modal-content">
    <div class="modal-header">
      <h3>ğŸ§ åƒåŠ è¡Œç¨‹</h3>
      <button type="button" class="close" onclick="closeJoinModal()">Ã—</button>
    </div>

    <div class="modal-body">
      <form id="joinForm" method="POST">
        {% csrf_token %}

        <div class="join-field">
          <label>æš±ç¨±</label>
          <input type="text" name="passenger_name" required>
        </div>

        <div class="join-field">
          <label>æ€§åˆ¥</label>
          <select name="gender" required>
            <option value="X" selected>ä¸æ–¹ä¾¿é€æ¼</option>
            <option value="M">ç”·ç”Ÿ</option>
            <option value="F">å¥³ç”Ÿ</option>
          </select>
        </div>

        <div class="join-field">
          <label>Email <span class="muted">(ä¸å…¬é–‹ï¼Œç”¨æ–¼åª’åˆé€šçŸ¥)</span></label>
          <input type="email" name="email" placeholder="å¯ç•™ç©º">
        </div>

        <div class="join-field">
          <label>è¯çµ¡æ–¹å¼</label>
          <input type="text" name="contact" placeholder="LINE / IG / Phone" required>
        </div>

        <div class="join-field">
          <label>ä¸Šè»Šäººæ•¸</label>
          <input type="number" name="seats_needed" min="1" value="1" required>
        </div>

        <div class="join-field">
          <label>é¡˜ä»˜é‡‘é¡ <span class="muted">ï¼ˆå¯ç•™ç©ºï¼Œå–®ä½ NTSï¼‰</span></label>
          <input type="number" name="willing_to_pay" min="0" step="1" placeholder="å¯ç•™ç©º">
        </div>

        <!-- ä¸Šè»Šåœ°é»ï¼ˆç¸£å¸‚ä¸‹æ‹‰ + è‡ªå¡«ï¼‰ -->
        <div class="join-field">
          <label for="join-pickup-select">ä¸Šè»Šåœ°é»</label>

          <!-- ä½¿ç”¨ä¸‹æ‹‰åšé¸æ“‡ï¼ˆæ²’æœ‰ nameï¼Œé¿å…ç›´æ¥æäº¤ï¼‰ -->
          <select id="join-pickup-select">
            <option value="">è«‹é¸æ“‡ç¸£å¸‚</option>
            <option value="å…¶ä»–">å…¶ä»–</option>
            <option value="å°åŒ—å¸‚">å°åŒ—å¸‚</option>
            <option value="æ–°åŒ—å¸‚">æ–°åŒ—å¸‚</option>
            <option value="åŸºéš†å¸‚">åŸºéš†å¸‚</option>
            <option value="æ¡ƒåœ’å¸‚">æ¡ƒåœ’å¸‚</option>
            <option value="æ–°ç«¹å¸‚">æ–°ç«¹å¸‚</option>
            <option value="æ–°ç«¹ç¸£">æ–°ç«¹ç¸£</option>
            <option value="è‹—æ —ç¸£">è‹—æ —ç¸£</option>
            <option value="å°ä¸­å¸‚">å°ä¸­å¸‚</option>
            <option value="å½°åŒ–ç¸£">å½°åŒ–ç¸£</option>
            <option value="å—æŠ•ç¸£">å—æŠ•ç¸£</option>
            <option value="é›²æ—ç¸£">é›²æ—ç¸£</option>
            <option value="å˜‰ç¾©å¸‚">å˜‰ç¾©å¸‚</option>
            <option value="å˜‰ç¾©ç¸£">å˜‰ç¾©ç¸£</option>
            <option value="å°å—å¸‚">å°å—å¸‚</option>
            <option value="é«˜é›„å¸‚">é«˜é›„å¸‚</option>
            <option value="å±æ±ç¸£">å±æ±ç¸£</option>
            <option value="å®œè˜­ç¸£">å®œè˜­ç¸£</option>
            <option value="èŠ±è“®ç¸£">èŠ±è“®ç¸£</option>
            <option value="å°æ±ç¸£">å°æ±ç¸£</option>
            <option value="æ¾æ¹–ç¸£">æ¾æ¹–ç¸£</option>
            <option value="é‡‘é–€ç¸£">é‡‘é–€ç¸£</option>
            <option value="é€£æ±Ÿç¸£">é€£æ±Ÿç¸£</option>
          </select>

          <!-- è‡ªå¡«æ™‚æ‰é¡¯ç¤º -->
          <input
            type="text"
            id="join-pickup-custom"
            placeholder="è¼¸å…¥è‡ªè¨‚ä¸Šè»Šåœ°é»"
            style="display:none;"
          >

          <!-- çœŸæ­£æäº¤çµ¦å¾Œç«¯çš„æ¬„ä½ï¼ˆname=departureï¼‰ -->
          <input type="hidden" id="join-pickup" name="departure">
        </div>


        <div class="join-field">
          <label>ç›®çš„åœ°</label>
          <input type="text" name="destination">
        </div>

        <div class="join-field">
          <label>æ˜¯å¦ä¸€èµ·å›ç¨‹ï¼Ÿ</label>
          <select name="together_return">
            <option value="" selected>æœªæŒ‡å®š</option>
            <option value="true">æ˜¯</option>
            <option value="false">å¦</option>
          </select>
        </div>

        <div class="join-field">
          <label>ç®¡ç†å¯†ç¢¼ <span class="muted">ï¼ˆå»ºè­° 4 ç¢¼ï¼Œä¾›å–æ¶ˆ/ç·¨è¼¯ç”¨ï¼Œé è¨­0000ï¼‰</span></label>
          <input type="password" name="password" placeholder="å»ºè­° 4 ç¢¼" defaultValue="0000">
        </div>

        <div class="join-field">
          <label>å‚™è¨» <span class="muted">ï¼ˆå¯è¼¸å…¥åŒè¡Œäººã€å…·é«”éœ€æ±‚â€¦ï¼‰</span></label>
          <textarea name="note" rows="3" placeholder=""></textarea>
        </div>
      </form>
    </div>

    <div class="modal-footer">
      <button type="button" class="btn-cancel" onclick="closeJoinModal()">å–æ¶ˆ</button>
      <button type="submit" form="joinForm" class="btn-submit">é€å‡º</button>
    </div>
  </div>
</div>


<!-- ä¹˜å®¢å–æ¶ˆ Modal -->
<div id="cancelModal" class="modal" style="display:none;">
  <div class="modal-content">
    <span class="close" onclick="document.getElementById('cancelModal').style.display='none'">&times;</span>
    <h3>ğŸ” å–æ¶ˆåƒåŠ </h3>
    <form id="cancelForm" method="POST" action="">
      {% csrf_token %}
      <input type="hidden" id="cancelPassengerId" name="passenger_id" value="">
      <label>ç®¡ç†å¯†ç¢¼</label>
      <input type="password" id="cancelPassword" name="password" required>
      <button type="submit" style="margin-top:10px;">ğŸ—‘ï¸ ç¢ºèªå–æ¶ˆ</button>
    </form>
  </div>
</div>

</body>
</html>

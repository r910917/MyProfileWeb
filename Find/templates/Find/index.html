<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>🌐 花蓮光復救災交通媒合</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<style>
/* ==========================================================================
   全站基礎：字體、背景、主標題/小標題
   ========================================================================== */
body{
  font-family:"Microsoft JhengHei",sans-serif;
  margin:0; padding:0;
  background:linear-gradient(to right,#eaf8ff,#f7fff7);
  color:#222;
}
h1{ text-align:center; padding:20px; color:#005c4b; }
h2{ color:#00695c; margin:20px; font-size:20px; }

/* ==========================================================================
   首頁兩顆主功能按鈕
   ========================================================================== */
.buttons{ text-align:center; margin:20px 0; }
.btn-main{
  display:inline-flex; align-items:center; gap:6px;
  padding:12px 24px; font-size:16px; border-radius:8px;
  border:none; cursor:pointer; margin:0 6px; color:#fff; font-weight:bold;
  transition:transform .2s, background .3s;
}
.btn-driver{ background:#007bff; }
.btn-driver:hover{ background:#0056b3; transform:scale(1.05); }
.btn-passenger{ background:#dc3545; }
.btn-passenger:hover{ background:#a71d2a; transform:scale(1.05); }

/* ==========================================================================
   卡片（Driver/Passenger 列表）＋ 左側色條
   ========================================================================== */
/* 更貼左、較薄的卡片 */
.card{
  display:flex;
  align-items:left;
  justify-content:space-between;
  background:#fff;
  margin:3px;                 /* 取消奇怪的負邊距，左右不縮進 */
  padding:8px 12px 8px 24px;    /* 上下變薄、左邊多一點空間給色條 */
  border-radius:8px;            /* 比 1px 好看許多 */
  box-shadow:0 2px 6px rgba(0,0,0,.08);
  position:relative;
  flex-wrap:wrap;
  animation:fadeInUp .3s ease-out;
}

/* 讓色條微微突出到卡片外，視覺上更靠左，但不需要負邊距 */
.card::before{
  content:"";
  position:absolute;
  top:0;
  bottom:0;       /* 等同於 height:100% + 更穩定 */
  left:10px;      /* 向左突出 8px，達到「貼左」效果 */
  width:6px;
  border-radius:6px 0 0 6px;
}

.driver-card::before{ background:#2196f3; }
.passenger-card::before{ background:#f44336; }

/* 1) 取消 UL 預設縮排：卡片不要被推到右側 */
#driver-list,
#passenger-list {
  list-style: none;
  margin: 0;
  padding: 0;        /* ← 這行是重點 */
}

/* 如果有其它容器對 ul/li 做了 padding-left，也一併歸零 */
#driver-list > li,
#passenger-list > li {
  margin-left: 0;
}

/* ==========================================================================
   司機卡片三欄排版（左：暱稱座位 / 中：三行 / 右：操作與箭頭）
   ========================================================================== */
.driver-grid{
  display:grid; grid-template-columns:minmax(140px,200px) 1fr auto;
  column-gap:10px; align-items:center; width:100%;
}
/* 左欄：暱稱 - 座位 */
.col-left{ display:flex; align-items:center; justify-content:flex-start; height:100%; font-size:15px; }
.name-seat{ font-size:15px; color:#222; margin:0; }
/* 中欄：三行資訊 */
.col-middle .line{ display:block; margin:2px 0; }
.col-middle .line1{ font-size:16px; color:#222; }
.col-middle .line2, .col-middle .line3{ font-size:14px; color:#444; }
/* 右欄：操作按鈕＋箭頭 */
.col-actions{ display:flex; align-items:center; justify-content:flex-end; gap:6px; }

/* 展開區塊鋪滿整列 */
.details{ grid-column:1 / -1; }

/* ==========================================================================
   展開/收合：箭頭旋轉、絲滑開合；管理/參加按鈕色系
   ========================================================================== */
.driver-card .arrow{
  cursor:pointer; margin-left:6px; min-width:36px; min-height:36px;
  font-size:16px; color:#333; background:transparent; border:0;
  transition:transform .25s ease;
}
.driver-card .arrow.open{ transform:rotate(90deg); }

.driver-card .details{
  margin-top:0px; max-height:0; overflow:hidden; padding:0px 0px;
  background: transparent; border:0 #e6e6e6;
  transition:max-height 1.2s ease, padding 1s ease;
}
/* 展開時再加回外觀 */
.driver-card .details.open {
  margin-top: 8px;
  max-height: 650px;
  padding: 10px;
  background: #f9f9f9;
  border-top: 1px solid #e6e6e6;
  border-radius: 6px;
}

.driver-card .btn-manage{ background:#007bff; color:#fff; border:0; border-radius:6px; padding:6px 10px; }
.driver-card .btn-manage:hover{ background:#0056b3; }
.driver-card .btn-join{ background:#28a745; color:#fff; border:0; border-radius:6px; padding:6px 10px; }
.driver-card .btn-join:hover{ background:#1e7e34; }

/* =============================================================================
   A. 乘客清單（待確認 / 已接受）卡片樣式
   ========================================================================== */

/* 清單容器（舊 two-col 保留，某些頁面可能仍在用） */
.pax-section{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:16px;
  align-items:start;
}
@media (max-width: 860px){
  .pax-section{ grid-template-columns: 1fr; }
}

.pax-list{ list-style:none; padding:0; margin:8px 0 0; }
.pax-item{
  box-sizing:border-box;
  background:#fff;
  border:1px solid #e5e7eb;
  border-radius:10px;
  padding:12px 14px;
  margin:8px 0;
}

/* 每筆：左文字（兩行） + 右按鈕 */
.pax-2col{
  display:grid;
  grid-template-columns: 1fr auto;
  column-gap: 12px;
  align-items:center;
}
.pax-left{ min-width:0; }
.pax-title{
  font-weight:700;
  font-size:15px;
  color:#111827;
  line-height:1.25;
}
.pax-sub{
  margin-top:2px;
  font-size:13px;
  color:#4b5563;
  line-height:1.3;
}
.pax-actions{ display:inline-flex; gap:8px; white-space:nowrap; }

.btn-mini{
  border:0; border-radius:8px; padding:6px 10px; background:#e5e7eb; cursor:pointer;
}
.btn-mini:hover{ background:#d1d5db; }
.btn-mini.danger{ background:#fecaca; color:#7f1d1d; }
.btn-mini.danger:hover{ background:#fca5a5; }

/* 已接受：綠色底提示 */
.pax-item.pax-accepted{ background:#f0fdf4; border:1px solid #bbf7d0; }
.pax-item.pax-accepted .pax-title .check{
  display:inline-block; margin-right:6px; color:#16a34a; font-weight:800;
}
.pax-item.pax-accepted .btn-mini{ background:#e7f5ec; }
.pax-item.pax-accepted .btn-mini:hover{ background:#d9f0e4; }

/* 手機按鈕落到下方 */
@media (max-width: 640px){
  .pax-2col{ grid-template-columns:1fr; row-gap:8px; align-items:start; }
  .pax-actions{ justify-content:flex-start; }
}

/* 自訂卷軸（淡淡的） */
.pax-scroll::-webkit-scrollbar,
.pending-scroll::-webkit-scrollbar{ width:8px; }
.pax-scroll::-webkit-scrollbar-thumb,
.pending-scroll::-webkit-scrollbar-thumb{ background:#d5d9e0; border-radius:6px; }
.pax-scroll::-webkit-scrollbar-track,
.pending-scroll::-webkit-scrollbar-track{ background:transparent; }


/* =============================================================================
   B. 詳細區塊：三欄（桌機）= 左：司機資訊 / 中：待確認 / 右：已接受
   ========================================================================== */

/* 你的 details 開闔動畫（保留） */
.details{
  margin-top:8px; max-height:0; overflow:hidden; padding:8px 10px;
  background:#f9f9f9; border-top:1px solid #e6e6e6; border-radius:6px;
  transition:max-height .35s ease, padding .25s ease;
}
.details.open{ max-height:1200px; padding:10px; }

/* 三欄容器（桌機） */
.details-grid3{
  /* 可調高度：三欄同高，內容超出則各自出現卷軸 */
  --panel-h: 340px;

  display:grid;
  grid-template-columns: minmax(420px, 2fr) minmax(320px, 1fr) minmax(320px, 1fr);
  gap:16px;
  align-items:stretch;  /* 三欄拉齊 */
}

/* 欄位內盒：給三欄統一高度與卷軸用 */
.details-col{
  height: var(--panel-h);
  min-height: 0;          /* 重要：讓 grid 內元素可以正確 overflow */
  background:#fff;
  border:1px solid #e5e7eb;
  border-radius:10px;
  overflow:auto;
  padding:14px 16px;
  box-shadow: 0 1px 2px rgba(0,0,0,.03);
}

/* 中、右欄標題 */
.pax-panel-title{
  margin:0 0 10px;
  font-weight:800;
  font-size:15px;
  color:#0f172a;
  display:flex; align-items:center; gap:6px;
}

/* 中、右欄列表容器（等高卷軸） */
.pax-scroll{
  height: calc(var(--panel-h) - 38px); /* 扣掉標題區高度(約) */
  overflow:auto;
  padding-right:6px;
}

/* RWD：≤980px 回單欄，不要固定高度與卷軸 */
@media (max-width: 980px){
  .details-grid3{ grid-template-columns:1fr; }
  .details-col{ height:auto; overflow:visible; }
  .pax-scroll{ height:auto; overflow:visible; padding-right:0; }
}


/* =============================================================================
   C. 司機資訊（左欄）排版優化
   ========================================================================== */

/* 左欄內的視覺：標題列 */
.driver-info__title{
  display:flex; align-items:center; gap:8px;
  font-weight:800; color:#0f172a;
  margin:2px 0 12px;
}
.driver-info__title .emoji{ font-size:18px; }

/* key-value 版面：整齊對齊成兩欄（標籤 / 內容） */
.driver-kv{
  display:grid;
  grid-template-columns: 92px 1fr;
  row-gap:8px;
  column-gap:10px;
}
.driver-kv .k{
  color:#475569;
  font-weight:600;
  text-align:right;
}
.driver-kv .v{
  color:#111827;
  word-break:break-word;
}

/* 小分隔線群組：讓資訊區塊更乾淨 */
.driver-info__group{
  display:grid; gap:8px;
  padding-bottom:8px;
  border-bottom:1px dashed #e5e7eb;
  margin-bottom:10px;
}
.driver-info__group:last-child{ border-bottom:0; padding-bottom:0; margin-bottom:0; }

/* 次要文字（例如「未提供」、「未定」） */
.text-muted{ color:#6b7280; }

/* RWD：手機時改成單欄 */
@media (max-width: 640px){
  .driver-kv{ grid-template-columns: 86px 1fr; }
}


/* =============================================================================
   D. 你現有的箭頭/卡片/按鈕（如需，保留）
   ========================================================================== */

.arrow{ cursor:pointer; margin-left:6px; min-width:36px; min-height:36px;
  font-size:16px; color:#333; background:transparent; border:0;
  transition: transform .25s ease;
}
.arrow.open{ transform: rotate(90deg); }

.btn-manage{ background:#007bff; color:#fff; border:0; border-radius:6px; padding:6px 10px; }
.btn-manage:hover{ background:#0056b3; }
.btn-join{ background:#28a745; color:#fff; border:0; border-radius:6px; padding:6px 10px; }
.btn-join:hover{ background:#1e7e34; }

/* ==========================================================================
   Modal：通用（遮罩/容器/關閉鈕/區塊）
   ========================================================================== */
.modal{
  position:fixed; inset:0; z-index:1000;left: 0; top: 0; background:rgba(0,0,0,.55);
  display:none;justify-content: center; align-items: center;
}
.modal-content {
  background: #fff;
  border-radius: 12px;
  padding: 28px 30px;
  width: 90%;
  max-width: 420px;
  text-align: center;   /* 🎯 置中所有文字 */
  box-shadow: 0 6px 18px rgba(0,0,0,0.25);
  position: relative;
  animation: fadeIn 0.3s ease-out;
}
.modal .modal-content{
  display:flex; flex-direction:column;
  width:min(520px,94vw); max-height:min(92svh,640px);
  margin:6svh auto; background:#fff; border-radius:12px;
  box-shadow:0 10px 30px rgba(0,0,0,.25);
}
.modal-header, .modal-footer{
  flex:0 0 auto; padding:14px 16px; border-bottom:1px solid #eee;
}
.modal-footer{ border-top:1px solid #eee; border-bottom:0; display:flex; justify-content:flex-end; gap:8px; }
.modal-body{ flex:1 1 auto; overflow-y:auto; padding:14px 16px; }
.close{ background:transparent; border:0; font-size:20px; cursor:pointer; }
/* 背景頁在 modal 開啟時不要捲動（可選） */
.body-modal-open{ overflow:hidden; }
/* 標題與描述 */
.modal-title {
  margin: 0;
  font-size: 20px;
  font-weight: bold;
  color: #333;
}
.modal-desc {
  font-size: 14px;
  color: #666;
  margin: 8px 0 20px;
}

/* 關閉按鈕 */
.close {
  position: absolute;
  top: 12px; right: 16px;
  font-size: 22px;
  font-weight: bold;
  color: #888;
  cursor: pointer;
}
.close:hover { color: #000; }

/* 表單欄位 */
.form-group {
  margin-bottom: 20px;
  text-align: center;  /* label 單獨靠左，輸入框保持置中 */
}
.form-group label {
  display: block;
  margin-bottom: 8px;
  font-size: 14px;
  font-weight: 600;
  color: #333;
  text-align: center;    /* 🎯 標籤靠左 */
}
.form-group input {
  width: 50%;
  padding: 12px;
  border-radius: 8px;
  border: 1px solid #ccc;
  font-size: 15px;
  transition: border-color 0.2s;
  text-align: center;   /* 🎯 輸入框文字置中 */
}
.form-group input:focus {
  border-color: #007bff;
  outline: none;
}

/* 按鈕區塊 */
.modal-actions {
  display: flex;
  justify-content: center;  /* 🎯 按鈕置中 */
  gap: 12px;
}
.btn-primary {
  background: #007bff;
  color: #fff;
  border: none;
  padding: 10px 20px;
  border-radius: 6px;
  font-size: 15px;
  cursor: pointer;
  transition: background 0.2s;
}
.btn-primary:hover { background: #0056b3; }

.btn-secondary {
  background: #f1f1f1;
  color: #333;
  border: none;
  padding: 10px 20px;
  border-radius: 6px;
  font-size: 15px;
  cursor: pointer;
  transition: background 0.2s;
}
.btn-secondary:hover { background: #ddd; }

/* 動畫 */
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(-10px); }
  to { opacity: 1; transform: translateY(0); }
}

/* 🎯 手機版 RWD */
@media (max-width: 480px) {
  #driverAuthModal .modal-content {
    width: 70%;
    margin-top: 60%;
  }
  #driverAuthModal.btn-primary, .btn-secondary {
    flex: 1;              /* 按鈕變成等寬 */
    padding: 12px;
  }
  .modal-actions {
    flex-direction: column; /* 🎯 手機版按鈕上下排列 */
  }
}
/* ==========================================================================
   Join Modal：外觀微調（高度較矮、Header/Body/Footer 黏貼）
   ========================================================================== */
/* Join Modal 外觀 */
#joinModal .modal-content {
  width: min(520px, 94vw);
  max-height: min(88svh, 620px);
  margin: 4svh auto;
  border-radius: 14px;
  overflow: hidden;
  box-shadow: 0 14px 34px rgba(0,0,0,.25);
  background: #fff;
  display: flex;
  flex-direction: column;
}

/* Header */
#joinModal .modal-header {
  position: sticky; top: 0; z-index: 2;
  display: flex; align-items: center; justify-content: center;
  min-height: 44px; padding: 8px 16px;
  background: #fff; border-bottom: 1px solid #eee;
}
#joinModal .modal-header .title {
  font-size: 16px; font-weight: 700; color: #111827;
  display: inline-flex; align-items: center; gap: 8px;
}
#joinModal .modal-header .title .emoji { font-size: 18px; }
#joinModal .modal-header .close {
  position: absolute; right: 10px; top: 8px;
  width: 28px; height: 28px;
  display: inline-grid; place-items: center;
  font-size: 18px; color: #6b7280; background: transparent; border: none;
  cursor: pointer; border-radius: 6px;
}
#joinModal .modal-header .close:hover { background: #f3f4f6; color: #111827; }

/* Body */
#joinModal .modal-body {
  flex: 1 1 auto;
  overflow-y: auto;
  padding: 12px 16px;
}

/* Footer */
#joinModal .modal-footer {
  position: sticky; bottom: 0; z-index: 2;
  display: flex; justify-content: flex-end; gap: 8px;
  padding: 10px 16px; background: #fff;
  border-top: 1px solid #eee;
}
#joinModal .btn-cancel, #joinModal .btn-submit {
  border-radius: 10px; padding: 10px 18px;
  font-weight: 700; font-size: 15px;
  border: none; cursor: pointer;
}
#joinModal .btn-cancel { background: #f3f4f6; color: #333; }
#joinModal .btn-cancel:hover { background: #ddd; }
#joinModal .btn-submit { background: #3b82f6; color: #fff; }
#joinModal .btn-submit:hover { background: #2563eb; }

/* 表單欄位 */
#joinModal .join-field {
  display: flex; flex-direction: column;
  gap: 6px; margin: 12px 0;
  align-items: flex-start; /* 標籤靠左 */
}
#joinModal .join-field label {
  font-weight: 600; color: #1f2937; line-height: 1.2;
}
#joinModal .join-field input,
#joinModal .join-field select,
#joinModal .join-field textarea {
  width: 70%;
  padding: 10px 12px;
  border: 1px solid #d1d5db; border-radius: 8px;
  font-size: 14px; line-height: 1.25;
  background: #fff;
  transition: border-color .2s, box-shadow .2s;
}
#joinModal .join-field input:focus,
#joinModal .join-field select:focus,
#joinModal .join-field textarea:focus {
  outline: none;
  border-color: #3b82f6;
  box-shadow: 0 0 0 3px rgba(59,130,246,.15);
}
#joinModal textarea[name="note"] { min-height: 96px; }

/* 手機優化 */
@media (max-width: 480px) {
  #joinModal .modal-content {
    width: 80%; max-height: 90vh;
  }
  #joinModal .modal-footer {
    flex-direction: column;
  }
  #joinModal .btn-cancel, #joinModal .btn-submit {
    width: 100%;
  }
}
  /* Join 表單欄位間距與按鈕高度 */
  #joinModal .join-field{ margin:10px 0; gap:6px; }
  .btn-submit, .btn-cancel{ min-height:44px; font-size:16px; }

  /* JoinModal 再壓縮 header/邊距 */
  #joinModal .modal-content{ max-height:min(92svh,640px); margin:3svh auto; }
  #joinModal .modal-header{ min-height:40px; padding:6px 14px; }
  #joinModal .modal-header .title{ font-size:15px; }
  #joinModal .modal-body{ padding:10px 14px; }
  #joinModal .modal-footer{ padding:8px 14px; }

/* ==========================================================================
   返回頂端按鈕
   ========================================================================== */
#backToTop{
  position:fixed; bottom:20px; right:20px;
  background:#00897b; color:#fff; border:none; border-radius:50%;
  padding:14px; font-size:20px; cursor:pointer;
  box-shadow:0 4px 8px rgba(0,0,0,.2);
  z-index:1200; transition:transform .2s, background .3s;
}
#backToTop:hover{ background:#00695c; transform:scale(1.08); }

/* ==========================================================================
   動畫
   ========================================================================== */
@keyframes fadeInUp{
  from{ opacity:0; transform:translateY(15px); }
  to{ opacity:1; transform:translateY(0); }
}

/* ==========================================================================
   RWD 斷點調整
   ========================================================================== */
/* ≤1024px：卡片與主按鈕微調 */
@media (max-width:1024px){
  .card{ padding:8px 12px 8px 24px; margin:3px; }
  .btn-main{ padding:10px 16px; font-size:15px; }
}
/* ≤768px：字級、小標題、主按鈕等 */
@media (max-width:768px){
  body{ font-size:15px; }
  h1{ font-size:22px; }
  h2{ font-size:18px; margin:14px; }
  .buttons{ padding:0 12px; }
  .btn-main{ width:auto; min-width:44%; }
  #toast-container{ top:env(safe-area-inset-top,16px); right:12px; left:24px; }
}
/* ≤640px：主按鈕滿版、司機卡片三欄改單欄、Modal 更緊湊、Join 表單維持直向 */
@media (max-width:640px){
  /* 主按鈕改單欄滿版 */
  .buttons{ display:grid; grid-template-columns:1fr; gap:10px; padding:0 12px; }
  .btn-main{ width:100%; }

  /* 司機卡片：三欄→單欄 */
  .driver-grid{ display:grid; grid-template-columns:1fr; grid-row-gap:8px; }
  .col-left, .col-middle, .col-actions{ width:100%; }
  .col-left .name-seat{ font-size:16px; margin-bottom:6px; text-align:left; }
  .col-middle .line{ display:block; margin:4px 0; font-size:14px; }

  .col-actions{
    display:grid; grid-template-columns:1fr 1fr auto; align-items:center; gap:8px;
  }
  .btn-manage, .btn-join{ width:100%; min-height:44px; font-size:15px; }
  .arrow{ font-size:18px; min-width:44px; min-height:44px; display:inline-grid; place-items:center; }
  .details{
  margin-top:0px; max-height:0; overflow:hidden; padding:0px 0px;
  background: transparent; border:0 #e6e6e6;
  transition:max-height 1.2s ease, padding 1s ease;
  }
  /* 展開時再加回外觀 */
  .details.open {
    margin-top: 8px;
    max-height: 1200px;
    padding: 10px;
    background: #f9f9f9;
    border-top: 1px solid #e6e6e6;
    border-radius: 6px;
  }
  .details h4{ font-size:15px; margin:6px 0 4px; }
  .details p, .details li{ font-size:14px; margin:2px 0; }

  /* 乘客卡片：主列單欄、操作靠右 */
  .pax-row{ grid-template-columns:1fr; }
  .pax-actions{ justify-content:flex-end; }

  /* 通用 modal 寬度 */
  .modal .modal-content{ width:94vw; margin:4svh auto; }

  /* 返回頂端位置 */
  #backToTop{ right:12px; bottom:16px; }
}
/* ≤400px：字級調整、按鈕與箭頭更小 */
@media (max-width:400px){
  body{ font-size:14px; }
  h1{ font-size:20px; }
  h2{ font-size:16px; margin:10px; }
  .col-left .name-seat{ font-size:15px; }
  .col-middle .line1{ font-size:15px; }
  .col-middle .line2, .col-middle .line3{ font-size:13px; }
  .btn-manage, .btn-join{ font-size:14px; padding:8px 10px; }
  .arrow{ font-size:16px; min-width:40px; min-height:40px; }
}
/* ============================================================================
   Pax Edit Modal 美化（只影響 #paxEditModal）
   ========================================================================== */

/* 背景：半透明＋輕微模糊 */
#paxEditModal.modal{
  position: fixed; inset: 0; z-index: 1200;
  background: rgba(15, 23, 42, .45);
  backdrop-filter: blur(2px);
  display: none; /* 用 JS 控制 show/hide */
}

/* 容器：置中、圓角、陰影、flex 直向 */
#paxEditModal .modal-content{
  width: min(560px, 94vw);
  max-height: min(88svh, 680px);
  margin: 5svh auto;
  background: #ffffff;
  border-radius: 14px;
  box-shadow: 0 18px 40px rgba(2, 6, 23, .25);
  overflow: hidden;
  display: flex;
  flex-direction: column;
}

/* Header / Footer 黏住頂底，內容區可捲動 */
#paxEditModal .modal-header,
#paxEditModal .modal-footer{
  flex: 0 0 auto;
  padding: 12px 16px;
  background: #fff;
  border-bottom: 1px solid #eef2f7;
}
#paxEditModal .modal-footer{
  border-top: 1px solid #eef2f7;
  border-bottom: 0;
  display: flex;
  justify-content: flex-end;
  gap: 10px;
}

/* 標題與關閉鈕 */
#paxEditModal .modal-header{
  position: sticky; top: 0; z-index: 2;
  display: flex; align-items: center; justify-content: center;
}
#paxEditModal .modal-header .title{
  font-weight: 800; color: #0f172a; font-size: 16px;
  display: inline-flex; gap: 8px; align-items: center;
}
#paxEditModal .modal-header .close{
  position: absolute; right: 10px; top: 8px;
  width: 32px; height: 32px;
  border: 0; border-radius: 8px;
  display: inline-grid; place-items: center;
  font-size: 18px; line-height: 1; color: #6b7280;
  background: transparent; cursor: pointer;
  transition: color .15s ease;
}
#paxEditModal .modal-header .close:hover{
  background: #f3f4f6; color: #111827;
}

/* 內容可捲動 + 內距 */
#paxEditModal .modal-body{
  flex: 1 1 auto; overflow: auto;
  padding: 14px 16px;
}

/* 表單：桌機兩欄、手機單欄 */
#paxEditModal #paxEditForm{
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px 14px;
}
@media (max-width: 640px){
  #paxEditModal #paxEditForm{ grid-template-columns: 1fr; }
}

/* 單欄欄位（原本的 .join-field）統一視覺 */
#paxEditModal .join-field{
  display: flex; flex-direction: column; gap: 6px;
}

/* 讓較長的欄位（備註）自動佔兩欄 */
#paxEditModal textarea{ grid-column: 1 / -1; }

/* Label */
#paxEditModal .join-field > label{
  font-weight: 600; color: #1f2937; line-height: 1.2;
}

/* Input / Select / Textarea 一致化 */
#paxEditModal .join-field input,
#paxEditModal .join-field select,
#paxEditModal .join-field textarea{
  width: 50%;
  padding: 10px 12px;
  border: 1px solid #d7dde6;
  border-radius: 10px;
  font-size: 14px; line-height: 1.25;
  transition: border-color .18s ease, box-shadow .18s ease;
}

/* Focus ring */
#paxEditModal .join-field input:focus,
#paxEditModal .join-field select:focus,
#paxEditModal .join-field textarea:focus{
  outline: none;
  border-color: #3b82f6;
  box-shadow: 0 0 0 3px rgba(59,130,246,.18);
}

/* placeholder 淡一點 */
#paxEditModal ::placeholder{ color: #9ca3af; }

/* number 小箭頭隱藏（一致高度） */
#paxEditModal input[type="number"]::-webkit-inner-spin-button,
#paxEditModal input[type="number"]::-webkit-outer-spin-button{
  -webkit-appearance: none; margin: 0;
}
#paxEditModal input[type="number"]{ -moz-appearance: textfield; }

/* 按鈕 */
#paxEditModal .btn-cancel,
#paxEditModal .btn-submit{
  border: 0; border-radius: 10px;
  padding: 10px 16px; font-weight: 700; cursor: pointer;
  transition: transform .06s ease, box-shadow .2s ease;
}
#paxEditModal .btn-cancel{ background: #eef2f7; color: #111827; }
#paxEditModal .btn-cancel:hover{ background: #e5eaf2; }
#paxEditModal .btn-submit{ background: #2563eb; color: #fff; }
#paxEditModal .btn-submit:hover{ background: #1e4fd6; }
#paxEditModal .btn-cancel:active,
#paxEditModal .btn-submit:active{ transform: translateY(1px); }

/* 小螢幕微調 */
@media (max-width: 640px){
  #paxEditModal .modal-content{
    width: 94vw; max-height: min(92svh, 700px); margin: 4svh auto;
  }
  #paxEditModal .modal-body{ padding: 12px 14px; }
  #paxEditModal .modal-footer{ padding: 10px 14px; }
}

 #paxDelModal .btn-cancel{background:#d1d5db;padding:8px 14px;border:0;border-radius:6px;cursor:pointer;}
 #paxDelModal .btn-delete{background:#dc2626;color:#fff;padding:8px 14px;border:0;border-radius:6px;cursor:pointer;}
 #paxDelModal .btn-delete:hover{background:#b91c1c;}

</style>

</head>
<body>
  <h1>🌐 花蓮光復救災交通媒合</h1>

  <div class="buttons">
    <a href="{% url 'find_car' %}">
      <button class="btn-main btn-driver">🚗 我要出車（找乘客）</button>
    </a>
    <a href="{% url 'find_people' %}">
      <button class="btn-main btn-passenger">🧍 我要搭車（找車）</button>
    </a>
  </div>

  <h2>找人資訊（司機提供座位）</h2>
  <ul id="passenger-list">
    {% for p in passengers %}
      {% if not p.is_matched %}
        <li class="card passenger-card">
          <span><b>{{ p.passenger_name }}</b> - 需要 {{ p.seats_needed }} 人
            ({{ p.departure }} → {{ p.destination }}, {{ p.date }})</span>
          <div class="actions">
            <button onclick="openPassengerModal('{{ p.id }}')">編輯</button>
            <button onclick="openJoinModal('{{ p.id }}')">參加</button>
          </div>
        </li>
      {% endif %}
    {% empty %}
      <li class="card passenger-card">目前沒有需求</li>
    {% endfor %}
  </ul>

<h2>找車需求（乘客需要司機）</h2>
<ul id="driver-list">
  {% include "Find/_driver_list.html" %}
</ul>


  <!-- 回到頂端 -->
  <button id="backToTop" onclick="window.scrollTo({top:0, behavior:'smooth'});">⬆</button>

<!-- 司機管理授權 Modal -->
<div id="driverAuthModal" class="modal" style="display:none;">
  <div class="modal-content">
    <span class="close" onclick="closeDriverAuth()">&times;</span>
    <h3 class="modal-title">🔐 管理授權</h3>
    <p class="modal-desc">請輸入管理密碼以繼續</p>
    <form id="driverAuthForm" method="POST">
      {% csrf_token %}
      <input type="hidden" id="driverAuthId" value="">
      <div class="form-group">
        <label for="driverAuthPassword">管理密碼</label>
        <input id="driverAuthPassword" type="password" name="password" required placeholder="輸入管理密碼">
      </div>
      <div class="modal-actions">
        <button type="submit" class="btn-primary">確認</button>
        <button type="button" class="btn-secondary" onclick="closeDriverAuth()">取消</button>
      </div>
    </form>
  </div>
</div>
<!-- 刪除司機 Modal -->
<div id="deleteDriverModal" class="modal" style="display:none;">
  <div class="modal-content" style="max-width:400px;text-align:center;">
    <h3 style="color:#b91c1c;">⚠️ 確認刪除</h3>
    <p>確定要刪除此司機嗎？<br>此動作會解除所有乘客關聯，且無法復原。</p>
    <div style="margin-top:20px;display:flex;justify-content:center;gap:12px;">
      <button type="button" class="btn-cancel" onclick="closeDeleteDriver()">取消</button>
      <button type="button" class="btn-delete" id="confirmDeleteDriver">刪除</button>
    </div>
  </div>
</div>

<style>
  .btn-cancel{background:#d1d5db;padding:8px 14px;border:0;border-radius:6px;cursor:pointer;}
  .btn-delete{background:#dc2626;color:#fff;padding:8px 14px;border:0;border-radius:6px;cursor:pointer;}
  .btn-delete:hover{background:#b91c1c;}
</style>



<!-- Toast 容器 -->
<div id="toast-container" style="
  position: fixed;
  top: 20px;
  right: 20px;
  z-index: 2000;
"></div>

<!-- 參加行程 Modal -->
<div id="joinModal" class="modal" style="display:none;">
  <div class="modal-content">
    <div class="modal-header">
      <h3>🧍 參加行程</h3>
      <button type="button" class="close" onclick="closeJoinModal()">×</button>
    </div>

    <div class="modal-body">
      <form id="joinForm" method="POST">
        {% csrf_token %}

        <div class="join-field">
          <label>暱稱</label>
          <input type="text" name="passenger_name" required>
        </div>

        <div class="join-field">
          <label>性別</label>
          <select name="gender" required>
            <option value="X" selected>不方便透漏</option>
            <option value="M">男生</option>
            <option value="F">女生</option>
          </select>
        </div>

        <div class="join-field">
          <label>Email <span class="muted">(不公開，用於媒合通知)</span></label>
          <input type="email" name="email" placeholder="選填">
        </div>

        <div class="join-field">
          <label>聯絡方式(選填,未填請自行連絡司機)</label>
          <input type="text" name="contact" placeholder="LINE / IG / Phone 擇一">
        </div>

        <div class="join-field">
          <label>上車人數</label>
          <input type="number" name="seats_needed" min="1" value="1" required>
        </div>

        <div class="join-field">
          <label>願付金額 <span class="muted">（選填，單位 NTS）</span></label>
          <input type="number" name="willing_to_pay" min="0" step="1" placeholder="選填">
        </div>

        <!-- 上車地點（縣市下拉 + 自填） -->
        <div class="join-field">
          <label for="join-pickup-select">上車地點</label>

          <!-- 使用下拉做選擇（沒有 name，避免直接提交） -->
          <select id="join-pickup-select">
            <option value="">請選擇縣市</option>
            <option value="其他">其他</option>
            <option value="花蓮縣光復鄉">花蓮縣光復鄉</option>
            <option value="花蓮縣光復車站以外火車站">花蓮縣光復車站以外火車站</option>
            <option value="花蓮縣光復車站">花蓮縣光復車站</option>
            <option value="光復鄉糖廠">光復鄉糖廠</option>
            <option value="需清淤地區">需清淤地區</option>
            <option value="台北市">台北市</option>
            <option value="新北市">新北市</option>
            <option value="基隆市">基隆市</option>
            <option value="桃園市">桃園市</option>
            <option value="新竹市">新竹市</option>
            <option value="新竹縣">新竹縣</option>
            <option value="苗栗縣">苗栗縣</option>
            <option value="台中市">台中市</option>
            <option value="彰化縣">彰化縣</option>
            <option value="南投縣">南投縣</option>
            <option value="雲林縣">雲林縣</option>
            <option value="嘉義市">嘉義市</option>
            <option value="嘉義縣">嘉義縣</option>
            <option value="台南市">台南市</option>
            <option value="高雄市">高雄市</option>
            <option value="屏東縣">屏東縣</option>
            <option value="宜蘭縣">宜蘭縣</option>
            <option value="花蓮縣">花蓮縣</option>
            <option value="台東縣">台東縣</option>
            <option value="澎湖縣">澎湖縣</option>
            <option value="金門縣">金門縣</option>
            <option value="連江縣">連江縣</option>
          </select>

          <!-- 自填（選「其他」才顯示；無 name） -->
          <input type="text" id="join-pickup-custom" placeholder="輸入自訂上車地點" style="display:none;">

          <!-- 真正提交用（有 name） -->
          <input type="hidden" id="join-pickup" name="departure">
        </div>
        
        

        <div class="join-field">
          <label>目的地</label>
          <input type="text" name="destination">
        </div>



        <!-- 出發日期（必填） -->
        <div class="join-field">
          <label for="join-date">出發日期</label>
          <input type="date" id="join-date" name="date" required>
        </div>
        <!-- 是否一起回程 -->
        <div class="join-field">
          <label>是否一起回程？</label>
          <select name="together_return" id="join-together">
            <option value="" selected>未指定</option>
            <option value="true">是</option>
            <option value="false">否</option>
          </select>
        </div>
        <!-- 回程日期 -->
        <div class="join-field" id="returnField" style="display:none;">
          <label for="join-return">回程日期</label>
          <input type="date" id="join-return" name="return_date">
        </div>


        <div class="join-field">
          <label>管理密碼 <span class="muted">（建議 4 碼，供取消/編輯用，預設0000）</span></label>
          <input type="password" name="password" placeholder="建議 4 碼" defaultValue="0000">
        </div>

        <div class="join-field">
          <label>備註 <span class="muted">（可輸入同行人、具體需求…）</span></label>
          <textarea name="note" rows="3" placeholder=""></textarea>
        </div>
      </form>
    </div>

    <div class="modal-footer">
      <button type="button" class="btn-cancel" onclick="closeJoinModal()">取消</button>
      <button type="submit" form="joinForm" class="btn-submit">送出</button>
    </div>
  </div>
</div>

<!-- 乘客編輯授權 Modal -->
<div id="paxAuthModal" class="modal" style="display:none;">
  <div class="modal-content" style="max-width:420px;">
    <div class="modal-header">
      <span class="title">🔐 編輯授權</span>
      <button class="close" onclick="closePaxAuth()">&times;</button>
    </div>
    <div class="modal-body">
      <form id="paxAuthForm" method="POST">
        {% csrf_token %}
        <input type="hidden" id="paxAuthId" name="id">
        <div class="join-field">
          <label>管理密碼</label>
          <input type="password" id="paxAuthPassword" name="password" placeholder="請輸入乘客管理密碼" required>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn-cancel" onclick="closePaxAuth()">取消</button>
      <button class="btn-submit" onclick="submitPaxAuth()">確認</button>
    </div>
  </div>
</div>
<!-- 乘客編輯 Modal -->
<div id="paxEditModal" class="modal" style="display:none;">
  <div class="modal-content">
    <div class="modal-header">
      <span class="title">✏️ 編輯乘客</span>
      <button class="close" onclick="closePaxEdit()">&times;</button>
    </div>
    <div class="modal-body">
      <form id="paxEditForm">
        {% csrf_token %}
        <input type="hidden" id="paxEditId" name="id">

        <div class="join-field">
          <label>暱稱</label>
          <input type="text" id="paxName" name="passenger_name" required>
        </div>

        <div class="join-field">
          <label>性別</label>
          <select id="paxGender" name="gender">
            <option value="X">不方便透漏</option>
            <option value="M">男生</option>
            <option value="F">女生</option>
          </select>
        </div>

        <div class="join-field">
          <label>Email（不公開）</label>
          <input type="email" id="paxEmail" name="email" placeholder="可空白">
        </div>

        <div class="join-field">
          <label>聯絡方式</label>
          <input type="text" id="paxContact" name="contact" placeholder="LINE / IG / Phone">
        </div>

        <div class="join-field">
          <label>上車人數</label>
          <input type="number" id="paxSeats" name="seats_needed" min="1" value="1">
        </div>

        <div class="join-field">
          <label>願付金額（可空）</label>
          <input type="text" id="paxPay" name="willing_to_pay" placeholder="例如 300">
        </div>

        <div class="join-field">
          <label>上車地點</label>
          <input type="text" id="paxDeparture" name="departure">
        </div>

        <div class="join-field">
          <label>目的地</label>
          <input type="text" id="paxDestination" name="destination">
        </div>

        <div class="join-field">
          <label>出發日期</label>
          <input type="date" id="paxDate" name="date">
        </div>

        <div class="join-field">
          <label>回程日期（選填）</label>
          <input type="date" id="paxReturn" name="return_date">
        </div>

        <div class="join-field">
          <label>是否一起回程</label>
          <select id="paxTogether" name="together_return">
            <option value="">未指定</option>
            <option value="true">是</option>
            <option value="false">否</option>
          </select>
        </div>

        <div class="join-field">
          <label>備註</label>
          <textarea id="paxNote" name="note" rows="3"></textarea>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn-cancel" onclick="closePaxEdit()">取消</button>
      <button class="btn-submit" onclick="submitPaxEdit()">儲存</button>
    </div>
  </div>
</div>

<!-- 乘客刪除 Modal（簡單確認） -->
<div id="paxDelModal" class="modal" style="display:none;">
  <div class="modal-content">
    <div class="modal-header">
      <span class="title">🗑 刪除乘客</span>
      <button class="close" onclick="closePaxDel()">&times;</button>
    </div>
    <div class="modal-body">
      <p>確定要刪除這位乘客嗎？此動作無法復原。</p>
      <input type="hidden" id="paxDelId">
    </div>
    <div class="modal-footer">
      <button class="btn-cancel" onclick="closePaxDel()">取消</button>
      <button class="btn-submit" style="background:#e11d48" onclick="confirmPaxDel()">刪除</button>
    </div>
  </div>
</div>



<script>
/* =========================================================================
 * 0) 公用小工具（單一來源）
 * ========================================================================= */
(function initUtils(){
  if (window.__UTILS_READY__) return;
  window.__UTILS_READY__ = true;

  window.$id = (id) => document.getElementById(id);

  window.getCookie = function(name){
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    return parts.length === 2 ? parts.pop().split(';').shift() : null;
  };

  // 從任一表單或 cookie 取 CSRF（優先表單）
  window.getCSRF = function(form){
    const el = (form || document).querySelector('input[name="csrfmiddlewaretoken"]');
    return (el && el.value) || getCookie('csrftoken') || '';
  };

  window.showToastSafe = function(msg, type){
    if (typeof showToast === 'function') showToast(msg, type);
    else alert(msg);
  };

  // 安全 JSON 取回：res 失敗或非 JSON 不拋例外
  window.jsonFetch = async function(url, options = {}){
    const res = await fetch(url, options);
    let data = {};
    try { data = await res.json(); } catch(_) {}
    return { res, data };
  };
})();

/* =========================================================================
 * 1) WebSocket 初始化（單一來源）+ 事件綁定（使用 addEventListener）
 *    - 支援全量 passengers_html
 *    - 支援單卡片 driver_partial → patchDriverCard()
 * ========================================================================= */
(function initSocket(){
  if (!window.socket) {
    window.socket = new WebSocket(
      (location.protocol === 'https:' ? 'wss://' : 'ws://') + window.location.host + '/ws/find/'
    );
  }
  socket.addEventListener('open',  () => console.log('✅ WebSocket 連線成功'));
  socket.addEventListener('close', () => console.log('❌ WebSocket 已關閉'));
  socket.addEventListener('error', (err) => console.error('⚠️ WebSocket 發生錯誤', err));

  socket.addEventListener('message', (event) => {
    let data;
    try { data = JSON.parse(event.data); } catch { return; }

    // 單一卡片更新
    if (data.type === 'driver_partial') {
      // 期待 payload: { type, driver_id, driver_html, active }
      patchDriverCard(data.driver_id, data.driver_html, data.active);
      return;
    }

    // 全量更新（保留乘客清單）
    if (data.type === 'update') {
      if (data.passengers_html) {
        const plist = $id('passenger-list');
        if (plist) plist.innerHTML = data.passengers_html;
      }
      // drivers_html 建議改走 driver_partial；如仍傳入，可視需求處理
      return;
    }

    if (data.type === 'join_result') {
      if (data.success) showToastSafe('✅ 成功加入乘客行程！', 'success');
      else showToastSafe('⚠️ 加入失敗：' + (data.message || '沒有可用的司機'), 'error');
    }
  });
})();

/* =========================================================================
 * 2) Driver 列表：全量替換（保留展開與卷軸） & 單卡片替換
 * ========================================================================= */
// 記住目前展開的 driver ids
function snapshotOpenDrivers () {
  return Array
    .from(document.querySelectorAll('#driver-list .details.open'))
    .map(el => el.id.replace('details-', ''));
}
// 還原展開狀態（包含箭頭 aria）
function restoreOpenDrivers (openIds) {
  if (!Array.isArray(openIds) || openIds.length === 0) return;
  openIds.forEach(id => {
    const details = document.getElementById('details-' + id);
    const arrow   = document.getElementById('arrow-' + id);
    if (details) {
      details.classList.add('open');
      details.setAttribute('aria-hidden', 'false');
    }
    if (arrow) {
      arrow.classList.add('open');
      arrow.setAttribute('aria-expanded', 'true');
    }
  });
}
// 全量替換 driver list
function replaceDriverListSafely (newHtml) {
  const list = document.getElementById('driver-list');
  if (!list || typeof newHtml !== 'string') return;
  const openIds     = snapshotOpenDrivers();
  const prevScrollY = window.scrollY;
  list.innerHTML = newHtml;
  restoreOpenDrivers(openIds);
  window.scrollTo(0, prevScrollY);
}
// 同時處理 drivers / passengers
function replaceLists (data) {
  if (!data || typeof data !== 'object') return;
  if (typeof data.drivers_html === 'string') replaceDriverListSafely(data.drivers_html);
  if (typeof data.passengers_html === 'string') {
    const p = document.getElementById('passenger-list');
    if (p) p.innerHTML = data.passengers_html;
  }
}

// 取得卡片狀態
function snapshotCardState(li) {
  if (!li) return null;
  const panel    = li.querySelector('.details');
  if (!panel) return { open: false, scrollP: 0, scrollA: 0 };
  const pending  = panel.querySelector('.pending-scroll');
  const accepted = panel.querySelector('.accepted-scroll');
  return {
    open   : panel.classList.contains('open'),
    scrollP: pending  ? pending.scrollTop  : 0,
    scrollA: accepted ? accepted.scrollTop : 0
  };
}
// 還原卡片狀態
function restoreCardState(li, state) {
  if (!li || !state) return;
  const panel = li.querySelector('.details');
  const arrow = li.querySelector('.arrow');
  if (state.open && panel) {
    panel.classList.add('open');
    panel.setAttribute('aria-hidden', 'false');
    if (arrow) {
      arrow.classList.add('open');
      arrow.setAttribute('aria-expanded', 'true');
    }
  }
  const pending  = li.querySelector('.pending-scroll');
  const accepted = li.querySelector('.accepted-scroll');
  if (pending)  pending.scrollTop  = state.scrollP || 0;
  if (accepted) accepted.scrollTop = state.scrollA || 0;
}
// 單一卡片替換 / 附加 / 移除
function patchDriverCard(driverId, driverHTML, active = true) {
  const list = document.getElementById('driver-list');
  if (!list || !driverId || typeof driverHTML !== 'string') return;
  const selector = `li[data-driver="${CSS.escape(String(driverId))}"]`;
  const oldLi = list.querySelector(selector);

  // 不存在：active=true → append
  if (!oldLi) {
    if (!active) return;
    const tmp = document.createElement('div');
    tmp.innerHTML = driverHTML.trim();
    const newLi = tmp.querySelector('li') || tmp.firstElementChild;
    if (newLi) list.appendChild(newLi);
    return;
  }
  // 下架：移除
  if (!active) { oldLi.remove(); return; }

  const state = snapshotCardState(oldLi);
  const tmp = document.createElement('div');
  tmp.innerHTML = driverHTML.trim();
  const newLi = tmp.querySelector('li') || tmp.firstElementChild;
  if (!newLi) return;
  oldLi.replaceWith(newLi);
  restoreCardState(newLi, state);
}

/* =========================================================================
 * 3) Driver 管理授權（密碼驗證 → 成功跳轉）
 *    - openDriverModal(driverId) / closeDriverAuth()
 * ========================================================================= */
(function initDriverAuth(){
  function bindDriverAuthForm() {
    const form = $id("driverAuthForm");
    if (!form || form.dataset.bound === "1") return;

    const idEl  = $id("driverAuthId");
    const pwdEl = $id("driverAuthPassword");

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const driverId = idEl && idEl.value;
      const password = pwdEl && pwdEl.value;
      if (!driverId) { console.error("缺 driverId"); return; }
      if (!password) { showToastSafe("請輸入密碼", "error"); pwdEl && pwdEl.focus(); return; }

      const btn = form.querySelector('[type="submit"]');
      try {
        if (btn) btn.disabled = true;
        const { res, data } = await jsonFetch(`/find/driver/${driverId}/manage/auth/`, {
          method: "POST",
          credentials: "same-origin",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8",
            "X-CSRFToken": getCSRF(form),
            "X-Requested-With": "XMLHttpRequest",
          },
          body: new URLSearchParams({ password }),
        });

        if (res.ok && data && data.ok && data.url) {
          showToastSafe("✅ 驗證成功，前往管理頁…", "success");
          closeDriverAuth();
          window.location.href = data.url;
        } else {
          const msg = (data && (data.error || data.detail)) || `驗證失敗 (HTTP ${res.status})`;
          showToastSafe(msg, "error");
          pwdEl && pwdEl.focus();
        }
      } catch (err) {
        console.error(err);
        showToastSafe("伺服器錯誤，稍後再試", "error");
      } finally {
        if (btn) btn.disabled = false;
      }
    });

    form.dataset.bound = "1";
  }

  window.openDriverModal = function (driverId) {
    const idEl  = $id("driverAuthId");
    const pwdEl = $id("driverAuthPassword");
    const modal = $id("driverAuthModal");
    if (!idEl || !pwdEl || !modal) { alert("管理視窗元件缺失"); return; }
    idEl.value = driverId;
    pwdEl.value = "";
    modal.style.display = "block";
    bindDriverAuthForm();
    setTimeout(() => pwdEl.focus(), 0);
  };
  window.closeDriverAuth = function () {
    const modal = $id("driverAuthModal");
    if (modal) modal.style.display = "none";
  };
  document.addEventListener("DOMContentLoaded", bindDriverAuthForm);
})();

/* =========================================================================
 * 4) Join / Cancel Modal 開關 + 可選 AJAX 送出
 *    - openJoinModal(driverId) / closeJoinModal()
 *    - openCancelModal(passengerId)
 * ========================================================================= */
function openJoinModal(driverId){
  const m = $id('joinModal');
  const f = $id('joinForm');
  if (!m || !f) return;
  f.action = `/find/driver/${driverId}/join/`;
  m.style.display = 'block';
  document.body.classList.add('body-modal-open');
  setTimeout(() => {
    const first = f.querySelector('input,select,textarea');
    if (first) first.focus();
  }, 0);
}
function closeJoinModal(){
  const m = $id('joinModal');
  if (m) m.style.display = 'none';
  document.body.classList.remove('body-modal-open');
}
function openCancelModal(passengerId){
  const m = $id('cancelModal');
  const f = $id('cancelForm');
  const hidden = $id('cancelPassengerId');
  if (!m || !f || !hidden) return;
  hidden.value = passengerId;
  f.action = `/find/passenger/${passengerId}/cancel/`;
  m.style.display = 'block';
}

// 可選：把 join/cancel 攔截成 AJAX
(function enhanceJoinCancel(){
  const joinForm   = $id('joinForm');
  const cancelForm = $id('cancelForm');

  async function ajaxSubmit(form, okMsg){
    const body = new URLSearchParams(new FormData(form));
    const { res, data } = await jsonFetch(form.action, {
      method: 'POST',
      headers: { 'X-Requested-With': 'XMLHttpRequest' },
      body
    });
    if (res.ok && data.ok) {
      showToastSafe(okMsg || '成功', 'success');
      const modal = form.closest('.modal');
      if (modal) modal.style.display = 'none';
    } else {
      const msg = (data && (data.error || data.detail)) || `失敗（${res.status}）`;
      showToastSafe(msg, 'error');
    }
  }

  if (joinForm) {
    joinForm.addEventListener('submit', async (e) => {
      e.preventDefault();             // 要走同步 POST 的話，移除此行
      await ajaxSubmit(joinForm, '✅ 已送出申請');
    });
  }
  if (cancelForm) {
    cancelForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      await ajaxSubmit(cancelForm, '🗑️ 已取消');
    });
  }
})();

/* =========================================================================
 * 5) Join Modal 行為（帶入司機日期、控制回程欄位、最小日期限制）
 *    - openJoinModal(driverId, driverDate?, driverReturn?)
 *    - resetReturnDate()（可選）
 * ========================================================================= */
(function joinModalBehavior(){
  let currentDriverDate   = "";
  let currentDriverReturn = "";

  function grabJoinEls() {
    return {
      togetherSel: $id("join-together"),
      departInput: $id("join-date"),
      returnWrap : $id("returnField"),
      returnInput: $id("join-return"),
      joinModal  : $id("joinModal"),
      joinForm   : $id("joinForm"),
    };
  }

  function handleTogetherChange() {
    const { togetherSel, departInput, returnWrap, returnInput } = grabJoinEls();
    const v = togetherSel ? togetherSel.value : "";
    if (returnInput) {
      const minBase = (departInput && departInput.value) || currentDriverDate || "";
      returnInput.min = minBase;
    }
    if (v === "false") {
      if (returnWrap) returnWrap.style.display = "block";
      if (returnInput) {
        returnInput.readOnly = false;
        if (!returnInput.value && returnInput.min) returnInput.value = returnInput.min;
      }
    } else if (v === "true") {
      const hasReturn = !!currentDriverReturn;
      if (returnWrap) returnWrap.style.display = hasReturn ? "block" : "none";
      if (returnInput) {
        returnInput.readOnly = true;
        returnInput.value = hasReturn ? currentDriverReturn : "";
      }
    } else {
      if (returnWrap) returnWrap.style.display = "none";
      if (returnInput) { returnInput.readOnly = false; returnInput.value = ""; }
    }
  }

  function syncReturnMin() {
    const { departInput, returnInput } = grabJoinEls();
    if (!departInput || !returnInput) return;
    returnInput.min = departInput.value || currentDriverDate || "";
    if (returnInput.value && departInput.value && returnInput.value < departInput.value) {
      returnInput.value = "";
    }
  }

  window.openJoinModal = function (driverId, driverDate = "", driverReturn = "") {
    const { togetherSel, departInput, returnWrap, returnInput, joinModal, joinForm } = grabJoinEls();
    currentDriverDate   = driverDate || "";
    currentDriverReturn = driverReturn || "";
    if (departInput && currentDriverDate) departInput.value = currentDriverDate;
    if (togetherSel) togetherSel.value = "";
    if (returnInput) { returnInput.value = ""; returnInput.readOnly = false; }
    if (returnWrap) returnWrap.style.display = "none";
    syncReturnMin();
    if (joinForm)  joinForm.action  = `/find/driver/${driverId}/join/`;
    if (joinModal) joinModal.style.display = "block";
  };

  window.resetReturnDate = function () {
    const { returnInput } = grabJoinEls();
    if (returnInput) returnInput.value = "";
    syncReturnMin();
  };

  // 綁定（一次）
  if (!window.__JOIN_MODAL_BOUND__) {
    window.__JOIN_MODAL_BOUND__ = true;
    document.addEventListener("change", function (e) {
      if (e.target && e.target.id === "join-together") handleTogetherChange();
      if (e.target && e.target.id === "join-date")     syncReturnMin();
    });
    // 讓 data-action="join" 的按鈕可將 data-date / data-return 帶入
    document.addEventListener("click", function (e) {
      const btn = e.target.closest('[data-action="join"]');
      if (!btn) return;
      e.preventDefault();
      openJoinModal(btn.dataset.id, btn.dataset.date || "", btn.dataset.return || "");
    });
  }
})();

/* =========================================================================
 * 6) 參加表單：上車地點（下拉＋自填）→ 同步到隱藏欄位 name="departure"
 *    元素：
 *      #join-pickup-select（含「其他」）
 *      #join-pickup-custom（輸入框，選「其他」才顯示）
 *      #join-pickup（hidden，真正送後端的 departure）
 *      #joinForm
 * ========================================================================= */
(function pickupFieldBinding(){
  if (window.__PICKUP_BIND__) return; // 防重複
  window.__PICKUP_BIND__ = true;

  const PICKUP_SELECT_ID = "join-pickup-select";
  const PICKUP_CUSTOM_ID = "join-pickup-custom";
  const PICKUP_HIDDEN_ID = "join-pickup";
  const JOIN_FORM_ID     = "joinForm";

  function getEls() {
    return {
      sel   : $id(PICKUP_SELECT_ID),
      custom: $id(PICKUP_CUSTOM_ID),
      hidden: $id(PICKUP_HIDDEN_ID),
      form  : $id(JOIN_FORM_ID),
    };
  }
  function applyPickupUI() {
    const { sel, custom } = getEls();
    if (!sel || !custom) return;
    if (sel.value === "其他") {
      custom.style.display = "block";
    } else {
      custom.style.display = "none";
      custom.value = "";
    }
  }
  function syncHidden() {
    const { sel, custom, hidden } = getEls();
    if (!sel || !custom || !hidden) return;
    hidden.value = (sel.value === "其他") ? (custom.value || "").trim() : (sel.value || "");
  }

  // 事件委派一次搞定
  document.addEventListener("change", (e) => {
    if (e.target && e.target.id === PICKUP_SELECT_ID) {
      applyPickupUI(); syncHidden();
    }
  });
  document.addEventListener("input", (e) => {
    if (e.target && e.target.id === PICKUP_CUSTOM_ID) syncHidden();
  });
  document.addEventListener("submit", (e) => {
    const { form } = getEls();
    if (form && e.target === form) syncHidden();
  });

  // 對外重置（打開 Modal 時可用）
  window.resetPickupField = function(){
    const { sel, custom, hidden } = getEls();
    if (!sel || !custom || !hidden) return;
    sel.value = ""; custom.value = ""; custom.style.display = "none"; hidden.value = "";
  };

  // 初始套用一次
  setTimeout(() => { applyPickupUI(); syncHidden(); }, 0);
})();

/* =========================================================================
 * 7) 乘客：密碼驗證 →（編輯｜刪除）/ 編輯儲存 / 刪除
 *    - 事件委派： [data-pax-edit], [data-pax-del]
 *    - 可用 window.afterPaxChanged?.({action, id}) 作為更新鉤子
 * ========================================================================= */
// Modal 開關
function openPaxAuth (pid) {
  const idEl  = $id('paxAuthId');
  const pwdEl = $id('paxAuthPassword');
  const modal = $id('paxAuthModal');
  if (!idEl || !pwdEl || !modal) return;
  idEl.value = pid; pwdEl.value = '';
  modal.style.display = 'block';
  setTimeout(() => pwdEl.focus(), 0);
}
function closePaxAuth () { const m = $id('paxAuthModal'); if (m) m.style.display = 'none'; }
function openPaxEdit ()  { const m = $id('paxEditModal'); if (m) m.style.display  = 'block'; }
function closePaxEdit () { const m = $id('paxEditModal'); if (m) m.style.display  = 'none'; }

let __paxNextAction = null;

// 委派：編輯 / 刪除 → 先驗證密碼
document.addEventListener('click', (e) => {
  const editBtn = e.target.closest('[data-pax-edit]');
  if (editBtn){ e.preventDefault(); __paxNextAction = 'edit';   openPaxAuth(editBtn.dataset.id); return; }
  const delBtn  = e.target.closest('[data-pax-del]');
  if (delBtn){  e.preventDefault(); __paxNextAction = 'delete'; openPaxAuth(delBtn.dataset.id); return; }
});

async function submitPaxAuth () {
  const pid = $id('paxAuthId')?.value;
  const pwd = $id('paxAuthPassword')?.value;
  if (!pid || !pwd) { showToastSafe('請輸入密碼', 'error'); return; }

  try {
    const { res, data } = await jsonFetch(`/find/pax/${pid}/auth/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': getCSRF(),
        'X-Requested-With': 'XMLHttpRequest',
        'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8',
      },
      body: new URLSearchParams({ password: pwd })
    });
    if (!res.ok || !data.ok) { showToastSafe(data.error || '驗證失敗', 'error'); return; }
    closePaxAuth();
    if (__paxNextAction === 'delete') { await doPaxDelete(pid); return; }
    if (__paxNextAction === 'edit')   { await loadPaxAndOpenEdit(pid); return; }
  } catch (err) {
    console.error(err);
    showToastSafe('伺服器錯誤，稍後再試', 'error');
  } finally {
    __paxNextAction = null;
  }
}
window.submitPaxAuth = submitPaxAuth;

async function loadPaxAndOpenEdit (pid) {
  const { res, data } = await jsonFetch(`/find/pax/${pid}/get/`, {
    headers: { 'X-Requested-With': 'XMLHttpRequest' }
  });
  if (!res.ok || !data.ok) { showToastSafe(data.error || '讀取資料失敗', 'error'); return; }
  const p = data.p || {};
  ($id('paxEditId')       || {}).value = p.id ?? '';
  ($id('paxName')         || {}).value = p.passenger_name ?? '';
  ($id('paxGender')       || {}).value = p.gender ?? 'X';
  ($id('paxEmail')        || {}).value = p.email ?? '';
  ($id('paxContact')      || {}).value = p.contact ?? '';
  ($id('paxSeats')        || {}).value = p.seats_needed ?? 1;
  ($id('paxPay')          || {}).value = p.willing_to_pay ?? '';
  ($id('paxDeparture')    || {}).value = p.departure ?? '';
  ($id('paxDestination')  || {}).value = p.destination ?? '';
  ($id('paxDate')         || {}).value = p.date ?? '';
  ($id('paxReturn')       || {}).value = p.return_date ?? '';
  ($id('paxTogether')     || {}).value = p.together_return ?? '';
  ($id('paxNote')         || {}).value = p.note ?? '';
  openPaxEdit();
}

async function submitPaxEdit () {
  const form = $id('paxEditForm');
  const pid  = $id('paxEditId')?.value;
  if (!form || !pid) return;
  const btn = form.querySelector('[type="button"],[type="submit"]');
  if (btn) btn.disabled = true;
  try {
    const body = new URLSearchParams(new FormData(form));
    const { res, data } = await jsonFetch(`/find/pax/${pid}/update/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': getCSRF(),
        'X-Requested-With': 'XMLHttpRequest',
        'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8',
      },
      body
    });
    if (!res.ok || !data.ok) { showToastSafe(data.error || '更新失敗', 'error'); return; }
    showToastSafe('✅ 已更新乘客資料', 'success');
    closePaxEdit();
    window.afterPaxChanged && window.afterPaxChanged({ action: 'update', id: Number(pid) });
  } catch (err) {
    console.error(err);
    showToastSafe('伺服器錯誤，稍後再試', 'error');
  } finally {
    if (btn) btn.disabled = false;
  }
}
window.submitPaxEdit = submitPaxEdit;

async function doPaxDelete (pid) {
  if (!confirm('確定要刪除這位乘客嗎？此動作無法復原。')) return;
  try {
    const { res, data } = await jsonFetch(`/find/pax/${pid}/delete/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': getCSRF(),
        'X-Requested-With': 'XMLHttpRequest',
        'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8',
      },
      body: new URLSearchParams()
    });
    if (!res.ok || !data.ok) { showToastSafe(data.error || '刪除失敗', 'error'); return; }
    showToastSafe('🗑️ 已刪除乘客', 'success');
    window.afterPaxChanged && window.afterPaxChanged({ action: 'delete', id: Number(pid) });
  } catch (err) {
    console.error(err);
    showToastSafe('伺服器錯誤，稍後再試', 'error');
  }
}

/* =========================================================================
 * 8) 乘客編輯 Modal：together_return 與回程日期聯動
 * ========================================================================= */
(function paxEditReturnLink(){
  const togetherSel = document.getElementById('paxTogether');
  const returnInput = document.getElementById('paxReturn');
  function syncReturnState () {
    if (!togetherSel || !returnInput) return;
    const v = togetherSel.value;
    if (v === 'true') {
      returnInput.value = '';
      returnInput.disabled = true;
      returnInput.placeholder = '與司機回程日期相同';
      returnInput.classList.add('is-disabled');
    } else {
      returnInput.disabled = false;
      returnInput.placeholder = '';
      returnInput.classList.remove('is-disabled');
    }
  }
  if (togetherSel && returnInput) {
    togetherSel.addEventListener('change', syncReturnState);
  }
  window.syncPaxReturnOnce = syncReturnState; // 可在打開編輯 Modal 後呼叫一次
})();

/* =========================================================================
 * 9) 頁面級事件委派：管理 / 參加 / 展開（避免動態內容失效）
 * ========================================================================= */
document.addEventListener('click', function (e) {
  const btn = e.target.closest('[data-action]');
  if (!btn) return;

  const action   = btn.dataset.action;
  const driverId = btn.dataset.id;
  if (!action || !driverId) return;

  if (action === 'manage') {
    e.preventDefault();
    openDriverModal(driverId);
    return;
  }
  if (action === 'join') {
    e.preventDefault();
    // 若 _driver_list.html 上有 data-date / data-return 就讀取，否則 fallback
    openJoinModal(driverId, btn.dataset.date || "", btn.dataset.return || "");
    return;
  }
  if (action === 'toggle') {
    e.preventDefault();
    const details = $id('details-' + driverId);
    const arrow   = $id('arrow-' + driverId) || btn;
    if (!details) return;
    const isOpen = details.classList.toggle('open');
    arrow.classList.toggle('open', isOpen);
    arrow.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
    details.setAttribute('aria-hidden', isOpen ? 'false' : 'true');
    return;
  }
});

/* =========================================================================
 * 10) 其他：後端事件（可選）。例：透過 WS 主動告知「管理某司機」
 * ========================================================================= */
window.manageDriver = function (driverId) {
  try { socket.send(JSON.stringify({ action: 'driver_manage', driver_id: driverId })); }
  catch (e) { console.warn('WS send 失敗', e); }
};


// 綁定一組出發/回程欄位的防呆
// params: { depart: '#出發input', ret: '#回程input', form: '#表單', msg?: '自訂錯誤訊息' }
function bindDateGuard({ depart, ret, form, msg }){
  const dep = document.querySelector(depart);
  const rtn = document.querySelector(ret);
  const frm = form ? document.querySelector(form) : null;
  if(!dep || !rtn) return;

  // 即時：回程最小日 ≧ 出發
  function syncMin(){
    rtn.min = dep.value || '';
    if(rtn.value && dep.value && rtn.value < dep.value){
      rtn.value = ''; // 自動清空無效值
    }
  }
  dep.addEventListener('change', syncMin);
  // 初始跑一次
  syncMin();

  // 送出時：硬性檢查，不符就擋下
  function checkOnSubmit(e){
    if(dep.value && rtn.value && rtn.value < dep.value){
      e && e.preventDefault();
      alert(msg || '回程日期不可早於出發日期');
      rtn.focus();
      return false;
    }
    return true;
  }

  if(frm){
    frm.addEventListener('submit', checkOnSubmit);
  }
  // 若要在 JS 手動檢查也能呼叫：
  return { check: checkOnSubmit, syncMin };

  document.addEventListener('DOMContentLoaded', () => {
  bindDateGuard({
    depart: '#paxDate',
    ret: '#paxReturn',
    form: '#paxEditForm'
  });
});
}
</script>



</body>
</html>
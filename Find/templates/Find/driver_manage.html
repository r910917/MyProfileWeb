<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>🛠 司機管理</title>
  <style>
/* ========== Base ========== */
:root{
  --clr-primary:#007bff;
  --clr-primary-2:#0056b3;
  --clr-accent:#00b894;
}
*{box-sizing:border-box}
body{
  font-family:"Microsoft JhengHei",sans-serif;
  background:linear-gradient(to right,#f0f9ff,#fefefe);
  margin:0; padding:40px 20px;
}
h2{ text-align:center; color:#005c4b; margin-bottom:25px; font-size:26px; }
@keyframes fadeIn{ from{opacity:0;transform:translateY(20px)} to{opacity:1;transform:translateY(0)} }

/* ========== Forms ========== */
form{
  max-width:600px;margin:0 auto;background:#fff;
  padding:25px 30px;border-radius:16px;
  box-shadow:0 6px 12px rgba(0,0,0,.1);animation:fadeIn .5s ease-in-out;
}
label{font-weight:700;display:block;margin:12px 0 6px;color:#444}
input,textarea,select{
  width:100%;padding:12px;margin-bottom:10px;border-radius:10px;
  border:1px solid #ccc;transition:border-color .3s,box-shadow .3s;font-size:15px;
}
input:focus,textarea:focus,select:focus{
  border-color:var(--clr-primary);
  box-shadow:0 0 8px rgba(0,123,255,.3); outline:none;
}
textarea{min-height:80px;resize:vertical}
.required::after{content:" *";color:red}

/* ========== Buttons ========== */
.btn{
  width:100%;padding:14px;border:0;border-radius:10px;
  background:linear-gradient(45deg,var(--clr-primary),var(--clr-accent));
  color:#fff;font-size:18px;font-weight:700;cursor:pointer;
  transition:background .3s,transform .2s;
}
.btn:hover{background:linear-gradient(45deg,var(--clr-primary-2),#009e77);transform:scale(1.02)}
.btn-danger{background:linear-gradient(45deg,#ef4444,#f97316)}
.btn-danger:hover{background:linear-gradient(45deg,#b91c1c,#ea580c)}
.btn-ghost{
  width:100%;padding:14px;border:0;border-radius:10px;
  background:linear-gradient(45deg,var(--clr-primary),var(--clr-accent));
  color:#fff;font-size:18px;font-weight:700;cursor:pointer;transition:background .3s,transform .2s;
}
.btn-ghost:hover{background:linear-gradient(45deg,#0fbfd2,#402fc7);transform:scale(1.02)}
.btn-mini{
  padding:8px 12px;border:0;border-radius:8px;line-height:1;font-weight:600;cursor:pointer;
}
.btn-mini:hover{filter:brightness(.97)}
.btn-mini.ok{background:#dcfce7;color:#065f46}
.btn-mini.danger{background:#fee2e2;color:#7f1d1d}
.btn-mini.memo{background:#e0e7ff;color:#3730a3}

/* ========== Alerts ========== */
.alert{max-width:600px;margin:0 auto 12px;padding:12px 14px;border-radius:10px}
.alert-ok{background:#e8f8ef;color:#206b3a;border:1px solid #a7e2bf}
.alert-warn{background:#fff7e6;color:#9a6b00;border:1px solid #f7d7a3}

/* ========== Passenger cards ========== */
.panel{max-width:900px;margin:18px auto}
.pax-list{list-style:none;margin:10px auto 0;padding:0;max-width:900px}
.pax-item{
  background:#fff;border:1px solid #e5e7eb;border-radius:12px;
  padding:14px 16px;margin:10px 0;box-shadow:0 3px 8px rgba(0,0,0,.05)
}
.pax-row{display:grid;grid-template-columns:1fr auto;grid-row-gap:10px;align-items:start}
.pax-head{grid-column:1/-1;display:flex;align-items:center;gap:8px}
.pax-name{font-weight:700;font-size:15px}
.badge{font-size:12px;padding:2px 8px;border-radius:999px;background:#eef2ff;color:#4338ca}
.badge.gender{background:#e0f2fe;color:#0369a1}
.badge.rt{background:#fef3c7;color:#92400e}
.pax-grid{
  grid-column:1/-1;display:grid;grid-template-columns:repeat(6,minmax(0,1fr));
  gap:10px 14px
}
.pax-cell label{display:block;font-size:12px;color:#6b7280;margin-bottom:4px;letter-spacing:.02em}
.pax-cell div{font-size:14px;color:#111827}
.pax-cell.span-2{grid-column:span 2}
.pax-actions{
  display:flex;
  gap:8px;
  justify-content:flex-end; /* 內容向右 */
  align-self:end;           /* 在 grid 列中靠下 */
  justify-self:end;         /* 在 grid 欄位靠右 */
  grid-column: 1 / -1;      /* 需要時讓整列橫跨，才能貼到最右邊 */
}

/* ========== Note & Memo ribbons ========== */
.pax-note, .pax-memo{
  grid-column: 1 / -1;
  position:relative;
  display:grid; grid-template-columns:92px 1fr auto;
  align-items:center; gap:10px 14px; padding:10px 12px;
  border-radius:10px; margin:10px 0 8px; border:1px solid transparent;
}
.pax-note{ background:#fff7ed; border-color:#ffe6c7; }
.pax-note .label{ font-weight:700; color:#9a6700; }
.pax-memo{ background:#eef6ff; border-color:#dbeafe; }
.pax-memo .label{ font-weight:700; color:#1d4ed8; }
.pax-memo .memo-text{ color:#0f172a; word-break:break-word; }
.pax-memo .memo-actions{ display:flex; gap:8px; justify-self:end; }
/* 左側色條 */
.pax-note::before, .pax-memo::before{
  content:""; position:absolute; left:0; top:0; bottom:0; width:6px; border-radius:10px 0 0 10px;
}
.pax-note::before{ background:#f59e0b; }
.pax-memo::before{ background:#3b82f6; }

/* ========== Switch (toggle) ========== */
.switch{
  display:flex;align-items:center;justify-content:center;gap:12px;margin:10px 0;
}
.switch input[type="checkbox"]{position:absolute;opacity:0;width:0;height:0}
.switch .toggle{
  position:relative;width:52px;height:30px;border-radius:999px;background:#e5e7eb;
  box-shadow:inset 0 0 0 1px rgba(0,0,0,.06);transition:background .2s ease;cursor:pointer;display:inline-block;
}
.switch .toggle::after{
  content:"";position:absolute;top:3px;left:3px;width:24px;height:24px;border-radius:50%;background:#fff;
  box-shadow:0 1px 2px rgba(0,0,0,.2);transition:transform .2s ease;
}
.switch input[type="checkbox"]:checked + .toggle{ background:#10b981 }
.switch input[type="checkbox"]:checked + .toggle::after{ transform:translateX(22px) }
.switch .toggle.is-disabled{opacity:.6;cursor:not-allowed}
.switch label{font-weight:600;color:#374151;cursor:pointer}
.switch .hint{display:block;font-size:12px;color:#6b7280;margin-top:2px;text-align:center}

/* ========== Responsive ========== */
@media (max-width:1024px){ .pax-grid{grid-template-columns:repeat(4,minmax(0,1fr))} }
@media (max-width:768px){
  form{padding:18px 16px}
  .pax-row{grid-template-columns:1fr}
  .pax-actions{justify-content:flex-end}
  .pax-grid{grid-template-columns:repeat(2,minmax(0,1fr))}
  .pax-cell.span-2{grid-column:1/-1}
  .pax-note, .pax-memo{grid-template-columns:1fr;gap:6px}
  .pax-memo .memo-actions{justify-self:start}
  .switch .toggle{width:56px;height:34px}
  .switch .toggle::after{width:26px;height:26px;top:4px;left:4px;transform:none}
  .switch input[type="checkbox"]:checked + .toggle::after{transform:translateX(22px)}
}
@media (max-width:480px){ .pax-grid{grid-template-columns:1fr} }
</style>

</head>
<body>
  <h2>🛠 司機管理</h2>

  {% if saved_msg %}<div class="alert alert-ok">{{ saved_msg }}</div>{% endif %}
  {% if matched_msg %}<div class="alert alert-ok">{{ matched_msg }}</div>{% endif %}
  {% if full_msg %}<div class="alert alert-warn">{{ full_msg }}</div>{% endif %}

  <!-- A) 編輯司機資料 -->
  <!-- 省略前段相同 CSS 與 <body> 開頭 -->

  <!-- A) 編輯司機資料 -->
  <form method="POST">
    {% csrf_token %}
    <input type="hidden" name="form" value="update_driver" />

    <label class="required">暱稱</label>
    <input type="text" name="driver_name" value="{{ driver.driver_name }}" required />

    <label class="required">性別</label>
    <select name="gender" required>
      <option value="M" {% if driver.gender == 'M' %}selected{% endif %}>男生</option>
      <option value="F" {% if driver.gender == 'F' %}selected{% endif %}>女生</option>
      <option value="X" {% if driver.gender == 'X' %}selected{% endif %}>不方便透漏</option>
    </select>

    <label>Email（選填）</label>
    <input type="email" id="email" name="email" value="{{ driver.email|default_if_none:'' }}" />

    <!-- 🔒 隱私：需要 Email 才能啟用 -->
    <div class="switch" id="privacy-switch" style="margin-top:6px;">
      <input type="checkbox"
             id="hide_contact"
             name="hide_contact"
             {% if driver.hide_contact %}checked{% endif %} />
      <span class="toggle"></span>
      <label for="hide_contact">隱藏個資（聯絡方式）</label>
    </div>
    <span id="privacyHint" class="hint">需填寫 Email 才能隱藏；Email 僅供系統通知，不會公開。</span>

    <label class="required" style="margin-top:14px;">聯絡方式</label>
    <input type="text" name="contact" value="{{ driver.contact }}" placeholder="LINE / IG / Phone Number" required />

    <label>管理密碼（留空不變更）</label>
    <input type="password" name="passwordf" placeholder="留空不修改" />

    <label class="required">總座位</label>
    <input type="number" id="seats_total" name="seats_total" min="1" value="{{ driver.seats_total }}" required />

    <!-- 出發地（下拉 + 自填） -->
    {% with has_dep_custom=driver.departure_custom %}
    <label class="required">出發地</label>
    <select name="departure" id="departure" onchange="checkCustomDeparture(this)" required>
      <option value="" {% if not driver.departure and not has_dep_custom %}selected{% endif %}>請選擇縣市</option>
      <option value="自填" {% if has_dep_custom %}selected{% endif %}>其他</option>
      <option value="花蓮縣光復鄉" {% if not has_dep_custom and driver.departure == '花蓮縣光復鄉' %}selected{% endif %}>花蓮縣光復鄉</option>
      <option value="花蓮縣光復車站以外火車站" {% if not has_dep_custom and driver.departure == '花蓮縣光復車站以外火車站' %}selected{% endif %}>花蓮縣光復車站以外火車站</option>
      <option value="花蓮縣光復車站" {% if not has_dep_custom and driver.departure == '花蓮縣光復車站' %}selected{% endif %}>花蓮縣光復車站</option>
      <option value="光復鄉糖廠" {% if not has_dep_custom and driver.departure == '光復鄉糖廠' %}selected{% endif %}>光復鄉糖廠</option>
      <option value="需清淤地區" {% if not has_dep_custom and driver.departure == '需清淤地區' %}selected{% endif %}>需清淤地區</option>
      <option value="台北市" {% if not has_dep_custom and driver.departure == '台北市' %}selected{% endif %}>台北市</option>
      <option value="新北市" {% if not has_dep_custom and driver.departure == '新北市' %}selected{% endif %}>新北市</option>
      <option value="基隆市" {% if not has_dep_custom and driver.departure == '基隆市' %}selected{% endif %}>基隆市</option>
      <option value="桃園市" {% if not has_dep_custom and driver.departure == '桃園市' %}selected{% endif %}>桃園市</option>
      <option value="新竹市" {% if not has_dep_custom and driver.departure == '新竹市' %}selected{% endif %}>新竹市</option>
      <option value="新竹縣" {% if not has_dep_custom and driver.departure == '新竹縣' %}selected{% endif %}>新竹縣</option>
      <option value="苗栗縣" {% if not has_dep_custom and driver.departure == '苗栗縣' %}selected{% endif %}>苗栗縣</option>
      <option value="台中市" {% if not has_dep_custom and driver.departure == '台中市' %}selected{% endif %}>台中市</option>
      <option value="彰化縣" {% if not has_dep_custom and driver.departure == '彰化縣' %}selected{% endif %}>彰化縣</option>
      <option value="南投縣" {% if not has_dep_custom and driver.departure == '南投縣' %}selected{% endif %}>南投縣</option>
      <option value="雲林縣" {% if not has_dep_custom and driver.departure == '雲林縣' %}selected{% endif %}>雲林縣</option>
      <option value="嘉義市" {% if not has_dep_custom and driver.departure == '嘉義市' %}selected{% endif %}>嘉義市</option>
      <option value="嘉義縣" {% if not has_dep_custom and driver.departure == '嘉義縣' %}selected{% endif %}>嘉義縣</option>
      <option value="台南市" {% if not has_dep_custom and driver.departure == '台南市' %}selected{% endif %}>台南市</option>
      <option value="高雄市" {% if not has_dep_custom and driver.departure == '高雄市' %}selected{% endif %}>高雄市</option>
      <option value="屏東縣" {% if not has_dep_custom and driver.departure == '屏東縣' %}selected{% endif %}>屏東縣</option>
      <option value="宜蘭縣" {% if not has_dep_custom and driver.departure == '宜蘭縣' %}selected{% endif %}>宜蘭縣</option>
      <option value="花蓮縣" {% if not has_dep_custom and driver.departure == '花蓮縣' %}selected{% endif %}>花蓮縣</option>
      <option value="台東縣" {% if not has_dep_custom and driver.departure == '台東縣' %}selected{% endif %}>台東縣</option>
      <option value="澎湖縣" {% if not has_dep_custom and driver.departure == '澎湖縣' %}selected{% endif %}>澎湖縣</option>
      <option value="金門縣" {% if not has_dep_custom and driver.departure == '金門縣' %}selected{% endif %}>金門縣</option>
      <option value="連江縣" {% if not has_dep_custom and driver.departure == '連江縣' %}selected{% endif %}>連江縣</option>
    </select>
    <input type="text"
           id="customDeparture"
           name="departure_custom"
           value="{{ driver.departure_custom|default:'' }}"
           style="display:{% if has_dep_custom %}block{% else %}none{% endif %};"
           placeholder="輸入自訂出發地" />
    {% endwith %}

    <!-- 目的地（下拉 + 自填） -->
    {% with has_des_custom=driver.destination_custom %}
    <label>目的地</label>
    <select name="destination" id="destination" onchange="checkCustomDestination(this)">
      <option value="" {% if not driver.destination and not has_des_custom %}selected{% endif %}>請選擇縣市</option>
      <option value="自填" {% if has_des_custom %}selected{% endif %}>其他</option>
      <option value="花蓮縣光復鄉" {% if not has_des_custom and driver.destination == '花蓮縣光復鄉' %}selected{% endif %}>花蓮縣光復鄉</option>
      <option value="花蓮縣光復車站以外火車站" {% if not has_des_custom and driver.destination == '花蓮縣光復車站以外火車站' %}selected{% endif %}>花蓮縣光復車站以外火車站</option>
      <option value="花蓮縣光復車站" {% if not has_des_custom and driver.destination == '花蓮縣光復車站' %}selected{% endif %}>花蓮縣光復車站</option>
      <option value="光復鄉糖廠" {% if not has_des_custom and driver.destination == '光復鄉糖廠' %}selected{% endif %}>光復鄉糖廠</option>
      <option value="需清淤地區" {% if not has_des_custom and driver.destination == '需清淤地區' %}selected{% endif %}>需清淤地區</option>
      <option value="台北市" {% if not has_des_custom and driver.destination == '台北市' %}selected{% endif %}>台北市</option>
      <option value="新北市"  {% if not has_des_custom and driver.destination == '新北市' %}selected{% endif %}>新北市</option>
      <option value="基隆市"  {% if not has_des_custom and driver.destination == '基隆市' %}selected{% endif %}>基隆市</option>
      <option value="桃園市"  {% if not has_des_custom and driver.destination == '桃園市' %}selected{% endif %}>桃園市</option>
      <option value="新竹市"  {% if not has_des_custom and driver.destination == '新竹市' %}selected{% endif %}>新竹市</option>
      <option value="新竹縣"  {% if not has_des_custom and driver.destination == '新竹縣' %}selected{% endif %}>新竹縣</option>
      <option value="苗栗縣"  {% if not has_des_custom and driver.destination == '苗栗縣' %}selected{% endif %}>苗栗縣</option>
      <option value="台中市"  {% if not has_des_custom and driver.destination == '台中市' %}selected{% endif %}>台中市</option>
      <option value="彰化縣"  {% if not has_des_custom and driver.destination == '彰化縣' %}selected{% endif %}>彰化縣</option>
      <option value="南投縣"  {% if not has_des_custom and driver.destination == '南投縣' %}selected{% endif %}>南投縣</option>
      <option value="雲林縣"  {% if not has_des_custom and driver.destination == '雲林縣' %}selected{% endif %}>雲林縣</option>
      <option value="嘉義市"  {% if not has_des_custom and driver.destination == '嘉義市' %}selected{% endif %}>嘉義市</option>
      <option value="嘉義縣"  {% if not has_des_custom and driver.destination == '嘉義縣' %}selected{% endif %}>嘉義縣</option>
      <option value="台南市"  {% if not has_des_custom and driver.destination == '台南市' %}selected{% endif %}>台南市</option>
      <option value="高雄市"  {% if not has_des_custom and driver.destination == '高雄市' %}selected{% endif %}>高雄市</option>
      <option value="屏東縣"  {% if not has_des_custom and driver.destination == '屏東縣' %}selected{% endif %}>屏東縣</option>
      <option value="宜蘭縣"  {% if not has_des_custom and driver.destination == '宜蘭縣' %}selected{% endif %}>宜蘭縣</option>
      <option value="花蓮縣"  {% if not has_des_custom and driver.destination == '花蓮縣' %}selected{% endif %}>花蓮縣</option>
      <option value="台東縣"  {% if not has_des_custom and driver.destination == '台東縣' %}selected{% endif %}>台東縣</option>
      <option value="澎湖縣"  {% if not has_des_custom and driver.destination == '澎湖縣' %}selected{% endif %}>澎湖縣</option>
      <option value="金門縣"  {% if not has_des_custom and driver.destination == '金門縣' %}selected{% endif %}>金門縣</option>
      <option value="連江縣"  {% if not has_des_custom and driver.destination == '連江縣' %}selected{% endif %}>連江縣</option>
    </select>
    <input type="text"
           id="customDestination"
           name="destination_custom"
           value="{{ driver.destination_custom|default:'' }}"
           style="display:{% if has_des_custom %}block{% else %}none{% endif %};"
           placeholder="輸入自訂目的地" />
    {% endwith %}

    <label>酌收費用（選填）</label>
    <input type="text" name="fare_note" value="{{ driver.fare_note|default_if_none:'' }}" placeholder="例如：每人 200、油錢均攤、視里程而定…" />

    <label class="required">出發日期</label>
    <input type="date" name="date" id="driver-date" value="{{ driver.date|date:'Y-m-d' }}" required />

    <label>回程日期（選填）</label>
    <input type="date" name="return_date" id="driver-return" value="{{ driver.return_date|date:'Y-m-d' }}" />

    <label>順路接送意願</label>
    <select name="flexible_pickup">
      <option value="YES" {% if driver.flexible_pickup == 'YES' %}selected{% endif %}>順路可載</option>
      <option value="NO"  {% if driver.flexible_pickup == 'NO'  %}selected{% endif %}>不順路也OK</option>
      <option value="MAYBE" {% if driver.flexible_pickup == 'MAYBE' %}selected{% endif %}>視情況</option>
    </select>

    <div class="switch" id="active-switch">
      <input type="checkbox" name="is_active" id="is_active" {% if driver.is_active %}checked{% endif %} />
      <span class="toggle"></span>
      <label for="is_active">是否開放（座位滿會自動關閉）</label>
    </div>

    <label>備註</label>
    <textarea id="driverNote" name="note" row="3" placeholder="備註(選填)">{{ driver.note|default_if_none:'' }}</textarea>

    <button class="btn" type="submit">💾 儲存</button>

    <div style="max-width:600px;margin:0 auto 8px;">
      <a href="{% url 'find_index' %}" class="btn-ghost" style="display:inline-block;text-decoration:none;text-align:center;width:96%;padding:12px;margin-top:10px;border-radius:10px;font-weight:700;">
        🏠 回首頁
      </a>
    </div>
  </form>

  <!-- 刪除司機表單（保留 CSRF 與 action） -->
<form id="deleteDriverForm"
      method="POST"
      action="{% url 'delete_driver' driver.id %}"
      style="max-width:600px;margin:14px auto 0;"
      onsubmit="return handleDeleteDriverSubmit(event)">
  {% csrf_token %}
  <button id="deleteDriverBtn" class="btn btn-danger" type="submit">🗑️ 取消出車</button>
</form>

  <!-- 乘客清單（原樣） -->
<!-- C) 已登記乘客（升級：接受 / 拒絕 / 司機備忘錄） -->
<div class="panel" id="manage-panels">
  {% csrf_token %}
  {% include "Find/_manage_panels.html" %}
</div>

<div id="driver-meta" data-driver-id="{{ driver.id }}"></div>

</div>

  <script>
    const driverId = "{{ driver.id }}";
    const proto = location.protocol === "https:" ? "wss" : "ws";
    // 出發/目的自填顯示（原樣）
    function checkCustomDeparture(select){
      const customInput = document.getElementById('customDeparture');
      if (!customInput) return;
      const show = (select.value === '自填');
      customInput.style.display = show ? 'block' : 'none';
      customInput.required = show;
      if (!show) customInput.value = '';
    }
    function checkCustomDestination(select){
      const input = document.getElementById('customDestination');
      if (!input) return;
      const show = (select.value === '自填');
      input.style.display = show ? 'block' : 'none';
      input.required = show;
      if (!show) input.value = '';
    }

    // 日期防呆（原樣）
    document.addEventListener('DOMContentLoaded', () => {
      const dep = document.getElementById('driver-date');
      const ret = document.getElementById('driver-return');
      const today = new Date().toISOString().split('T')[0];
      if (!dep || !ret) return;
      function syncMin(){
        dep.min = today;
        ret.min = dep.value || today;
        if (ret.value && ret.value < ret.min) ret.value = '';
      }
      dep.addEventListener('change', syncMin);
      ret.addEventListener('change', syncMin);
      syncMin();
    });

    // 初始化「自填」展開
    (function(){
      const depSel = document.getElementById('departure');
      const desSel = document.getElementById('destination');
      if (depSel) checkCustomDeparture(depSel);
      if (desSel) checkCustomDestination(desSel);
    })();

    function getCsrfToken() {
    // 從表單 hidden input 拿 CSRF
    const tokenInput = document.querySelector('#deleteDriverForm input[name=csrfmiddlewaretoken]');
    return tokenInput ? tokenInput.value : '';
  }

    // ✅ 隱私開關：需要 Email 才能啟用
(function () {
  const wrap   = document.getElementById('privacy-switch');
  const email  = document.getElementById('email');           // 司機的 Email 欄
  const cb     = document.getElementById('hide_contact');    // 司機的隱私 checkbox
  const knob   = wrap?.querySelector('.toggle');
  const hintEl = document.getElementById('privacyHint');
  if (!wrap || !email || !cb) return;

  function syncDriverPrivacy () {
    const hasEmail = !!email.value.trim();

    // 沒 Email → 一律上鎖且強制關閉
    if (!hasEmail) {
      cb.checked  = false;          // 只有沒 Email 時才強制改為關閉
      cb.disabled = true;
      knob?.classList.add('is-disabled');
      if (hintEl) { hintEl.textContent = '尚未填寫 Email，無法隱藏聯絡方式。'; hintEl.style.color = '#9a6b00'; }
      return;
    }

    // 有 Email → 只解鎖，不改變使用者勾選結果
    cb.disabled = false;            // 讓使用者自己決定勾/不勾
    knob?.classList.remove('is-disabled');
    if (hintEl) { hintEl.textContent = '需填寫 Email 才能隱藏；Email 僅供系統通知，不會公開。'; hintEl.style.color = '#6b7280'; }
  }

  // 讓點擊滑桿也能切換（被鎖定時不動）
  knob?.addEventListener('click', () => {
    if (cb.disabled) return;
    cb.checked = !cb.checked;
  });

  // Email 變動時重新同步；初始化跑一次（保留伺服器初始 checked）
  email.addEventListener('input', syncDriverPrivacy);
  syncDriverPrivacy();

  // 如果你有從後端 AJAX 回填司機資料，可在回填後呼叫這個
  window.syncDriverPrivacy = syncDriverPrivacy;
})();

    // 是否開放 switch 鎖定（你原本的腳本保留）
    (function () {
  const wrap    = document.getElementById('active-switch');
  if (!wrap) return;
  const elActive= document.getElementById('is_active');
  const elToggle= wrap.querySelector('.toggle');
  const elLabel = wrap.querySelector('label');

  // 建立提示：插在「是否開放」這組開關下面
  let hint = wrap.querySelector('#active-hint');
  if (!hint) {
    hint = document.createElement('span');
    hint.id = 'active-hint';
    hint.className = 'hint';
    elLabel.insertAdjacentElement('afterend', hint);
  }

  // 取得 filled（與你原本一致）
  function getFilled() {
    const h = document.getElementById('seats_filled_val');
    if (h && h.value !== undefined) {
      const n = parseInt(h.value, 10);
      return Number.isFinite(n) ? n : 0;
    }
    const meta = document.getElementById('driver-meta');
    if (meta?.dataset?.seatsFilled !== undefined) {
      const n = parseInt(meta.dataset.seatsFilled, 10);
      return Number.isFinite(n) ? n : 0;
    }
    return 0;
  }

  const elTotal = document.getElementById('seats_total');

  function setHint(text, tone){
    hint.textContent = text || '';
    hint.style.color = (tone === 'warn') ? '#9a6b00'
                    : (tone === 'ok')   ? '#206b3a'
                    : '#6b7280';
  }

  function refreshLock() {
    const filled = getFilled();
    const total  = parseInt(elTotal && elTotal.value, 10);
    const totalSafe = Number.isFinite(total) ? Math.max(1, total) : 1;

    if (filled >= totalSafe) {
      elActive.checked = false;
      elActive.disabled = true;
      elToggle.classList.add('is-disabled');
      setHint(`座位已滿（${filled}/${totalSafe}），已自動關閉`, 'warn');
      elActive.title = '座位已滿時不可開放';
    } else {
      elActive.disabled = false;
      elToggle.classList.remove('is-disabled');
      elActive.title = '';
      setHint(elActive.checked ? '目前狀態：已開放' : '目前狀態：未開放', elActive.checked ? 'ok' : '');
    }
  }

      elToggle.addEventListener('click', () => {
        if (elActive.disabled) return;
        elActive.checked = !elActive.checked;
        refreshLock();
      });
      elActive.addEventListener('change', refreshLock);
      if (elTotal) {
        elTotal.addEventListener('input', refreshLock);
        elTotal.addEventListener('change', refreshLock);
      }
      refreshLock();
    })();
    
  </script>
<script>
(function(){
  const $  = (s, r=document)=>r.querySelector(s);
  const $$ = (s, r=document)=>Array.from(r.querySelectorAll(s));
  const pendingList  = $('#pending-list');
  const acceptedList = $('#accepted-list');

  function htmlToNode(html){
    const wrap = document.createElement('div');
    wrap.innerHTML = html.trim();
    return wrap.firstElementChild;
  }
  function getListByStatus(status){
    if (status === 'pending')  return pendingList;
    if (status === 'accepted') return acceptedList;
    return null;
  }
  function patchPaxItem(payload){
    if (!payload || !payload.pax_id) return;
    const id  = String(payload.pax_id);
    const old = document.querySelector(`.pax-item[data-pax="${CSS.escape(id)}"]`);

    if (payload.status === 'deleted'){
      if (old) old.remove();
      return;
    }
    const container = getListByStatus(payload.status);
    if (!container) return;

    const node = htmlToNode(payload.html);
    if (!node) return;

    if (old && old.parentElement === container){
      old.replaceWith(node);
    }else{
      if (old) old.remove();
      container.appendChild(node);
    }
  }
// 取得 CSRF（沿用你現有的 getCSRF() 即可）
function getCSRF() {
  return (document.querySelector('[name=csrfmiddlewaretoken]')?.value) || '';
}
// 小工具：把 /0/accept/ → /{id}/accept/；/0/reject/ → /{id}/reject/
function buildUrl(base, id, action) {
  const pat = action === 'accept' ? /\/0\/accept\/?$/ : /\/0\/reject\/?$/;
  return base.replace(pat, `/${id}/${action}/`);
}

document.addEventListener('click', async (e) => {
  // ==== 接受 ====
  const btnAccept = e.target.closest('button[data-action="accept"]');
  if (btnAccept) {
    e.preventDefault();
    const pid  = btnAccept.dataset.id;
    const base = btnAccept.dataset.urlBase; // 例如 /find/pax/0/accept/
    if (!pid || !base) return;
    const url  = buildUrl(base, pid, 'accept');

    try {
      const res = await fetch(url, {
        method: 'POST',
        headers: {
          'X-CSRFToken': getCSRF(),
          'X-Requested-With': 'XMLHttpRequest',
          'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8',
        },
        body: new URLSearchParams(),
        credentials: 'same-origin',
      });

      let data;
      try { data = await res.json(); }
      catch { data = { ok:false, error: await res.text() || `HTTP ${res.status}` }; }

      if (!res.ok || !data.ok) { alert(data.error || '接受失敗'); return; }
      // 成功：等 WebSocket 廣播自動重繪
    } catch (err) {
      console.error(err); alert('網路錯誤，請稍後再試');
    }
  }

  // ==== 拒絕 ====
  const btnReject = e.target.closest('button[data-action="reject"]');
  if (btnReject) {
    e.preventDefault();
    const pid  = btnReject.dataset.id;
    const base = btnReject.dataset.urlBase; // 例如 /find/pax/0/reject/
    if (!pid || !base) return;
    const url  = buildUrl(base, pid, 'reject');

    try {
      const res = await fetch(url, {
        method: 'POST',
        headers: {
          'X-CSRFToken': getCSRF(),
          'X-Requested-With': 'XMLHttpRequest',
          'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8',
        },
        body: new URLSearchParams(),
        credentials: 'same-origin',
      });

      let data;
      try { data = await res.json(); }
      catch { data = { ok:false, error: await res.text() || `HTTP ${res.status}` }; }

      if (!res.ok || !data.ok) { alert(data.error || '操作失敗'); return; }
      // 成功：等 WebSocket 廣播自動重繪
    } catch (err) {
      console.error(err); alert('網路錯誤，請稍後再試');
    }
  }
});


  // 司機備忘錄（prompt 版本）
document.addEventListener('click', async (e) => {
    const btn = e.target.closest('button[data-action="memo"]');
    if (!btn) return;

    const paxId   = btn.dataset.id;
    const urlBase = btn.dataset.urlBase; // 例如 /find/pax/0/memo/
    const cur     = btn.dataset.current || "";
    if (!paxId || !urlBase) return;
    const url     = urlBase.replace(/\/0\/memo\/?$/, `/${paxId}/memo/`);

    const memo = prompt('司機備忘錄（僅司機可見）', cur);
    if (memo === null) return;

    try{
      const csrf = document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
      const fd   = new FormData(); fd.append('memo', memo);
      const res  = await fetch(url, { method:'POST', headers:{'X-CSRFToken': csrf}, body: fd });
      const data = await res.json();
      if (!data.ok) throw new Error(data.error||'更新失敗');

      patchPaxItem(data); // 直接用後端回來的新 li 替換
      alert('已更新司機備忘錄');
    }catch(err){
      console.error(err); alert('更新失敗');
    }
  });

  // WebSocket：別處修改（如公開列表編輯）時即時同步
  try{
    const driverId = $('#driver-meta')?.dataset?.driverId || '{{ driver.id }}';
    const proto = location.protocol === 'https:' ? 'wss' : 'ws';
    ws.onmessage = (evt) => {
      try{
        const data = JSON.parse(evt.data);
        if (data && data.ok) patchPaxItem(data);
      }catch(_e){}
    };
  }catch(_e){}
})();

(function initManageWS(){
  const meta = document.getElementById('driver-meta');
  if (!meta) return;
  const driverId = meta.dataset.driverId;
  if (!driverId) return;

  // ✅ 用 driver/<id> 這條路，或 manage/<id> 都可（因為路由都加了）
  const proto = (location.protocol === 'https:') ? 'wss://' : 'ws://';
  const host  = location.host;
  const wsUrl = `${proto}${host}/ws/find/driver/${driverId}/`;   // ←← 建議用這條

  // 避免重複建立多條連線
  if (window.__manageWS && window.__manageWS.readyState === 1) {
    try { window.__manageWS.close(); } catch (_) {}
  }

  const ws = new WebSocket(wsUrl);
  window.__manageWS = ws;

  ws.onopen = () => console.log('[manageWS] connected:', wsUrl);
  ws.onclose = (e) => console.log('[manageWS] closed', e.code, e.reason);
  ws.onerror = (e) => console.error('[manageWS] error', e);

  // 後端廣播 manage_panels 的 payload，要在這裡更新畫面
  ws.onmessage = (ev) => {
    try {
      const msg = JSON.parse(ev.data);
      if (msg.type === 'manage_panels' && typeof msg.html === 'string') {
        const box = document.getElementById('manage-panels');
        if (box) box.innerHTML = msg.html;
      }
      // 如果你有分單張卡片更新：
      if (msg.type === 'replace_pax_item' && msg.pax_id && typeof msg.html === 'string') {
        const li = document.querySelector(`.pax-item[data-pax="${msg.pax_id}"]`);
        if (li) li.outerHTML = msg.html;
      }
    } catch (err) {
      console.error('ws message parse error', err, ev.data);
    }
  };
})();
</script>
<script>
async function handleDeleteDriverSubmit(e){
  e.preventDefault();
  if (!confirm('⚠️ 確定要取消出車嗎？相關乘客也會被解除關聯！')) return false;

  const btn  = document.getElementById('deleteDriverBtn');
  const form = document.getElementById('deleteDriverForm');
  const url  = form.action;
  const csrf = form.querySelector('input[name=csrfmiddlewaretoken]')?.value || '';

  btn.disabled = true; btn.textContent = '處理中…';

  try {
    const resp = await fetch(url, {
      method: 'POST',
      headers: {
        'X-CSRFToken': csrf,
        'X-Requested-With': 'XMLHttpRequest'
      }
    });
    const data = await resp.json();

    if (!resp.ok || !data.ok) {
      alert(data.error || '刪除失敗'); 
      btn.disabled = false; btn.textContent = '🗑️ 取消出車';
      return false;
    }

    // ✅ 成功：這頁沒有 onmessage，就手動跳回列表（或改成 location.reload()）
    window.location.href = "{% url 'find_index' %}";
    return true;
  } catch (err) {
    console.error(err);
    alert('網路錯誤');
    btn.disabled = false; btn.textContent = '🗑️ 取消出車';
    return false;
  }
}
</script>
<script>
(function () {
  const wsScheme = location.protocol === 'https:' ? 'wss' : 'ws';
  const wsUrl    = `${wsScheme}://${location.host}/ws/find/`; // ← 路由見第2步
  let socket;

  function connect() {
    socket = new WebSocket(wsUrl);
    socket.onopen  = () => console.log('[WS] connected');
    socket.onclose = () => setTimeout(connect, 2000);
    socket.onerror = (e) => { console.error('[WS] error', e); socket.close(); };

    socket.onmessage = (e) => {
      let msg; try { msg = JSON.parse(e.data); } catch { return; }

      if (msg.type === "send.update") {
        const dList = document.getElementById("driver-list");
        const pList = document.getElementById("passenger-list");
        if (msg.drivers_html && dList)    dList.innerHTML    = msg.drivers_html;
        if (msg.passengers_html && pList) pList.innerHTML = msg.passengers_html;
        return;
      }

      if (msg.type === "send.partial") {
        if (msg.payload && msg.payload.type === "driver_partial") {
          upsertDriverCard(msg.payload.driver_id, msg.payload.driver_html, msg.payload.active !== false);
          return;
        }
        if (msg.driver_id && msg.html) {
          upsertDriverCard(msg.driver_id, msg.html, true);
          return;
        }
      }

      if (msg.type === "manage.panels" && msg.html) {
        const el = document.getElementById("managePanels");
        if (el) el.innerHTML = msg.html;
      }
    };
  }
  connect();

  function upsertDriverCard(driverId, html, active = true) {
    const list = document.getElementById("driver-list");
    if (!list) return;
    const existing = list.querySelector(`[data-driver-id="${driverId}"]`);

    if (active === false) { if (existing) existing.remove(); return; }

    const tmp = document.createElement('div');
    tmp.innerHTML = (html || '').trim();
    const node = tmp.firstElementChild;
    if (!node) return;

    if (existing) existing.replaceWith(node);
    else list.prepend(node);
  }
})();
</script>



</body>
</html>

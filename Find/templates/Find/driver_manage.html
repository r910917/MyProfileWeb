<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>🛠 司機管理</title>
  <style>
/* ========== Base ========== */
:root{
  --clr-primary:#007bff;
  --clr-primary-2:#0056b3;
  --clr-accent:#00b894;
}
*{box-sizing:border-box}
body{
  font-family:"Microsoft JhengHei",sans-serif;
  background:linear-gradient(to right,#f0f9ff,#fefefe);
  margin:0; padding:40px 20px;
}
h2{ text-align:center; color:#005c4b; margin-bottom:25px; font-size:26px; }
@keyframes fadeIn{ from{opacity:0;transform:translateY(20px)} to{opacity:1;transform:translateY(0)} }

/* ========== Forms ========== */
form{
  max-width:600px;margin:0 auto;background:#fff;
  padding:25px 30px;border-radius:16px;
  box-shadow:0 6px 12px rgba(0,0,0,.1);animation:fadeIn .5s ease-in-out;
}
label{font-weight:700;display:block;margin:12px 0 6px;color:#444}
input,textarea,select{
  width:100%;padding:12px;margin-bottom:10px;border-radius:10px;
  border:1px solid #ccc;transition:border-color .3s,box-shadow .3s;font-size:15px;
}
input:focus,textarea:focus,select:focus{
  border-color:var(--clr-primary);
  box-shadow:0 0 8px rgba(0,123,255,.3); outline:none;
}
textarea{min-height:80px;resize:vertical}
.required::after{content:" *";color:red}

/* ========== Buttons ========== */
.btn{
  width:100%;padding:14px;border:0;border-radius:10px;
  background:linear-gradient(45deg,var(--clr-primary),var(--clr-accent));
  color:#fff;font-size:18px;font-weight:700;cursor:pointer;
  transition:background .3s,transform .2s;
}
.btn:hover{background:linear-gradient(45deg,var(--clr-primary-2),#009e77);transform:scale(1.02)}
.btn-danger{background:linear-gradient(45deg,#ef4444,#f97316)}
.btn-danger:hover{background:linear-gradient(45deg,#b91c1c,#ea580c)}
.btn-ghost{
  width:100%;padding:14px;border:0;border-radius:10px;
  background:linear-gradient(45deg,var(--clr-primary),var(--clr-accent));
  color:#fff;font-size:18px;font-weight:700;cursor:pointer;transition:background .3s,transform .2s;
}
.btn-ghost:hover{background:linear-gradient(45deg,#0fbfd2,#402fc7);transform:scale(1.02)}
.btn-mini{
  padding:8px 12px;border:0;border-radius:8px;line-height:1;font-weight:600;cursor:pointer;
}
.btn-mini:hover{filter:brightness(.97)}
.btn-mini.ok{background:#dcfce7;color:#065f46}
.btn-mini.danger{background:#fee2e2;color:#7f1d1d}
.btn-mini.memo{background:#e0e7ff;color:#3730a3}

/* ========== Alerts ========== */
.alert{max-width:600px;margin:0 auto 12px;padding:12px 14px;border-radius:10px}
.alert-ok{background:#e8f8ef;color:#206b3a;border:1px solid #a7e2bf}
.alert-warn{background:#fff7e6;color:#9a6b00;border:1px solid #f7d7a3}

/* ========== Passenger cards ========== */
.panel{max-width:900px;margin:18px auto}
.pax-list{list-style:none;margin:10px auto 0;padding:0;max-width:900px}
.pax-item{
  background:#fff;border:1px solid #e5e7eb;border-radius:12px;
  padding:14px 16px;margin:10px 0;box-shadow:0 3px 8px rgba(0,0,0,.05)
}
.pax-row{display:grid;grid-template-columns:1fr auto;grid-row-gap:10px;align-items:start}
.pax-head{grid-column:1/-1;display:flex;align-items:center;gap:8px}
.pax-name{font-weight:700;font-size:15px}
.badge{font-size:12px;padding:2px 8px;border-radius:999px;background:#eef2ff;color:#4338ca}
.badge.gender{background:#e0f2fe;color:#0369a1}
.badge.rt{background:#fef3c7;color:#92400e}
.pax-grid{
  grid-column:1/-1;display:grid;grid-template-columns:repeat(6,minmax(0,1fr));
  gap:10px 14px
}
.pax-cell label{display:block;font-size:12px;color:#6b7280;margin-bottom:4px;letter-spacing:.02em}
.pax-cell div{font-size:14px;color:#111827}
.pax-cell.span-2{grid-column:span 2}
.pax-actions{
  display:flex;
  gap:8px;
  justify-content:flex-end; /* 內容向右 */
  align-self:end;           /* 在 grid 列中靠下 */
  justify-self:end;         /* 在 grid 欄位靠右 */
  grid-column: 1 / -1;      /* 需要時讓整列橫跨，才能貼到最右邊 */
}

/* ========== Note & Memo ribbons ========== */
.pax-note, .pax-memo{
  grid-column: 1 / -1;
  position:relative;
  display:grid; grid-template-columns:92px 1fr auto;
  align-items:center; gap:10px 14px; padding:10px 12px;
  border-radius:10px; margin:10px 0 8px; border:1px solid transparent;
}
.pax-note{ background:#fff7ed; border-color:#ffe6c7; }
.pax-note .label{ font-weight:700; color:#9a6700; }
.pax-memo{ background:#eef6ff; border-color:#dbeafe; }
.pax-memo .label{ font-weight:700; color:#1d4ed8; }
.pax-memo .memo-text{ color:#0f172a; word-break:break-word; }
.pax-memo .memo-actions{ display:flex; gap:8px; justify-self:end; }
/* 左側色條 */
.pax-note::before, .pax-memo::before{
  content:""; position:absolute; left:0; top:0; bottom:0; width:6px; border-radius:10px 0 0 10px;
}
.pax-note::before{ background:#f59e0b; }
.pax-memo::before{ background:#3b82f6; }

/* ========== Switch (toggle) ========== */
/* 卡片容器 */
    .pref-card{
      border:1px solid #e5e7eb; background:#f9fafb; border-radius:12px;
      padding:14px; margin:12px 0;
    }

    /* 每一列（開關 + 文字） */
    .pref-row{ display:flex; align-items:center; gap:12px; padding:6px 2px; }
    .pref-row.sub{ padding-left:44px; }       /* 第二列縮排，看起來是附屬選項 */

    /* 文字區 */
    .pref-text{ display:flex; flex-direction:column; gap:2px; }
    .pref-title{ font-weight:600; color:#1f2937; }
    .pref-desc{ font-size:.9rem; color:#6b7280; }

    /* 底部說明 */
    .pref-hint{ margin-top:8px; font-size:.85rem; color:#6b7280; }
    .pref-hint.hint-error{ color:#b91c1c; }

    /* 滑動開關（與 iOS 風格相近） */
.switch{ position:relative; display:inline-block; width:52px; height:28px; }
.switch input{ display:none; }
.slider{
  position:absolute; inset:0; cursor:pointer; background:#e5e7eb; border-radius:999px;
  transition:background .2s ease;
}
.slider:before{
  content:""; position:absolute; height:22px; width:22px; left:3px; top:3px;
  background:white; border-radius:999px; transition:transform .2s ease;
  box-shadow:0 1px 2px rgba(0,0,0,.15);
}
.switch input:checked + .slider{ background:#10b981; }          /* 綠色開啟 */
.switch input:checked + .slider:before{ transform:translateX(24px); }

/* 小螢幕微調 */
@media (max-width: 480px){
  .pref-row.sub{ padding-left:36px; }
}

/* 只影響 #active-switch 這一顆，避免被全站 .switch 覆蓋 */
#active-switch.active-switch{
  display:flex; align-items:center; gap:.6rem; user-select:none;
  /* 這行可幫你擋住外部繼承的排版 */
  position:relative;
}
#active-switch input[type="checkbox"]{
  position:absolute; opacity:0; width:1px; height:1px; pointer-events:none;
}

/* Toggle 外觀 */
#active-switch .toggle{
  position:relative; width:48px; height:26px; border-radius:999px;
  background:#e5e7eb; box-shadow:inset 0 0 0 1px rgba(0,0,0,.08);
  transition:background .2s ease;
}
#active-switch .toggle::after{
  content:""; position:absolute; top:3px; left:3px; width:20px; height:20px;
  border-radius:50%; background:#fff; box-shadow:0 1px 2px rgba(0,0,0,.2);
  transition:transform .2s cubic-bezier(.4,0,.2,1);
}

/* 勾選狀態 */
#active-switch input[type="checkbox"]:checked + .toggle{ background:#10b981; }
#active-switch input[type="checkbox"]:checked + .toggle::after{ transform:translateX(22px); }

/* 焦點可及性 */
#active-switch input[type="checkbox"]:focus + .toggle{
  outline:2px solid #2563eb; outline-offset:2px;
}

/* 標籤字 */
#active-switch .txt{ cursor:pointer; color:#374151; font-size:.95rem; line-height:1.2; }


/* ========== Responsive ========== */
@media (max-width:1024px){ .pax-grid{grid-template-columns:repeat(4,minmax(0,1fr))} }
@media (max-width:768px){
  form{padding:18px 16px}
  .pax-row{grid-template-columns:1fr}
  .pax-actions{justify-content:flex-end}
  .pax-grid{grid-template-columns:repeat(2,minmax(0,1fr))}
  .pax-cell.span-2{grid-column:1/-1}
  .pax-note, .pax-memo{grid-template-columns:1fr;gap:6px}
  .pax-memo .memo-actions{justify-self:start}
  .switch .toggle{width:56px;height:34px}
  .switch .toggle::after{width:26px;height:26px;top:4px;left:4px;transform:none}
  .switch input[type="checkbox"]:checked + .toggle::after{transform:translateX(22px)}
}
@media (max-width:480px){ .pax-grid{grid-template-columns:1fr} }
</style>

</head>
<body>
  <h2>🛠 乘客管理</h2>
<!-- 乘客清單（原樣） -->
<!-- C) 已登記乘客（升級：接受 / 拒絕 / 司機備忘錄） -->
<div class="panel" id="manage-panels">
  {% csrf_token %}
  {% include "Find/_manage_panels.html" %}
</div>

<div id="driver-meta" data-driver-id="{{ driver.id }}"></div>
<!-- 刪除司機表單（保留 CSRF 與 action） -->
<form id="deleteDriverForm"
      method="POST"
      action="{% url 'delete_driver' driver.id %}"
      style="max-width:600px;margin:14px auto 0;"
      onsubmit="return handleDeleteDriverSubmit(event)">
  {% csrf_token %}
  <button id="deleteDriverBtn" class="btn btn-danger" type="submit">🗑️ 取消出車</button>
  <div style="max-width:600px;margin:0 auto 8px;">
      <a href="{% url 'find_index' %}" class="btn-ghost" style="display:inline-block;text-decoration:none;text-align:center;width:100%;padding:12px;margin-top:10px;border-radius:10px;font-weight:700;">
        🏠 回首頁
      </a>
  </div>
</form>


  <h2>🛠 司機管理</h2>

  {% if saved_msg %}<div class="alert alert-ok">{{ saved_msg }}</div>{% endif %}
  {% if matched_msg %}<div class="alert alert-ok">{{ matched_msg }}</div>{% endif %}
  {% if full_msg %}<div class="alert alert-warn">{{ full_msg }}</div>{% endif %}

  <!-- A) 編輯司機資料 -->
  <!-- 省略前段相同 CSS 與 <body> 開頭 -->

  <!-- A) 編輯司機資料 -->
  <form method="POST">
    {% csrf_token %}
    <input type="hidden" name="form" value="update_driver" />

    <label class="required">暱稱</label>
    <input type="text" name="driver_name" value="{{ driver.driver_name }}" required />

    <label class="required">性別</label>
    <select name="gender" required>
      <option value="M" {% if driver.gender == 'M' %}selected{% endif %}>男生</option>
      <option value="F" {% if driver.gender == 'F' %}selected{% endif %}>女生</option>
      <option value="X" {% if driver.gender == 'X' %}selected{% endif %}>不方便透漏</option>
    </select>

    <label>Email（選填）</label>
    <input type="email" id="email" name="email" value="{{ driver.email|default_if_none:'' }}" />

    <!-- 隱私設定：卡片 + 兩個滑動開關 -->
    <section class="pref-card">
      <div class="pref-row">
        <label class="switch">
          <input type="checkbox" id="hide_contact" name="hide_contact"
                {% if driver.hide_contact %}checked{% endif %}>>
          <span class="slider"></span>
        </label>
        <div class="pref-text">
          <div class="pref-title">隱藏個資（聯絡方式）</div>
          <div class="pref-desc"></div>
        </div>
      </div>

      <div id="autoEmailWrap" class="pref-row sub" style="display:none;">
        <label class="switch">
          <input type="checkbox" id="auto_email_contact" name="auto_email_contact"
                {% if driver.auto_email_contact %}checked{% endif %} {% if not driver.hide_contact %}disabled{% endif %}>
          <span class="slider"></span>
        </label>
        <div class="pref-text">
          <div class="pref-title">隱藏時，自動把我的聯絡方式 Email 給已報名乘客</div>
        </div>
      </div>

      <div id="privacyHint" class="pref-hint">
        ※ 需填寫 Email 才能隱藏；Email 僅供系統通知，不會公開。
      </div>
    </section>

    <label class="required" style="margin-top:14px;">聯絡方式</label>
    <input type="text" name="contact" value="{{ driver.contact }}" placeholder="LINE / IG / Phone Number" required />

    <label>管理密碼（留空不變更）</label>
    <input type="password" name="passwordf" placeholder="留空不修改" />

    <label class="required">總座位</label>
    <input type="number" id="seats_total" name="seats_total" min="1" value="{{ driver.seats_total }}" required />

    <!-- 出發地（下拉 + 自填） -->
    {% with has_dep_custom=driver.departure_custom %}
    <label class="required">出發地</label>
    <select name="departure" id="departure" onchange="checkCustomDeparture(this)" required>
      <option value="" {% if not driver.departure and not has_dep_custom %}selected{% endif %}>請選擇縣市</option>
      <option value="自填" {% if has_dep_custom %}selected{% endif %}>其他</option>
      <option value="花蓮縣光復鄉" {% if not has_dep_custom and driver.departure == '花蓮縣光復鄉' %}selected{% endif %}>花蓮縣光復鄉</option>
      <option value="花蓮縣光復車站以外火車站" {% if not has_dep_custom and driver.departure == '花蓮縣光復車站以外火車站' %}selected{% endif %}>花蓮縣光復車站以外火車站</option>
      <option value="花蓮縣光復車站" {% if not has_dep_custom and driver.departure == '花蓮縣光復車站' %}selected{% endif %}>花蓮縣光復車站</option>
      <option value="光復鄉糖廠" {% if not has_dep_custom and driver.departure == '光復鄉糖廠' %}selected{% endif %}>光復鄉糖廠</option>
      <option value="需清淤地區" {% if not has_dep_custom and driver.departure == '需清淤地區' %}selected{% endif %}>需清淤地區</option>
      <option value="台北市" {% if not has_dep_custom and driver.departure == '台北市' %}selected{% endif %}>台北市</option>
      <option value="新北市" {% if not has_dep_custom and driver.departure == '新北市' %}selected{% endif %}>新北市</option>
      <option value="基隆市" {% if not has_dep_custom and driver.departure == '基隆市' %}selected{% endif %}>基隆市</option>
      <option value="桃園市" {% if not has_dep_custom and driver.departure == '桃園市' %}selected{% endif %}>桃園市</option>
      <option value="新竹市" {% if not has_dep_custom and driver.departure == '新竹市' %}selected{% endif %}>新竹市</option>
      <option value="新竹縣" {% if not has_dep_custom and driver.departure == '新竹縣' %}selected{% endif %}>新竹縣</option>
      <option value="苗栗縣" {% if not has_dep_custom and driver.departure == '苗栗縣' %}selected{% endif %}>苗栗縣</option>
      <option value="台中市" {% if not has_dep_custom and driver.departure == '台中市' %}selected{% endif %}>台中市</option>
      <option value="彰化縣" {% if not has_dep_custom and driver.departure == '彰化縣' %}selected{% endif %}>彰化縣</option>
      <option value="南投縣" {% if not has_dep_custom and driver.departure == '南投縣' %}selected{% endif %}>南投縣</option>
      <option value="雲林縣" {% if not has_dep_custom and driver.departure == '雲林縣' %}selected{% endif %}>雲林縣</option>
      <option value="嘉義市" {% if not has_dep_custom and driver.departure == '嘉義市' %}selected{% endif %}>嘉義市</option>
      <option value="嘉義縣" {% if not has_dep_custom and driver.departure == '嘉義縣' %}selected{% endif %}>嘉義縣</option>
      <option value="台南市" {% if not has_dep_custom and driver.departure == '台南市' %}selected{% endif %}>台南市</option>
      <option value="高雄市" {% if not has_dep_custom and driver.departure == '高雄市' %}selected{% endif %}>高雄市</option>
      <option value="屏東縣" {% if not has_dep_custom and driver.departure == '屏東縣' %}selected{% endif %}>屏東縣</option>
      <option value="宜蘭縣" {% if not has_dep_custom and driver.departure == '宜蘭縣' %}selected{% endif %}>宜蘭縣</option>
      <option value="花蓮縣" {% if not has_dep_custom and driver.departure == '花蓮縣' %}selected{% endif %}>花蓮縣</option>
      <option value="台東縣" {% if not has_dep_custom and driver.departure == '台東縣' %}selected{% endif %}>台東縣</option>
      <option value="澎湖縣" {% if not has_dep_custom and driver.departure == '澎湖縣' %}selected{% endif %}>澎湖縣</option>
      <option value="金門縣" {% if not has_dep_custom and driver.departure == '金門縣' %}selected{% endif %}>金門縣</option>
      <option value="連江縣" {% if not has_dep_custom and driver.departure == '連江縣' %}selected{% endif %}>連江縣</option>
    </select>
    <input type="text"
           id="customDeparture"
           name="departure_custom"
           value="{{ driver.departure_custom|default:'' }}"
           style="display:{% if has_dep_custom %}block{% else %}none{% endif %};"
           placeholder="輸入自訂出發地" />
    {% endwith %}

    <!-- 目的地（下拉 + 自填） -->
    {% with has_des_custom=driver.destination_custom %}
    <label>目的地</label>
    <select name="destination" id="destination" onchange="checkCustomDestination(this)">
      <option value="" {% if not driver.destination and not has_des_custom %}selected{% endif %}>請選擇縣市</option>
      <option value="自填" {% if has_des_custom %}selected{% endif %}>其他</option>
      <option value="花蓮縣光復鄉" {% if not has_des_custom and driver.destination == '花蓮縣光復鄉' %}selected{% endif %}>花蓮縣光復鄉</option>
      <option value="花蓮縣光復車站以外火車站" {% if not has_des_custom and driver.destination == '花蓮縣光復車站以外火車站' %}selected{% endif %}>花蓮縣光復車站以外火車站</option>
      <option value="花蓮縣光復車站" {% if not has_des_custom and driver.destination == '花蓮縣光復車站' %}selected{% endif %}>花蓮縣光復車站</option>
      <option value="光復鄉糖廠" {% if not has_des_custom and driver.destination == '光復鄉糖廠' %}selected{% endif %}>光復鄉糖廠</option>
      <option value="需清淤地區" {% if not has_des_custom and driver.destination == '需清淤地區' %}selected{% endif %}>需清淤地區</option>
      <option value="台北市" {% if not has_des_custom and driver.destination == '台北市' %}selected{% endif %}>台北市</option>
      <option value="新北市"  {% if not has_des_custom and driver.destination == '新北市' %}selected{% endif %}>新北市</option>
      <option value="基隆市"  {% if not has_des_custom and driver.destination == '基隆市' %}selected{% endif %}>基隆市</option>
      <option value="桃園市"  {% if not has_des_custom and driver.destination == '桃園市' %}selected{% endif %}>桃園市</option>
      <option value="新竹市"  {% if not has_des_custom and driver.destination == '新竹市' %}selected{% endif %}>新竹市</option>
      <option value="新竹縣"  {% if not has_des_custom and driver.destination == '新竹縣' %}selected{% endif %}>新竹縣</option>
      <option value="苗栗縣"  {% if not has_des_custom and driver.destination == '苗栗縣' %}selected{% endif %}>苗栗縣</option>
      <option value="台中市"  {% if not has_des_custom and driver.destination == '台中市' %}selected{% endif %}>台中市</option>
      <option value="彰化縣"  {% if not has_des_custom and driver.destination == '彰化縣' %}selected{% endif %}>彰化縣</option>
      <option value="南投縣"  {% if not has_des_custom and driver.destination == '南投縣' %}selected{% endif %}>南投縣</option>
      <option value="雲林縣"  {% if not has_des_custom and driver.destination == '雲林縣' %}selected{% endif %}>雲林縣</option>
      <option value="嘉義市"  {% if not has_des_custom and driver.destination == '嘉義市' %}selected{% endif %}>嘉義市</option>
      <option value="嘉義縣"  {% if not has_des_custom and driver.destination == '嘉義縣' %}selected{% endif %}>嘉義縣</option>
      <option value="台南市"  {% if not has_des_custom and driver.destination == '台南市' %}selected{% endif %}>台南市</option>
      <option value="高雄市"  {% if not has_des_custom and driver.destination == '高雄市' %}selected{% endif %}>高雄市</option>
      <option value="屏東縣"  {% if not has_des_custom and driver.destination == '屏東縣' %}selected{% endif %}>屏東縣</option>
      <option value="宜蘭縣"  {% if not has_des_custom and driver.destination == '宜蘭縣' %}selected{% endif %}>宜蘭縣</option>
      <option value="花蓮縣"  {% if not has_des_custom and driver.destination == '花蓮縣' %}selected{% endif %}>花蓮縣</option>
      <option value="台東縣"  {% if not has_des_custom and driver.destination == '台東縣' %}selected{% endif %}>台東縣</option>
      <option value="澎湖縣"  {% if not has_des_custom and driver.destination == '澎湖縣' %}selected{% endif %}>澎湖縣</option>
      <option value="金門縣"  {% if not has_des_custom and driver.destination == '金門縣' %}selected{% endif %}>金門縣</option>
      <option value="連江縣"  {% if not has_des_custom and driver.destination == '連江縣' %}selected{% endif %}>連江縣</option>
    </select>
    <input type="text"
           id="customDestination"
           name="destination_custom"
           value="{{ driver.destination_custom|default:'' }}"
           style="display:{% if has_des_custom %}block{% else %}none{% endif %};"
           placeholder="輸入自訂目的地" />
    {% endwith %}

    <label>酌收費用（選填）</label>
    <input type="text" name="fare_note" value="{{ driver.fare_note|default_if_none:'' }}" placeholder="例如：每人 200、油錢均攤、視里程而定…" />

    <label class="required">出發日期</label>
    <input type="date" name="date" id="driver-date" value="{{ driver.date|date:'Y-m-d' }}" required />

    <label>回程日期（選填）</label>
    <input type="date" name="return_date" id="driver-return" value="{{ driver.return_date|date:'Y-m-d' }}" />

    <label>順路接送意願</label>
    <select name="flexible_pickup">
      <option value="YES" {% if driver.flexible_pickup == 'YES' %}selected{% endif %}>順路可載</option>
      <option value="NO"  {% if driver.flexible_pickup == 'NO'  %}selected{% endif %}>不順路也OK</option>
      <option value="MAYBE" {% if driver.flexible_pickup == 'MAYBE' %}selected{% endif %}>視情況</option>
    </select>

    <div id="active-switch" class="active-switch">
      <input type="checkbox" name="is_active" id="is_active" {% if driver.is_active %}checked{% endif %}>
      <span class="toggle" aria-hidden="true"></span>
      <label for="is_active" class="txt">是否開放（座位滿會自動關閉）</label>
    </div>

    <label>備註</label>
    <textarea id="driverNote" name="note" row="3" placeholder="備註(選填)">{{ driver.note|default_if_none:'' }}</textarea>
    <button class="btn" type="submit">💾 儲存</button>
  </form>

  <script>
    // 取 driverId（driver_manage.html 內放 <div id="driver-meta" data-driver-id="{{ driver.id }}">）
function getDriverId(){
  return document.getElementById('driver-meta')?.dataset?.driverId || '';
}

// 等待一次 manage_panels WS，超時就回 false
function waitWSOnce(timeoutMs=800){
  return new Promise(resolve=>{
    let done = false;
    const ws = window.__manageWS;
    const t  = setTimeout(()=>{ if(!done){ done=true; resolve(false); } }, timeoutMs);
    if(!ws || ws.readyState!==1){
      clearTimeout(t); resolve(false); return;
    }
    const origOnMsg = ws.onmessage;
    ws.onmessage = (ev)=>{
      try{
        const msg = JSON.parse(ev.data||'{}');
        if(msg.type==='manage_panels' && typeof msg.html==='string'){
          // 直接套用（若你的 onmessage 也會處理沒關係，這邊套用一次也安全）
          const box = document.getElementById('manage-panels');
          if (box) box.innerHTML = msg.html;
          if(!done){ done=true; clearTimeout(t); resolve(true); }
        }
      }catch(_){} 
      // 繼續讓原有 handler 收其他訊息
      if (typeof origOnMsg === 'function') origOnMsg(ev);
    };
  });
}

// 手動刷新 panels（建議在後端加一條局部 view: GET /find/driver/<id>/manage/panels/ 回傳 html）
// 如果你暫時沒有這條路由，最後會 fallback reload。
async function refreshManagePanels(){
  const driverId = getDriverId();
  if(!driverId){ location.reload(); return; }
  try{
    const url = `/find/driver/${driverId}/manage/panels/`;
    const res = await fetch(url, { headers:{'X-Requested-With':'XMLHttpRequest'} });
    if(!res.ok){ location.reload(); return; }
    const html = await res.text();
    if(!html || !html.trim()){ location.reload(); return; }
    const box = document.getElementById('manage-panels');
    if (box) box.innerHTML = html;
  }catch(_){
    location.reload();
  }
}
    const driverId = "{{ driver.id }}";
    const proto = location.protocol === "https:" ? "wss" : "ws";
    // 出發/目的自填顯示（原樣）
    function checkCustomDeparture(select){
      const customInput = document.getElementById('customDeparture');
      if (!customInput) return;
      const show = (select.value === '自填');
      customInput.style.display = show ? 'block' : 'none';
      customInput.required = show;
      if (!show) customInput.value = '';
    }
    function checkCustomDestination(select){
      const input = document.getElementById('customDestination');
      if (!input) return;
      const show = (select.value === '自填');
      input.style.display = show ? 'block' : 'none';
      input.required = show;
      if (!show) input.value = '';
    }

    // 日期防呆（原樣）
    document.addEventListener('DOMContentLoaded', () => {
      const dep = document.getElementById('driver-date');
      const ret = document.getElementById('driver-return');
      const today = new Date().toISOString().split('T')[0];
      if (!dep || !ret) return;
      function syncMin(){
        dep.min = today;
        ret.min = dep.value || today;
        if (ret.value && ret.value < ret.min) ret.value = '';
      }
      dep.addEventListener('change', syncMin);
      ret.addEventListener('change', syncMin);
      syncMin();
    });

    // 初始化「自填」展開
    (function(){
      const depSel = document.getElementById('departure');
      const desSel = document.getElementById('destination');
      if (depSel) checkCustomDeparture(depSel);
      if (desSel) checkCustomDestination(desSel);
    })();

    function getCsrfToken() {
    // 從表單 hidden input 拿 CSRF
    const tokenInput = document.querySelector('#deleteDriverForm input[name=csrfmiddlewaretoken]');
    return tokenInput ? tokenInput.value : '';
  }

    // ✅ 隱私開關：需要 Email 才能啟用
    (function(){
      // 僅用於「管理頁」，不去改變初始化的 checked（由後端 DB 決定）
      const email = document.getElementById('email');               // 司機的 Email 輸入
      const hide  = document.getElementById('hide_contact');        // 隱藏個資
      const auto  = document.getElementById('auto_email_contact');  // 自動寄信
      const wrap  = document.getElementById('autoEmailWrap');       // 自動寄信那一列
      const hint  = document.getElementById('privacyHint');

      // 紀錄 DB 初始值（只讀一次，不要被我們的 UI 邏輯覆蓋）
      const initialHide = hide ? hide.checked : false;
      const initialAuto = auto ? auto.checked : false;

      function hasEmail(){
        return !!(email && email.value && email.value.includes('@'));
      }

      function setHintLines(lines){
        if (!hint) return;
        hint.innerHTML = lines.map(s => s.replace(/\s+$/,'')).join('<br>');
      }

      function syncUI(){
        const okEmail = hasEmail();

        if (!okEmail){
          // 沒 Email：兩個都不可用，第二列隱藏，但「不改變 checked 值」
          if (hide){ hide.disabled = true; }
          if (auto){ auto.disabled = true; }
          if (wrap){ wrap.style.display = 'none'; }
          setHintLines([
            '※ 尚未填寫 Email，無法隱藏聯絡方式。',
            '填寫後即可啟用「隱藏個資」與「自動寄信」。'
          ]);
          return;
        }

        // 有 Email：根據目前 hide.checked 來決定 auto 的可用與顯示；不改變 checked 狀態
        if (hide){ hide.disabled = false; }

        const on = !!(hide && hide.checked);
        if (wrap){ wrap.style.display = on ? '' : 'none'; }
        if (auto){ auto.disabled = !on; if (!on) auto.checked = false; }

        setHintLines([
          '※ Email 僅供系統通知，不會公開。',
          '若關閉自動寄送 Email，則需等待乘客加入後，系統才會把乘客資料寄送至您的 Email。'
        ]);
      }

      // 使用者操作只影響可用性與顯示，不覆寫 checked 預設
      hide && hide.addEventListener('change', syncUI);
      email && email.addEventListener('input', syncUI);

      // 初次進頁：直接用 DB 值渲染（不要動 checked）
      if (hide) hide.checked = initialHide;
      if (auto) auto.checked = initialAuto;
      syncUI();
})();

    // 是否開放 switch 鎖定（你原本的腳本保留）
    (function () {
  const wrap    = document.getElementById('active-switch');
  if (!wrap) return;
  const elActive= document.getElementById('is_active');
  const elToggle= wrap.querySelector('.toggle');
  const elLabel = wrap.querySelector('label');

  // 建立提示：插在「是否開放」這組開關下面
  let hint = wrap.querySelector('#active-hint');
  if (!hint) {
    hint = document.createElement('span');
    hint.id = 'active-hint';
    hint.className = 'hint';
    elLabel.insertAdjacentElement('afterend', hint);
  }

  // 取得 filled（與你原本一致）
  function getFilled() {
    const h = document.getElementById('seats_filled_val');
    if (h && h.value !== undefined) {
      const n = parseInt(h.value, 10);
      return Number.isFinite(n) ? n : 0;
    }
    const meta = document.getElementById('driver-meta');
    if (meta?.dataset?.seatsFilled !== undefined) {
      const n = parseInt(meta.dataset.seatsFilled, 10);
      return Number.isFinite(n) ? n : 0;
    }
    return 0;
  }

  const elTotal = document.getElementById('seats_total');

  function setHint(text, tone){
    hint.textContent = text || '';
    hint.style.color = (tone === 'warn') ? '#9a6b00'
                    : (tone === 'ok')   ? '#206b3a'
                    : '#6b7280';
  }

  function refreshLock() {
    const filled = getFilled();
    const total  = parseInt(elTotal && elTotal.value, 10);
    const totalSafe = Number.isFinite(total) ? Math.max(1, total) : 1;

    if (filled >= totalSafe) {
      elActive.checked = false;
      elActive.disabled = true;
      elToggle.classList.add('is-disabled');
      setHint(`座位已滿（${filled}/${totalSafe}），已自動關閉`, 'warn');
      elActive.title = '座位已滿時不可開放';
    } else {
      elActive.disabled = false;
      elToggle.classList.remove('is-disabled');
      elActive.title = '';
      setHint(elActive.checked ? '目前狀態：已開放' : '目前狀態：未開放', elActive.checked ? 'ok' : '');
    }
  }

      elToggle.addEventListener('click', () => {
        if (elActive.disabled) return;
        elActive.checked = !elActive.checked;
        refreshLock();
      });
      elActive.addEventListener('change', refreshLock);
      if (elTotal) {
        elTotal.addEventListener('input', refreshLock);
        elTotal.addEventListener('change', refreshLock);
      }
      refreshLock();
    })();
    
  </script>
<script>
(function(){
  const $  = (s, r=document)=>r.querySelector(s);
  const $$ = (s, r=document)=>Array.from(r.querySelectorAll(s));
  const pendingList  = $('#pending-list');
  const acceptedList = $('#accepted-list');

  function htmlToNode(html){
    const wrap = document.createElement('div');
    wrap.innerHTML = html.trim();
    return wrap.firstElementChild;
  }
  function getListByStatus(status){
    if (status === 'pending')  return pendingList;
    if (status === 'accepted') return acceptedList;
    return null;
  }
  function patchPaxItem(payload){
    if (!payload || !payload.pax_id) return;
    const id  = String(payload.pax_id);
    const old = document.querySelector(`.pax-item[data-pax="${CSS.escape(id)}"]`);

    if (payload.status === 'deleted'){
      if (old) old.remove();
      return;
    }
    const container = getListByStatus(payload.status);
    if (!container) return;

    const node = htmlToNode(payload.html);
    if (!node) return;

    if (old && old.parentElement === container){
      old.replaceWith(node);
    }else{
      if (old) old.remove();
      container.appendChild(node);
    }
  }
// 取得 CSRF（沿用你現有的 getCSRF() 即可）
function getCSRF() {
  return (document.querySelector('[name=csrfmiddlewaretoken]')?.value) || '';
}
// 小工具：把 /0/accept/ → /{id}/accept/；/0/reject/ → /{id}/reject/
function buildUrl(base, id, action) {
  const pat = action === 'accept' ? /\/0\/accept\/?$/ : /\/0\/reject\/?$/;
  return base.replace(pat, `/${id}/${action}/`);
}

// 後端若直接回傳單一 <li> HTML，用這個替換
function patchPaxItemHTML(html, paxId){
  if (!html || !paxId) return;
  const li = document.querySelector(`.pax-item[data-pax="${paxId}"]`);
  if (!li) return;
  li.outerHTML = html;
}


// ---------- 單一事件委派：接受 / 拒絕 / 備忘錄 ----------
  document.addEventListener('click', async (e) => {
    // 1) 接受
    const btnAccept = e.target.closest('button[data-action="accept"]');
    if (btnAccept){
      e.preventDefault();
      const paxId = btnAccept.dataset.id;
      const base  = btnAccept.dataset.urlBase; // 例如 /find/pax/0/accept/
      if (!paxId || !base) return;
      const url = buildUrl(base, paxId);

      try{
        const res  = await fetch(url, {
          method: 'POST',
          headers: {
            'X-CSRFToken': getCSRF(),
            'X-Requested-With': 'XMLHttpRequest',
            'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8',
          },
          body: new URLSearchParams(),
          credentials: 'same-origin',
        });
        let data; try{ data = await res.json(); }catch{ data = {ok:false, error: await res.text() || `HTTP ${res.status}`} }
        if (!res.ok || !data.ok) { alert(data.error || '接受失敗'); return; }
        await refreshManagePanels(); // 沒來就自己抓一次
        
        // 成功後交給 WS 廣播重繪（後端會推 manage_panels），
        // 若後端同時回傳了片段，可先行局部替換：
        if (data.html) patchPaxItemHTML(data.html, paxId);
        
      }catch(err){
        console.error(err); alert('網路錯誤，請稍後再試');
      }
      return;
    }

    // 2) 拒絕 / 取消（已接受＆待確認都走這裡）
    const btnReject = e.target.closest('button[data-action="reject"]');
    if (btnReject){
      e.preventDefault();
      const paxId = btnReject.dataset.id;
      const base  = btnReject.dataset.urlBase; // 例如 /find/pax/0/reject/
      if (!paxId || !base) return;
      if (!confirm('⚠️ 確定要拒絕/取消此乘客嗎？')) return;
      const url = buildUrl(base, paxId);

      try{
        const res  = await fetch(url, {
          method: 'POST',
          headers: {
            'X-CSRFToken': getCSRF(),
            'X-Requested-With': 'XMLHttpRequest',
            'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8',
          },
          body: new URLSearchParams(),
          credentials: 'same-origin',
        });
        let data; try{ data = await res.json(); }catch{ data = {ok:false, error: await res.text() || `HTTP ${res.status}`} }
        if (!res.ok || !data.ok) { alert(data.error || '操作失敗'); return; }
        await refreshManagePanels(); // 沒來就自己抓一次
        // 同上：等 WS；若有片段先替
        if (data.html) patchPaxItemHTML(data.html, paxId);
      }catch(err){
        console.error(err); alert('網路錯誤，請稍後再試');
      }
      return;
    }

    // 3) 司機備忘錄（prompt 版）
    const btnMemo = e.target.closest('button[data-action="memo"]');
    if (btnMemo){
      e.preventDefault();
      const paxId   = btnMemo.dataset.id;
      const urlBase = btnMemo.dataset.urlBase; // /find/pax/0/memo/
      const cur     = btnMemo.dataset.current || "";
      if (!paxId || !urlBase) return;
      const url     = urlBase.replace(/\/0\/memo\/?$/, `/${paxId}/memo/`);

      const memo = prompt('司機備忘錄（僅司機可見）', cur);
      if (memo === null) return;

      try{
        const fd  = new FormData(); fd.append('memo', memo);
        const res = await fetch(url, { method:'POST', headers:{'X-CSRFToken': getCSRF()}, body: fd, credentials:'same-origin' });
        const data = await res.json();
        if (!data.ok) throw new Error(data.error||'更新失敗');
        // 後端若回 li 片段
        await refreshManagePanels(); // 沒來就自己抓一次
        if (data.html && data.pax_id) patchPaxItemHTML(data.html, data.pax_id);
      }catch(err){
        console.error(err); alert('更新失敗');
      }
      return;
    }
  });

// ---------- WebSocket：driver_manage panels 即時更新 ----------
  (function initManageWS(){
    const meta = document.getElementById('driver-meta');
    if (!meta) return;
    const driverId = meta.dataset.driverId;
    if (!driverId) return;

    const proto = location.protocol === 'https:' ? 'wss://' : 'ws://';
    const wsUrl = proto + location.host + '/ws/find/';
    const ws = new WebSocket(wsUrl);
    ws.onopen = ()=> console.log('[WS] public open');

    // 避免重複連線
    if (window.__manageWS && window.__manageWS.readyState === 1) {
      try { window.__manageWS.close(); } catch (_) {}
    }

    
    window.__manageWS = ws;

    ws.onopen  = () => console.log('[manageWS] connected:', wsUrl);
    ws.onclose = (e) => console.log('[manageWS] closed', e.code, e.reason);
    ws.onerror = (e) => console.error('[manageWS] error', e);

    // 後端廣播 payload：
    // - {type:'manage_panels', html:'...整個 manage-panels 片段...'}
    // - {type:'replace_pax_item', pax_id: 123, html:'<li ...>...</li>'}
    ws.onmessage = (ev)=>{
    try{
      const msg = JSON.parse(ev.data || '{}');
      if (msg.type === 'replace_driver_card' && msg.driver_id && typeof msg.html === 'string'){
        const li = document.querySelector(`.driver-card[data-driver="${msg.driver_id}"]`);
        if (li) li.outerHTML = msg.html;
      }
    }catch(e){ console.error('public ws parse', e, ev.data); }
  };
  })();
})();
</script>
<script>
async function handleDeleteDriverSubmit(e){
  e.preventDefault();
  if (!confirm('⚠️ 確定要取消出車嗎？相關乘客也會被解除關聯！')) return false;

  const btn  = document.getElementById('deleteDriverBtn');
  const form = document.getElementById('deleteDriverForm');
  const url  = form.action;
  const csrf = form.querySelector('input[name=csrfmiddlewaretoken]')?.value || '';

  btn.disabled = true;
  btn.disabled = true; btn.textContent = '處理中…';

  try {
    const resp = await fetch(url, {
      method: 'POST',
      headers: {
        'X-CSRFToken': csrf,
        'X-Requested-With': 'XMLHttpRequest'
      }
    });
    const data = await resp.json();

    if (!resp.ok || !data.ok) {
      alert(data.error || '刪除失敗'); 
      btn.disabled = false; btn.textContent = '🗑️ 取消出車';
      return false;
    }

    // ✅ 成功：不進行 WebSocket 更新，直接跳轉或刷新頁面
    window.location.href = "{% url 'find_index' %}";
    return true;
  } catch (err) {
    console.error(err);
    alert('網路錯誤');
    btn.disabled = false;
    btn.textContent = '🗑️ 取消出車';
    return false;
  }
}
</script>


<!-- <script>
(function () {
  const meta = document.getElementById('driver-meta');
  if (!meta) return;
  const driverId = meta.dataset.driverId;
  if (!driverId) return;

  // ✅ 用 driver/<id> 這條路，或 manage/<id> 都可（因為路由都加了）
  const proto = (location.protocol === 'https:') ? 'wss://' : 'ws://';
  const host  = location.host;
  const wsUrl = `${proto}${host}/ws/find/driver/${driverId}/`;   // ←← 建議用這條

  // 避免重複建立多條連線
  if (window.__manageWS && window.__manageWS.readyState === 1) {
    try { window.__manageWS.close(); } catch (_) {}
  }

  const ws = new WebSocket(wsUrl);
  window.__manageWS = ws;

  ws.onopen = () => console.log('[manageWS] connected:', wsUrl);
  ws.onclose = (e) => console.log('[manageWS] closed', e.code, e.reason);
  ws.onerror = (e) => console.error('[manageWS] error', e);

  // 後端廣播 manage_panels 的 payload，要在這裡更新畫面
  ws.onmessage = (ev) => {
    try {
      const msg = JSON.parse(ev.data);
      if (msg.type === 'manage_panels' && typeof msg.html === 'string') {
        const box = document.getElementById('manage-panels');
        if (box) box.innerHTML = msg.html;
      }
      // 如果你有分單張卡片更新：
      if (msg.type === 'replace_pax_item' && msg.pax_id && typeof msg.html === 'string') {
        const li = document.querySelector(`.pax-item[data-pax="${msg.pax_id}"]`);
        if (li) li.outerHTML = msg.html;
      }
    } catch (err) {
      console.error('ws message parse error', err, ev.data);
    }
  };
})();
</script> -->
</body>
</html>
